var lt=Object.defineProperty;var ct=(s,t,o)=>t in s?lt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):s[t]=o;var ye=(s,t,o)=>ct(s,typeof t!="symbol"?t+"":t,o);import{f as oe,j as e,r,bt as Ue,bu as dt,t as ue,B as a,k as G,a5 as ge,I as Q,bv as K,R as N,e as he,U as Oe,T as O,bw as He,g as ut,aI as ve,Y as Me,M as Pe,Z as De,b1 as Re,O as Ne,bx as qe,by as pt,S as ht,X as gt,$ as Te,P as xe,Q as xt,w as fe}from"./index-DTtJxl4K.js";import{D as Ve,C as ft}from"./Dialog-479to39A.js";import{I as Ye}from"./Input-DdUxxgQs.js";const bt=oe(e.jsx("path",{d:"m18 7-1.41-1.41-6.34 6.34 1.41 1.41zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12zM.41 13.41 6 19l1.41-1.41L1.83 12z"})),Ke=oe(e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11"})),mt=oe(e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"})),yt=oe(e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"})),de=oe([e.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"},"0"),e.jsx("path",{d:"M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"},"1")]);class St{constructor(){ye(this,"observer",null);ye(this,"callbacks",new Map);ye(this,"observedElements",new WeakSet)}createObserver(){return this.observer?this.observer:(this.observer=new IntersectionObserver(t=>{t.forEach(o=>{const i=this.callbacks.get(o.target);i&&i(o.isIntersecting)})},{threshold:.1,rootMargin:"500px"}),this.observer)}observe(t,o){if(this.observedElements.has(t))return;const i=this.createObserver();this.callbacks.set(t,o),this.observedElements.add(t),i.observe(t)}unobserve(t){!this.observer||!this.observedElements.has(t)||(this.observer.unobserve(t),this.callbacks.delete(t),this.observedElements.delete(t),this.callbacks.size===0&&(this.observer.disconnect(),this.observer=null))}disconnect(){this.observer&&(this.observer.disconnect(),this.observer=null),this.callbacks.clear()}}const Le=new St,wt=s=>{const t=r.useRef(null),o=r.useRef(s);r.useEffect(()=>{o.current=s},[s]);const i=r.useCallback(()=>{const d=t.current;d&&Le.observe(d,x=>{o.current(x)})},[]),h=r.useCallback(()=>{const d=t.current;d&&Le.unobserve(d)},[]);return r.useEffect(()=>(i(),h),[i,h]),{elementRef:t}},ce=({storageKey:s,alt:t="",sx:o,className:i,onClick:h,loadingMode:d=null,staggerIndex:x=0})=>{const{getSignedUrl:m,hasSignedUrl:S}=Ue(),l=dt(v=>v.user.currentUser),[u,p]=r.useState(!0),[R,f]=r.useState(!1),[E,L]=r.useState(!1),[B,z]=r.useState(!1),T=r.useCallback(v=>{if(v&&!E){L(!0);const n=Math.min(x*50,500);setTimeout(()=>{z(!0)},n)}},[E,x]),{elementRef:C}=wt(T);if(!l)return e.jsx(ue,{ref:C,variant:"rectangular",className:i,sx:{width:"100%",height:"100%",bgcolor:"rgba(255,255,255,0.05)",cursor:h?"pointer":"default",...o}});const k=B?m(s,l.id):null;return!B||!k||!S(s)?e.jsx(ue,{ref:C,variant:"rectangular",className:i,sx:{width:"100%",height:"100%",bgcolor:"rgba(255,255,255,0.05)",cursor:h?"pointer":"default",...o,"&::after":{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent)",animationDuration:"1.5s"}}}):e.jsxs(a,{ref:C,className:i,onClick:h,sx:{width:"100%",height:"100%",position:"relative",overflow:"hidden",cursor:h?"pointer":"default",...o},children:[u&&e.jsx(ue,{variant:"rectangular",sx:{position:"absolute",top:0,left:0,right:0,bottom:0,width:"100%",height:"100%",bgcolor:"rgba(255,255,255,0.05)",zIndex:1,"&::after":{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent)",animationDuration:"1.2s"}}}),R?e.jsx(a,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"rgba(255,255,255,0.05)",color:"rgba(255,255,255,0.3)",fontSize:"2rem",border:"1px dashed rgba(255,255,255,0.1)",borderRadius:"inherit"},children:"❌"}):e.jsx("img",{src:k,alt:t,loading:"lazy",decoding:"async",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:"inherit",transition:"opacity 0.3s ease",willChange:"auto"},onLoad:()=>p(!1),onError:()=>{p(!1),f(!0)}})]})},Qe=oe(e.jsx("path",{d:"M11.67 3.87 9.9 2.1 0 12l9.9 9.9 1.77-1.77L3.54 12z"})),Ge=oe(e.jsx("path",{d:"M6.23 20.23 8 22l10-10L8 2 6.23 3.77 14.46 12z"})),jt=oe(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-2h2zm0-4h-2V7h2z"})),kt=oe(e.jsx("path",{d:"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2M8.5 13.5l2.5 3.01L14.5 12l4.5 6H5z"})),Ce=oe(e.jsx("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"})),Xe=oe(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"})),vt=G(Ve)({"& .MuiBackdrop-root":{backgroundColor:"rgba(0, 0, 0, 0.8)",backdropFilter:"blur(8px)"},"& .MuiDialog-paper":{backgroundColor:"rgba(30, 30, 47, 0.95)",backdropFilter:"blur(10px)",borderRadius:"16px",border:"1px solid rgba(255, 255, 255, 0.1)",maxWidth:"70vw",maxHeight:"90vh",margin:"auto",overflow:"hidden"}}),Ct=G("div")({position:"relative",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",userSelect:"none",padding:"20px"}),Ae=G(Q)({position:"absolute",top:"50%",transform:"translateY(-50%)",width:56,height:56,backgroundColor:"rgba(0, 0, 0, 0.6)",border:`1px solid ${K.primary}30`,color:K.text.primary,transition:"all 0.2s ease","&:hover":{backgroundColor:`${K.primary}20`,borderColor:`${K.primary}60`,transform:"translateY(-50%) scale(1.1)",boxShadow:`0 0 20px ${K.primary}40`},"&:active":{transform:"translateY(-50%) scale(0.95)"}}),Mt=G(Q)({position:"absolute",top:20,right:20,width:48,height:48,backgroundColor:"rgba(0, 0, 0, 0.6)",border:"1px solid rgba(255, 61, 113, 0.3)",color:K.text.primary,transition:"all 0.2s ease","&:hover":{backgroundColor:"rgba(255, 61, 113, 0.2)",borderColor:"rgba(255, 61, 113, 0.6)",transform:"scale(1.1) rotate(90deg)",boxShadow:"0 0 20px rgba(255, 61, 113, 0.4)"}}),Dt=G(a)({position:"absolute",bottom:24,left:"50%",transform:"translateX(-50%)",padding:"8px 16px",backgroundColor:"rgba(0, 0, 0, 0.7)",border:`1px solid ${K.primary}30`,borderRadius:"20px",color:K.text.primary,fontSize:"14px",fontWeight:600,backdropFilter:"blur(10px)"}),Rt=G(a)({position:"absolute",bottom:60,left:"50%",transform:"translateX(-50%)",display:"flex",gap:"8px",alignItems:"center"}),It=G("button")(({active:s})=>({width:s?24:8,height:8,border:"none",borderRadius:"4px",backgroundColor:s?K.primary:"rgba(255, 255, 255, 0.3)",cursor:"pointer",transition:"all 0.2s ease","&:hover":{backgroundColor:s?K.primary:"rgba(255, 255, 255, 0.5)",transform:"scale(1.2)"}})),zt=G(a)({width:"100%",height:"calc(90vh - 120px)",display:"flex",alignItems:"center",justifyContent:"center"}),Et=({open:s,images:t,currentIndex:o,onClose:i,onNavigate:h})=>{const d=r.useMemo(()=>t[o],[t,o]),x=r.useCallback(()=>{o>0&&h(o-1)},[o,h]),m=r.useCallback(()=>{o<t.length-1&&h(o+1)},[o,t.length,h]),S=r.useCallback(l=>{switch(l.key){case"Escape":i();break;case"ArrowLeft":x();break;case"ArrowRight":m();break}},[i,x,m]);return d?e.jsx(vt,{open:s,onClose:i,onKeyDown:S,children:e.jsxs(Ct,{onClick:i,children:[e.jsx(zt,{onClick:l=>l.stopPropagation(),children:e.jsx(ce,{storageKey:d,alt:"Preview",sx:{width:"100%",height:"100%",objectFit:"contain",borderRadius:"12px",filter:"drop-shadow(0 8px 32px rgba(0,0,0,0.8))",transition:"transform 0.2s ease","&:hover":{transform:"scale(1.01)"}}})}),o>0&&e.jsx(Ae,{onClick:l=>{l.stopPropagation(),x()},style:{left:32},children:e.jsx(Qe,{})}),o<t.length-1&&e.jsx(Ae,{onClick:l=>{l.stopPropagation(),m()},style:{right:32},children:e.jsx(Ge,{})}),e.jsx(Mt,{onClick:l=>{l.stopPropagation(),i()},children:e.jsx(ge,{})}),t.length>1&&e.jsxs(e.Fragment,{children:[e.jsxs(Dt,{children:[o+1," / ",t.length]}),e.jsx(Rt,{children:t.map((l,u)=>e.jsx(It,{active:u===o,onClick:p=>{p.stopPropagation(),h(u)}},u))})]})]})}):null},Ft=s=>new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),Tt=s=>{var o;if(s.content&&s.content.trim())return s.content;const t="attachments_count"in s?s.attachments_count:((o=s.attachments)==null?void 0:o.length)||0;return t>0?t===1?"📎 Вложение":t>=2&&t<=4?`📎 ${t} вложения`:`📎 ${t} вложений`:"📎 Вложение"},Je=N.memo(s=>{const{message:t,isFirstInGroup:o=s.isFirstOfGroup||!1,isTempMessage:i=!1,isHighlighted:h=!1,isUnread:d=!1,isFocused:x=!1,isSearchMode:m=!1,searchQuery:S="",currentUserId:l,hubId:u=0,loadingMode:p=null,onReply:R,onEdit:f,onDelete:E,onReplyClick:L,onMouseEnter:B,onMouseLeave:z}=s,[T,C]=r.useState(!1),k=N.useRef(null),[v,n]=r.useState(null),[c,y]=r.useState(0),g=t.attachments&&t.attachments.length>0,M=N.useCallback((w,_)=>{n(w),y(_)},[]),A=N.useCallback(()=>{t.reply&&L&&L(t.reply.id)},[t.reply,L]),P=N.useCallback(()=>{t&&R&&R(t)},[t,R]),b=N.useCallback(()=>{f&&typeof f=="function"&&f(t.id)},[f,t.id]),D=N.useCallback(()=>{E&&typeof E=="function"&&E(t.id)},[E,t.id]);return e.jsxs(e.Fragment,{children:[e.jsxs(a,{id:`message-${t.id}`,className:"message-item","data-date":t.created_at,"data-msg-id":t.id.toString(),onMouseEnter:w=>{k.current&&(clearTimeout(k.current),k.current=null),C(!0),B&&B(w,t)},onMouseLeave:w=>{k.current=setTimeout(()=>{C(!1),z&&z(w)},100)},sx:{display:"flex",gap:2,alignItems:"flex-start",position:"relative",borderRadius:"10px",overflow:"visible",transition:"background-color 0.2s ease",opacity:i?.6:1,mt:o?3:.5,px:1.5,py:.5,backgroundColor:x?"rgba(0, 207, 255, 0.25)":h?"rgba(33, 150, 243, 0.25)":d?"rgba(25,118,210,0.1)":"transparent","&.highlight-pulse":{animation:"pulse 2s infinite"},"&:hover":{backgroundColor:x?"rgba(0, 207, 255, 0.35)":h?"rgba(33, 150, 243, 0.35)":d?"rgba(25,118,210,0.15)":"rgba(255,255,255,0.05)"}},children:[T&&e.jsxs(a,{sx:{position:"absolute",top:-40,left:"50%",transform:"translateX(-50%)",display:"flex",gap:.5,zIndex:1e3,padding:"6px 8px",borderRadius:"20px",background:"rgba(40, 44, 52, 0.95)",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",transition:"all 0.2s ease",opacity:1,animation:"fadeIn 0.2s ease-in-out","@keyframes fadeIn":{from:{opacity:0,transform:"translateX(-50%) translateY(5px)"},to:{opacity:1,transform:"translateX(-50%) translateY(0)"}}},children:[e.jsx(he,{title:"Ответить",enterDelay:1e3,placement:"top",children:e.jsx(Q,{size:"small",onClick:P,sx:{color:"#00CFFF",transition:"all 0.2s ease","&:hover":{color:"#E5FBFF",transform:"scale(1.05)"}},children:e.jsx(Ke,{fontSize:"small"})})}),t.author.id===l&&e.jsxs(e.Fragment,{children:[e.jsx(he,{title:"Редактировать",enterDelay:1e3,placement:"top",children:e.jsx(Q,{size:"small",onClick:b,sx:{color:"#00CFFF",transition:"transform 0.15s ease, color 0.15s ease","&:hover":{color:"#E5FBFF",transform:"scale(1.02)"}},children:e.jsx(mt,{fontSize:"small"})})}),e.jsx(he,{title:"Удалить",enterDelay:1e3,placement:"top",children:e.jsx(Q,{size:"small",onClick:D,sx:{color:"#FF3D71",transition:"transform 0.15s ease, color 0.15s ease","&:hover":{color:"#FF708D",transform:"scale(1.02)"}},children:e.jsx(yt,{fontSize:"small"})})})]})]}),e.jsx(a,{sx:{width:40,display:"flex",flexDirection:"column",alignItems:"center",mt:1},children:o?e.jsx("div",{style:{cursor:"pointer"},children:e.jsx(Oe,{src:t.author.avatar||void 0,alt:t.author.login,userId:t.author.id,hubId:u})}):null}),e.jsxs(a,{sx:{flex:1,position:"relative"},children:[e.jsx(a,{sx:{maxWidth:"99%"},children:e.jsxs(a,{sx:{py:"5px",px:"0px",pl:0},children:[o&&e.jsx(O,{sx:{color:"#00CFFF",fontWeight:700,mb:.5,fontSize:"1rem",letterSpacing:.2},children:t.author.login}),t.reply&&e.jsx(a,{sx:{mb:.8,mt:.25},children:e.jsxs(a,{sx:{display:"flex",flexDirection:"column",borderRadius:"8px",padding:"6px 10px",ml:0,background:"rgba(0, 207, 255, 0.06)",borderLeft:"3px solid #00CFFF",cursor:"pointer",transition:"transform 0.15s ease, color 0.15s ease","&:hover":{background:"rgba(0, 207, 255, 0.1)",transform:"translateX(2px)"}},onClick:A,children:[e.jsx(a,{sx:{display:"flex",alignItems:"center",gap:.5},children:e.jsx(O,{sx:{color:"#00CFFF",fontSize:"0.75rem",fontWeight:"600",letterSpacing:.3},children:t.reply.author.login})}),e.jsx(O,{sx:{color:"rgba(255,255,255,0.6)",fontSize:"0.8rem",mt:.2,lineHeight:1.3,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"400px"},children:Tt(t.reply)})]})})]})}),g&&e.jsx(a,{sx:{mt:1.5,mb:1},children:(()=>{var _;const w=((_=t.attachments)==null?void 0:_.length)||0;return w===1?e.jsxs(a,{sx:{position:"relative",borderRadius:3,overflow:"hidden",maxWidth:"450px",height:"300px",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 8px 32px rgba(0,0,0,0.12)",background:"linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"translateY(-2px)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)","& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.02)"}}},onClick:()=>M(t.attachments[0],0),children:[e.jsx(ce,{storageKey:t.attachments[0],className:"attachment-image",alt:"",loadingMode:p,staggerIndex:0,sx:{width:"100%",height:"100%",borderRadius:3,transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(de,{sx:{color:"white",fontSize:"36px",filter:"drop-shadow(0 2px 8px rgba(0,0,0,0.4))"}})})]}):w===2?e.jsx(a,{sx:{display:"flex",gap:1,maxWidth:"450px"},children:t.attachments.map((I,j)=>e.jsxs(a,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",flex:1,height:"200px",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"translateY(-2px) scale(1.02)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>M(I,j),children:[e.jsx(ce,{loadingMode:p,storageKey:I,className:"attachment-image",alt:"",staggerIndex:j,sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(de,{sx:{color:"white",fontSize:"28px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(a,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:[j+1,"/",w]})]},j))}):w===3?e.jsxs(a,{sx:{display:"flex",gap:1,maxWidth:"450px",height:"280px"},children:[e.jsxs(a,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",flex:2,cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.01)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>M(t.attachments[0],0),children:[e.jsx(ce,{loadingMode:p,storageKey:t.attachments[0],className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(de,{sx:{color:"white",fontSize:"32px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(a,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:["1/",w]})]}),e.jsx(a,{sx:{display:"flex",flexDirection:"column",gap:1,flex:1},children:t.attachments.slice(1,3).map((I,j)=>e.jsxs(a,{sx:{position:"relative",borderRadius:2,overflow:"hidden",flex:1,cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.01)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>M(I,j+1),children:[e.jsx(ce,{loadingMode:p,storageKey:I,className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(de,{sx:{color:"white",fontSize:"24px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(a,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:[j+2,"/",w]})]},j+1))})]}):w===4?e.jsx(a,{sx:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:1,maxWidth:"400px",aspectRatio:"1"},children:t.attachments.map((I,j)=>e.jsxs(a,{sx:{position:"relative",borderRadius:2,overflow:"hidden",aspectRatio:"1",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.03)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.08)"}}},onClick:()=>M(I,j),children:[e.jsx(ce,{loadingMode:p,storageKey:I,className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(de,{sx:{color:"white",fontSize:"28px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(a,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:[j+1,"/",w]})]},j))}):w>=5?e.jsxs(a,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:1,maxWidth:"450px",aspectRatio:"3/2"},children:[e.jsxs(a,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",gridColumn:"span 2",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.01)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>M(t.attachments[0],0),children:[e.jsx(ce,{loadingMode:p,storageKey:t.attachments[0],className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(de,{sx:{color:"white",fontSize:"32px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(a,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:["1/",w]})]}),e.jsx(a,{sx:{display:"flex",flexDirection:"column",gap:1},children:t.attachments.slice(1,3).map((I,j)=>e.jsxs(a,{sx:{position:"relative",borderRadius:2,overflow:"hidden",flex:1,cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.03)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>M(I,j+1),children:[e.jsx(ce,{loadingMode:p,storageKey:I,className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:j===1&&w>3?e.jsxs(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:.5},children:[e.jsxs(O,{sx:{color:"white",fontSize:"1.2rem",fontWeight:700,textShadow:"0 2px 8px rgba(0,0,0,0.8)"},children:["+",w-3]}),e.jsx(O,{sx:{color:"white",fontSize:"0.75rem",fontWeight:500,textShadow:"0 1px 4px rgba(0,0,0,0.8)",opacity:.9},children:"ещё"})]}):e.jsx(de,{sx:{color:"white",fontSize:"20px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(a,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:[j+2,"/",w]})]},j+1))})]}):null})()}),e.jsxs(a,{sx:{display:"flex",flexDirection:"column",position:"relative"},children:[t.content&&e.jsx(O,{sx:{color:"rgba(255,255,255,0.85)",wordBreak:"break-word",fontSize:"1.01rem",whiteSpace:"pre-wrap",pr:"120px",pl:0,lineHeight:1.4},component:"span",dangerouslySetInnerHTML:{__html:He.sanitize((()=>{let w=t.content.replace(/\r\n/g,`
`).replace(/\n/g,"<br>");if(m&&S.trim()){const I=S.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),j=new RegExp(`(${I})`,"gi");w=w.replace(j,'<span style="background-color: rgba(0, 207, 255, 0.3); color: #fff; border-radius: 2px; padding: 0; font-weight: 600;">$1</span>')}return w})())}}),!t.content&&g&&e.jsx(a,{sx:{minHeight:"20px"}}),e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:.5,position:"absolute",bottom:t.content?"7px":"22px",right:0,padding:"0 8px"},children:[t.last_modified_at&&t.last_modified_at!==t.created_at&&e.jsx("span",{style:{color:"#90caf9",fontSize:"0.85em",fontStyle:"italic",fontWeight:500},children:"ред."}),t.author.id===l&&e.jsx(a,{sx:{display:"flex",alignItems:"center",gap:.5,mr:.5},children:e.jsx(bt,{sx:{fontSize:"1rem",color:t.read_by_count&&t.read_by_count>0?"#FF69B4":"rgba(255,255,255,0.35)"}})}),e.jsx(O,{sx:{color:"rgba(255,255,255,0.35)",fontSize:"0.78rem",lineHeight:1,whiteSpace:"nowrap",display:"flex",alignItems:"center",gap:.5},children:Ft(t.created_at)})]})]})]})]}),e.jsx(Et,{open:!!v,images:t.attachments||[],currentIndex:c,onClose:()=>n(null),onNavigate:w=>{y(w),n(t.attachments[w])}})]})});Je.displayName="ChatMessageItem";const Lt=ut.injectEndpoints({endpoints:s=>({signMediaUrls:s.mutation({query:t=>({url:"/api/v1/media-sign",method:"POST",body:t}),invalidatesTags:["Media"]})})}),{useSignMediaUrlsMutation:At}=Lt,Bt=Pe().shape({content:Ne().min(1,"Message cannot be empty").max(2e3,"Message is too long")}),ke=new Map,_t=s=>{const t=s.split("T")[0];if(ke.has(t))return ke.get(t);const o=new Date(s),i=new Date,h=new Date(i);h.setDate(h.getDate()-1);let d;if(o.toDateString()===i.toDateString())d="Сегодня";else if(o.toDateString()===h.toDateString())d="Вчера";else{const x=o.getFullYear()===i.getFullYear(),m=o.toLocaleDateString([],{weekday:"long",day:"numeric",month:"long",...x?{}:{year:"numeric"}});d=m.charAt(0).toUpperCase()+m.slice(1)}return ke.set(t,d),d},$t=(s,t,o=30)=>{const i=new Date(s),h=new Date(t);return Math.abs(i.getTime()-h.getTime())/(1e3*60)<=o},Wt=(s,t)=>{const o=new Date(s),i=new Date(t);return o.toDateString()===i.toDateString()},sr=({activeChannel:s,messages:t,tempMessages:o,searchMode:i,searchQuery:h,highlightedMessages:d,focusedMessageId:x,unreadMessages:m,isLoadingMore:S,isLoadingAround:l,editingMessageId:u,user:p,hubId:R,paginationState:f,messagesPerPage:E,showDateLabel:L,currentDateLabel:B,messagesContainerRef:z,messagesEndRef:T,editInputRef:C,highlightTimeoutRef:k,scrollToMessageIdRef:v,hoverTimeoutRef:n,isHoveringPortal:c,scrollCorrectionRef:y,forceScrollToMessageId:g,setHighlightedMessages:M,setFocusedMessageId:A,setEditingMessageId:P,setMessages:b,setTempMessages:D,setReplyingToMessage:w,setHoveredMessage:_,setTargetMessageId:I,paginationActions:j,handleEditMessage:U,handleDeleteMessage:Y})=>{const[X]=At(),{setSignedUrls:Z,hasSignedUrl:ee}=Ue(),ae=N.useRef(new Set),q=N.useMemo(()=>[...t].sort((F,H)=>new Date(F.created_at).getTime()-new Date(H.created_at).getTime()),[t]);N.useEffect(()=>{if(!t.length)return;const F=new Set;t.forEach(W=>{W.attachments&&W.attachments.length>0&&W.attachments.forEach(V=>{V.trim()&&F.add(V)})});const H=Array.from(F).filter(W=>!ee(W)&&!ae.current.has(W));H.length>0&&(H.forEach(W=>ae.current.add(W)),X({storage_keys:H}).unwrap().then(W=>{console.log("Media URLs signed:",W),Z(W),H.forEach(V=>ae.current.delete(V))}).catch(W=>{console.error("Failed to sign media URLs:",W),H.forEach(V=>ae.current.delete(V))}))},[t,X,Z,ee]);const te=N.useMemo(()=>t.length===0&&o.size===0,[t.length,o.size]),ie=N.useMemo(()=>te&&!S&&!l&&f.loadingMode!=="initial"&&f.loadingMode!=="around"&&!f.isJumpingToMessage&&!!s,[te,S,l,f.loadingMode,f.isJumpingToMessage,s]),Se=N.useMemo(()=>{const F=Array.from(o.entries()).map(([H,W])=>({...W,__isTemp:!0,__tempId:H}));return[...q,...F]},[q,o]),Ze=ie&&e.jsx(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(O,{variant:"body1",color:"text.secondary",children:i?"No messages found matching your search.":"No messages yet. Start a conversation!"})}),et=N.useCallback(F=>{if(q.some(W=>W.id===F)){const W=document.querySelector(`[data-msg-id='${F}']`);W&&(W.scrollIntoView({behavior:"smooth",block:"center"}),k.current&&(clearTimeout(k.current),k.current=null),A(null),M(new Set),A(F),M(()=>{const V=new Set;return V.add(F),V}),k.current=setTimeout(()=>{M(V=>{const J=new Set(V);return J.delete(F),J}),A(null),k.current=null},1500))}else j.setIsJumpingToMessage(!0),j.setSkipMainQuery(!0),b([]),D(new Map),j.setBeforeId(null),j.setAfterId(null),j.setHasMoreMessages(!0),j.setHasMoreMessagesAfter(!0),j.setEnableAfterPagination(!0),I(F),j.setAroundMessageId(F),j.setLoadingMode("around")},[q,A,M,k,j,b,D,I]),tt=N.useCallback(F=>{w(F)},[w]),rt=N.useCallback(F=>P(typeof F=="number"?F:F.id),[P]),st=N.useCallback(F=>Y(typeof F=="number"?F:F.id),[Y]),ot=N.useCallback((F,H)=>{n!=null&&n.current&&(clearTimeout(n.current),n.current=null),_&&H&&_({element:F.currentTarget,message:H})},[n,_]),nt=N.useCallback(()=>{n&&(n.current=setTimeout(()=>{!(c!=null&&c.current)&&_&&_(null)},100))},[n,c,_]),at=()=>e.jsx(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",color:"rgba(255,255,255,0.5)",textAlign:"center",gap:2},children:f.loadingMode==="around"||f.isJumpingToMessage||l?e.jsx(a,{sx:{width:"100%",height:"100%",overflowY:"auto",p:3,display:"flex",flexDirection:"column",gap:2},children:[...Array(E)].map((F,H)=>e.jsxs(a,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[e.jsx(ue,{variant:"circular",width:40,height:40,sx:{bgcolor:"rgba(255,255,255,0.1)"}}),e.jsxs(a,{sx:{flex:1},children:[e.jsx(ue,{variant:"text",width:120,height:24,sx:{bgcolor:"rgba(255,255,255,0.1)",mb:1}}),e.jsx(ue,{variant:"text",width:"80%",height:20,sx:{bgcolor:"rgba(255,255,255,0.1)"}}),e.jsx(ue,{variant:"text",width:"60%",height:20,sx:{bgcolor:"rgba(255,255,255,0.1)"}})]})]},H))}):i&&h&&h.trim()?e.jsxs(e.Fragment,{children:[e.jsx(O,{variant:"h6",children:"Нет результатов поиска"}),e.jsx(O,{variant:"body2",children:"Попробуйте изменить поисковый запрос"})]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{variant:"h6",children:"Нет сообщений"}),e.jsx(O,{variant:"body2",children:"Начните общение, отправив первое сообщение"})]})}),Ie=N.useRef(null),ze=N.useRef(null);return N.useEffect(()=>{const F=Ie.current,H=ze.current;if(!F||!H)return;const W=$=>{const[be]=$;if(be.isIntersecting&&f.hasMoreMessages&&!f.isJumpingToMessage&&f.loadingMode!=="pagination"&&f.loadingMode!=="around"){const se=q[0];se&&(j.setBeforeId(se.id),j.setLoadingMode("pagination"))}},V=$=>{const[be]=$;if(be.isIntersecting&&f.enableAfterPagination&&f.hasMoreMessagesAfter&&!f.isJumpingToMessage&&f.loadingMode!=="pagination"&&f.loadingMode!=="around"){const se=q[q.length-1];se&&(j.setAfterId(se.id),j.setLoadingMode("pagination"))}},J=new IntersectionObserver(W,{root:z.current,threshold:.1}),re=new IntersectionObserver(V,{root:z.current,threshold:.8});return J.observe(F),re.observe(H),()=>{J.disconnect(),re.disconnect()}},[q,f,j,z]),N.useEffect(()=>{var V;const F=z.current;if(!F)return;const H=g??((v==null?void 0:v.current)||null);if(H===null)return;if(f.enableAfterPagination&&f.loadingMode==="pagination"&&f.afterId){v&&(v.current=null);return}const W=F.querySelector(`[data-msg-id="${H}"]`);W&&(W.scrollIntoView({behavior:(V=y==null?void 0:y.current)!=null&&V.setDisableSmoothScroll?"auto":"smooth",block:"center"}),v&&(v.current=null),x!==H&&(M(J=>{const re=new Set(J);return re.add(H),re}),A&&A(H),k.current&&clearTimeout(k.current),k.current=setTimeout(()=>{M(J=>{const re=new Set(J);return re.delete(H),re}),A&&A(null)},1500)))},[g,v==null?void 0:v.current,x,k,M,A,y,f.enableAfterPagination,f.loadingMode,f.afterId]),N.useEffect(()=>{f.enableAfterPagination&&f.loadingMode==="pagination"&&f.afterId&&(k.current&&(clearTimeout(k.current),k.current=null),M(new Set),A(null),v&&(v.current=null))},[f.enableAfterPagination,f.loadingMode,f.afterId,k,M,A,v]),e.jsx(a,{ref:z,className:"messages-container",sx:{flex:1,px:3,pt:3,pb:1,overflowY:"auto",display:"flex",flexDirection:"column",gap:1,position:"relative",willChange:"scroll-position","&::-webkit-scrollbar":{width:"8px"},"&::-webkit-scrollbar-track":{background:"rgba(255,255,255,0.05)",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.1)",borderRadius:"4px","&:hover":{background:"rgba(255,255,255,0.15)"}}},children:q.length===0&&o.size===0?at():e.jsxs(e.Fragment,{children:[Ze,e.jsx(ve,{in:L,timeout:{enter:300,exit:500},children:e.jsx(a,{sx:{position:"sticky",top:0,zIndex:10,alignSelf:"center",backgroundColor:"rgba(30,30,47,0.85)",backdropFilter:"blur(8px)",borderRadius:"16px",px:2,py:.75,mb:1,boxShadow:"0 2px 8px rgba(0,0,0,0.2)",border:"1px solid rgba(255,255,255,0.1)",transition:"all 0.3s ease"},children:e.jsx(O,{sx:{color:"rgba(255,255,255,0.9)",fontWeight:600,fontSize:"0.9rem"},children:B})})}),e.jsx("div",{ref:Ie,style:{height:"1px",margin:"20px 0"}}),(()=>{let F=[],H=null,W=null,V=[],J=null,re=new Set;return Se.forEach($=>{var Ee;const se=new Date($.created_at).toDateString();J!==se&&!re.has(se)&&(V.length>0&&(F.push(...V),V=[]),F.push(e.jsx(a,{className:"date-separator","data-date":$.created_at,sx:{display:"flex",justifyContent:"center",alignItems:"center",my:3,position:"relative","&::before":{content:'""',position:"absolute",top:"50%",left:0,right:0,height:"1px",background:"linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 20%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0.2) 80%, transparent 100%)",zIndex:0}},children:e.jsx(a,{sx:{backgroundColor:"rgba(30,30,47,0.95)",backdropFilter:"blur(8px)",px:3,py:1,borderRadius:"16px",boxShadow:"0 2px 8px rgba(0,0,0,0.25)",border:"1px solid rgba(255,255,255,0.15)",zIndex:1},children:e.jsx(O,{variant:"body2",sx:{color:"rgba(255,255,255,0.85)",fontWeight:600,fontSize:"0.8rem",letterSpacing:"0.5px"},children:_t($.created_at)})})},`date-${se}`)),J=se,re.add(se));const me="__isTemp"in $&&$.__isTemp,we=((Ee=$.author)==null?void 0:Ee.id)!==H||!W||!$t($.created_at,W,30)||!Wt($.created_at,W),it=u===$.id?e.jsxs(a,{id:`message-${$.id}`,className:"message-item","data-date":$.created_at,"data-msg-id":$.id.toString(),sx:{display:"flex",gap:2,alignItems:"flex-start",position:"relative",borderRadius:"10px",transition:"background-color 0.3s ease",opacity:me?.6:1},children:[e.jsx(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"flex-start",width:40,ml:1,mt:1},children:we?e.jsx("div",{style:{cursor:"pointer"},children:e.jsx(Oe,{src:$.author.avatar||void 0,alt:$.author.login,userId:$.author.id,hubId:R})}):null}),e.jsx(a,{sx:{flex:1,position:"relative"},children:e.jsx(a,{sx:{maxWidth:"100%"},children:e.jsxs(a,{sx:{py:"5px",px:"0px",pl:0},children:[we&&e.jsx(O,{sx:{color:"#00CFFF",fontWeight:700,mb:.5,fontSize:"1rem",letterSpacing:.2},children:$.author.login}),e.jsx(Me,{initialValues:{content:$.content},validationSchema:Bt,onSubmit:U,children:({handleSubmit:Fe,values:je})=>e.jsx(De,{children:e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:1,background:"rgba(30,30,47,0.9)",borderRadius:"8px",padding:"8px",border:"1px solid rgba(255,255,255,0.1)",boxShadow:"0 4px 12px rgba(0,0,0,0.2)"},children:[e.jsx(Re,{name:"content",component:Ye,multiline:!0,fullWidth:!0,size:"small",inputRef:C,onKeyDown:le=>{le.key==="Enter"&&!le.shiftKey?(le.preventDefault(),Fe()):le.key==="Escape"&&(le.preventDefault(),P(null))}}),e.jsxs(a,{sx:{display:"flex",gap:1,justifyContent:"flex-end",padding:"4px 8px"},children:[e.jsx(Q,{size:"small",onClick:le=>{le.preventDefault(),P(null)},sx:{color:"#d32f2f","&:hover":{background:"rgba(211,47,47,0.1)"}},children:e.jsx(ge,{fontSize:"small"})}),e.jsx(Q,{size:"small",onClick:le=>Fe(),disabled:!je.content,sx:{color:je.content?"#1976D2":"rgba(255,255,255,0.3)",transition:"color 0.25s cubic-bezier(.4,0,.2,1)","&:hover":{color:je.content?"#1976D2":"rgba(255,255,255,0.3)"}},children:e.jsx(Xe,{fontSize:"small"})})]})]})})})]})})})]},me?`temp-${$.__tempId}`:$.id):e.jsx(Je,{message:$,isFirstOfGroup:we,isTempMessage:me,isHighlighted:d.has($.id),isUnread:m.has($.id),isFocused:x===$.id,isSearchMode:i,searchQuery:h,currentUserId:p.id,hubId:R,loadingMode:f.loadingMode,onReply:tt,onEdit:rt,onDelete:st,onReplyClick:et,onMouseEnter:ot,onMouseLeave:nt},me?`temp-${$.__tempId}`:$.id);V.push(it),H=$.author.id,W=$.created_at}),V.length>0&&F.push(...V),F})(),e.jsx("div",{ref:ze,style:{height:"1px",margin:"2px 0"}}),e.jsx("div",{ref:T})]})})},Ut=N.memo(({message:s,searchQuery:t,onResultClick:o})=>{const{highlightedContent:i,formattedTime:h}=r.useMemo(()=>{const m=new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1});let S=s.content;if(S.length>150&&(S=S.substring(0,150)+"..."),S=S.replace(/\r\n/g," ").replace(/\n/g," "),t.trim()){const u=t.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),p=new RegExp(`(${u})`,"gi");S=S.replace(p,"<mark>$1</mark>")}return{highlightedContent:He.sanitize(S),formattedTime:m}},[s.content,s.created_at,t]),d=N.useCallback(()=>{o(s)},[s,o]);return e.jsxs(a,{onClick:d,onMouseDown:x=>x.preventDefault(),sx:{p:2,borderBottom:"1px solid rgba(255,255,255,0.05)",cursor:"pointer",transition:"background-color 0.2s ease","&:hover":{background:"rgba(255,255,255,0.1)"},"&:last-child":{borderBottom:"none"},contain:"layout style paint",contentVisibility:"auto",containIntrinsicSize:"0 80px"},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(O,{sx:{color:"#00CFFF",fontSize:"0.8rem",fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"150px"},children:s.author.login}),e.jsx(O,{sx:{color:"rgba(255,255,255,0.4)",fontSize:"0.7rem",ml:"auto"},children:h})]}),e.jsx(O,{sx:{color:"rgba(255,255,255,0.8)",fontSize:"0.85rem",lineHeight:1.4,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical","& mark":{background:"rgba(255, 105, 180, 0.3)",color:"#FF69B4",padding:"1px 2px",borderRadius:"2px",fontWeight:600}},dangerouslySetInnerHTML:{__html:i}})]})},(s,t)=>s.message.id===t.message.id&&s.message.content===t.message.content&&s.searchQuery===t.searchQuery),Ot=({activeChannelId:s})=>{const[t,o]=r.useState(!1),[i,h]=r.useState(""),[d,x]=r.useState(""),[m,S]=r.useState(!1),l=r.useRef(null),u=r.useRef(null),[p,R]=r.useState(0),[f,E]=r.useState([]),[L,B]=r.useState(!0),[z,T]=r.useState(-1),C=s!==null&&d.trim()?{channelId:s,search:d,size:50,...p>0?{page:p}:{}}:void 0,{data:k,isFetching:v,error:n}=qe(C,{skip:!s||!d.trim()}),c=r.useCallback(pt(b=>{x(b)},300),[]);r.useEffect(()=>{k&&(p>0&&p!==z?(E(b=>[...b,...k]),T(p)):(p===0&&z!==-1||p===0&&z===-1)&&(E(k),T(0)),B(k.length>=20))},[k,p,z]),r.useEffect(()=>{d.trim()?(R(0),T(-1)):(E([]),R(0),B(!0),T(-1))},[d]);const y=r.useCallback(b=>{h(b),c(b),b.trim()?S(!0):S(!1)},[c]),g=r.useCallback(()=>{L&&!v&&R(b=>b+1)},[L,v]),M=v&&p>0,A=r.useCallback(()=>{h(""),x(""),S(!1),o(!1),E([]),R(0),B(!0),T(-1),l.current&&(l.current.value="")},[]),P=r.useCallback(b=>{S(!1),o(!1),A()},[A]);return r.useEffect(()=>{const b=D=>{u.current&&!u.current.contains(D.target)&&l.current&&!l.current.contains(D.target)&&S(!1)};return document.addEventListener("mousedown",b),()=>{document.removeEventListener("mousedown",b)}},[]),r.useEffect(()=>{A(),o(!1)},[s,A]),{searchMode:t,setSearchMode:o,searchQuery:i,searchResults:f,debouncedSearchQuery:d,isSearching:v,showSearchResults:m,setShowSearchResults:S,hasMore:L,isLoadingMore:M,searchInputRef:l,searchResultsRef:u,handleSearchInputChange:y,clearSearch:A,loadMore:g,handleResultClick:P}},or=({activeChannelId:s,onSearchResultClick:t})=>{const o=Ot({activeChannelId:s}),i=o.searchMode,h=o.setSearchMode,d=o.searchQuery,x=o.searchResults,m=o.debouncedSearchQuery,S=o.isSearching,l=o.showSearchResults,u=o.setShowSearchResults,p=o.searchInputRef,R=o.searchResultsRef,f=o.handleSearchInputChange,E=o.clearSearch,L=o.handleResultClick,B=r.useCallback(C=>{t?t(C):L&&L(C)},[t,L]);if(!i)return e.jsx(he,{title:"Поиск сообщений",placement:"top",children:e.jsx(Q,{onClick:()=>{h(!0),requestAnimationFrame(()=>{var C;(C=p.current)==null||C.focus()})},sx:{color:"rgba(255,255,255,0.6)","&:hover":{color:"rgba(255,255,255,0.9)",background:"rgba(255,255,255,0.05)"}},children:e.jsx(ht,{})})});const z=x&&x.length>0,T=l&&d.trim();return e.jsxs(a,{sx:{display:"flex",flexDirection:"column",position:"relative",zIndex:10001},children:[e.jsx(a,{sx:{display:"flex",alignItems:"center",background:"rgba(255,255,255,0.05)",borderRadius:T&&z?"20px 20px 0 0":"20px",border:"1px solid rgba(255,255,255,0.1)",borderBottom:T&&z?"none":"1px solid rgba(255,255,255,0.1)",paddingLeft:2,paddingRight:1,width:"300px",transition:"all 0.3s ease"},children:e.jsx(Me,{initialValues:{query:d},onSubmit:()=>{},enableReinitialize:!0,children:({setFieldValue:C})=>e.jsxs(De,{style:{width:"100%",display:"flex",alignItems:"center"},children:[e.jsx(a,{sx:{display:"flex",alignItems:"center",width:"100%",position:"relative"},children:e.jsx(Re,{name:"query",children:({field:k})=>e.jsx("input",{...k,ref:p,onChange:v=>{k.onChange(v),f(v.target.value)},onFocus:()=>{var v;(v=k.value)!=null&&v.trim()&&z&&u(!0)},placeholder:"Поиск сообщений...",style:{width:"100%",border:"none",outline:"none",background:"transparent",color:"#fff",fontSize:"0.9rem",padding:"8px 0"},onKeyDown:v=>{v.key==="Escape"&&(l?u(!1):E())}})})}),e.jsx(Q,{type:"button",size:"small",onClick:()=>{l?u(!1):(E(),C("query",""))},sx:{color:"rgba(255,255,255,0.5)","&:hover":{color:"rgba(255,255,255,0.9)",background:"rgba(255,255,255,0.1)"}},children:l?e.jsx(Ce,{fontSize:"small"}):e.jsx(ge,{fontSize:"small"})})]})})}),T&&e.jsxs(a,{ref:R,onMouseDown:C=>C.preventDefault(),sx:{position:"absolute",top:"100%",left:0,width:"100%",maxHeight:"300px",background:"rgba(20, 20, 35, 0.98)",border:"1px solid rgba(255,255,255,0.1)",borderTop:"none",borderRadius:"0 0 20px 20px",overflowY:"auto",overflowX:"hidden",zIndex:10002,backdropFilter:"blur(15px)",boxShadow:"0 8px 32px rgba(0,0,0,0.6)","&::-webkit-scrollbar":{width:"6px"},"&::-webkit-scrollbar-track":{background:"rgba(255,255,255,0.1)",borderRadius:"3px"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.3)",borderRadius:"3px","&:hover":{background:"rgba(255,255,255,0.5)"}}},children:[S&&e.jsxs(a,{sx:{p:2,display:"flex",justifyContent:"center",alignItems:"center"},children:[e.jsx(a,{sx:{width:24,height:24,border:"2px solid rgba(255,255,255,0.1)",borderTop:"2px solid #00CFFF",borderRadius:"50%",animation:"spin 1s linear infinite","@keyframes spin":{"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}}}}),e.jsx(O,{sx:{ml:1,color:"rgba(255,255,255,0.7)",fontSize:"0.9rem"},children:"Поиск..."})]}),!S&&x&&x.length===0&&m&&e.jsx(a,{sx:{p:3,textAlign:"center"},children:e.jsxs(O,{sx:{color:"rgba(255,255,255,0.5)",fontSize:"0.9rem"},children:["По запросу ",e.jsx(a,{component:"span",sx:{fontWeight:"bold",color:"#00CFFF"},children:m})," ничего не найдено"]})}),!S&&z&&x.map((C,k)=>e.jsx(Ut,{message:C,searchQuery:m,onResultClick:B},`${C.id}-${k}`))]})]})},nr=({open:s,messageToDelete:t,deleteForEveryone:o,canManageMessages:i,messages:h,userId:d,onClose:x,onConfirm:m,onDeleteForEveryoneChange:S})=>{const l=t?h.find(R=>R.id===t):null,p=l&&l.author.id===d||i;return e.jsx(gt,{open:s,onClose:x,title:"Удалить сообщение",children:e.jsxs(a,{sx:{p:2,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:[t&&e.jsxs(a,{sx:{mb:3,width:"100%",maxWidth:300},children:[p&&e.jsxs(a,{onClick:()=>S(!o),sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:1.5,mb:1.5,borderRadius:2,cursor:"pointer",backgroundColor:o?"rgba(255, 61, 113, 0.1)":"rgba(0,0,0,0.15)",border:`1px solid ${o?"rgba(255, 61, 113, 0.3)":"rgba(255,255,255,0.1)"}`,transition:"all 0.2s ease","&:hover":{backgroundColor:o?"rgba(255, 61, 113, 0.15)":"rgba(0,0,0,0.2)",transform:"translateY(-2px)"}},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",mb:.5},children:[e.jsx(ft,{checked:o,onChange:R=>S(R.target.checked),sx:{color:"rgba(255,255,255,0.5)",p:.5,mr:1,"&.Mui-checked":{color:"#FF3D71"}}}),e.jsx(O,{sx:{fontWeight:500,fontSize:"0.9rem"},children:"Удалить у всех"})]}),e.jsx(O,{variant:"body2",sx:{color:"rgba(255,255,255,0.6)",fontStyle:"italic",fontSize:"0.75rem",textAlign:"center"},children:o?"Сообщение исчезнет у всех участников чата":"Сообщение останется видимым для других"})]}),e.jsx(O,{sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.75rem",textAlign:"center",mt:1},children:p?o?"":"Сообщение будет скрыто только в вашем интерфейсе":"Сообщение будет скрыто только для вас"})]}),e.jsxs(a,{sx:{display:"flex",gap:2,justifyContent:"center"},children:[e.jsx(Te,{variant:"outlined",onClick:x,sx:{color:"rgba(255,255,255,0.7)",borderColor:"rgba(255,255,255,0.2)",borderRadius:2,px:3,"&:hover":{borderColor:"rgba(255,255,255,0.4)",backgroundColor:"rgba(255,255,255,0.05)"}},children:"Отмена"}),e.jsx(Te,{variant:"contained",onClick:m,sx:{backgroundColor:"#FF3D71",color:"#fff",borderRadius:2,px:3,"&:hover":{backgroundColor:"#FF1744"}},children:"Удалить"})]})]})})},ar=({showScrollButton:s,newMessagesCount:t,unreadCount:o,replyingToMessage:i,onScrollToBottom:h})=>{const d=i?160:100;return e.jsxs(e.Fragment,{children:[e.jsx(ve,{in:s,children:e.jsx(Q,{onClick:h,sx:{position:"absolute",bottom:d,right:20,backgroundColor:"rgba(30,30,47,0.95)",backdropFilter:"blur(8px)",border:"1px solid rgba(255,255,255,0.1)",boxShadow:"0 4px 12px rgba(0,0,0,0.2)","&:hover":{backgroundColor:"rgba(40,40,57,0.95)"},zIndex:1e3,transition:"bottom 0.2s ease-out"},children:e.jsx(Ce,{sx:{color:"#fff"}})})}),e.jsx(ve,{in:t>0||o>0,children:e.jsx(a,{sx:{position:"absolute",bottom:d,left:"50%",transform:"translateX(-50%)",zIndex:1e3,transition:"bottom 0.2s ease-out"},children:e.jsxs(xe,{sx:{backgroundColor:"#FF69B4",color:"#fff",px:2,py:1,borderRadius:"20px",cursor:"pointer",boxShadow:"0 4px 12px rgba(255,105,180,0.2)",display:"flex",alignItems:"center",gap:1,"&:hover":{backgroundColor:"#FF1493"}},onClick:h,children:[e.jsx(Ce,{}),e.jsxs(O,{variant:"body2",sx:{fontWeight:600},children:[t||o," ",(t||o)===1?"новое сообщение":"новых сообщений"]})]})})})]})},Ht=G(Ve)({"& .MuiBackdrop-root":{backgroundColor:"rgba(0, 0, 0, 0.8)",backdropFilter:"blur(8px)"},"& .MuiDialog-paper":{backgroundColor:"rgba(30, 30, 47, 0.95)",backdropFilter:"blur(10px)",borderRadius:"16px",border:"1px solid rgba(255, 255, 255, 0.1)",maxWidth:"70vw",maxHeight:"70vh",margin:"auto",overflow:"hidden"}}),Pt=G("div")({position:"relative",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",userSelect:"none",padding:"20px"}),Nt=G("img")({width:"100%",height:"calc(70vh - 120px)",objectFit:"contain",borderRadius:"12px",filter:"drop-shadow(0 8px 32px rgba(0,0,0,0.8))",transition:"transform 0.2s ease","&:hover":{transform:"scale(1.01)"}}),Be=G(Q)(({theme:s})=>({position:"absolute",top:"50%",transform:"translateY(-50%)",width:56,height:56,backgroundColor:"rgba(0, 0, 0, 0.6)",border:`1px solid ${K.primary}30`,color:K.text.primary,transition:"all 0.2s ease","&:hover":{backgroundColor:`${K.primary}20`,borderColor:`${K.primary}60`,transform:"translateY(-50%) scale(1.1)",boxShadow:`0 0 20px ${K.primary}40`},"&:active":{transform:"translateY(-50%) scale(0.95)"}})),qt=G(Q)({position:"absolute",top:20,right:20,width:48,height:48,backgroundColor:"rgba(0, 0, 0, 0.6)",border:"1px solid rgba(255, 61, 113, 0.3)",color:K.text.primary,transition:"all 0.2s ease","&:hover":{backgroundColor:"rgba(255, 61, 113, 0.2)",borderColor:"rgba(255, 61, 113, 0.6)",transform:"scale(1.1) rotate(90deg)",boxShadow:"0 0 20px rgba(255, 61, 113, 0.4)"}}),Vt=G(a)({position:"absolute",bottom:24,left:"50%",transform:"translateX(-50%)",padding:"8px 16px",backgroundColor:"rgba(0, 0, 0, 0.7)",border:`1px solid ${K.primary}30`,borderRadius:"20px",color:K.text.primary,fontSize:"14px",fontWeight:600,backdropFilter:"blur(10px)"}),Yt=G(a)({position:"absolute",bottom:60,left:"50%",transform:"translateX(-50%)",display:"flex",gap:"8px",alignItems:"center"}),Kt=G("button")(({active:s})=>({width:s?24:8,height:8,border:"none",borderRadius:"4px",backgroundColor:s?K.primary:"rgba(255, 255, 255, 0.3)",cursor:"pointer",transition:"all 0.2s ease","&:hover":{backgroundColor:s?K.primary:"rgba(255, 255, 255, 0.5)",transform:"scale(1.2)"}})),Qt=({open:s,images:t,currentIndex:o,onClose:i,onNavigate:h})=>{const d=r.useMemo(()=>t[o],[t,o]),x=r.useCallback(()=>{o>0&&h(o-1)},[o,h]),m=r.useCallback(()=>{o<t.length-1&&h(o+1)},[o,t.length,h]),S=r.useCallback(l=>{switch(l.key){case"Escape":i();break;case"ArrowLeft":x();break;case"ArrowRight":m();break}},[i,x,m]);return d?e.jsx(Ht,{open:s,onClose:i,onKeyDown:S,children:e.jsxs(Pt,{onClick:i,children:[e.jsx(Nt,{src:d.preview,alt:"Preview",onClick:l=>l.stopPropagation(),draggable:!1}),o>0&&e.jsx(Be,{onClick:l=>{l.stopPropagation(),x()},style:{left:32},children:e.jsx(Qe,{})}),o<t.length-1&&e.jsx(Be,{onClick:l=>{l.stopPropagation(),m()},style:{right:32},children:e.jsx(Ge,{})}),e.jsx(qt,{onClick:l=>{l.stopPropagation(),i()},children:e.jsx(ge,{})}),t.length>1&&e.jsxs(e.Fragment,{children:[e.jsxs(Vt,{children:[o+1," / ",t.length]}),e.jsx(Yt,{children:t.map((l,u)=>e.jsx(Kt,{active:u===o,onClick:p=>{p.stopPropagation(),h(u)}},u))})]})]})}):null},Gt=Pe().shape({content:Ne().max(2e3,"Message is too long").test("content-or-images","Message cannot be empty",function(){return!0})}),_e=15*1024*1024,ne=5,$e=["image/jpeg","image/jpg","image/png","image/gif","image/webp"],Xt=({activeChannel:s,canSendMessages:t,sending:o,replyingToMessage:i,onSendMessage:h,onReplyCancel:d,onReplyClick:x})=>{var v;const m=r.useRef(null),S=r.useRef(null),l=r.useRef(null),[u,p]=r.useState([]),[R,f]=r.useState(null);r.useEffect(()=>{if(s&&m.current){m.current.focus();const n=m.current.value.length;m.current.setSelectionRange(n,n)}},[s]),r.useEffect(()=>{if(i&&m.current){m.current.focus();const n=m.current.value.length;m.current.setSelectionRange(n,n)}},[i]),r.useEffect(()=>{const n=c=>{c.key==="Escape"&&i&&d()};return document.addEventListener("keydown",n),()=>{document.removeEventListener("keydown",n)}},[i,d]),r.useEffect(()=>{const n=y=>{if(!y.clipboardData)return;const M=Array.from(y.clipboardData.items).filter(P=>P.type.startsWith("image/"));if(M.length===0||u.length>=ne)return;y.preventDefault();const A=[];M.slice(0,ne-u.length).forEach(P=>{const b=P.getAsFile();if(!b)return;if(u.some(Z=>Z.file.size===b.size&&Z.file.type===b.type&&Z.file.lastModified===b.lastModified)){console.log("Duplicate image detected, skipping");return}const w=new Date().getTime(),_=Math.random().toString(36).substring(2,8),I=b.type.split("/")[1]||"png",j=new File([b],`pasted-image-${w}-${_}.${I}`,{type:b.type,lastModified:b.lastModified||Date.now()}),U=$e.includes(j.type),Y=j.size<=_e,X={file:j,preview:URL.createObjectURL(j),valid:U&&Y,error:U?Y?void 0:"Файл слишком большой (макс. 15MB)":"Неподдерживаемый формат файла"};A.push(X)}),A.length>0&&p(P=>[...P,...A])},c=m.current;if(c)return c.addEventListener("paste",n),()=>{c.removeEventListener("paste",n)}},[u.length]),r.useEffect(()=>()=>{u.forEach(n=>URL.revokeObjectURL(n.preview))},[u]);const E=()=>{i&&x&&x(i.id)},L=n=>{var y;if(n.content&&n.content.trim())return B(n.content);const c=((y=n.attachments)==null?void 0:y.length)||0;return c>0?c===1?"📎 Вложение":c>=2&&c<=4?`📎 ${c} вложения`:`📎 ${c} вложений`:"📎 Вложение"},B=n=>n.length>150?!(n.indexOf(" ")!==-1)&&n.length>100?n.substring(0,100)+"...":n.substring(0,150)+"...":n,z=n=>{if(!n.target.files||!n.target.files.length)return;const c=Array.from(n.target.files);if(S.current&&(S.current.value=""),u.length>=ne)return;const y=[];c.slice(0,ne-u.length).forEach(g=>{if(u.some(D=>D.file.size===g.size&&D.file.type===g.type&&D.file.name===g.name&&D.file.lastModified===g.lastModified)){console.log("Duplicate file detected, skipping:",g.name);return}const A=$e.includes(g.type),P=g.size<=_e,b={file:g,preview:URL.createObjectURL(g),valid:A&&P,error:A?P?void 0:"Файл слишком большой (макс. 15MB)":"Неподдерживаемый формат файла"};y.push(b)}),y.length>0&&p(g=>[...g,...y])},T=n=>{p(c=>{const y=[...c];return URL.revokeObjectURL(y[n].preview),y.splice(n,1),y})},C=()=>{S.current&&S.current.click()},k=n=>{f(n)};return e.jsxs(a,{sx:{p:2},children:[t?e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:1},children:[i&&e.jsxs(xe,{sx:{p:"8px 16px",display:"flex",alignItems:"flex-start",gap:1,background:"rgba(30,30,47,0.95)",border:"1px solid rgba(149,128,255,0.25)",borderRadius:2,position:"relative",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",mb:1,pl:3,width:"100%"},children:[e.jsx(a,{sx:{position:"absolute",left:0,top:0,bottom:0,width:"4px",backgroundColor:"#00CFFF",borderTopLeftRadius:2,borderBottomLeftRadius:2}}),e.jsxs(a,{sx:{flex:1,cursor:"pointer"},onClick:E,children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(Ke,{sx:{color:"#00CFFF",fontSize:"0.9rem"}}),e.jsxs(O,{variant:"caption",sx:{color:"#00CFFF",fontWeight:600,display:"flex",alignItems:"center"},children:["Ответ ",(v=i.author)!=null&&v.login?`@${i.author.login}`:""]})]}),e.jsx(O,{variant:"body2",sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.85rem",lineHeight:1.4,wordBreak:"break-word"},children:L(i)})]}),e.jsx(Q,{size:"small",onClick:d,sx:{color:"rgba(255,255,255,0.5)","&:hover":{color:"rgba(255,255,255,0.8)"}},children:e.jsx(ge,{fontSize:"small"})})]}),u.length>0&&e.jsxs(xe,{sx:{p:2,background:"rgba(30,30,47,0.95)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:2,mb:1},children:[e.jsx(a,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:u.map((n,c)=>e.jsx(a,{sx:{width:{xs:"calc(33.33% - 8px)",sm:"calc(25% - 8px)",md:"calc(16.66% - 8px)"}},children:e.jsxs(a,{sx:{position:"relative",height:100,borderRadius:1,overflow:"hidden",border:n.valid?"1px solid rgba(255,255,255,0.1)":"1px solid #f44336","&:hover .image-remove-btn":{opacity:1}},children:[e.jsx(a,{component:"img",src:n.preview,alt:"Preview",onClick:()=>k(c),sx:{width:"100%",height:"100%",objectFit:"cover",cursor:"pointer"}}),!n.valid&&e.jsx(he,{title:n.error||"Invalid image",children:e.jsx(a,{sx:{position:"absolute",top:5,left:5,bgcolor:"rgba(0,0,0,0.7)",borderRadius:"50%",width:24,height:24,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(jt,{sx:{color:"#f44336",fontSize:"16px"}})})}),e.jsx(Q,{className:"image-remove-btn",size:"small",onClick:()=>T(c),sx:{position:"absolute",top:5,right:5,bgcolor:"rgba(0,0,0,0.7)",color:"white",p:"4px",opacity:0,transition:"opacity 0.2s","&:hover":{bgcolor:"rgba(0,0,0,0.85)"}},children:e.jsx(ge,{sx:{fontSize:"16px"}})})]})},c))}),e.jsxs(a,{sx:{mt:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(O,{variant:"caption",sx:{color:"rgba(255,255,255,0.7)"},children:[u.length," / ",ne," изображений"]}),u.length>1&&e.jsx(O,{variant:"caption",onClick:()=>{u.forEach(n=>URL.revokeObjectURL(n.preview)),p([])},sx:{color:"#1976D2",cursor:"pointer","&:hover":{textDecoration:"underline"}},children:"Очистить все"})]})]}),e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",multiple:!0,ref:S,onChange:z,style:{display:"none"},max:ne.toString()}),e.jsx(xe,{sx:{p:"8px 16px",display:"flex",alignItems:"center",gap:1,background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:3},children:e.jsx(Me,{innerRef:l,initialValues:{content:""},validationSchema:Gt,onSubmit:async(n,c)=>{const y=u.filter(g=>g.valid).map(g=>g.file);try{await h({content:n.content,images:y.length>0?y:void 0},c),u.forEach(g=>URL.revokeObjectURL(g.preview)),p([])}catch(g){console.error("Error sending message:",g)}},children:({handleSubmit:n,values:c})=>e.jsxs(e.Fragment,{children:[e.jsx(De,{style:{width:"100%"},children:e.jsx(Re,{name:"content",component:Ye,placeholder:"Type a message...",multiline:!0,maxRows:4,size:"small",disabled:!s||o,inputRef:m,sx:{"& .MuiOutlinedInput-root":{"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"},"& .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"}}},onKeyDown:y=>{y.key==="Enter"&&!y.shiftKey&&(y.preventDefault(),n())}})}),e.jsxs(xt,{direction:"row",spacing:1,children:[e.jsx(he,{title:u.length>=ne?`Максимум ${ne} изображений`:"Прикрепить изображения",children:e.jsxs(a,{children:["  ",e.jsx(Q,{size:"small",sx:{color:u.length>=ne?"rgba(255,255,255,0.3)":"#1E90FF"},onClick:C,disabled:u.length>=ne,children:e.jsx(kt,{})})]})}),e.jsx(Q,{size:"small",sx:{color:c.content||u.length>0?"#1976D2":"rgba(255,255,255,0.3)",transition:"color 0.25s cubic-bezier(.4,0,.2,1)","&:hover":{color:c.content||u.length>0?"#1976D2":"rgba(255,255,255,0.3)"}},onClick:()=>n(),disabled:o||!c.content&&u.length===0,children:e.jsx(Xe,{})})]})]})})})]}):e.jsx(xe,{sx:{p:"12px 16px",display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:3},children:e.jsx(O,{sx:{color:"rgba(255,255,255,0.5)",fontSize:"0.9rem"},children:"Недостаточно прав для отправки сообщений"})}),e.jsx(Qt,{open:R!==null,images:u,currentIndex:R||0,onClose:()=>f(null),onNavigate:f})]})},ir=({activeChannel:s,canSendMessages:t,sending:o,replyingToMessage:i,onSendMessage:h,onReplyCancel:d,onReplyClick:x})=>e.jsx(Xt,{activeChannel:s,canSendMessages:t,sending:o,replyingToMessage:i,onSendMessage:h,onReplyCancel:d,onReplyClick:x}),lr=()=>{const[s,t]=r.useState(null),[o,i]=r.useState(null),[h,d]=r.useState(!0),[x,m]=r.useState(!0),[S,l]=r.useState(!1),[u,p]=r.useState("initial"),[R,f]=r.useState(!1),[E,L]=r.useState(!1),[B,z]=r.useState(null),T=r.useRef(!1),C=r.useRef(null),k=r.useRef(null),v=r.useRef(null),n=r.useRef(!1),c=r.useRef(!1),y=r.useRef(null),g=r.useRef(null),M=r.useCallback(U=>{v.current&&(clearTimeout(v.current),v.current=null),T.current=U,U&&(v.current=setTimeout(()=>{console.warn("[Pagination] Loading timeout - resetting loading state after 10 seconds"),T.current=!1,p(null),v.current=null},1e4))},[]),A=r.useCallback((U,Y,X)=>{if(E)return;if(!(T.current||u==="initial"||u==="around"||!n.current)){if(U.scrollTop/U.scrollHeight<.2&&h){if(y.current!==null&&y.current<X){console.log("[useMessagePagination] Skipping before pagination - previous request returned fewer messages than page size:",{lastMessageCount:y.current,messagesPerPage:X});return}M(!0),p("pagination");const q=[...Y].sort((te,ie)=>new Date(te.created_at).getTime()-new Date(ie.created_at).getTime())[0];q&&C.current!==q.id?(console.log("[useMessagePagination] Setting beforeId for pagination:",{oldestMessageId:q.id,previousBeforeId:C.current,messagesCount:Y.length}),t(q.id),C.current=q.id,i(null),k.current=null,f(!1)):q&&(console.log("[useMessagePagination] Duplicate before request detected, skipping:",{oldestMessageId:q.id,lastBeforeId:C.current}),M(!1),p(null))}if(S&&!c.current&&x&&Y.length>=X){if(g.current!==null&&g.current<X){console.log("[useMessagePagination] Skipping after pagination - previous request returned fewer messages than page size:",{lastAfterMessageCount:g.current,messagesPerPage:X});return}if(U.scrollHeight-U.scrollTop-U.clientHeight<100){M(!0),p("pagination");const q=[...Y].sort((ie,Se)=>new Date(ie.created_at).getTime()-new Date(Se.created_at).getTime()),te=q[q.length-1];te&&k.current!==te.id?(i(te.id),k.current=te.id,t(null),C.current=null,f(!1),c.current=!0):te&&(M(!1),p(null))}}}},[E,u,h,x,S,M]),P=r.useCallback(()=>{t(null),i(null),d(!0),m(!0),l(!1),p("initial"),f(!1),L(!1),z(null),M(!1),C.current=null,k.current=null,n.current=!1,c.current=!1,y.current=null,g.current=null},[M]),b=r.useCallback(U=>{L(!0),z(U),p("around"),f(!0),t(null),i(null),C.current=null,k.current=null,M(!1)},[M]),D=r.useCallback(U=>{n.current=U},[]),w=r.useCallback(()=>{c.current=!1},[]),_=r.useCallback((U,Y)=>{Y==="before"?y.current=U:Y==="after"?g.current=U:Y==="initial"&&(y.current=U,g.current=U),console.log("[useMessagePagination] Updated message count tracking:",{direction:Y,count:U,beforeCount:y.current,afterCount:g.current})},[]);r.useEffect(()=>()=>{v.current&&clearTimeout(v.current)},[]);const I=r.useMemo(()=>({beforeId:s,afterId:o,hasMoreMessages:h,hasMoreMessagesAfter:x,enableAfterPagination:S,loadingMode:u,skipMainQuery:R,isJumpingToMessage:E,aroundMessageId:B}),[s,o,h,x,S,u,R,E,B]),j=r.useMemo(()=>({setBeforeId:t,setAfterId:i,setHasMoreMessages:d,setHasMoreMessagesAfter:m,setEnableAfterPagination:l,setLoadingMode:p,setSkipMainQuery:f,setIsJumpingToMessage:L,setAroundMessageId:z,handleScrollPagination:A,resetPagination:P,jumpToMessage:b,setInitialLoadComplete:D,clearAfterPaginationCooldown:w,updateLastRequestMessageCount:_}),[A,P,b,D,w,_]);return{state:I,actions:j,isLoadingMoreRef:T,lastBeforeIdRef:C,lastAfterIdRef:k,setLoadingWithTimeout:M}},cr=({activeChannel:s})=>{const t=r.useRef(new Set),o=r.useCallback(d=>{t.current.add(d)},[]),i=r.useCallback(d=>{s&&t.current.add(d)},[s]),h=r.useCallback(()=>{s&&fe.publish(`/app/v1/channels/${s.id}/messages/bulk-read-all`,{})},[s]);return r.useEffect(()=>{if(!s)return;const d=()=>{if(t.current.size>0){const m=Array.from(t.current);fe.publish(`/app/v1/channels/${s.id}/messages/bulk-read`,{messageIds:m}),t.current.clear()}},x=setInterval(d,1e3);return()=>{clearInterval(x),d()}},[s]),{unreadMessagesBufferRef:t,markMessageAsRead:i,markAllMessagesAsRead:h,addToReadBuffer:o}},dr=({messagesContainerRef:s,messages:t,activeChannel:o,onMarkAllAsRead:i,bulkReadAllRef:h,paginationActions:d,messagesPerPage:x=20})=>{const[m,S]=r.useState(!0),[l,u]=r.useState(!1),[p,R]=r.useState(!1),[f,E]=r.useState(null),[L,B]=r.useState(!1),[z,T]=r.useState(!1),C=r.useRef(null),k=r.useRef(null),v=r.useRef(0),n=r.useRef(0),c=r.useRef(0),y=r.useRef(!1),g=r.useCallback(()=>{const b=s.current;b&&(v.current=b.scrollHeight,n.current=b.scrollTop)},[s]),M=r.useCallback((b=!1)=>{if(!s.current||L)return;const D=s.current;requestAnimationFrame(()=>{if(b||z){const w=D.style.scrollBehavior;D.style.scrollBehavior="auto",D.scrollTop=D.scrollHeight,D.style.scrollBehavior=w}else D.scrollTop=D.scrollHeight;u(!1),setTimeout(()=>{D.scrollTop<D.scrollHeight-D.clientHeight-100&&(D.scrollTop=D.scrollHeight)},100)})},[L,z,s]),A=r.useCallback(b=>{if(!s.current)return;const D=document.getElementById(`message-${b}`);if(!D)return;B(!0);const w=s.current,_=D.offsetTop,I=D.offsetHeight,j=w.clientHeight,U=_-j/2+I/2;w.scrollTop=Math.max(0,U),D.style.transition="background-color 0.3s ease-in-out",D.style.backgroundColor="rgba(0, 207, 255, 0.1)",k.current&&clearTimeout(k.current),k.current=setTimeout(()=>{D&&(D.style.backgroundColor=""),B(!1),w.scrollTop+w.clientHeight>=w.scrollHeight-20&&M()},2e3)},[s,M]),P=b=>{const D=new Date(b),w=new Date,_=new Date(w);if(_.setDate(_.getDate()-1),D.toDateString()===w.toDateString())return"Сегодня";if(D.toDateString()===_.toDateString())return"Вчера";const I=D.getFullYear()===w.getFullYear(),j=D.toLocaleDateString([],{weekday:"long",day:"numeric",month:"long",...I?{}:{year:"numeric"}});return j.charAt(0).toUpperCase()+j.slice(1)};return r.useEffect(()=>{const b=s.current;if(!b)return;let D=b.scrollTop,w=null,_=0;const I=()=>{y.current||(y.current=!0,requestAnimationFrame(()=>{w&&clearTimeout(w);const j=b.scrollTop,Y=b.scrollHeight-j-b.clientHeight<100;if(j<D)d&&x&&d.handleScrollPagination(b,t,x);else if(j>D&&Y&&!m){S(!0);const ee=Date.now();i&&(h!=null&&h.current)&&ee-_>1e3&&ee-h.current>1e3&&(_=ee,h.current=ee,i())}D=j,S(Y),u(b.scrollTop+b.clientHeight<b.scrollHeight-400),C.current&&clearTimeout(C.current);const X=b.querySelectorAll(".message-item");let Z=null;if(X.length>0)for(const ee of X){const ae=ee.getBoundingClientRect(),q=b.getBoundingClientRect();if(ae.bottom>q.top&&ae.top<q.bottom){const ie=ee.getAttribute("data-date");if(ie){Z=P(ie);break}}}Z?(E(Z),R(!0),C.current=setTimeout(()=>{R(!1)},1e3)):R(!1),w=setTimeout(()=>{w=null},150),y.current=!1}))};return b.addEventListener("scroll",I),()=>{b.removeEventListener("scroll",I),C.current&&clearTimeout(C.current),w&&clearTimeout(w)}},[o,t,s,i,h,d,x]),r.useEffect(()=>{const b=s.current;if(!b)return;const D=t.length,w=c.current;if(D>w&&w>0){const _=b.scrollHeight-v.current;if(_>0){const I=n.current+_;b.scrollTop=I}}c.current=D,v.current=b.scrollHeight,n.current=b.scrollTop},[t.length,s]),r.useEffect(()=>()=>{k.current&&clearTimeout(k.current),C.current&&clearTimeout(C.current)},[]),{isScrolledToBottom:m,setIsScrolledToBottom:S,showScrollButton:l,setShowScrollButton:u,showDateLabel:p,setShowDateLabel:R,currentDateLabel:f,setCurrentDateLabel:E,disableAutoScroll:L,setDisableAutoScroll:B,scrollToBottom:M,scrollToMessage:A,prepareScrollCorrection:g,setDisableSmoothScroll:T}},ur=({channelId:s,onSearchResultClick:t})=>{const[o,i]=r.useState(!1),[h,d]=r.useState(""),[x,m]=r.useState(""),[S,l]=r.useState(!1),[u,p]=r.useState(new Set),[R,f]=r.useState(null),[E,L]=r.useState(void 0),[B,z]=r.useState([]),[T,C]=r.useState(!0),k=r.useRef(null),v=r.useRef(null),n=r.useRef(null),c={channelId:s??0,search:x,size:20,...E&&{beforeId:E}},y=!s||!x||!o,{data:g,isLoading:M,isFetching:A}=qe(c,{skip:y,refetchOnMountOrArgChange:!0}),P=A&&E!==void 0,b=r.useCallback(I=>{d(I),n.current&&clearTimeout(n.current),L(void 0),z([]),C(!0),n.current=setTimeout(()=>{m(I),I.trim()&&l(!0)},300)},[]),D=r.useCallback(I=>{i(!1),d(""),m(""),l(!1),p(new Set),f(null),t(I.id)},[t]),w=r.useCallback(()=>{i(!1),d(""),m(""),l(!1),p(new Set),f(null),L(void 0),z([]),C(!0)},[]),_=r.useCallback(()=>{if(T&&!P&&B.length>0){const I=B[B.length-1];console.log("Loading more, last message id:",I.id,"hasMore:",T),L(I.id)}},[T,P,B]);return r.useEffect(()=>{g?(z(E?I=>{const j=new Set(I.map(Y=>Y.id)),U=g.filter(Y=>!j.has(Y.id));return U.length===0&&C(!1),[...I,...U]}:g),C(g.length===20)):x||z([])},[g,E,x]),r.useEffect(()=>{o||(d(""),m(""),l(!1),L(void 0),z([]),C(!0))},[o]),r.useEffect(()=>{const I=j=>{S&&v.current&&k.current&&!v.current.contains(j.target)&&!k.current.contains(j.target)&&l(!1)};return document.addEventListener("mousedown",I),()=>{document.removeEventListener("mousedown",I)}},[S]),r.useEffect(()=>()=>{n.current&&clearTimeout(n.current)},[]),{searchMode:o,setSearchMode:i,searchQuery:h,setSearchQuery:d,debouncedSearchQuery:x,showSearchResults:S,setShowSearchResults:l,searchInputRef:k,searchResultsRef:v,highlightedMessages:u,setHighlightedMessages:p,focusedMessageId:R,setFocusedMessageId:f,searchResults:B,isSearching:M&&E===void 0,handleSearchInputChange:b,handleSearchResultClick:D,clearSearch:w,loadMore:_,hasMore:T,isLoadingMore:P}},We=(s,t)=>{const o=r.useCallback(t,[t]);r.useEffect(()=>{if(!s)return;let i=!0;return i&&(async()=>{try{await fe.subscribe(s,o)}catch(d){console.error("Failed to setup WebSocket subscription:",d)}})(),()=>{i=!1,fe.unsubscribe(s,o)}},[s,o])};var pe=(s=>(s[s.SENT=0]="SENT",s[s.READ=1]="READ",s[s.NEW=2]="NEW",s))(pe||{});const pr=(s,t,o,i)=>{const h=r.useRef(0),d=r.useRef(o),x=r.useRef(i);r.useEffect(()=>{d.current=o},[o]),r.useEffect(()=>{x.current=i},[i]);const m=r.useCallback(()=>{if(!s)return;const l=Date.now();l-h.current>1e3&&l-x.current.bulkReadAllRef.current>1e3&&(h.current=l,x.current.bulkReadAllRef.current=l,fe.publish(`/app/v1/channels/${s.id}/messages/bulk-read-all`,{}),d.current.onMarkAllAsRead())},[s==null?void 0:s.id]),S=r.useCallback(l=>{const u=x.current,p=d.current;if(l.type==="MESSAGE_CREATE"&&l.message){const R=u.convertToExtendedMessage(l.message);if(R.author.id===(t==null?void 0:t.id))return;p.onMessageCreate(R),p.onHighlightMessage(R.id,1500),R.status===pe.NEW&&requestAnimationFrame(()=>{const f=u.messagesContainerRef.current;if(f){const E=f.scrollHeight-f.scrollTop-f.clientHeight,L=E<100,B=E>300;L&&s?(u.addToReadBuffer(R.id),p.onMarkMessageAsRead(R.id),u.loadingMode!=="around"&&!u.isJumpingToMessage&&p.onScrollToBottom(),m()):B?(p.onNewMessageIndicator(!0),p.onUnreadMessage(R.id),setTimeout(()=>{const z=document.querySelector(`[data-msg-id="${R.id}"]`);if(z){const T=z.getBoundingClientRect();T.top>=0&&T.bottom<=window.innerHeight&&s&&(u.addToReadBuffer(R.id),p.onMarkMessageAsRead(R.id))}},100)):(u.addToReadBuffer(R.id),p.onMarkMessageAsRead(R.id),u.loadingMode!=="around"&&!u.isJumpingToMessage&&p.onScrollToBottom(),m())}})}else if(l.type==="MESSAGE_UPDATE"&&l.message){const R=u.convertToExtendedMessage(l.message);p.onMessageUpdate(R),R.status===pe.READ&&p.onUnreadCountChange(-1)}else l.type==="MESSAGE_DELETE"&&l.messageId?(p.onMessageDelete(l.messageId),p.onUnreadCountChange(-1)):l.type==="MESSAGE_READ_STATUS"&&l.message_range&&p.onMessageReadStatus(l.message_range)},[t==null?void 0:t.id,s==null?void 0:s.id,m]);return We(s&&t?`/v1/user/${t.id}/queue/channels/${s.id}/messages`:null,S),We(s?`/v1/topic/channels/${s.id}/messages`:null,S),{}},hr=()=>{const[s,t]=r.useState([]),[o,i]=r.useState(new Map),[h,d]=r.useState(new Set),[x,m]=r.useState(0),[S,l]=r.useState(0),u=r.useCallback(n=>({...n,status:"status"in n?n.status:pe.SENT,reply:n.reply?{...n.reply,status:"status"in n.reply?n.reply.status:pe.SENT}:null}),[]),p=r.useCallback(()=>{t([]),i(new Map),d(new Set),m(0),l(0)},[]),R=r.useCallback((n,c)=>{t(y=>y.map(g=>g.id===n&&g.author.id!==c?{...g,status:pe.READ}:g))},[]),f=r.useCallback(n=>{t(c=>c.map(y=>y.author.id!==n?{...y,status:pe.READ}:y)),d(new Set),m(0),l(0)},[]),E=r.useCallback((n,c)=>{t(y=>y.map(g=>{if(g.id>=n.from&&g.id<=n.to&&g.author.id===c){const M=g.read_by_count||0;return{...g,read_by_count:M+1}}return g}))},[]),L=r.useCallback(n=>{t(c=>c.some(M=>M.id===n)?c.filter(M=>M.id!==n).map(M=>M.reply&&M.reply.id===n?{...M,reply:void 0}:M):c)},[]),B=r.useCallback(n=>{t(c=>c.some(g=>g.id===n.id)?c.map(g=>g.id===n.id?n:g):c)},[]),z=r.useCallback(n=>{t(c=>c.some(g=>g.id===n.id)?c:[...c,n])},[]),T=r.useCallback(n=>{d(c=>{const y=new Set(c);return y.add(n),y}),m(c=>c+1),l(c=>c+1)},[]),C=r.useCallback(n=>{d(c=>{const y=new Set(c);return y.delete(n),y}),m(c=>Math.max(0,c-1)),l(c=>Math.max(0,c-1))},[]),k=r.useCallback(n=>{m(c=>Math.max(0,c+n)),l(c=>Math.max(0,c+n))},[]),v=r.useCallback(()=>{m(0),l(0)},[]);return{messages:s,setMessages:t,tempMessages:o,setTempMessages:i,unreadMessages:h,setUnreadMessages:d,unreadCount:x,setUnreadCount:m,newMessagesCount:S,setNewMessagesCount:l,convertToExtendedMessage:u,resetMessageStates:p,updateMessageReadStatus:R,markAllMessagesAsReadInState:f,updateMessageReadByCount:E,deleteMessageFromState:L,updateMessageInState:B,addMessageToState:z,addUnreadMessage:T,removeUnreadMessage:C,updateUnreadCount:k,resetUnreadCounts:v}};export{ir as C,nr as D,pe as M,ar as N,or as S,lr as a,cr as b,dr as c,ur as d,pr as e,sr as f,hr as u};
