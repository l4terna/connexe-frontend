var Ze=Object.defineProperty;var et=(o,t,r)=>t in o?Ze(o,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[t]=r;var ye=(o,t,r)=>et(o,typeof t!="symbol"?t+"":t,r);import{f as ee,j as e,r as s,bu as Le,bv as tt,t as le,B as a,aB as Te,ay as pe,a4 as ue,T as L,R as Y,e as de,I as J,U as Be,bw as Ae,g as rt,X as ke,L as _e,Y as ve,b2 as Ce,N as We,bx as st,by as ot,S as nt,W as at,_ as Re,P as he,O as it,bz as xe}from"./index-tyeYGKYQ.js";import{I as Ue}from"./Input-ghVEFCy7.js";import{C as lt}from"./Checkbox-BgAc3lfi.js";const ct=ee(e.jsx("path",{d:"m18 7-1.41-1.41-6.34 6.34 1.41 1.41zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12zM.41 13.41 6 19l1.41-1.41L1.83 12z"})),He=ee(e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11"})),dt=ee(e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"})),ut=ee(e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"})),ie=ee([e.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"},"0"),e.jsx("path",{d:"M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"},"1")]);class gt{constructor(){ye(this,"observer",null);ye(this,"callbacks",new Map);ye(this,"observedElements",new WeakSet)}createObserver(){return this.observer?this.observer:(this.observer=new IntersectionObserver(t=>{t.forEach(r=>{const i=this.callbacks.get(r.target);i&&i(r.isIntersecting)})},{threshold:.1,rootMargin:"100px"}),this.observer)}observe(t,r){if(this.observedElements.has(t))return;const i=this.createObserver();this.callbacks.set(t,r),this.observedElements.add(t),i.observe(t)}unobserve(t){!this.observer||!this.observedElements.has(t)||(this.observer.unobserve(t),this.callbacks.delete(t),this.observedElements.delete(t),this.callbacks.size===0&&(this.observer.disconnect(),this.observer=null))}disconnect(){this.observer&&(this.observer.disconnect(),this.observer=null),this.callbacks.clear()}}const Ee=new gt,ht=o=>{const t=s.useRef(null),r=s.useRef(o);s.useEffect(()=>{r.current=o},[o]);const i=s.useCallback(()=>{const l=t.current;l&&Ee.observe(l,p=>{r.current(p)})},[]),h=s.useCallback(()=>{const l=t.current;l&&Ee.unobserve(l)},[]);return s.useEffect(()=>(i(),h),[i,h]),{elementRef:t}},ae=({storageKey:o,alt:t="",sx:r,className:i,onClick:h,loadingMode:l=null,staggerIndex:p=0})=>{const{getSignedUrl:x,hasSignedUrl:b}=Le(),w=tt(m=>m.user.currentUser),[S,j]=s.useState(!0),[B,y]=s.useState(!1),[I,_]=s.useState(!1),[A,v]=s.useState(!1),$=s.useCallback(m=>{if(m&&!I){_(!0);const n=Math.min(p*50,500);setTimeout(()=>{v(!0)},n)}},[I,p]),{elementRef:E}=ht($);if(!w)return e.jsx(le,{ref:E,variant:"rectangular",className:i,sx:{width:"100%",height:"100%",bgcolor:"rgba(255,255,255,0.05)",cursor:h?"pointer":"default",...r}});const k=A?x(o,w.id):null;return!A||!k||!b(o)?e.jsx(le,{ref:E,variant:"rectangular",className:i,sx:{width:"100%",height:"100%",bgcolor:"rgba(255,255,255,0.05)",cursor:h?"pointer":"default",...r,"&::after":{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent)",animationDuration:"1.5s"}}}):e.jsxs(a,{ref:E,className:i,onClick:h,sx:{width:"100%",height:"100%",position:"relative",overflow:"hidden",cursor:h?"pointer":"default",...r},children:[S&&e.jsx(le,{variant:"rectangular",sx:{position:"absolute",top:0,left:0,right:0,bottom:0,width:"100%",height:"100%",bgcolor:"rgba(255,255,255,0.05)",zIndex:1,"&::after":{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent)",animationDuration:"1.2s"}}}),B?e.jsx(a,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"rgba(255,255,255,0.05)",color:"rgba(255,255,255,0.3)",fontSize:"2rem",border:"1px dashed rgba(255,255,255,0.1)",borderRadius:"inherit"},children:"❌"}):e.jsx("img",{src:k,alt:t,style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:"inherit",transition:"opacity 0.3s ease"},onLoad:()=>j(!1),onError:()=>{j(!1),y(!0)}})]})},$e=ee(e.jsx("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"})),Pe=ee(e.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"})),pt=({open:o,images:t,currentIndex:r,onClose:i,onNavigate:h})=>(s.useEffect(()=>{const l=p=>{o&&(p.key==="Escape"?i():p.key==="ArrowLeft"&&r>0?h(r-1):p.key==="ArrowRight"&&r<t.length-1&&h(r+1))};return window.addEventListener("keydown",l),()=>window.removeEventListener("keydown",l)},[o,r,t.length,i,h]),e.jsx(Te,{open:o,onClose:i,sx:{display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(20px)",backgroundColor:"rgba(10, 10, 26, 0.85)"},children:e.jsx(pe,{in:o,children:e.jsx(a,{sx:{position:"relative",width:"100vw",height:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, rgba(13,13,26,0.95) 0%, rgba(26,26,46,0.95) 100%)",outline:"none"},onClick:i,children:t[r]&&e.jsxs(e.Fragment,{children:[e.jsx(a,{sx:{position:"relative",maxWidth:"90vw",maxHeight:"90vh",display:"flex",alignItems:"center",justifyContent:"center"},onClick:l=>l.stopPropagation(),children:e.jsx(ae,{storageKey:t[r],alt:"Fullscreen preview",sx:{maxWidth:"100%",maxHeight:"90vh",objectFit:"contain",borderRadius:2,boxShadow:"0 20px 40px rgba(0,0,0,0.4)",width:"auto",height:"auto"}})}),r>0&&e.jsx(a,{onClick:l=>{l.stopPropagation(),h(r-1)},sx:{position:"absolute",left:40,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(-4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx($e,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),r<t.length-1&&e.jsx(a,{onClick:l=>{l.stopPropagation(),h(r+1)},sx:{position:"absolute",right:40,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(Pe,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(a,{onClick:l=>{l.stopPropagation(),i()},sx:{position:"absolute",top:40,right:40,display:"flex",alignItems:"center",justifyContent:"center",width:48,height:48,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.1) 0%, rgba(255, 61, 113, 0.2) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 61, 113, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF3D71 0%, #FF69B4 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"scale(1.1) rotate(90deg)",boxShadow:"0 8px 32px rgba(255, 61, 113, 0.4)",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.2) 0%, rgba(255, 61, 113, 0.3) 100%)","&::before":{opacity:1}}},children:e.jsx(ue,{sx:{fontSize:24,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(a,{sx:{position:"absolute",bottom:40,left:"50%",transform:"translateX(-50%)",display:"flex",gap:1,alignItems:"center"},children:t.map((l,p)=>e.jsx(a,{onClick:x=>{x.stopPropagation(),h(p)},sx:{width:p===r?32:8,height:8,borderRadius:1,bgcolor:p===r?"#FF69B4":"rgba(255, 255, 255, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&:hover":{bgcolor:p===r?"#FF69B4":"rgba(255, 255, 255, 0.5)"}}},p))}),e.jsx(a,{sx:{position:"absolute",top:40,left:40,color:"white",bgcolor:"rgba(30, 30, 47, 0.95)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:2,px:2,py:1},children:e.jsxs(L,{variant:"body2",sx:{opacity:.8},children:[r+1," из ",t.length]})})]})})})})),xt=o=>new Date(o).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),ft=o=>{var r;if(o.content&&o.content.trim())return o.content;const t="attachments_count"in o?o.attachments_count:((r=o.attachments)==null?void 0:r.length)||0;return t>0?t===1?"📎 Вложение":t>=2&&t<=4?`📎 ${t} вложения`:`📎 ${t} вложений`:"📎 Вложение"},Oe=Y.memo(o=>{const{message:t,isFirstInGroup:r=o.isFirstOfGroup||!1,isTempMessage:i=!1,isHighlighted:h=!1,isUnread:l=!1,isFocused:p=!1,isSearchMode:x=!1,searchQuery:b="",currentUserId:w,hubId:S=0,loadingMode:j=null,onReply:B,onEdit:y,onDelete:I,onReplyClick:_,onMouseEnter:A,onMouseLeave:v}=o,[$,E]=s.useState(!1),[k,m]=s.useState(null),[n,c]=s.useState(0),f=t.attachments&&t.attachments.length>0,u=Y.useCallback((M,C)=>{m(M),c(C)},[]),z=Y.useCallback(()=>{t.reply&&_&&_(t.reply.id)},[t.reply,_]),D=Y.useCallback(()=>{t&&B&&B(t)},[t,B]),U=Y.useCallback(()=>{y&&typeof y=="function"&&y(t.id)},[y,t.id]),N=Y.useCallback(()=>{I&&typeof I=="function"&&I(t.id)},[I,t.id]);return e.jsxs(e.Fragment,{children:[e.jsxs(a,{id:`message-${t.id}`,className:"message-item","data-date":t.created_at,"data-msg-id":t.id.toString(),onMouseEnter:M=>{E(!0),A&&A(M,t)},onMouseLeave:M=>{E(!1),v&&v(M)},sx:{contentVisibility:"auto",contain:"layout style paint",display:"flex",gap:2,alignItems:"flex-start",position:"relative",borderRadius:"10px",willChange:"auto",transition:"background-color 0.2s ease",opacity:i?.6:1,mt:r?3:.5,px:1.5,py:.5,backgroundColor:p?"rgba(0, 207, 255, 0.25)":h?"rgba(33, 150, 243, 0.25)":l?"rgba(25,118,210,0.1)":"transparent","&.highlight-pulse":{animation:"pulse 2s infinite"},"&:hover":{backgroundColor:p?"rgba(0, 207, 255, 0.35)":h?"rgba(33, 150, 243, 0.35)":l?"rgba(25,118,210,0.15)":"rgba(255,255,255,0.05)"}},children:[$&&e.jsxs(a,{sx:{position:"absolute",top:-40,left:"50%",transform:"translateX(-50%)",display:"flex",gap:.5,zIndex:1e3,padding:"6px 8px",borderRadius:"20px",background:"rgba(40, 44, 52, 0.95)",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",transition:"all 0.2s ease",opacity:1,animation:"fadeIn 0.2s ease-in-out","@keyframes fadeIn":{from:{opacity:0,transform:"translateX(-50%) translateY(5px)"},to:{opacity:1,transform:"translateX(-50%) translateY(0)"}}},children:[e.jsx(de,{title:"Ответить",enterDelay:1e3,placement:"top",children:e.jsx(J,{size:"small",onClick:D,sx:{color:"#00CFFF",transition:"all 0.2s ease","&:hover":{color:"#E5FBFF",transform:"scale(1.05)"}},children:e.jsx(He,{fontSize:"small"})})}),t.author.id===w&&e.jsxs(e.Fragment,{children:[e.jsx(de,{title:"Редактировать",enterDelay:1e3,placement:"top",children:e.jsx(J,{size:"small",onClick:U,sx:{color:"#00CFFF",transition:"transform 0.15s ease, color 0.15s ease","&:hover":{color:"#E5FBFF",transform:"scale(1.02)"}},children:e.jsx(dt,{fontSize:"small"})})}),e.jsx(de,{title:"Удалить",enterDelay:1e3,placement:"top",children:e.jsx(J,{size:"small",onClick:N,sx:{color:"#FF3D71",transition:"transform 0.15s ease, color 0.15s ease","&:hover":{color:"#FF708D",transform:"scale(1.02)"}},children:e.jsx(ut,{fontSize:"small"})})})]})]}),e.jsx(a,{sx:{width:40,display:"flex",flexDirection:"column",alignItems:"center",mt:1},children:r?e.jsx("div",{style:{cursor:"pointer"},children:e.jsx(Be,{src:t.author.avatar||void 0,alt:t.author.login,userId:t.author.id,hubId:S})}):null}),e.jsxs(a,{sx:{flex:1,position:"relative"},children:[e.jsx(a,{sx:{maxWidth:"99%"},children:e.jsxs(a,{sx:{py:"5px",px:"0px",pl:0},children:[r&&e.jsx(L,{sx:{color:"#00CFFF",fontWeight:700,mb:.5,fontSize:"1rem",letterSpacing:.2},children:t.author.login}),t.reply&&e.jsx(a,{sx:{mb:.8,mt:.25},children:e.jsxs(a,{sx:{display:"flex",flexDirection:"column",borderRadius:"8px",padding:"6px 10px",ml:0,background:"rgba(0, 207, 255, 0.06)",borderLeft:"3px solid #00CFFF",cursor:"pointer",transition:"transform 0.15s ease, color 0.15s ease","&:hover":{background:"rgba(0, 207, 255, 0.1)",transform:"translateX(2px)"}},onClick:z,children:[e.jsx(a,{sx:{display:"flex",alignItems:"center",gap:.5},children:e.jsx(L,{sx:{color:"#00CFFF",fontSize:"0.75rem",fontWeight:"600",letterSpacing:.3},children:t.reply.author.login})}),e.jsx(L,{sx:{color:"rgba(255,255,255,0.6)",fontSize:"0.8rem",mt:.2,lineHeight:1.3,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"400px"},children:ft(t.reply)})]})})]})}),f&&e.jsx(a,{sx:{mt:1.5,mb:1},children:(()=>{var C;const M=((C=t.attachments)==null?void 0:C.length)||0;return M===1?e.jsxs(a,{sx:{position:"relative",borderRadius:3,overflow:"hidden",maxWidth:"450px",height:"300px",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 8px 32px rgba(0,0,0,0.12)",background:"linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"translateY(-2px)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)","& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.02)"}}},onClick:()=>u(t.attachments[0],0),children:[e.jsx(ae,{storageKey:t.attachments[0],className:"attachment-image",alt:"",loadingMode:j,staggerIndex:0,sx:{width:"100%",height:"100%",borderRadius:3,transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(ie,{sx:{color:"white",fontSize:"36px",filter:"drop-shadow(0 2px 8px rgba(0,0,0,0.4))"}})})]}):M===2?e.jsx(a,{sx:{display:"flex",gap:1,maxWidth:"450px"},children:t.attachments.map((d,g)=>e.jsxs(a,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",flex:1,height:"200px",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"translateY(-2px) scale(1.02)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>u(d,g),children:[e.jsx(ae,{loadingMode:j,storageKey:d,className:"attachment-image",alt:"",staggerIndex:g,sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(ie,{sx:{color:"white",fontSize:"28px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(a,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:[g+1,"/",M]})]},g))}):M===3?e.jsxs(a,{sx:{display:"flex",gap:1,maxWidth:"450px",height:"280px"},children:[e.jsxs(a,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",flex:2,cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.01)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>u(t.attachments[0],0),children:[e.jsx(ae,{loadingMode:j,storageKey:t.attachments[0],className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(ie,{sx:{color:"white",fontSize:"32px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(a,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:["1/",M]})]}),e.jsx(a,{sx:{display:"flex",flexDirection:"column",gap:1,flex:1},children:t.attachments.slice(1,3).map((d,g)=>e.jsxs(a,{sx:{position:"relative",borderRadius:2,overflow:"hidden",flex:1,cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.01)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>u(d,g+1),children:[e.jsx(ae,{loadingMode:j,storageKey:d,className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(ie,{sx:{color:"white",fontSize:"24px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(a,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:[g+2,"/",M]})]},g+1))})]}):M===4?e.jsx(a,{sx:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:1,maxWidth:"400px",aspectRatio:"1"},children:t.attachments.map((d,g)=>e.jsxs(a,{sx:{position:"relative",borderRadius:2,overflow:"hidden",aspectRatio:"1",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.03)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.08)"}}},onClick:()=>u(d,g),children:[e.jsx(ae,{loadingMode:j,storageKey:d,className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(ie,{sx:{color:"white",fontSize:"28px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(a,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:[g+1,"/",M]})]},g))}):M>=5?e.jsxs(a,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:1,maxWidth:"450px",aspectRatio:"3/2"},children:[e.jsxs(a,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",gridColumn:"span 2",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.01)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>u(t.attachments[0],0),children:[e.jsx(ae,{loadingMode:j,storageKey:t.attachments[0],className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(ie,{sx:{color:"white",fontSize:"32px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(a,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:["1/",M]})]}),e.jsx(a,{sx:{display:"flex",flexDirection:"column",gap:1},children:t.attachments.slice(1,3).map((d,g)=>e.jsxs(a,{sx:{position:"relative",borderRadius:2,overflow:"hidden",flex:1,cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.03)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>u(d,g+1),children:[e.jsx(ae,{loadingMode:j,storageKey:d,className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:g===1&&M>3?e.jsxs(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:.5},children:[e.jsxs(L,{sx:{color:"white",fontSize:"1.2rem",fontWeight:700,textShadow:"0 2px 8px rgba(0,0,0,0.8)"},children:["+",M-3]}),e.jsx(L,{sx:{color:"white",fontSize:"0.75rem",fontWeight:500,textShadow:"0 1px 4px rgba(0,0,0,0.8)",opacity:.9},children:"ещё"})]}):e.jsx(ie,{sx:{color:"white",fontSize:"20px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(a,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:[g+2,"/",M]})]},g+1))})]}):null})()}),e.jsxs(a,{sx:{display:"flex",flexDirection:"column",position:"relative"},children:[t.content&&e.jsx(L,{sx:{color:"rgba(255,255,255,0.85)",wordBreak:"break-word",fontSize:"1.01rem",whiteSpace:"pre-wrap",pr:"120px",pl:0,lineHeight:1.4},component:"span",dangerouslySetInnerHTML:{__html:Ae.sanitize((()=>{let M=t.content.replace(/\r\n/g,`
`).replace(/\n/g,"<br>");if(x&&b.trim()){const d=b.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),g=new RegExp(`(${d})`,"gi");M=M.replace(g,'<span style="background-color: rgba(0, 207, 255, 0.3); color: #fff; border-radius: 2px; padding: 0; font-weight: 600;">$1</span>')}return M})())}}),e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:.5,position:"absolute",top:0,right:0,padding:"0 8px"},children:[t.last_modified_at&&t.last_modified_at!==t.created_at&&e.jsx("span",{style:{color:"#90caf9",fontSize:"0.85em",fontStyle:"italic",fontWeight:500},children:"ред."}),t.author.id===w&&e.jsx(a,{sx:{display:"flex",alignItems:"center",gap:.5,mr:.5},children:e.jsx(ct,{sx:{fontSize:"1rem",color:t.read_by_count&&t.read_by_count>0?"#FF69B4":"rgba(255,255,255,0.35)"}})}),e.jsx(L,{sx:{color:"rgba(255,255,255,0.35)",fontSize:"0.78rem",lineHeight:1,whiteSpace:"nowrap",display:"flex",alignItems:"center",gap:.5},children:xt(t.created_at)})]})]})]})]}),e.jsx(pt,{open:!!k,images:t.attachments||[],currentIndex:n,onClose:()=>m(null),onNavigate:M=>{c(M),m(t.attachments[M])}})]})});Oe.displayName="ChatMessageItem";const Ne=ee(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"})),bt=rt.injectEndpoints({endpoints:o=>({signMediaUrls:o.mutation({query:t=>({url:"/api/v1/media-sign",method:"POST",body:t}),invalidatesTags:["Media"]})})}),{useSignMediaUrlsMutation:mt}=bt,yt=_e().shape({content:We().min(1,"Message cannot be empty").max(2e3,"Message is too long")}),St=o=>{const t=new Date(o),r=new Date,i=new Date(r);if(i.setDate(i.getDate()-1),t.toDateString()===r.toDateString())return"Сегодня";if(t.toDateString()===i.toDateString())return"Вчера";const h=t.getFullYear()===r.getFullYear(),l=t.toLocaleDateString([],{weekday:"long",day:"numeric",month:"long",...h?{}:{year:"numeric"}});return l.charAt(0).toUpperCase()+l.slice(1)},Bt=({activeChannel:o,messages:t,tempMessages:r,searchMode:i,searchQuery:h,highlightedMessages:l,focusedMessageId:p,unreadMessages:x,isLoadingMore:b,isLoadingAround:w,editingMessageId:S,user:j,hubId:B,paginationState:y,messagesPerPage:I,showDateLabel:_,currentDateLabel:A,messagesContainerRef:v,messagesEndRef:$,editInputRef:E,highlightTimeoutRef:k,scrollToMessageIdRef:m,hoverTimeoutRef:n,isHoveringPortal:c,scrollCorrectionRef:f,forceScrollToMessageId:u,setHighlightedMessages:z,setFocusedMessageId:D,setEditingMessageId:U,setMessages:N,setTempMessages:M,setReplyingToMessage:C,setHoveredMessage:d,setTargetMessageId:g,paginationActions:F,handleEditMessage:K,handleDeleteMessage:V})=>{const[te]=mt(),{setSignedUrls:P,hasSignedUrl:X}=Le(),W=Y.useRef(new Set),O=[...t].sort((R,H)=>new Date(R.created_at).getTime()-new Date(H.created_at).getTime());Y.useEffect(()=>{if(!t.length)return;const R=new Set;t.forEach(T=>{T.attachments&&T.attachments.length>0&&T.attachments.forEach(Q=>{Q.trim()&&R.add(Q)})});const H=Array.from(R).filter(T=>!X(T)&&!W.current.has(T));H.length>0&&(H.forEach(T=>W.current.add(T)),te({storage_keys:H}).unwrap().then(T=>{console.log("Media URLs signed:",T),P(T),H.forEach(Q=>W.current.delete(Q))}).catch(T=>{console.error("Failed to sign media URLs:",T),H.forEach(Q=>W.current.delete(Q))}))},[t,te,P,X]);const fe=t.length===0&&r.size===0&&!b&&!!o&&e.jsx(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(L,{variant:"body1",color:"text.secondary",children:i?"No messages found matching your search.":"No messages yet. Start a conversation!"})}),be=Y.useCallback(R=>{if(O.some(T=>T.id===R)){const T=document.querySelector(`[data-msg-id='${R}']`);T&&(T.scrollIntoView({behavior:"smooth",block:"center"}),k.current&&(clearTimeout(k.current),k.current=null),D(null),z(new Set),D(R),z(()=>{const Q=new Set;return Q.add(R),Q}),k.current=setTimeout(()=>{z(Q=>{const Z=new Set(Q);return Z.delete(R),Z}),D(null),k.current=null},1500))}else F.setIsJumpingToMessage(!0),F.setSkipMainQuery(!0),N([]),M(new Map),F.setBeforeId(null),F.setAfterId(null),F.setHasMoreMessages(!0),F.setHasMoreMessagesAfter(!0),F.setEnableAfterPagination(!0),g(R),F.setAroundMessageId(R),F.setLoadingMode("around")},[O,D,z,k,F,N,M,g]),Ve=Y.useCallback(R=>{C(R)},[C]),qe=Y.useCallback(R=>U(typeof R=="number"?R:R.id),[U]),Qe=Y.useCallback(R=>V(typeof R=="number"?R:R.id),[V]),Ke=Y.useCallback((R,H)=>{n!=null&&n.current&&(clearTimeout(n.current),n.current=null),d&&H&&d({element:R.currentTarget,message:H})},[n,d]),Ye=Y.useCallback(()=>{n&&(n.current=setTimeout(()=>{!(c!=null&&c.current)&&d&&d(null)},100))},[n,c,d]),Xe=()=>e.jsx(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",color:"rgba(255,255,255,0.5)",textAlign:"center",gap:2},children:y.loadingMode==="around"||y.isJumpingToMessage||w?e.jsx(a,{sx:{width:"100%",height:"100%",overflowY:"auto",p:3,display:"flex",flexDirection:"column",gap:2},children:[...Array(I)].map((R,H)=>e.jsxs(a,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[e.jsx(le,{variant:"circular",width:40,height:40,sx:{bgcolor:"rgba(255,255,255,0.1)"}}),e.jsxs(a,{sx:{flex:1},children:[e.jsx(le,{variant:"text",width:120,height:24,sx:{bgcolor:"rgba(255,255,255,0.1)",mb:1}}),e.jsx(le,{variant:"text",width:"80%",height:20,sx:{bgcolor:"rgba(255,255,255,0.1)"}}),e.jsx(le,{variant:"text",width:"60%",height:20,sx:{bgcolor:"rgba(255,255,255,0.1)"}})]})]},H))}):i&&h&&h.trim()?e.jsxs(e.Fragment,{children:[e.jsx(L,{variant:"h6",children:"Нет результатов поиска"}),e.jsx(L,{variant:"body2",children:"Попробуйте изменить поисковый запрос"})]}):e.jsxs(e.Fragment,{children:[e.jsx(L,{variant:"h6",children:"Нет сообщений"}),e.jsx(L,{variant:"body2",children:"Начните общение, отправив первое сообщение"})]})});return Y.useEffect(()=>{const R=v.current;if(!R)return;let H=!1;const T=()=>{H||(H=!0,requestAnimationFrame(()=>{const Q=R.scrollTop,Z=R.scrollHeight,oe=R.clientHeight;if(Q/Z<.2&&y.hasMoreMessages&&!y.isJumpingToMessage&&y.loadingMode!=="pagination"&&y.loadingMode!=="around"){const re=O[0];re&&(F.setBeforeId(re.id),F.setLoadingMode("pagination"))}if((Q+oe)/Z>.8&&y.enableAfterPagination&&y.hasMoreMessagesAfter&&!y.isJumpingToMessage&&y.loadingMode!=="pagination"&&y.loadingMode!=="around"){const re=O[O.length-1];re&&(F.setAfterId(re.id),F.setLoadingMode("pagination"))}H=!1}))};return R.addEventListener("scroll",T,{passive:!0}),()=>R.removeEventListener("scroll",T)},[O,y,F]),Y.useEffect(()=>{var Q;const R=v.current;if(!R)return;const H=u??((m==null?void 0:m.current)||null);if(H===null)return;if(y.enableAfterPagination&&y.loadingMode==="pagination"&&y.afterId){m&&(m.current=null);return}const T=R.querySelector(`[data-msg-id="${H}"]`);T&&(T.scrollIntoView({behavior:(Q=f==null?void 0:f.current)!=null&&Q.setDisableSmoothScroll?"auto":"smooth",block:"center"}),m&&(m.current=null),p!==H&&(z(Z=>{const oe=new Set(Z);return oe.add(H),oe}),D&&D(H),k.current&&clearTimeout(k.current),k.current=setTimeout(()=>{z(Z=>{const oe=new Set(Z);return oe.delete(H),oe}),D&&D(null)},1500)))},[t,u,m==null?void 0:m.current,p,k,z,D,f,y.enableAfterPagination,y.loadingMode,y.afterId]),Y.useEffect(()=>{y.enableAfterPagination&&y.loadingMode==="pagination"&&y.afterId&&(k.current&&(clearTimeout(k.current),k.current=null),z(new Set),D(null))},[y.enableAfterPagination,y.loadingMode,y.afterId,k,z,D]),e.jsx(a,{ref:v,className:"messages-container",sx:{flex:1,p:3,overflowY:"auto",display:"flex",flexDirection:"column",gap:1,position:"relative","&::-webkit-scrollbar":{width:"8px"},"&::-webkit-scrollbar-track":{background:"rgba(255,255,255,0.05)",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.1)",borderRadius:"4px","&:hover":{background:"rgba(255,255,255,0.15)"}}},children:O.length===0&&r.size===0?Xe():e.jsxs(e.Fragment,{children:[fe,e.jsx(pe,{in:_,timeout:{enter:300,exit:500},children:e.jsx(a,{sx:{position:"sticky",top:0,zIndex:10,alignSelf:"center",backgroundColor:"rgba(30,30,47,0.85)",backdropFilter:"blur(8px)",borderRadius:"16px",px:2,py:.75,mb:1,boxShadow:"0 2px 8px rgba(0,0,0,0.2)",border:"1px solid rgba(255,255,255,0.1)",transition:"all 0.3s ease"},children:e.jsx(L,{sx:{color:"rgba(255,255,255,0.9)",fontWeight:600,fontSize:"0.9rem"},children:A})})}),(()=>{let R=[],H=null,T=[],Q=null,Z=new Set;return[...O,...Array.from(r.values())].forEach(q=>{var Me;const re=new Date(q.created_at).toDateString();Q!==re&&!Z.has(re)&&(T.length>0&&(R.push(...T),T=[]),R.push(e.jsx(a,{className:"date-separator","data-date":q.created_at,sx:{display:"flex",justifyContent:"center",alignItems:"center",my:2,position:"relative"},children:e.jsx(a,{sx:{backgroundColor:"rgba(30,30,47,0.85)",backdropFilter:"blur(8px)",px:2,py:.75,borderRadius:"12px",boxShadow:"0 1px 4px rgba(0,0,0,0.15)",zIndex:1},children:e.jsx(L,{variant:"body2",sx:{color:"text.secondary",fontWeight:500,fontSize:"0.85rem"},children:St(q.created_at)})})},`date-${re}`)),Q=re,Z.add(re));const me="temp_id"in q,Se=((Me=q.author)==null?void 0:Me.id)!==H,Je=S===q.id?e.jsxs(a,{id:`message-${q.id}`,className:"message-item","data-date":q.created_at,"data-msg-id":q.id.toString(),sx:{display:"flex",gap:2,alignItems:"flex-start",position:"relative",borderRadius:"10px",transition:"background-color 0.3s ease",opacity:me?.6:1},children:[e.jsx(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"flex-start",width:40,ml:1,mt:1},children:Se?e.jsx("div",{style:{cursor:"pointer"},children:e.jsx(Be,{src:q.author.avatar||void 0,alt:q.author.login,userId:q.author.id,hubId:B})}):null}),e.jsx(a,{sx:{flex:1,position:"relative"},children:e.jsx(a,{sx:{maxWidth:"100%"},children:e.jsxs(a,{sx:{py:"5px",px:"0px",pl:0},children:[Se&&e.jsx(L,{sx:{color:"#00CFFF",fontWeight:700,mb:.5,fontSize:"1rem",letterSpacing:.2},children:q.author.login}),e.jsx(ke,{initialValues:{content:q.content},validationSchema:yt,onSubmit:K,children:({handleSubmit:Fe,values:je})=>e.jsx(ve,{children:e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:1,background:"rgba(30,30,47,0.9)",borderRadius:"8px",padding:"8px",border:"1px solid rgba(255,255,255,0.1)",boxShadow:"0 4px 12px rgba(0,0,0,0.2)"},children:[e.jsx(Ce,{name:"content",component:Ue,multiline:!0,fullWidth:!0,size:"small",inputRef:E,onKeyDown:ne=>{ne.key==="Enter"&&!ne.shiftKey?(ne.preventDefault(),Fe()):ne.key==="Escape"&&(ne.preventDefault(),U(null))}}),e.jsxs(a,{sx:{display:"flex",gap:1,justifyContent:"flex-end",padding:"4px 8px"},children:[e.jsx(J,{size:"small",onClick:ne=>{ne.preventDefault(),U(null)},sx:{color:"#d32f2f","&:hover":{background:"rgba(211,47,47,0.1)"}},children:e.jsx(ue,{fontSize:"small"})}),e.jsx(J,{size:"small",onClick:ne=>Fe(),disabled:!je.content,sx:{color:je.content?"#1976D2":"rgba(255,255,255,0.3)",transition:"color 0.25s cubic-bezier(.4,0,.2,1)","&:hover":{color:je.content?"#1976D2":"rgba(255,255,255,0.3)"}},children:e.jsx(Ne,{fontSize:"small"})})]})]})})})]})})})]},me?`temp-${q.created_at}`:q.id):e.jsx(Oe,{message:q,isFirstOfGroup:Se,isTempMessage:me,isHighlighted:l.has(q.id),isUnread:x.has(q.id),isFocused:p===q.id,isSearchMode:i,searchQuery:h,currentUserId:j.id,hubId:B,loadingMode:y.loadingMode,onReply:Ve,onEdit:qe,onDelete:Qe,onReplyClick:be,onMouseEnter:Ke,onMouseLeave:Ye},me?`temp-${q.created_at}`:q.id);T.push(Je),H=q.author.id}),T.length>0&&R.push(...T),R})(),e.jsx("div",{ref:$})]})})},we=ee(e.jsx("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"})),jt=Y.memo(({message:o,searchQuery:t,onResultClick:r})=>{const{highlightedContent:i,formattedTime:h}=s.useMemo(()=>{const x=new Date(o.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1});let b=o.content;if(b.length>150&&(b=b.substring(0,150)+"..."),b=b.replace(/\r\n/g," ").replace(/\n/g," "),t.trim()){const S=t.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),j=new RegExp(`(${S})`,"gi");b=b.replace(j,"<mark>$1</mark>")}return{highlightedContent:Ae.sanitize(b),formattedTime:x}},[o.content,o.created_at,t]),l=Y.useCallback(()=>{r(o)},[o,r]);return e.jsxs(a,{onClick:l,onMouseDown:p=>p.preventDefault(),sx:{p:2,borderBottom:"1px solid rgba(255,255,255,0.05)",cursor:"pointer",transition:"background-color 0.2s ease","&:hover":{background:"rgba(255,255,255,0.1)"},"&:last-child":{borderBottom:"none"},contain:"layout style paint",contentVisibility:"auto",containIntrinsicSize:"0 80px"},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(L,{sx:{color:"#00CFFF",fontSize:"0.8rem",fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"150px"},children:o.author.login}),e.jsx(L,{sx:{color:"rgba(255,255,255,0.4)",fontSize:"0.7rem",ml:"auto"},children:h})]}),e.jsx(L,{sx:{color:"rgba(255,255,255,0.8)",fontSize:"0.85rem",lineHeight:1.4,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical","& mark":{background:"rgba(255, 105, 180, 0.3)",color:"#FF69B4",padding:"1px 2px",borderRadius:"2px",fontWeight:600}},dangerouslySetInnerHTML:{__html:i}})]})},(o,t)=>o.message.id===t.message.id&&o.message.content===t.message.content&&o.searchQuery===t.searchQuery),wt=({channelId:o,onSearchResultClick:t})=>{const[r,i]=s.useState(!1),[h,l]=s.useState(""),[p,x]=s.useState(""),[b,w]=s.useState(!1),[S,j]=s.useState(new Set),[B,y]=s.useState(null),[I,_]=s.useState(void 0),[A,v]=s.useState([]),[$,E]=s.useState(!0),k=s.useRef(null),m=s.useRef(null),n=s.useRef(null),c={channelId:o??0,search:p,size:20,...I&&{beforeId:I}},f=!o||!p||!r,{data:u,isLoading:z,isFetching:D}=st(c,{skip:f,refetchOnMountOrArgChange:!0}),U=D&&I!==void 0,N=s.useCallback(g=>{l(g),n.current&&clearTimeout(n.current),_(void 0),v([]),E(!0),n.current=setTimeout(()=>{x(g),g.trim()&&w(!0)},300)},[]),M=s.useCallback(g=>{i(!1),l(""),x(""),w(!1),j(new Set),y(null),t(g.id)},[t]),C=s.useCallback(()=>{i(!1),l(""),x(""),w(!1),j(new Set),y(null),_(void 0),v([]),E(!0)},[]),d=s.useCallback(()=>{if($&&!U&&A.length>0){const g=A[A.length-1];console.log("Loading more, last message id:",g.id,"hasMore:",$),_(g.id)}},[$,U,A]);return s.useEffect(()=>{u?(v(I?g=>{const F=new Set(g.map(V=>V.id)),K=u.filter(V=>!F.has(V.id));return K.length===0&&E(!1),[...g,...K]}:u),E(u.length===20)):p||v([])},[u,I,p]),s.useEffect(()=>{r||(l(""),x(""),w(!1),_(void 0),v([]),E(!0))},[r]),s.useEffect(()=>{const g=F=>{b&&m.current&&k.current&&!m.current.contains(F.target)&&!k.current.contains(F.target)&&w(!1)};return document.addEventListener("mousedown",g),()=>{document.removeEventListener("mousedown",g)}},[b]),s.useEffect(()=>()=>{n.current&&clearTimeout(n.current)},[]),{searchMode:r,setSearchMode:i,searchQuery:h,setSearchQuery:l,debouncedSearchQuery:p,showSearchResults:b,setShowSearchResults:w,searchInputRef:k,searchResultsRef:m,highlightedMessages:S,setHighlightedMessages:j,focusedMessageId:B,setFocusedMessageId:y,searchResults:A,isSearching:z&&I===void 0,handleSearchInputChange:N,handleSearchResultClick:M,clearSearch:C,loadMore:d,hasMore:$,isLoadingMore:U}},kt=({activeChannelId:o})=>{const[t,r]=s.useState(!1),[i,h]=s.useState(""),[l,p]=s.useState(""),[x,b]=s.useState(!1),w=s.useRef(null),S=s.useRef(null),{searchResults:j,isSearching:B,hasMore:y,isLoadingMore:I,loadMore:_,clearSearch:A}=wt({channelId:o!==null?o:void 0,onSearchResultClick:()=>{}}),v=s.useCallback(ot(m=>{p(m)},300),[]),$=s.useCallback(m=>{h(m),v(m),m.trim()&&b(!0)},[v]),E=s.useCallback(()=>{h(""),p(""),b(!1),A(),t||w.current&&(w.current.value="")},[t,A]),k=s.useCallback(m=>{b(!1),r(!1),E()},[E]);return s.useEffect(()=>{const m=n=>{S.current&&!S.current.contains(n.target)&&w.current&&!w.current.contains(n.target)&&b(!1)};return document.addEventListener("mousedown",m),()=>{document.removeEventListener("mousedown",m)}},[]),s.useEffect(()=>{E(),r(!1)},[o,E]),{searchMode:t,setSearchMode:r,searchQuery:i,searchResults:j,debouncedSearchQuery:l,isSearching:B,showSearchResults:x,setShowSearchResults:b,hasMore:y,isLoadingMore:I,searchInputRef:w,searchResultsRef:S,handleSearchInputChange:$,clearSearch:E,loadMore:_,handleResultClick:k}},At=({activeChannelId:o,onSearchResultClick:t,searchMode:r,setSearchMode:i,searchQuery:h,searchInputRef:l,searchResultsRef:p,showSearchResults:x,setShowSearchResults:b,searchResults:w,isSearching:S,debouncedSearchQuery:j,handleSearchInputChange:B,clearSearch:y,loadMore:I,hasMore:_,isLoadingMore:A})=>{const v=kt({activeChannelId:o}),$=r!==void 0?r:v.searchMode,E=i||v.setSearchMode,k=h!==void 0?h:v.searchQuery,m=w||v.searchResults,n=j!==void 0?j:v.debouncedSearchQuery,c=S!==void 0?S:v.isSearching,f=x!==void 0?x:v.showSearchResults,u=b||v.setShowSearchResults,z=_!==void 0?_:v.hasMore,D=A!==void 0?A:v.isLoadingMore,U=l||v.searchInputRef,N=p||v.searchResultsRef,M=B||v.handleSearchInputChange,C=y||v.clearSearch,d=I||v.loadMore,g=v.handleResultClick,F=s.useCallback(W=>{const O=W.currentTarget,{scrollHeight:G,scrollTop:ge,clientHeight:fe}=O;G-ge-fe<100&&d&&z&&!D&&d()},[d,z,D]),K=s.useCallback(W=>{t?t(W):g&&g(W)},[t,g]),V=(m==null?void 0:m.length)||0,te=s.useMemo(()=>`${V} ${V===1?"result":"results"}`,[V]);if(!$)return e.jsx(de,{title:"Поиск сообщений",placement:"top",children:e.jsx(J,{onClick:()=>{E(!0),requestAnimationFrame(()=>{var W;(W=U.current)==null||W.focus()})},sx:{color:"rgba(255,255,255,0.6)","&:hover":{color:"rgba(255,255,255,0.9)",background:"rgba(255,255,255,0.05)"}},children:e.jsx(nt,{})})});const P=m&&m.length>0,X=f&&k.trim();return e.jsxs(a,{sx:{display:"flex",flexDirection:"column",position:"relative",zIndex:10001},children:[e.jsx(a,{sx:{display:"flex",alignItems:"center",background:"rgba(255,255,255,0.05)",borderRadius:X&&P?"20px 20px 0 0":"20px",border:"1px solid rgba(255,255,255,0.1)",borderBottom:X&&P?"none":"1px solid rgba(255,255,255,0.1)",paddingLeft:2,paddingRight:1,width:"300px",transition:"all 0.3s ease"},children:e.jsx(ke,{initialValues:{query:k},onSubmit:()=>{},enableReinitialize:!0,children:({setFieldValue:W})=>e.jsxs(ve,{style:{width:"100%",display:"flex",alignItems:"center"},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",width:"100%",position:"relative"},children:[e.jsx(Ce,{name:"query",children:({field:O})=>e.jsx("input",{...O,ref:U,onChange:G=>{O.onChange(G),M(G.target.value)},onFocus:()=>{var G;(G=O.value)!=null&&G.trim()&&P&&u(!0)},placeholder:"Поиск сообщений...",style:{width:"100%",border:"none",outline:"none",background:"transparent",color:"#fff",fontSize:"0.9rem",padding:"8px 0"},onKeyDown:G=>{G.key==="Escape"&&(f?u(!1):C())}})}),k.trim()&&e.jsx(L,{variant:"caption",sx:{position:"absolute",right:0,top:"-18px",color:P?"#00FFBA":"#FF69B4",fontSize:"0.7rem",fontWeight:500,padding:"2px 6px",borderRadius:"4px",background:"rgba(0,0,0,0.3)"},children:te})]}),e.jsx(J,{type:"button",size:"small",onClick:()=>{f?u(!1):(C(),W("query",""))},sx:{color:"rgba(255,255,255,0.5)","&:hover":{color:"rgba(255,255,255,0.9)",background:"rgba(255,255,255,0.1)"}},children:f?e.jsx(we,{fontSize:"small"}):e.jsx(ue,{fontSize:"small"})})]})})}),X&&e.jsxs(a,{ref:N,onMouseDown:W=>W.preventDefault(),onScroll:F,sx:{position:"absolute",top:"100%",left:0,width:"100%",maxHeight:"300px",background:"rgba(20, 20, 35, 0.98)",border:"1px solid rgba(255,255,255,0.1)",borderTop:"none",borderRadius:"0 0 20px 20px",overflowY:"auto",overflowX:"hidden",zIndex:10002,backdropFilter:"blur(15px)",boxShadow:"0 8px 32px rgba(0,0,0,0.6)",willChange:"scroll-position",contain:"layout style paint","&::-webkit-scrollbar":{width:"6px"},"&::-webkit-scrollbar-track":{background:"rgba(255,255,255,0.1)",borderRadius:"3px"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.3)",borderRadius:"3px","&:hover":{background:"rgba(255,255,255,0.5)"}}},children:[c&&e.jsxs(a,{sx:{p:2,display:"flex",justifyContent:"center",alignItems:"center"},children:[e.jsx(a,{sx:{width:24,height:24,border:"2px solid rgba(255,255,255,0.1)",borderTop:"2px solid #00CFFF",borderRadius:"50%",animation:"spin 1s linear infinite","@keyframes spin":{"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}}}}),e.jsx(L,{sx:{ml:1,color:"rgba(255,255,255,0.7)",fontSize:"0.9rem"},children:"Поиск..."})]}),!c&&m&&m.length===0&&n&&e.jsx(a,{sx:{p:3,textAlign:"center"},children:e.jsxs(L,{sx:{color:"rgba(255,255,255,0.5)",fontSize:"0.9rem"},children:["По запросу ",e.jsx(a,{component:"span",sx:{fontWeight:"bold",color:"#00CFFF"},children:n})," ничего не найдено"]})}),!c&&P&&m.map((W,O)=>e.jsx(jt,{message:W,searchQuery:n,onResultClick:K},`${W.id}-${O}`)),D&&e.jsxs(a,{sx:{p:2,display:"flex",justifyContent:"center",alignItems:"center"},children:[e.jsx(a,{sx:{width:20,height:20,border:"2px solid rgba(255,255,255,0.1)",borderTop:"2px solid #00CFFF",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsx(L,{sx:{ml:1,color:"rgba(255,255,255,0.5)",fontSize:"0.8rem"},children:"Загрузка..."})]})]})]})},_t=({open:o,messageToDelete:t,deleteForEveryone:r,canManageMessages:i,messages:h,userId:l,onClose:p,onConfirm:x,onDeleteForEveryoneChange:b})=>{const w=t?h.find(B=>B.id===t):null,j=w&&w.author.id===l||i;return e.jsx(at,{open:o,onClose:p,title:"Удалить сообщение",children:e.jsxs(a,{sx:{p:2,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:[t&&e.jsxs(a,{sx:{mb:3,width:"100%",maxWidth:300},children:[j&&e.jsxs(a,{onClick:()=>b(!r),sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:1.5,mb:1.5,borderRadius:2,cursor:"pointer",backgroundColor:r?"rgba(255, 61, 113, 0.1)":"rgba(0,0,0,0.15)",border:`1px solid ${r?"rgba(255, 61, 113, 0.3)":"rgba(255,255,255,0.1)"}`,transition:"all 0.2s ease","&:hover":{backgroundColor:r?"rgba(255, 61, 113, 0.15)":"rgba(0,0,0,0.2)",transform:"translateY(-2px)"}},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",mb:.5},children:[e.jsx(lt,{checked:r,onChange:B=>b(B.target.checked),sx:{color:"rgba(255,255,255,0.5)",p:.5,mr:1,"&.Mui-checked":{color:"#FF3D71"}}}),e.jsx(L,{sx:{fontWeight:500,fontSize:"0.9rem"},children:"Удалить у всех"})]}),e.jsx(L,{variant:"body2",sx:{color:"rgba(255,255,255,0.6)",fontStyle:"italic",fontSize:"0.75rem",textAlign:"center"},children:r?"Сообщение исчезнет у всех участников чата":"Сообщение останется видимым для других"})]}),e.jsx(L,{sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.75rem",textAlign:"center",mt:1},children:j?r?"":"Сообщение будет скрыто только в вашем интерфейсе":"Сообщение будет скрыто только для вас"})]}),e.jsxs(a,{sx:{display:"flex",gap:2,justifyContent:"center"},children:[e.jsx(Re,{variant:"outlined",onClick:p,sx:{color:"rgba(255,255,255,0.7)",borderColor:"rgba(255,255,255,0.2)",borderRadius:2,px:3,"&:hover":{borderColor:"rgba(255,255,255,0.4)",backgroundColor:"rgba(255,255,255,0.05)"}},children:"Отмена"}),e.jsx(Re,{variant:"contained",onClick:x,sx:{backgroundColor:"#FF3D71",color:"#fff",borderRadius:2,px:3,"&:hover":{backgroundColor:"#FF1744"}},children:"Удалить"})]})]})})},Wt=({showScrollButton:o,newMessagesCount:t,unreadCount:r,replyingToMessage:i,onScrollToBottom:h})=>{const l=i?160:100;return e.jsxs(e.Fragment,{children:[e.jsx(pe,{in:o,children:e.jsx(J,{onClick:h,sx:{position:"absolute",bottom:l,right:20,backgroundColor:"rgba(30,30,47,0.95)",backdropFilter:"blur(8px)",border:"1px solid rgba(255,255,255,0.1)",boxShadow:"0 4px 12px rgba(0,0,0,0.2)","&:hover":{backgroundColor:"rgba(40,40,57,0.95)"},zIndex:1e3,transition:"bottom 0.2s ease-out"},children:e.jsx(we,{sx:{color:"#fff"}})})}),e.jsx(pe,{in:t>0||r>0,children:e.jsx(a,{sx:{position:"absolute",bottom:l,left:"50%",transform:"translateX(-50%)",zIndex:1e3,transition:"bottom 0.2s ease-out"},children:e.jsxs(he,{sx:{backgroundColor:"#FF69B4",color:"#fff",px:2,py:1,borderRadius:"20px",cursor:"pointer",boxShadow:"0 4px 12px rgba(255,105,180,0.2)",display:"flex",alignItems:"center",gap:1,"&:hover":{backgroundColor:"#FF1493"}},onClick:h,children:[e.jsx(we,{}),e.jsxs(L,{variant:"body2",sx:{fontWeight:600},children:[t||r," ",(t||r)===1?"новое сообщение":"новых сообщений"]})]})})})]})},vt=ee(e.jsx("path",{d:"M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M8.5 8c.83 0 1.5.67 1.5 1.5S9.33 11 8.5 11 7 10.33 7 9.5 7.67 8 8.5 8M12 18c-2.28 0-4.22-1.66-5-4h10c-.78 2.34-2.72 4-5 4m3.5-7c-.83 0-1.5-.67-1.5-1.5S14.67 8 15.5 8s1.5.67 1.5 1.5-.67 1.5-1.5 1.5"})),Ct=ee(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-2h2zm0-4h-2V7h2z"})),Mt=ee(e.jsx("path",{d:"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2M8.5 13.5l2.5 3.01L14.5 12l4.5 6H5z"})),Ft=({open:o,images:t,currentIndex:r,onClose:i,onNavigate:h})=>(s.useEffect(()=>{const l=p=>{o&&(p.key==="Escape"?i():p.key==="ArrowLeft"&&r>0?h(r-1):p.key==="ArrowRight"&&r<t.length-1&&h(r+1))};return window.addEventListener("keydown",l),()=>window.removeEventListener("keydown",l)},[o,r,t.length,i,h]),e.jsx(Te,{open:o,onClose:i,sx:{display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(20px)",backgroundColor:"rgba(10, 10, 26, 0.85)"},children:e.jsx(pe,{in:o,children:e.jsx(a,{sx:{position:"relative",width:"90vw",height:"90vh",maxWidth:"1400px",maxHeight:"900px",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, rgba(13,13,26,0.98) 0%, rgba(26,26,46,0.98) 100%)",borderRadius:3,boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.8)",border:"1px solid rgba(255, 255, 255, 0.1)",outline:"none",overflow:"hidden"},onClick:i,children:t[r]&&e.jsxs(e.Fragment,{children:[e.jsx(a,{sx:{position:"relative",maxWidth:"calc(100% - 120px)",maxHeight:"calc(100% - 120px)",display:"flex",alignItems:"center",justifyContent:"center"},onClick:l=>l.stopPropagation(),children:e.jsx(a,{component:"img",src:t[r].preview,alt:"Fullscreen preview",sx:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain",borderRadius:2,boxShadow:"0 20px 40px rgba(0,0,0,0.4)"}})}),r>0&&e.jsx(a,{onClick:l=>{l.stopPropagation(),h(r-1)},sx:{position:"absolute",left:20,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(-4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx($e,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),r<t.length-1&&e.jsx(a,{onClick:l=>{l.stopPropagation(),h(r+1)},sx:{position:"absolute",right:20,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(Pe,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(a,{onClick:l=>{l.stopPropagation(),i()},sx:{position:"absolute",top:20,right:20,display:"flex",alignItems:"center",justifyContent:"center",width:48,height:48,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.1) 0%, rgba(255, 61, 113, 0.2) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 61, 113, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF3D71 0%, #FF69B4 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"scale(1.1) rotate(90deg)",boxShadow:"0 8px 32px rgba(255, 61, 113, 0.4)",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.2) 0%, rgba(255, 61, 113, 0.3) 100%)","&::before":{opacity:1}}},children:e.jsx(ue,{sx:{fontSize:24,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(a,{sx:{position:"absolute",bottom:20,left:"50%",transform:"translateX(-50%)",display:"flex",gap:1,alignItems:"center"},children:t.map((l,p)=>e.jsx(a,{onClick:x=>{x.stopPropagation(),h(p)},sx:{width:p===r?32:8,height:8,borderRadius:1,bgcolor:p===r?"#FF69B4":"rgba(255, 255, 255, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&:hover":{bgcolor:p===r?"#FF69B4":"rgba(255, 255, 255, 0.5)"}}},p))}),e.jsx(a,{sx:{position:"absolute",top:20,left:20,color:"white",bgcolor:"rgba(30, 30, 47, 0.95)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:2,px:2,py:1},children:e.jsxs(L,{variant:"body2",sx:{opacity:.8},children:[r+1," из ",t.length]})})]})})})})),Rt=_e().shape({content:We().max(2e3,"Message is too long").test("content-or-images","Message cannot be empty",function(){return!0})}),ze=15*1024*1024,se=5,De=["image/jpeg","image/jpg","image/png","image/gif","image/webp"],Et=({activeChannel:o,canSendMessages:t,sending:r,replyingToMessage:i,onSendMessage:h,onReplyCancel:l,onReplyClick:p})=>{var m;const x=s.useRef(null),b=s.useRef(null),w=s.useRef(null),[S,j]=s.useState([]),[B,y]=s.useState(null);s.useEffect(()=>{if(o&&x.current){x.current.focus();const n=x.current.value.length;x.current.setSelectionRange(n,n)}},[o]),s.useEffect(()=>{if(i&&x.current){x.current.focus();const n=x.current.value.length;x.current.setSelectionRange(n,n)}},[i]),s.useEffect(()=>{const n=c=>{c.key==="Escape"&&i&&l()};return document.addEventListener("keydown",n),()=>{document.removeEventListener("keydown",n)}},[i,l]),s.useEffect(()=>{const n=f=>{if(!f.clipboardData)return;const z=Array.from(f.clipboardData.items).filter(U=>U.type.startsWith("image/"));if(z.length===0||S.length>=se)return;f.preventDefault();const D=[];z.slice(0,se-S.length).forEach(U=>{const N=U.getAsFile();if(!N)return;if(S.some(P=>P.file.size===N.size&&P.file.type===N.type&&P.file.lastModified===N.lastModified)){console.log("Duplicate image detected, skipping");return}const C=new Date().getTime(),d=Math.random().toString(36).substring(2,8),g=N.type.split("/")[1]||"png",F=new File([N],`pasted-image-${C}-${d}.${g}`,{type:N.type,lastModified:N.lastModified||Date.now()}),K=De.includes(F.type),V=F.size<=ze,te={file:F,preview:URL.createObjectURL(F),valid:K&&V,error:K?V?void 0:"Файл слишком большой (макс. 15MB)":"Неподдерживаемый формат файла"};D.push(te)}),D.length>0&&j(U=>[...U,...D])},c=x.current;if(c)return c.addEventListener("paste",n),()=>{c.removeEventListener("paste",n)}},[S.length]),s.useEffect(()=>()=>{S.forEach(n=>URL.revokeObjectURL(n.preview))},[S]);const I=()=>{i&&p&&p(i.id)},_=n=>{var f;if(n.content&&n.content.trim())return A(n.content);const c=((f=n.attachments)==null?void 0:f.length)||0;return c>0?c===1?"📎 Вложение":c>=2&&c<=4?`📎 ${c} вложения`:`📎 ${c} вложений`:"📎 Вложение"},A=n=>n.length>150?!(n.indexOf(" ")!==-1)&&n.length>100?n.substring(0,100)+"...":n.substring(0,150)+"...":n,v=n=>{if(!n.target.files||!n.target.files.length)return;const c=Array.from(n.target.files);if(b.current&&(b.current.value=""),S.length>=se)return;const f=[];c.slice(0,se-S.length).forEach(u=>{if(S.some(M=>M.file.size===u.size&&M.file.type===u.type&&M.file.name===u.name&&M.file.lastModified===u.lastModified)){console.log("Duplicate file detected, skipping:",u.name);return}const D=De.includes(u.type),U=u.size<=ze,N={file:u,preview:URL.createObjectURL(u),valid:D&&U,error:D?U?void 0:"Файл слишком большой (макс. 15MB)":"Неподдерживаемый формат файла"};f.push(N)}),f.length>0&&j(u=>[...u,...f])},$=n=>{j(c=>{const f=[...c];return URL.revokeObjectURL(f[n].preview),f.splice(n,1),f})},E=()=>{b.current&&b.current.click()},k=n=>{y(n)};return e.jsxs(a,{sx:{p:2},children:[t?e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:1},children:[i&&e.jsxs(he,{sx:{p:"8px 16px",display:"flex",alignItems:"flex-start",gap:1,background:"rgba(30,30,47,0.95)",border:"1px solid rgba(149,128,255,0.25)",borderRadius:2,position:"relative",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",mb:1,pl:3,width:"100%"},children:[e.jsx(a,{sx:{position:"absolute",left:0,top:0,bottom:0,width:"4px",backgroundColor:"#00CFFF",borderTopLeftRadius:2,borderBottomLeftRadius:2}}),e.jsxs(a,{sx:{flex:1,cursor:"pointer"},onClick:I,children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(He,{sx:{color:"#00CFFF",fontSize:"0.9rem"}}),e.jsxs(L,{variant:"caption",sx:{color:"#00CFFF",fontWeight:600,display:"flex",alignItems:"center"},children:["Ответ ",(m=i.author)!=null&&m.login?`@${i.author.login}`:""]})]}),e.jsx(L,{variant:"body2",sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.85rem",lineHeight:1.4,wordBreak:"break-word"},children:_(i)})]}),e.jsx(J,{size:"small",onClick:l,sx:{color:"rgba(255,255,255,0.5)","&:hover":{color:"rgba(255,255,255,0.8)"}},children:e.jsx(ue,{fontSize:"small"})})]}),S.length>0&&e.jsxs(he,{sx:{p:2,background:"rgba(30,30,47,0.95)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:2,mb:1},children:[e.jsx(a,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:S.map((n,c)=>e.jsx(a,{sx:{width:{xs:"calc(33.33% - 8px)",sm:"calc(25% - 8px)",md:"calc(16.66% - 8px)"}},children:e.jsxs(a,{sx:{position:"relative",height:100,borderRadius:1,overflow:"hidden",border:n.valid?"1px solid rgba(255,255,255,0.1)":"1px solid #f44336","&:hover .image-remove-btn":{opacity:1}},children:[e.jsx(a,{component:"img",src:n.preview,alt:"Preview",onClick:()=>k(c),sx:{width:"100%",height:"100%",objectFit:"cover",cursor:"pointer"}}),!n.valid&&e.jsx(de,{title:n.error||"Invalid image",children:e.jsx(a,{sx:{position:"absolute",top:5,left:5,bgcolor:"rgba(0,0,0,0.7)",borderRadius:"50%",width:24,height:24,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(Ct,{sx:{color:"#f44336",fontSize:"16px"}})})}),e.jsx(J,{className:"image-remove-btn",size:"small",onClick:()=>$(c),sx:{position:"absolute",top:5,right:5,bgcolor:"rgba(0,0,0,0.7)",color:"white",p:"4px",opacity:0,transition:"opacity 0.2s","&:hover":{bgcolor:"rgba(0,0,0,0.85)"}},children:e.jsx(ue,{sx:{fontSize:"16px"}})})]})},c))}),e.jsxs(a,{sx:{mt:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(L,{variant:"caption",sx:{color:"rgba(255,255,255,0.7)"},children:[S.length," / ",se," изображений"]}),S.length>1&&e.jsx(L,{variant:"caption",onClick:()=>{S.forEach(n=>URL.revokeObjectURL(n.preview)),j([])},sx:{color:"#1976D2",cursor:"pointer","&:hover":{textDecoration:"underline"}},children:"Очистить все"})]})]}),e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",multiple:!0,ref:b,onChange:v,style:{display:"none"},max:se.toString()}),e.jsx(he,{sx:{p:"8px 16px",display:"flex",alignItems:"center",gap:1,background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:3},children:e.jsx(ke,{innerRef:w,initialValues:{content:""},validationSchema:Rt,onSubmit:async(n,c)=>{const f=S.filter(u=>u.valid).map(u=>u.file);try{await h({content:n.content,images:f.length>0?f:void 0},c),S.forEach(u=>URL.revokeObjectURL(u.preview)),j([])}catch(u){console.error("Error sending message:",u)}},children:({handleSubmit:n,values:c})=>e.jsxs(e.Fragment,{children:[e.jsx(ve,{style:{width:"100%"},children:e.jsx(Ce,{name:"content",component:Ue,placeholder:"Type a message...",multiline:!0,maxRows:4,size:"small",disabled:!o||r,inputRef:x,sx:{"& .MuiOutlinedInput-root":{"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"},"& .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"}}},onKeyDown:f=>{f.key==="Enter"&&!f.shiftKey&&(f.preventDefault(),n())}})}),e.jsxs(it,{direction:"row",spacing:1,children:[e.jsx(J,{size:"small",sx:{color:"#FF69B4"},children:e.jsx(vt,{})}),e.jsx(de,{title:S.length>=se?`Максимум ${se} изображений`:"Прикрепить изображения",children:e.jsxs(a,{children:["  ",e.jsx(J,{size:"small",sx:{color:S.length>=se?"rgba(255,255,255,0.3)":"#1E90FF"},onClick:E,disabled:S.length>=se,children:e.jsx(Mt,{})})]})}),e.jsx(J,{size:"small",sx:{color:c.content||S.length>0?"#1976D2":"rgba(255,255,255,0.3)",transition:"color 0.25s cubic-bezier(.4,0,.2,1)","&:hover":{color:c.content||S.length>0?"#1976D2":"rgba(255,255,255,0.3)"}},onClick:()=>n(),disabled:r||!c.content&&S.length===0,children:e.jsx(Ne,{})})]})]})})})]}):e.jsx(he,{sx:{p:"12px 16px",display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:3},children:e.jsx(L,{sx:{color:"rgba(255,255,255,0.5)",fontSize:"0.9rem"},children:"Недостаточно прав для отправки сообщений"})}),e.jsx(Ft,{open:B!==null,images:S,currentIndex:B||0,onClose:()=>y(null),onNavigate:y})]})},Ut=({activeChannel:o,canSendMessages:t,sending:r,replyingToMessage:i,onSendMessage:h,onReplyCancel:l,onReplyClick:p})=>e.jsx(Et,{activeChannel:o,canSendMessages:t,sending:r,replyingToMessage:i,onSendMessage:h,onReplyCancel:l,onReplyClick:p}),Ht=()=>{const[o,t]=s.useState(null),[r,i]=s.useState(null),[h,l]=s.useState(!0),[p,x]=s.useState(!0),[b,w]=s.useState(!1),[S,j]=s.useState("initial"),[B,y]=s.useState(!1),[I,_]=s.useState(!1),[A,v]=s.useState(null),$=s.useRef(!1),E=s.useRef(null),k=s.useRef(null),m=s.useRef(null),n=s.useRef(!1),c=s.useRef(!1),f=s.useCallback(d=>{m.current&&(clearTimeout(m.current),m.current=null),$.current=d,d&&(m.current=setTimeout(()=>{console.warn("[Pagination] Loading timeout - resetting loading state after 10 seconds"),$.current=!1,j(null),m.current=null},1e4))},[]),u=s.useCallback((d,g,F)=>{if(I)return;if(!($.current||S==="initial"||S==="around"||!n.current)){if(d.scrollTop/d.scrollHeight<.2&&h){f(!0),j("pagination");const P=[...g].sort((X,W)=>new Date(X.created_at).getTime()-new Date(W.created_at).getTime())[0];P&&E.current!==P.id?(console.log("[useMessagePagination] Setting beforeId for pagination:",{oldestMessageId:P.id,previousBeforeId:E.current,messagesCount:g.length}),t(P.id),E.current=P.id,i(null),k.current=null,y(!1)):P&&(console.log("[useMessagePagination] Duplicate before request detected, skipping:",{oldestMessageId:P.id,lastBeforeId:E.current}),f(!1),j(null))}if(b&&!c.current&&p&&g.length>=F&&d.scrollHeight-d.scrollTop-d.clientHeight<100){f(!0),j("pagination");const P=[...g].sort((W,O)=>new Date(W.created_at).getTime()-new Date(O.created_at).getTime()),X=P[P.length-1];X&&k.current!==X.id?(i(X.id),k.current=X.id,t(null),E.current=null,y(!1),c.current=!0):X&&(f(!1),j(null))}}},[I,S,h,p,b,f]),z=s.useCallback(()=>{t(null),i(null),l(!0),x(!0),w(!1),j("initial"),y(!1),_(!1),v(null),f(!1),E.current=null,k.current=null,n.current=!1,c.current=!1},[f]),D=s.useCallback(d=>{_(!0),v(d),j("around"),y(!0),t(null),i(null),E.current=null,k.current=null,f(!1)},[f]),U=s.useCallback(d=>{n.current=d},[]),N=s.useCallback(()=>{c.current=!1},[]);s.useEffect(()=>()=>{m.current&&clearTimeout(m.current)},[]);const M=s.useMemo(()=>({beforeId:o,afterId:r,hasMoreMessages:h,hasMoreMessagesAfter:p,enableAfterPagination:b,loadingMode:S,skipMainQuery:B,isJumpingToMessage:I,aroundMessageId:A}),[o,r,h,p,b,S,B,I,A]),C=s.useMemo(()=>({setBeforeId:t,setAfterId:i,setHasMoreMessages:l,setHasMoreMessagesAfter:x,setEnableAfterPagination:w,setLoadingMode:j,setSkipMainQuery:y,setIsJumpingToMessage:_,setAroundMessageId:v,handleScrollPagination:u,resetPagination:z,jumpToMessage:D,setInitialLoadComplete:U,clearAfterPaginationCooldown:N}),[u,z,D,U,N]);return{state:M,actions:C,isLoadingMoreRef:$,lastBeforeIdRef:E,lastAfterIdRef:k,setLoadingWithTimeout:f}},$t=({activeChannel:o})=>{const t=s.useRef(new Set),r=s.useCallback(l=>{t.current.add(l)},[]),i=s.useCallback(l=>{o&&t.current.add(l)},[o]),h=s.useCallback(()=>{o&&xe.publish(`/app/v1/channels/${o.id}/messages/bulk-read-all`,{})},[o]);return s.useEffect(()=>{if(!o)return;const l=()=>{if(t.current.size>0){const x=Array.from(t.current);xe.publish(`/app/v1/channels/${o.id}/messages/bulk-read`,{messageIds:x}),t.current.clear()}},p=setInterval(l,1e3);return()=>{clearInterval(p),l()}},[o]),{unreadMessagesBufferRef:t,markMessageAsRead:i,markAllMessagesAsRead:h,addToReadBuffer:r}},Pt=({messagesContainerRef:o,messages:t,activeChannel:r,onScrollToBottom:i,onMarkAllAsRead:h,bulkReadAllRef:l,paginationActions:p,messagesPerPage:x=20})=>{const[b,w]=s.useState(!0),[S,j]=s.useState(!1),[B,y]=s.useState(!1),[I,_]=s.useState(null),[A,v]=s.useState(!1),[$,E]=s.useState(!1),k=s.useRef(null),m=s.useRef(null),n=s.useRef(0),c=s.useRef(0),f=s.useRef(0),u=s.useRef(!1),z=s.useCallback(()=>{const C=o.current;C&&(n.current=C.scrollHeight,c.current=C.scrollTop)},[o]),D=s.useCallback((C=!1)=>{if(!o.current||A)return;const d=o.current;requestAnimationFrame(()=>{if(C||$){const g=d.style.scrollBehavior;d.style.scrollBehavior="auto",d.scrollTop=d.scrollHeight,d.style.scrollBehavior=g}else d.scrollTop=d.scrollHeight;j(!1),setTimeout(()=>{d.scrollTop<d.scrollHeight-d.clientHeight-100&&(d.scrollTop=d.scrollHeight)},100)})},[A,$,o]),U=s.useCallback(C=>{if(!o.current)return;const d=document.getElementById(`message-${C}`);if(!d)return;v(!0);const g=o.current,F=d.offsetTop,K=d.offsetHeight,V=g.clientHeight,te=F-V/2+K/2;g.scrollTop=Math.max(0,te),d.style.transition="background-color 0.3s ease-in-out",d.style.backgroundColor="rgba(0, 207, 255, 0.1)",m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{d&&(d.style.backgroundColor=""),v(!1),g.scrollTop+g.clientHeight>=g.scrollHeight-20&&D()},2e3)},[o,D]),N=s.useCallback(()=>{D(),h&&r&&h()},[r,h,D]),M=C=>{const d=new Date(C),g=new Date,F=new Date(g);if(F.setDate(F.getDate()-1),d.toDateString()===g.toDateString())return"Сегодня";if(d.toDateString()===F.toDateString())return"Вчера";const K=d.getFullYear()===g.getFullYear(),V=d.toLocaleDateString([],{weekday:"long",day:"numeric",month:"long",...K?{}:{year:"numeric"}});return V.charAt(0).toUpperCase()+V.slice(1)};return s.useEffect(()=>{const C=o.current;if(!C)return;let d=C.scrollTop,g=null,F=0;const K=()=>{u.current||(u.current=!0,requestAnimationFrame(()=>{g&&clearTimeout(g);const V=C.scrollTop,P=C.scrollHeight-V-C.clientHeight<100;if(V<d)p&&x&&p.handleScrollPagination(C,t,x);else if(V>d&&P&&!b){w(!0);const O=Date.now();h&&(l!=null&&l.current)&&O-F>1e3&&O-l.current>1e3&&(F=O,l.current=O,h())}d=V,w(P),j(C.scrollTop+C.clientHeight<C.scrollHeight-400),k.current&&clearTimeout(k.current);const X=C.querySelectorAll(".message-item");if(!X.length)return;let W=null;X.forEach(O=>{const G=O.getBoundingClientRect(),ge=C.getBoundingClientRect();if(G.top>=ge.top&&G.bottom<=ge.bottom&&!W){const be=O.getAttribute("data-date");be&&(W=M(be))}}),W&&(_(W),y(!0),k.current=setTimeout(()=>{y(!1)},1e3)),g=setTimeout(()=>{g=null},150),u.current=!1}))};return C.addEventListener("scroll",K),()=>{C.removeEventListener("scroll",K),k.current&&clearTimeout(k.current),g&&clearTimeout(g)}},[r,t,o,h,l,p,x]),s.useEffect(()=>{const C=o.current;if(!C)return;const d=t.length,g=f.current;if(d>g&&g>0){const F=C.scrollHeight-n.current;if(F>0){const K=c.current+F;C.scrollTop=K}}f.current=d,n.current=C.scrollHeight,c.current=C.scrollTop},[t.length,o]),s.useEffect(()=>{b&&i&&i()},[b,i]),s.useEffect(()=>()=>{m.current&&clearTimeout(m.current),k.current&&clearTimeout(k.current)},[]),{isScrolledToBottom:b,setIsScrolledToBottom:w,showScrollButton:S,setShowScrollButton:j,showDateLabel:B,setShowDateLabel:y,currentDateLabel:I,setCurrentDateLabel:_,disableAutoScroll:A,setDisableAutoScroll:v,scrollToBottom:D,scrollToMessage:U,handleScrollToBottom:N,prepareScrollCorrection:z,setDisableSmoothScroll:E}},Ie=(o,t)=>{const r=s.useCallback(t,[t]);s.useEffect(()=>{if(!o)return;let i=!0;return i&&(async()=>{try{await xe.subscribe(o,r)}catch(l){console.error("Failed to setup WebSocket subscription:",l)}})(),()=>{i=!1,xe.unsubscribe(o,r)}},[o,r])};var ce=(o=>(o[o.SENT=0]="SENT",o[o.READ=1]="READ",o[o.NEW=2]="NEW",o))(ce||{});const Ot=(o,t,r,i)=>{const h=s.useRef(0),l=s.useCallback(()=>{if(!o)return;const x=Date.now();x-h.current>1e3&&x-i.bulkReadAllRef.current>1e3&&(h.current=x,i.bulkReadAllRef.current=x,xe.publish(`/app/v1/channels/${o.id}/messages/bulk-read-all`,{}),r.onMarkAllAsRead())},[o,r.onMarkAllAsRead,i.bulkReadAllRef]),p=s.useCallback(x=>{if(x.type==="MESSAGE_CREATE"&&x.message){const b=i.convertToExtendedMessage(x.message);if(b.author.id===(t==null?void 0:t.id))return;if(r.onMessageCreate(b),r.onHighlightMessage(b.id,1500),b.status===ce.NEW){const w=i.messagesContainerRef.current;if(w){const S=w.scrollHeight-w.scrollTop-w.clientHeight,j=S<100,B=S>300;j&&o?(i.addToReadBuffer(b.id),r.onMarkMessageAsRead(b.id),i.loadingMode!=="around"&&!i.isJumpingToMessage&&r.onScrollToBottom(),l()):B?(r.onNewMessageIndicator(!0),r.onUnreadMessage(b.id),setTimeout(()=>{const y=document.querySelector(`[data-msg-id="${b.id}"]`);if(y){const I=y.getBoundingClientRect();I.top>=0&&I.bottom<=window.innerHeight&&o&&(i.addToReadBuffer(b.id),r.onMarkMessageAsRead(b.id))}},100)):(i.addToReadBuffer(b.id),r.onMarkMessageAsRead(b.id),i.loadingMode!=="around"&&!i.isJumpingToMessage&&r.onScrollToBottom(),l())}}}else if(x.type==="MESSAGE_UPDATE"&&x.message){const b=i.convertToExtendedMessage(x.message);r.onMessageUpdate(b),b.status===ce.READ&&r.onUnreadCountChange(-1)}else x.type==="MESSAGE_DELETE"&&x.messageId?(r.onMessageDelete(x.messageId),r.onUnreadCountChange(-1)):x.type==="MESSAGE_READ_STATUS"&&x.message_range&&r.onMessageReadStatus(x.message_range)},[t==null?void 0:t.id,o,i.convertToExtendedMessage,i.isJumpingToMessage,i.loadingMode,i.messagesContainerRef,i.addToReadBuffer,r.onMessageCreate,r.onMessageUpdate,r.onMessageDelete,r.onMessageReadStatus,r.onHighlightMessage,r.onUnreadMessage,r.onMarkMessageAsRead,r.onNewMessageIndicator,r.onScrollToBottom,l,r.onUnreadCountChange]);return Ie(o&&t?`/v1/user/${t.id}/queue/channels/${o.id}/messages`:null,p),Ie(o?`/v1/topic/channels/${o.id}/messages`:null,p),{}},Nt=()=>{const[o,t]=s.useState([]),[r,i]=s.useState(new Map),[h,l]=s.useState(new Set),[p,x]=s.useState(0),[b,w]=s.useState(0),S=s.useCallback(n=>({...n,status:"status"in n?n.status:ce.SENT,reply:n.reply?{...n.reply,status:"status"in n.reply?n.reply.status:ce.SENT}:null}),[]),j=s.useCallback(()=>{t([]),i(new Map),l(new Set),x(0),w(0)},[]),B=s.useCallback((n,c)=>{t(f=>f.map(u=>u.id===n&&u.author.id!==c?{...u,status:ce.READ}:u))},[]),y=s.useCallback(n=>{t(c=>c.map(f=>f.author.id!==n?{...f,status:ce.READ}:f)),l(new Set),x(0),w(0)},[]),I=s.useCallback((n,c)=>{t(f=>f.map(u=>{if(u.id>=n.from&&u.id<=n.to&&u.author.id===c){const z=u.read_by_count||0;return{...u,read_by_count:z+1}}return u}))},[]),_=s.useCallback(n=>{t(c=>c.some(z=>z.id===n)?c.filter(z=>z.id!==n).map(z=>z.reply&&z.reply.id===n?{...z,reply:void 0}:z):c)},[]),A=s.useCallback(n=>{t(c=>c.some(u=>u.id===n.id)?c.map(u=>u.id===n.id?n:u):c)},[]),v=s.useCallback(n=>{t(c=>c.some(u=>u.id===n.id)?c:[...c,n])},[]),$=s.useCallback(n=>{l(c=>{const f=new Set(c);return f.add(n),f}),x(c=>c+1),w(c=>c+1)},[]),E=s.useCallback(n=>{l(c=>{const f=new Set(c);return f.delete(n),f}),x(c=>Math.max(0,c-1)),w(c=>Math.max(0,c-1))},[]),k=s.useCallback(n=>{x(c=>Math.max(0,c+n)),w(c=>Math.max(0,c+n))},[]),m=s.useCallback(()=>{x(0),w(0)},[]);return{messages:o,setMessages:t,tempMessages:r,setTempMessages:i,unreadMessages:h,setUnreadMessages:l,unreadCount:p,setUnreadCount:x,newMessagesCount:b,setNewMessagesCount:w,convertToExtendedMessage:S,resetMessageStates:j,updateMessageReadStatus:B,markAllMessagesAsReadInState:y,updateMessageReadByCount:I,deleteMessageFromState:_,updateMessageInState:A,addMessageToState:v,addUnreadMessage:$,removeUnreadMessage:E,updateUnreadCount:k,resetUnreadCounts:m}};export{Ut as C,_t as D,ce as M,Wt as N,At as S,Ht as a,$t as b,Pt as c,wt as d,Ot as e,Bt as f,Nt as u};
