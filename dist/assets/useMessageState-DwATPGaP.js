import{f as K,j as e,g as Ae,r as o,B as n,t as ce,aB as ve,ay as ue,a4 as ie,T as C,R as Ce,e as ae,I as X,U as Fe,bu as Me,X as he,L as ze,Y as me,b2 as ye,N as De,S as He,W as _e,_ as je,P as de,O as We,bv as ge,bw as Ue}from"./index-SyOjaueW.js";import{I as Ie}from"./Input-CizgT06n.js";import{C as $e}from"./Checkbox-DYhLorLg.js";const Ne=K(e.jsx("path",{d:"m18 7-1.41-1.41-6.34 6.34 1.41 1.41zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12zM.41 13.41 6 19l1.41-1.41L1.83 12z"})),be=K(e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11"})),Oe=K(e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"})),Pe=K(e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"})),oe=K([e.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"},"0"),e.jsx("path",{d:"M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"},"1")]),Ve=Ae.injectEndpoints({endpoints:a=>({getMediaUrl:a.query({queryFn:async(t,r,c,b)=>{try{const l=r.getState().auth.token;if(!l)return{error:{status:"UNAUTHORIZED",error:"No auth token available"}};const p=await fetch(`/api/v1/media/${t}`,{headers:{Authorization:`Bearer ${l}`}});if(!p.ok)return{error:{status:p.status,error:`HTTP ${p.status}`}};const d=await p.blob();return{data:URL.createObjectURL(d)}}catch(l){return{error:{status:"FETCH_ERROR",error:String(l)}}}},keepUnusedDataFor:300,providesTags:(t,r,c)=>[{type:"Media",id:c}]})}),overrideExisting:!1}),{useGetMediaUrlQuery:qe}=Ve,te=({storageKey:a,alt:t="Image",sx:r,className:c,onClick:b,loadingMode:l=null})=>{const[p,d]=o.useState(!1),[m,k]=o.useState(!1),y=o.useRef(null);o.useEffect(()=>{const F=y.current;if(!F)return;const E=new IntersectionObserver(R=>{const[B]=R;B.isIntersecting&&(k(!0),E.unobserve(F))},{rootMargin:"200px",threshold:.01});return E.observe(F),()=>{E.unobserve(F)}},[]);const w=a&&m&&l!=="initial",{data:I,isLoading:v,error:z}=qe(a,{skip:!w});return o.useEffect(()=>{d(!1)},[a]),w?v?e.jsx(n,{ref:y,sx:{width:"100%",height:"100%",position:"relative",overflow:"hidden",...r},children:e.jsx(ce,{variant:"rectangular",animation:"wave",sx:{width:"100%",height:"100%",bgcolor:"rgba(255,255,255,0.1)","&::after":{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent)"}}})}):z||p?(console.log("❌ Showing error state for:",a),e.jsx(n,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"rgba(255,0,0,0.1)",color:"rgba(255,255,255,0.7)",fontSize:"0.875rem",border:"1px dashed rgba(255,0,0,0.3)",...r},children:"Ошибка загрузки"})):I?e.jsx(n,{ref:y,component:"img",className:c,src:I,alt:t,onClick:b,onError:F=>{console.error("❌ Image render error:",{storageKey:a,imageSrc:I,error:F}),d(!0)},sx:{width:"100%",height:"100%",objectFit:"cover",display:"block",...r}}):e.jsx(n,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"rgba(255,255,0,0.1)",color:"rgba(255,255,255,0.7)",fontSize:"0.875rem",border:"1px dashed rgba(255,255,0,0.3)",...r},children:"Нет изображения"}):e.jsx(n,{ref:y,sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"rgba(255,255,255,0.05)",color:"rgba(255,255,255,0.3)",fontSize:"0.875rem",border:"1px dashed rgba(255,255,255,0.1)",...r},children:l==="initial"?"Загружается...":"📷"})},Ee=K(e.jsx("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"})),Te=K(e.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"})),Ye=({open:a,images:t,currentIndex:r,onClose:c,onNavigate:b})=>(o.useEffect(()=>{const l=p=>{a&&(p.key==="Escape"?c():p.key==="ArrowLeft"&&r>0?b(r-1):p.key==="ArrowRight"&&r<t.length-1&&b(r+1))};return window.addEventListener("keydown",l),()=>window.removeEventListener("keydown",l)},[a,r,t.length,c,b]),e.jsx(ve,{open:a,onClose:c,sx:{display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(20px)",backgroundColor:"rgba(10, 10, 26, 0.85)"},children:e.jsx(ue,{in:a,children:e.jsx(n,{sx:{position:"relative",width:"100vw",height:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, rgba(13,13,26,0.95) 0%, rgba(26,26,46,0.95) 100%)",outline:"none"},onClick:c,children:t[r]&&e.jsxs(e.Fragment,{children:[e.jsx(n,{sx:{position:"relative",maxWidth:"90vw",maxHeight:"90vh",display:"flex",alignItems:"center",justifyContent:"center"},onClick:l=>l.stopPropagation(),children:e.jsx(te,{storageKey:t[r],alt:"Fullscreen preview",sx:{maxWidth:"100%",maxHeight:"90vh",objectFit:"contain",borderRadius:2,boxShadow:"0 20px 40px rgba(0,0,0,0.4)",width:"auto",height:"auto"}})}),r>0&&e.jsx(n,{onClick:l=>{l.stopPropagation(),b(r-1)},sx:{position:"absolute",left:40,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(-4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(Ee,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),r<t.length-1&&e.jsx(n,{onClick:l=>{l.stopPropagation(),b(r+1)},sx:{position:"absolute",right:40,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(Te,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(n,{onClick:l=>{l.stopPropagation(),c()},sx:{position:"absolute",top:40,right:40,display:"flex",alignItems:"center",justifyContent:"center",width:48,height:48,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.1) 0%, rgba(255, 61, 113, 0.2) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 61, 113, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF3D71 0%, #FF69B4 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"scale(1.1) rotate(90deg)",boxShadow:"0 8px 32px rgba(255, 61, 113, 0.4)",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.2) 0%, rgba(255, 61, 113, 0.3) 100%)","&::before":{opacity:1}}},children:e.jsx(ie,{sx:{fontSize:24,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(n,{sx:{position:"absolute",bottom:40,left:"50%",transform:"translateX(-50%)",display:"flex",gap:1,alignItems:"center"},children:t.map((l,p)=>e.jsx(n,{onClick:d=>{d.stopPropagation(),b(p)},sx:{width:p===r?32:8,height:8,borderRadius:1,bgcolor:p===r?"#FF69B4":"rgba(255, 255, 255, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&:hover":{bgcolor:p===r?"#FF69B4":"rgba(255, 255, 255, 0.5)"}}},p))}),e.jsx(n,{sx:{position:"absolute",top:40,left:40,color:"white",bgcolor:"rgba(30, 30, 47, 0.95)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:2,px:2,py:1},children:e.jsxs(C,{variant:"body2",sx:{opacity:.8},children:[r+1," из ",t.length]})})]})})})})),Xe=a=>new Date(a).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),Ge=a=>{var r;if(a.content&&a.content.trim())return a.content;const t="attachments_count"in a?a.attachments_count:((r=a.attachments)==null?void 0:r.length)||0;return t>0?t===1?"📎 Вложение":t>=2&&t<=4?`📎 ${t} вложения`:`📎 ${t} вложений`:"📎 Вложение"},Re=Ce.memo(a=>{const{message:t,isFirstInGroup:r=a.isFirstOfGroup||!1,isTempMessage:c=!1,isHighlighted:b=!1,isUnread:l=!1,isFocused:p=!1,isSearchMode:d=!1,searchQuery:m="",currentUserId:k,hubId:y=0,loadingMode:w=null,onReply:I,onEdit:v,onDelete:z,onReplyClick:F,onMouseEnter:E,onMouseLeave:R}=a,[B,A]=o.useState(!1),[M,j]=o.useState(null),[s,i]=o.useState(0),u=t.attachments&&t.attachments.length>0,g=(S,h)=>{j(S),i(h)},L=()=>{t.reply&&F&&F(t.reply.id)},W=()=>{t&&I&&I(t)},U=()=>{v&&typeof v=="function"&&v(t.id)},_=()=>{z&&typeof z=="function"&&z(t.id)};return e.jsxs(e.Fragment,{children:[e.jsxs(n,{id:`message-${t.id}`,className:"message-item","data-date":t.created_at,"data-msg-id":t.id.toString(),onMouseEnter:S=>{A(!0),E&&E(S,t)},onMouseLeave:S=>{A(!1),R&&R(S)},sx:{display:"flex",gap:2,alignItems:"flex-start",position:"relative",borderRadius:"10px",transition:"background-color 0.3s ease, box-shadow 0.5s ease",opacity:c?.6:1,mt:r?2:0,backgroundColor:p?"rgba(0, 207, 255, 0.25)":b?"rgba(33, 150, 243, 0.25)":l?"rgba(25,118,210,0.1)":"transparent","&.highlight-pulse":{animation:"pulse 2s infinite"},"&:hover":{backgroundColor:p?"rgba(0, 207, 255, 0.35)":b?"rgba(33, 150, 243, 0.35)":l?"rgba(25,118,210,0.15)":"rgba(255,255,255,0.05)"}},children:[B&&e.jsxs(n,{sx:{position:"absolute",top:-40,left:"50%",transform:"translateX(-50%)",display:"flex",gap:.5,zIndex:1e3,padding:"6px 8px",borderRadius:"20px",background:"rgba(40, 44, 52, 0.85)",backdropFilter:"blur(6px)",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",transition:"all 0.2s ease",opacity:1,animation:"fadeIn 0.2s ease-in-out","@keyframes fadeIn":{from:{opacity:0,transform:"translateX(-50%) translateY(5px)"},to:{opacity:1,transform:"translateX(-50%) translateY(0)"}}},children:[e.jsx(ae,{title:"Ответить",enterDelay:1e3,placement:"top",children:e.jsx(X,{size:"small",onClick:W,sx:{color:"#00CFFF",transition:"all 0.2s ease","&:hover":{color:"#E5FBFF",transform:"scale(1.1)"}},children:e.jsx(be,{fontSize:"small"})})}),t.author.id===k&&e.jsxs(e.Fragment,{children:[e.jsx(ae,{title:"Редактировать",enterDelay:1e3,placement:"top",children:e.jsx(X,{size:"small",onClick:U,sx:{color:"#00CFFF",transition:"all 0.2s ease","&:hover":{color:"#E5FBFF",transform:"scale(1.1)"}},children:e.jsx(Oe,{fontSize:"small"})})}),e.jsx(ae,{title:"Удалить",enterDelay:1e3,placement:"top",children:e.jsx(X,{size:"small",onClick:_,sx:{color:"#FF3D71",transition:"all 0.2s ease","&:hover":{color:"#FF708D",transform:"scale(1.1)"}},children:e.jsx(Pe,{fontSize:"small"})})})]})]}),e.jsx(n,{sx:{width:40,display:"flex",flexDirection:"column",alignItems:"center",mt:1},children:r?e.jsx("div",{style:{cursor:"pointer"},children:e.jsx(Fe,{src:t.author.avatar||void 0,alt:t.author.login,userId:t.author.id,hubId:y})}):null}),e.jsxs(n,{sx:{flex:1,position:"relative"},children:[e.jsx(n,{sx:{maxWidth:"99%"},children:e.jsxs(n,{sx:{py:"5px",px:"0px",pl:0},children:[r&&e.jsx(C,{sx:{color:"#00CFFF",fontWeight:700,mb:.5,fontSize:"1rem",letterSpacing:.2},children:t.author.login}),t.reply&&e.jsxs(n,{sx:{display:"flex",flexDirection:"column",borderRadius:"4px",p:1,background:S=>S.palette.mode==="dark"?"rgba(255,255,255,0.04)":"rgba(0,0,0,0.04)",border:"1px solid rgba(255,255,255,0.05)",mb:1,mt:.25,cursor:"pointer","&:hover":{background:"rgba(255,255,255,0.06)"}},onClick:L,children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(be,{sx:{fontSize:"0.9rem",color:"#00CFFF"}}),e.jsx(C,{sx:{color:"#00CFFF",fontSize:"0.82rem",fontWeight:"500"},children:t.reply.author.login})]}),e.jsx(C,{sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.82rem",mt:.3,lineHeight:1.3},noWrap:!0,children:Ge(t.reply)})]})]})}),u&&e.jsx(n,{sx:{mt:1.5,mb:1},children:(()=>{var h;const S=((h=t.attachments)==null?void 0:h.length)||0;return S===1?e.jsx(n,{sx:{position:"relative",borderRadius:3,overflow:"hidden",maxWidth:"450px",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 8px 32px rgba(0,0,0,0.12)",background:"linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"translateY(-4px)",boxShadow:"0 20px 40px rgba(0,0,0,0.2)",border:"1px solid rgba(0, 207, 255, 0.3)","& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>g(t.attachments[0],0),children:e.jsxs(n,{sx:{position:"relative",width:"100%",paddingTop:"75%","& > *":{position:"absolute",top:0,left:0,width:"100%",height:"100%"}},children:[e.jsx(te,{storageKey:t.attachments[0],className:"attachment-image",alt:"Attachment",loadingMode:w,sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(n,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(3px)"},children:e.jsx(oe,{sx:{color:"white",fontSize:"36px",filter:"drop-shadow(0 2px 8px rgba(0,0,0,0.4))"}})})]})}):S===2?e.jsx(n,{sx:{display:"flex",gap:1,maxWidth:"450px"},children:t.attachments.map((x,f)=>e.jsxs(n,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",flex:1,height:"200px",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"translateY(-2px) scale(1.02)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.05)"}}},onClick:()=>g(x,f),children:[e.jsx(te,{loadingMode:w,storageKey:x,className:"attachment-image",alt:"Attachment",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(n,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(2px)"},children:e.jsx(oe,{sx:{color:"white",fontSize:"28px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(n,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,backdropFilter:"blur(6px)",border:"1px solid rgba(255,255,255,0.15)"},children:[f+1,"/",S]})]},f))}):S===3?e.jsxs(n,{sx:{display:"flex",gap:1,maxWidth:"450px",height:"280px"},children:[e.jsxs(n,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",flex:2,cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.02)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.05)"}}},onClick:()=>g(t.attachments[0],0),children:[e.jsx(te,{loadingMode:w,storageKey:t.attachments[0],className:"attachment-image",alt:"Attachment",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(n,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(2px)"},children:e.jsx(oe,{sx:{color:"white",fontSize:"32px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(n,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,backdropFilter:"blur(6px)",border:"1px solid rgba(255,255,255,0.15)"},children:["1/",S]})]}),e.jsx(n,{sx:{display:"flex",flexDirection:"column",gap:1,flex:1},children:t.attachments.slice(1,3).map((x,f)=>e.jsxs(n,{sx:{position:"relative",borderRadius:2,overflow:"hidden",flex:1,cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.03)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.08)"}}},onClick:()=>g(x,f+1),children:[e.jsx(te,{loadingMode:w,storageKey:x,className:"attachment-image",alt:"Attachment",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(n,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(2px)"},children:e.jsx(oe,{sx:{color:"white",fontSize:"24px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(n,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,backdropFilter:"blur(6px)",border:"1px solid rgba(255,255,255,0.15)"},children:[f+2,"/",S]})]},f+1))})]}):S===4?e.jsx(n,{sx:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:1,maxWidth:"400px",aspectRatio:"1"},children:t.attachments.map((x,f)=>e.jsxs(n,{sx:{position:"relative",borderRadius:2,overflow:"hidden",aspectRatio:"1",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.05)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.08)"}}},onClick:()=>g(x,f),children:[e.jsx(te,{loadingMode:w,storageKey:x,className:"attachment-image",alt:"Attachment",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(n,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(2px)"},children:e.jsx(oe,{sx:{color:"white",fontSize:"28px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(n,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,backdropFilter:"blur(6px)",border:"1px solid rgba(255,255,255,0.15)"},children:[f+1,"/",S]})]},f))}):S>=5?e.jsxs(n,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:1,maxWidth:"450px",aspectRatio:"3/2"},children:[e.jsxs(n,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",gridColumn:"span 2",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.02)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.05)"}}},onClick:()=>g(t.attachments[0],0),children:[e.jsx(te,{loadingMode:w,storageKey:t.attachments[0],className:"attachment-image",alt:"Attachment",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(n,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(2px)"},children:e.jsx(oe,{sx:{color:"white",fontSize:"32px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(n,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,backdropFilter:"blur(6px)",border:"1px solid rgba(255,255,255,0.15)"},children:["1/",S]})]}),e.jsx(n,{sx:{display:"flex",flexDirection:"column",gap:1},children:t.attachments.slice(1,3).map((x,f)=>e.jsxs(n,{sx:{position:"relative",borderRadius:2,overflow:"hidden",flex:1,cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.05)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.08)"}}},onClick:()=>g(x,f+1),children:[e.jsx(te,{loadingMode:w,storageKey:x,className:"attachment-image",alt:"Attachment",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(n,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(2px)"},children:f===1&&S>3?e.jsxs(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:.5},children:[e.jsxs(C,{sx:{color:"white",fontSize:"1.2rem",fontWeight:700,textShadow:"0 2px 8px rgba(0,0,0,0.8)"},children:["+",S-3]}),e.jsx(C,{sx:{color:"white",fontSize:"0.75rem",fontWeight:500,textShadow:"0 1px 4px rgba(0,0,0,0.8)",opacity:.9},children:"ещё"})]}):e.jsx(oe,{sx:{color:"white",fontSize:"20px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(n,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,backdropFilter:"blur(6px)",border:"1px solid rgba(255,255,255,0.15)"},children:[f+2,"/",S]})]},f+1))})]}):null})()}),e.jsxs(n,{sx:{display:"flex",flexDirection:"column",position:"relative"},children:[t.content&&e.jsx(C,{sx:{color:"rgba(255,255,255,0.85)",wordBreak:"break-word",fontSize:"1.01rem",whiteSpace:"pre-wrap",pr:"120px",pl:0,lineHeight:1.4},component:"span",dangerouslySetInnerHTML:{__html:Me.sanitize((()=>{let S=t.content.replace(/\r\n/g,`
`).replace(/\n/g,"<br>");if(d&&m.trim()){const x=m.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),f=new RegExp(`(${x})`,"gi");S=S.replace(f,'<span style="background-color: rgba(0, 207, 255, 0.3); color: #fff; border-radius: 2px; padding: 0; font-weight: 600;">$1</span>')}return S})())}}),e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:.5,position:"absolute",top:0,right:0,padding:"0 8px"},children:[t.last_modified_at&&t.last_modified_at!==t.created_at&&e.jsx("span",{style:{color:"#90caf9",fontSize:"0.85em",fontStyle:"italic",fontWeight:500},children:"ред."}),t.author.id===k&&e.jsx(n,{sx:{display:"flex",alignItems:"center",gap:.5,mr:.5},children:e.jsx(Ne,{sx:{fontSize:"1rem",color:t.read_by_count&&t.read_by_count>0?"#FF69B4":"rgba(255,255,255,0.35)"}})}),e.jsx(C,{sx:{color:"rgba(255,255,255,0.35)",fontSize:"0.78rem",lineHeight:1,whiteSpace:"nowrap",display:"flex",alignItems:"center",gap:.5},children:Xe(t.created_at)})]})]})]})]}),e.jsx(Ye,{open:!!M,images:t.attachments||[],currentIndex:s,onClose:()=>j(null),onNavigate:S=>{i(S),j(t.attachments[S])}})]})});Re.displayName="ChatMessageItem";const Le=K(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"})),Ke=ze().shape({content:De().min(1,"Message cannot be empty").max(2e3,"Message is too long")}),Je=a=>{const t=new Date(a),r=new Date,c=new Date(r);if(c.setDate(c.getDate()-1),t.toDateString()===r.toDateString())return"Сегодня";if(t.toDateString()===c.toDateString())return"Вчера";const b=t.getFullYear()===r.getFullYear(),l=t.toLocaleDateString([],{weekday:"long",day:"numeric",month:"long",...b?{}:{year:"numeric"}});return l.charAt(0).toUpperCase()+l.slice(1)},Qe=(a,t,r=30)=>{const c=new Date(a),b=new Date(t);return Math.abs(c.getTime()-b.getTime())/(1e3*60)<=r},ut=({activeChannel:a,messages:t,tempMessages:r,searchMode:c,searchQuery:b,highlightedMessages:l,focusedMessageId:p,unreadMessages:d,isLoadingMore:m,isLoadingAround:k,editingMessageId:y,user:w,hubId:I,paginationState:v,messagesPerPage:z,showDateLabel:F,currentDateLabel:E,messagesContainerRef:R,messagesEndRef:B,editInputRef:A,highlightTimeoutRef:M,hoverTimeoutRef:j,isHoveringPortal:s,setHighlightedMessages:i,setFocusedMessageId:u,setEditingMessageId:g,setMessages:L,setTempMessages:W,setReplyingToMessage:U,setHoveredMessage:_,setTargetMessageId:S,paginationActions:h,handleEditMessage:x,handleDeleteMessage:f})=>{const T=[...t].sort((D,$)=>new Date(D.created_at).getTime()-new Date($.created_at).getTime()),Q=t.length===0&&r.size===0&&!m&&!!a&&e.jsx(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(C,{variant:"body1",color:"text.secondary",children:c?"No messages found matching your search.":"No messages yet. Start a conversation!"})}),O=D=>{if(T.some(q=>q.id===D)){const q=document.querySelector(`[data-msg-id='${D}']`);q&&(q.scrollIntoView({behavior:"smooth",block:"center"}),M.current&&(clearTimeout(M.current),M.current=null),u(null),i(new Set),u(D),i(()=>{const V=new Set;return V.add(D),V}),M.current=setTimeout(()=>{i(V=>{const re=new Set(V);return re.delete(D),re}),u(null),M.current=null},1500))}else h.setIsJumpingToMessage(!0),h.setSkipMainQuery(!0),L([]),W(new Map),h.setBeforeId(null),h.setAfterId(null),h.setHasMoreMessages(!0),h.setHasMoreMessagesAfter(!0),h.setEnableAfterPagination(!0),S(D),h.setAroundMessageId(D),h.setLoadingMode("around")},G=()=>e.jsx(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",color:"rgba(255,255,255,0.5)",textAlign:"center",gap:2},children:v.loadingMode==="around"||v.isJumpingToMessage||k?e.jsx(n,{sx:{width:"100%",height:"100%",overflowY:"auto",p:3,display:"flex",flexDirection:"column",gap:2},children:[...Array(z)].map((D,$)=>e.jsxs(n,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[e.jsx(ce,{variant:"circular",width:40,height:40,sx:{bgcolor:"rgba(255,255,255,0.1)"}}),e.jsxs(n,{sx:{flex:1},children:[e.jsx(ce,{variant:"text",width:120,height:24,sx:{bgcolor:"rgba(255,255,255,0.1)",mb:1}}),e.jsx(ce,{variant:"text",width:"80%",height:20,sx:{bgcolor:"rgba(255,255,255,0.1)"}}),e.jsx(ce,{variant:"text",width:"60%",height:20,sx:{bgcolor:"rgba(255,255,255,0.1)"}})]})]},$))}):c&&b.trim()?e.jsxs(e.Fragment,{children:[e.jsx(C,{variant:"h6",children:"Нет результатов поиска"}),e.jsx(C,{variant:"body2",children:"Попробуйте изменить поисковый запрос"})]}):e.jsxs(e.Fragment,{children:[e.jsx(C,{variant:"h6",children:"Нет сообщений"}),e.jsx(C,{variant:"body2",children:"Начните общение, отправив первое сообщение"})]})});return Ce.useEffect(()=>{const D=R.current;if(!D)return;let $=!1;const q=()=>{$||($=!0,requestAnimationFrame(()=>{if(D.scrollTop/D.scrollHeight<.2&&v.hasMoreMessages&&!v.isJumpingToMessage&&v.loadingMode!=="pagination"&&v.loadingMode!=="around"){const Z=T[0];Z&&(h.setBeforeId(Z.id),h.setLoadingMode("pagination"))}$=!1}))};return D.addEventListener("scroll",q,{passive:!0}),()=>D.removeEventListener("scroll",q)},[T,v,h]),e.jsx(n,{ref:R,className:"messages-container",sx:{flex:1,p:3,overflowY:"auto",display:"flex",flexDirection:"column",gap:1,position:"relative","&::-webkit-scrollbar":{width:"8px"},"&::-webkit-scrollbar-track":{background:"rgba(255,255,255,0.05)",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.1)",borderRadius:"4px","&:hover":{background:"rgba(255,255,255,0.15)"}}},children:T.length===0&&r.size===0?G():e.jsxs(e.Fragment,{children:[Q,e.jsx(ue,{in:F,timeout:{enter:300,exit:500},children:e.jsx(n,{sx:{position:"sticky",top:0,zIndex:10,alignSelf:"center",backgroundColor:"rgba(30,30,47,0.85)",backdropFilter:"blur(8px)",borderRadius:"16px",px:2,py:.75,mb:1,boxShadow:"0 2px 8px rgba(0,0,0,0.2)",border:"1px solid rgba(255,255,255,0.1)",transition:"all 0.3s ease"},children:e.jsx(C,{sx:{color:"rgba(255,255,255,0.9)",fontWeight:600,fontSize:"0.9rem"},children:E})})}),(()=>{let D=[],$=null,q=null,V=[],re=null,Z=new Set;return[...T,...Array.from(r.values())].forEach(H=>{const le=new Date(H.created_at).toDateString();re!==le&&!Z.has(le)&&(V.length>0&&(D.push(...V),V=[]),D.push(e.jsxs(n,{className:"date-separator","data-date":H.created_at,sx:{display:"flex",justifyContent:"center",alignItems:"center",my:2,position:"relative"},children:[e.jsx(n,{sx:{backgroundColor:"rgba(30,30,47,0.85)",backdropFilter:"blur(8px)",borderRadius:"16px",px:2,py:.75,boxShadow:"0 2px 8px rgba(0,0,0,0.2)",border:"1px solid rgba(255,255,255,0.1)",zIndex:2},children:e.jsx(C,{sx:{color:"rgba(255,255,255,0.9)",fontWeight:600,fontSize:"0.9rem"},children:Je(H.created_at)})}),e.jsx(n,{sx:{position:"absolute",height:"1px",width:"100%",backgroundColor:"rgba(255,255,255,0.08)",zIndex:1}})]},`date-${le}`)),re=le,Z.add(le));const xe=$!==H.author.id||q!==null&&!Qe(q,H.created_at),pe=H.id===-1,Be=y===H.id?e.jsxs(n,{id:`message-${H.id}`,className:"message-item","data-date":H.created_at,"data-msg-id":H.id.toString(),sx:{display:"flex",gap:2,alignItems:"flex-start",position:"relative",borderRadius:"10px",transition:"background-color 0.3s ease",opacity:pe?.6:1},children:[e.jsx(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"flex-start",width:40,ml:1,mt:1},children:xe?e.jsx("div",{style:{cursor:"pointer"},children:e.jsx(Fe,{src:H.author.avatar||void 0,alt:H.author.login,userId:H.author.id,hubId:I})}):null}),e.jsx(n,{sx:{flex:1,position:"relative"},children:e.jsx(n,{sx:{maxWidth:"100%"},children:e.jsxs(n,{sx:{py:"5px",px:"0px",pl:0},children:[xe&&e.jsx(C,{sx:{color:"#00CFFF",fontWeight:700,mb:.5,fontSize:"1rem",letterSpacing:.2},children:H.author.login}),e.jsx(he,{initialValues:{content:H.content},validationSchema:Ke,onSubmit:x,children:({handleSubmit:Y,values:ne})=>e.jsx(me,{children:e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:1,background:"rgba(30,30,47,0.9)",borderRadius:"8px",padding:"8px",border:"1px solid rgba(255,255,255,0.1)",boxShadow:"0 4px 12px rgba(0,0,0,0.2)"},children:[e.jsx(ye,{name:"content",component:Ie,multiline:!0,fullWidth:!0,size:"small",inputRef:A,onKeyDown:ee=>{ee.key==="Enter"&&!ee.shiftKey?(ee.preventDefault(),Y()):ee.key==="Escape"&&(ee.preventDefault(),g(null))}}),e.jsxs(n,{sx:{display:"flex",gap:1,justifyContent:"flex-end",padding:"4px 8px"},children:[e.jsx(X,{size:"small",onClick:ee=>{ee.preventDefault(),g(null)},sx:{color:"#d32f2f","&:hover":{background:"rgba(211,47,47,0.1)"}},children:e.jsx(ie,{fontSize:"small"})}),e.jsx(X,{size:"small",onClick:ee=>Y(),disabled:!ne.content,sx:{color:ne.content?"#1976D2":"rgba(255,255,255,0.3)",transition:"color 0.25s cubic-bezier(.4,0,.2,1)","&:hover":{color:ne.content?"#1976D2":"rgba(255,255,255,0.3)"}},children:e.jsx(Le,{fontSize:"small"})})]})]})})})]})})})]},pe?`temp-${H.created_at}`:H.id):e.jsx(Re,{message:H,isFirstOfGroup:xe,isTempMessage:pe,isHighlighted:l.has(H.id),isUnread:d.has(H.id),isFocused:p===H.id,isSearchMode:c,searchQuery:b,currentUserId:w.id,hubId:I,loadingMode:v.loadingMode,onReply:Y=>{U(Y)},onEdit:Y=>g(typeof Y=="number"?Y:Y.id),onDelete:Y=>f(typeof Y=="number"?Y:Y.id),onReplyClick:O,onMouseEnter:(Y,ne)=>{j!=null&&j.current&&(clearTimeout(j.current),j.current=null),_&&ne&&_({element:Y.currentTarget,message:ne})},onMouseLeave:()=>{j&&(j.current=setTimeout(()=>{!(s!=null&&s.current)&&_&&_(null)},100))}},pe?`temp-${H.created_at}`:H.id);V.push(Be),$=H.author.id,q=H.created_at}),V.length>0&&D.push(...V),D})(),e.jsx("div",{ref:B})]})})},fe=K(e.jsx("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"})),gt=({searchMode:a,setSearchMode:t,searchQuery:r,searchInputRef:c,searchResultsRef:b,showSearchResults:l,setShowSearchResults:p,searchResults:d,isSearching:m,debouncedSearchQuery:k,handleSearchInputChange:y,clearSearch:w,onSearchResultClick:I,onLoadMore:v,hasMore:z=!1,isLoadingMore:F=!1})=>{const[E,R]=o.useState([]),B=o.useRef(!1),A=j=>new Date(j).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1});o.useEffect(()=>{d&&R(d)},[d]);const M=o.useCallback(j=>{const s=j.currentTarget,i=s.scrollHeight,u=s.scrollTop,g=s.clientHeight;i-u-g<100&&v&&z&&!F&&!B.current&&(B.current=!0,v(),setTimeout(()=>{B.current=!1},1e3))},[v,z,F]);return a?e.jsxs(n,{sx:{display:"flex",flexDirection:"column",position:"relative",zIndex:10001},children:[e.jsx(n,{sx:{display:"flex",alignItems:"center",background:"rgba(255,255,255,0.05)",borderRadius:l&&r.trim()&&d&&d.length>0?"20px 20px 0 0":"20px",border:"1px solid rgba(255,255,255,0.1)",borderBottom:l&&r.trim()&&d&&d.length>0?"none":"1px solid rgba(255,255,255,0.1)",paddingLeft:2,paddingRight:1,width:"300px",transition:"all 0.3s ease"},children:e.jsx(he,{initialValues:{query:r},onSubmit:()=>{},enableReinitialize:!0,children:({setFieldValue:j})=>e.jsxs(me,{style:{width:"100%",display:"flex",alignItems:"center"},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",width:"100%",position:"relative"},children:[e.jsx(ye,{name:"query",children:({field:s,form:i})=>e.jsx("input",{...s,ref:c,onChange:u=>{s.onChange(u),y(u.target.value)},onFocus:()=>{var u;(u=s.value)!=null&&u.trim()&&d&&d.length>0&&p(!0)},onBlur:u=>{const g=u.relatedTarget;g&&b.current&&!b.current.contains(g)?setTimeout(()=>{b.current&&!b.current.matches(":hover")&&p(!1)},150):g||setTimeout(()=>{p(!1)},150)},placeholder:"Поиск сообщений...",style:{width:"100%",border:"none",outline:"none",background:"transparent",color:"#fff",fontSize:"0.9rem",padding:"8px 0"},onKeyDown:u=>{u.key==="Escape"&&(l?p(!1):(w(),i.resetForm()))}})}),r.trim()&&e.jsxs(C,{variant:"caption",sx:{position:"absolute",right:0,top:"-18px",color:d&&d.length>0?"#00FFBA":"#FF69B4",fontSize:"0.7rem",fontWeight:500,padding:"2px 6px",borderRadius:"4px",background:"rgba(0,0,0,0.3)"},children:[(d==null?void 0:d.length)||0," ",(d==null?void 0:d.length)===1?"result":"results"]})]}),e.jsx(X,{type:"button",size:"small",onClick:()=>{l?p(!1):(w(),j("query",""))},sx:{color:"rgba(255,255,255,0.5)","&:hover":{color:"rgba(255,255,255,0.9)",background:"rgba(255,255,255,0.1)"}},children:l?e.jsx(fe,{fontSize:"small"}):e.jsx(ie,{fontSize:"small"})})]})})}),l&&r.trim()&&e.jsxs(n,{ref:b,onMouseDown:j=>{j.preventDefault()},onMouseEnter:()=>{p(!0)},onMouseLeave:j=>{const s=j.relatedTarget;s&&c.current&&!c.current.contains(s)?setTimeout(()=>p(!1),100):s||setTimeout(()=>p(!1),100)},onScroll:M,sx:{position:"absolute",top:"100%",left:0,width:"100%",maxHeight:"300px",background:"rgba(20, 20, 35, 0.98)",border:"1px solid rgba(255,255,255,0.1)",borderTop:"none",borderRadius:"0 0 20px 20px",overflowY:"auto",overflowX:"hidden",zIndex:10002,backdropFilter:"blur(15px)",boxShadow:"0 8px 32px rgba(0,0,0,0.6)","&::-webkit-scrollbar":{width:"6px"},"&::-webkit-scrollbar-track":{background:"rgba(255,255,255,0.1)",borderRadius:"3px"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.3)",borderRadius:"3px","&:hover":{background:"rgba(255,255,255,0.5)"}}},children:[m&&e.jsxs(n,{sx:{p:2,display:"flex",justifyContent:"center",alignItems:"center"},children:[e.jsx(n,{sx:{width:24,height:24,border:"2px solid rgba(255,255,255,0.1)",borderTop:"2px solid #00CFFF",borderRadius:"50%",animation:"spin 1s linear infinite","@keyframes spin":{"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}}}}),e.jsx(C,{sx:{ml:1,color:"rgba(255,255,255,0.7)",fontSize:"0.9rem"},children:"Поиск..."})]}),!m&&d&&d.length===0&&k&&e.jsx(n,{sx:{p:3,textAlign:"center"},children:e.jsxs(C,{sx:{color:"rgba(255,255,255,0.5)",fontSize:"0.9rem"},children:["По запросу ",e.jsx(n,{component:"span",sx:{fontWeight:"bold",color:"#00CFFF"},children:k})," ничего не найдено"]})}),!m&&E&&E.length>0&&E.map((j,s)=>e.jsxs(n,{onClick:()=>{I(j),p(!1)},onMouseDown:i=>{i.preventDefault()},sx:{p:2,borderBottom:"1px solid rgba(255,255,255,0.05)",cursor:"pointer",transition:"all 0.2s ease","&:hover":{background:"rgba(255,255,255,0.1)",transform:"translateX(2px)"},"&:last-child":{borderBottom:"none"}},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(C,{sx:{color:"#00CFFF",fontSize:"0.8rem",fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"150px"},children:j.author.login}),e.jsx(C,{sx:{color:"rgba(255,255,255,0.4)",fontSize:"0.7rem",ml:"auto"},children:A(j.created_at)})]}),e.jsx(C,{sx:{color:"rgba(255,255,255,0.8)",fontSize:"0.85rem",lineHeight:1.4,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical","& mark":{background:"rgba(255, 105, 180, 0.3)",color:"#FF69B4",padding:"1px 2px",borderRadius:"2px",fontWeight:600}},dangerouslySetInnerHTML:{__html:Me.sanitize((()=>{let i=j.content;if(i.length>150&&(i=i.substring(0,150)+"..."),i=i.replace(/\r\n/g," ").replace(/\n/g," "),k.trim()){const g=k.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),L=new RegExp(`(${g})`,"gi");i=i.replace(L,"<mark>$1</mark>")}return i})())}})]},`${j.id}-${s}`)),F&&e.jsxs(n,{sx:{p:2,display:"flex",justifyContent:"center",alignItems:"center"},children:[e.jsx(n,{sx:{width:20,height:20,border:"2px solid rgba(255,255,255,0.1)",borderTop:"2px solid #00CFFF",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsx(C,{sx:{ml:1,color:"rgba(255,255,255,0.5)",fontSize:"0.8rem"},children:"Загрузка..."})]})]})]}):e.jsx(ae,{title:"Поиск сообщений",placement:"top",children:e.jsx(X,{onClick:()=>{t(!0),setTimeout(()=>{c.current&&c.current.focus()},100)},sx:{color:"rgba(255,255,255,0.6)","&:hover":{color:"rgba(255,255,255,0.9)",background:"rgba(255,255,255,0.05)"}},children:e.jsx(He,{})})})},pt=({open:a,messageToDelete:t,deleteForEveryone:r,canManageMessages:c,messages:b,userId:l,onClose:p,onConfirm:d,onDeleteForEveryoneChange:m})=>{const k=t?b.find(I=>I.id===t):null,w=k&&k.author.id===l||c;return e.jsx(_e,{open:a,onClose:p,title:"Удалить сообщение",children:e.jsxs(n,{sx:{p:2,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:[t&&e.jsxs(n,{sx:{mb:3,width:"100%",maxWidth:300},children:[w&&e.jsxs(n,{onClick:()=>m(!r),sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:1.5,mb:1.5,borderRadius:2,cursor:"pointer",backgroundColor:r?"rgba(255, 61, 113, 0.1)":"rgba(0,0,0,0.15)",border:`1px solid ${r?"rgba(255, 61, 113, 0.3)":"rgba(255,255,255,0.1)"}`,transition:"all 0.2s ease","&:hover":{backgroundColor:r?"rgba(255, 61, 113, 0.15)":"rgba(0,0,0,0.2)",transform:"translateY(-2px)"}},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",mb:.5},children:[e.jsx($e,{checked:r,onChange:I=>m(I.target.checked),sx:{color:"rgba(255,255,255,0.5)",p:.5,mr:1,"&.Mui-checked":{color:"#FF3D71"}}}),e.jsx(C,{sx:{fontWeight:500,fontSize:"0.9rem"},children:"Удалить у всех"})]}),e.jsx(C,{variant:"body2",sx:{color:"rgba(255,255,255,0.6)",fontStyle:"italic",fontSize:"0.75rem",textAlign:"center"},children:r?"Сообщение исчезнет у всех участников чата":"Сообщение останется видимым для других"})]}),e.jsx(C,{sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.75rem",textAlign:"center",mt:1},children:w?r?"":"Сообщение будет скрыто только в вашем интерфейсе":"Сообщение будет скрыто только для вас"})]}),e.jsxs(n,{sx:{display:"flex",gap:2,justifyContent:"center"},children:[e.jsx(je,{variant:"outlined",onClick:p,sx:{color:"rgba(255,255,255,0.7)",borderColor:"rgba(255,255,255,0.2)",borderRadius:2,px:3,"&:hover":{borderColor:"rgba(255,255,255,0.4)",backgroundColor:"rgba(255,255,255,0.05)"}},children:"Отмена"}),e.jsx(je,{variant:"contained",onClick:d,sx:{backgroundColor:"#FF3D71",color:"#fff",borderRadius:2,px:3,"&:hover":{backgroundColor:"#FF1744"}},children:"Удалить"})]})]})})},xt=({showScrollButton:a,newMessagesCount:t,unreadCount:r,replyingToMessage:c,onScrollToBottom:b})=>{const l=c?160:100;return e.jsxs(e.Fragment,{children:[e.jsx(ue,{in:a,children:e.jsx(X,{onClick:b,sx:{position:"absolute",bottom:l,right:20,backgroundColor:"rgba(30,30,47,0.95)",backdropFilter:"blur(8px)",border:"1px solid rgba(255,255,255,0.1)",boxShadow:"0 4px 12px rgba(0,0,0,0.2)","&:hover":{backgroundColor:"rgba(40,40,57,0.95)"},zIndex:1e3,transition:"bottom 0.2s ease-out"},children:e.jsx(fe,{sx:{color:"#fff"}})})}),e.jsx(ue,{in:t>0||r>0,children:e.jsx(n,{sx:{position:"absolute",bottom:l,left:"50%",transform:"translateX(-50%)",zIndex:1e3,transition:"bottom 0.2s ease-out"},children:e.jsxs(de,{sx:{backgroundColor:"#FF69B4",color:"#fff",px:2,py:1,borderRadius:"20px",cursor:"pointer",boxShadow:"0 4px 12px rgba(255,105,180,0.2)",display:"flex",alignItems:"center",gap:1,"&:hover":{backgroundColor:"#FF1493"}},onClick:b,children:[e.jsx(fe,{}),e.jsxs(C,{variant:"body2",sx:{fontWeight:600},children:[t||r," ",(t||r)===1?"новое сообщение":"новых сообщений"]})]})})})]})},Ze=K(e.jsx("path",{d:"M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M8.5 8c.83 0 1.5.67 1.5 1.5S9.33 11 8.5 11 7 10.33 7 9.5 7.67 8 8.5 8M12 18c-2.28 0-4.22-1.66-5-4h10c-.78 2.34-2.72 4-5 4m3.5-7c-.83 0-1.5-.67-1.5-1.5S14.67 8 15.5 8s1.5.67 1.5 1.5-.67 1.5-1.5 1.5"})),et=K(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-2h2zm0-4h-2V7h2z"})),tt=K(e.jsx("path",{d:"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2M8.5 13.5l2.5 3.01L14.5 12l4.5 6H5z"})),rt=({open:a,images:t,currentIndex:r,onClose:c,onNavigate:b})=>(o.useEffect(()=>{const l=p=>{a&&(p.key==="Escape"?c():p.key==="ArrowLeft"&&r>0?b(r-1):p.key==="ArrowRight"&&r<t.length-1&&b(r+1))};return window.addEventListener("keydown",l),()=>window.removeEventListener("keydown",l)},[a,r,t.length,c,b]),e.jsx(ve,{open:a,onClose:c,sx:{display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(20px)",backgroundColor:"rgba(10, 10, 26, 0.85)"},children:e.jsx(ue,{in:a,children:e.jsx(n,{sx:{position:"relative",width:"90vw",height:"90vh",maxWidth:"1400px",maxHeight:"900px",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, rgba(13,13,26,0.98) 0%, rgba(26,26,46,0.98) 100%)",borderRadius:3,boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.8)",border:"1px solid rgba(255, 255, 255, 0.1)",outline:"none",overflow:"hidden"},onClick:c,children:t[r]&&e.jsxs(e.Fragment,{children:[e.jsx(n,{sx:{position:"relative",maxWidth:"calc(100% - 120px)",maxHeight:"calc(100% - 120px)",display:"flex",alignItems:"center",justifyContent:"center"},onClick:l=>l.stopPropagation(),children:e.jsx(n,{component:"img",src:t[r].preview,alt:"Fullscreen preview",sx:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain",borderRadius:2,boxShadow:"0 20px 40px rgba(0,0,0,0.4)"}})}),r>0&&e.jsx(n,{onClick:l=>{l.stopPropagation(),b(r-1)},sx:{position:"absolute",left:20,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(-4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(Ee,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),r<t.length-1&&e.jsx(n,{onClick:l=>{l.stopPropagation(),b(r+1)},sx:{position:"absolute",right:20,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(Te,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(n,{onClick:l=>{l.stopPropagation(),c()},sx:{position:"absolute",top:20,right:20,display:"flex",alignItems:"center",justifyContent:"center",width:48,height:48,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.1) 0%, rgba(255, 61, 113, 0.2) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 61, 113, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF3D71 0%, #FF69B4 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"scale(1.1) rotate(90deg)",boxShadow:"0 8px 32px rgba(255, 61, 113, 0.4)",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.2) 0%, rgba(255, 61, 113, 0.3) 100%)","&::before":{opacity:1}}},children:e.jsx(ie,{sx:{fontSize:24,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(n,{sx:{position:"absolute",bottom:20,left:"50%",transform:"translateX(-50%)",display:"flex",gap:1,alignItems:"center"},children:t.map((l,p)=>e.jsx(n,{onClick:d=>{d.stopPropagation(),b(p)},sx:{width:p===r?32:8,height:8,borderRadius:1,bgcolor:p===r?"#FF69B4":"rgba(255, 255, 255, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&:hover":{bgcolor:p===r?"#FF69B4":"rgba(255, 255, 255, 0.5)"}}},p))}),e.jsx(n,{sx:{position:"absolute",top:20,left:20,color:"white",bgcolor:"rgba(30, 30, 47, 0.95)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:2,px:2,py:1},children:e.jsxs(C,{variant:"body2",sx:{opacity:.8},children:[r+1," из ",t.length]})})]})})})})),ot=ze().shape({content:De().max(2e3,"Message is too long").test("content-or-images","Message cannot be empty",function(){return!0})}),we=15*1024*1024,J=5,ke=["image/jpeg","image/jpg","image/png","image/gif","image/webp"],st=({activeChannel:a,canSendMessages:t,sending:r,replyingToMessage:c,onSendMessage:b,onReplyCancel:l,onReplyClick:p})=>{var j;const d=o.useRef(null),m=o.useRef(null),k=o.useRef(null),[y,w]=o.useState([]),[I,v]=o.useState(null);o.useEffect(()=>{if(a&&d.current){d.current.focus();const s=d.current.value.length;d.current.setSelectionRange(s,s)}},[a]),o.useEffect(()=>{if(c&&d.current){d.current.focus();const s=d.current.value.length;d.current.setSelectionRange(s,s)}},[c]),o.useEffect(()=>{const s=i=>{i.key==="Escape"&&c&&l()};return document.addEventListener("keydown",s),()=>{document.removeEventListener("keydown",s)}},[c,l]),o.useEffect(()=>{const s=u=>{if(!u.clipboardData)return;const L=Array.from(u.clipboardData.items).filter(U=>U.type.startsWith("image/"));if(L.length===0||y.length>=J)return;u.preventDefault();const W=[];L.slice(0,J-y.length).forEach(U=>{const _=U.getAsFile();if(!_)return;if(y.some(O=>O.file.size===_.size&&O.file.type===_.type&&O.file.lastModified===_.lastModified)){console.log("Duplicate image detected, skipping");return}const h=new Date().getTime(),x=Math.random().toString(36).substring(2,8),f=_.type.split("/")[1]||"png",T=new File([_],`pasted-image-${h}-${x}.${f}`,{type:_.type,lastModified:_.lastModified||Date.now()}),P=ke.includes(T.type),N=T.size<=we,Q={file:T,preview:URL.createObjectURL(T),valid:P&&N,error:P?N?void 0:"Файл слишком большой (макс. 15MB)":"Неподдерживаемый формат файла"};W.push(Q)}),W.length>0&&w(U=>[...U,...W])},i=d.current;if(i)return i.addEventListener("paste",s),()=>{i.removeEventListener("paste",s)}},[y.length]),o.useEffect(()=>()=>{y.forEach(s=>URL.revokeObjectURL(s.preview))},[y]);const z=()=>{c&&p&&p(c.id)},F=s=>{var u;if(s.content&&s.content.trim())return E(s.content);const i=((u=s.attachments)==null?void 0:u.length)||0;return i>0?i===1?"📎 Вложение":i>=2&&i<=4?`📎 ${i} вложения`:`📎 ${i} вложений`:"📎 Вложение"},E=s=>s.length>150?!(s.indexOf(" ")!==-1)&&s.length>100?s.substring(0,100)+"...":s.substring(0,150)+"...":s,R=s=>{if(!s.target.files||!s.target.files.length)return;const i=Array.from(s.target.files);if(m.current&&(m.current.value=""),y.length>=J)return;const u=[];i.slice(0,J-y.length).forEach(g=>{if(y.some(S=>S.file.size===g.size&&S.file.type===g.type&&S.file.name===g.name&&S.file.lastModified===g.lastModified)){console.log("Duplicate file detected, skipping:",g.name);return}const W=ke.includes(g.type),U=g.size<=we,_={file:g,preview:URL.createObjectURL(g),valid:W&&U,error:W?U?void 0:"Файл слишком большой (макс. 15MB)":"Неподдерживаемый формат файла"};u.push(_)}),u.length>0&&w(g=>[...g,...u])},B=s=>{w(i=>{const u=[...i];return URL.revokeObjectURL(u[s].preview),u.splice(s,1),u})},A=()=>{m.current&&m.current.click()},M=s=>{v(s)};return e.jsxs(n,{sx:{p:2},children:[t?e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:1},children:[c&&e.jsxs(de,{sx:{p:"8px 16px",display:"flex",alignItems:"flex-start",gap:1,background:"rgba(30,30,47,0.95)",border:"1px solid rgba(149,128,255,0.25)",borderRadius:2,position:"relative",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",mb:1,pl:3,width:"100%"},children:[e.jsx(n,{sx:{position:"absolute",left:0,top:0,bottom:0,width:"4px",backgroundColor:"#00CFFF",borderTopLeftRadius:2,borderBottomLeftRadius:2}}),e.jsxs(n,{sx:{flex:1,cursor:"pointer"},onClick:z,children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(be,{sx:{color:"#00CFFF",fontSize:"0.9rem"}}),e.jsxs(C,{variant:"caption",sx:{color:"#00CFFF",fontWeight:600,display:"flex",alignItems:"center"},children:["Ответ ",(j=c.author)!=null&&j.login?`@${c.author.login}`:""]})]}),e.jsx(C,{variant:"body2",sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.85rem",lineHeight:1.4,wordBreak:"break-word"},children:F(c)})]}),e.jsx(X,{size:"small",onClick:l,sx:{color:"rgba(255,255,255,0.5)","&:hover":{color:"rgba(255,255,255,0.8)"}},children:e.jsx(ie,{fontSize:"small"})})]}),y.length>0&&e.jsxs(de,{sx:{p:2,background:"rgba(30,30,47,0.95)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:2,mb:1},children:[e.jsx(n,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:y.map((s,i)=>e.jsx(n,{sx:{width:{xs:"calc(33.33% - 8px)",sm:"calc(25% - 8px)",md:"calc(16.66% - 8px)"}},children:e.jsxs(n,{sx:{position:"relative",height:100,borderRadius:1,overflow:"hidden",border:s.valid?"1px solid rgba(255,255,255,0.1)":"1px solid #f44336","&:hover .image-remove-btn":{opacity:1}},children:[e.jsx(n,{component:"img",src:s.preview,alt:"Preview",onClick:()=>M(i),sx:{width:"100%",height:"100%",objectFit:"cover",cursor:"pointer"}}),!s.valid&&e.jsx(ae,{title:s.error||"Invalid image",children:e.jsx(n,{sx:{position:"absolute",top:5,left:5,bgcolor:"rgba(0,0,0,0.7)",borderRadius:"50%",width:24,height:24,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(et,{sx:{color:"#f44336",fontSize:"16px"}})})}),e.jsx(X,{className:"image-remove-btn",size:"small",onClick:()=>B(i),sx:{position:"absolute",top:5,right:5,bgcolor:"rgba(0,0,0,0.7)",color:"white",p:"4px",opacity:0,transition:"opacity 0.2s","&:hover":{bgcolor:"rgba(0,0,0,0.85)"}},children:e.jsx(ie,{sx:{fontSize:"16px"}})})]})},i))}),e.jsxs(n,{sx:{mt:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(C,{variant:"caption",sx:{color:"rgba(255,255,255,0.7)"},children:[y.length," / ",J," изображений"]}),y.length>1&&e.jsx(C,{variant:"caption",onClick:()=>{y.forEach(s=>URL.revokeObjectURL(s.preview)),w([])},sx:{color:"#1976D2",cursor:"pointer","&:hover":{textDecoration:"underline"}},children:"Очистить все"})]})]}),e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",multiple:!0,ref:m,onChange:R,style:{display:"none"},max:J.toString()}),e.jsx(de,{sx:{p:"8px 16px",display:"flex",alignItems:"center",gap:1,background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:3},children:e.jsx(he,{innerRef:k,initialValues:{content:""},validationSchema:ot,onSubmit:async(s,i)=>{const u=y.filter(g=>g.valid).map(g=>g.file);try{await b({content:s.content,images:u.length>0?u:void 0},i),y.forEach(g=>URL.revokeObjectURL(g.preview)),w([])}catch(g){console.error("Error sending message:",g)}},children:({handleSubmit:s,values:i})=>e.jsxs(e.Fragment,{children:[e.jsx(me,{style:{width:"100%"},children:e.jsx(ye,{name:"content",component:Ie,placeholder:"Type a message...",multiline:!0,maxRows:4,size:"small",disabled:!a||r,inputRef:d,sx:{"& .MuiOutlinedInput-root":{"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"},"& .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"}}},onKeyDown:u=>{u.key==="Enter"&&!u.shiftKey&&(u.preventDefault(),s())}})}),e.jsxs(We,{direction:"row",spacing:1,children:[e.jsx(X,{size:"small",sx:{color:"#FF69B4"},children:e.jsx(Ze,{})}),e.jsx(ae,{title:y.length>=J?`Максимум ${J} изображений`:"Прикрепить изображения",children:e.jsxs(n,{children:["  ",e.jsx(X,{size:"small",sx:{color:y.length>=J?"rgba(255,255,255,0.3)":"#1E90FF"},onClick:A,disabled:y.length>=J,children:e.jsx(tt,{})})]})}),e.jsx(X,{size:"small",sx:{color:i.content||y.length>0?"#1976D2":"rgba(255,255,255,0.3)",transition:"color 0.25s cubic-bezier(.4,0,.2,1)","&:hover":{color:i.content||y.length>0?"#1976D2":"rgba(255,255,255,0.3)"}},onClick:()=>s(),disabled:r||!i.content&&y.length===0,children:e.jsx(Le,{})})]})]})})})]}):e.jsx(de,{sx:{p:"12px 16px",display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:3},children:e.jsx(C,{sx:{color:"rgba(255,255,255,0.5)",fontSize:"0.9rem"},children:"Недостаточно прав для отправки сообщений"})}),e.jsx(rt,{open:I!==null,images:y,currentIndex:I||0,onClose:()=>v(null),onNavigate:v})]})},bt=({activeChannel:a,canSendMessages:t,sending:r,replyingToMessage:c,onSendMessage:b,onReplyCancel:l,onReplyClick:p})=>e.jsx(st,{activeChannel:a,canSendMessages:t,sending:r,replyingToMessage:c,onSendMessage:b,onReplyCancel:l,onReplyClick:p}),ft=()=>{const[a,t]=o.useState(null),[r,c]=o.useState(null),[b,l]=o.useState(!0),[p,d]=o.useState(!0),[m,k]=o.useState(!1),[y,w]=o.useState("initial"),[I,v]=o.useState(!1),[z,F]=o.useState(!1),[E,R]=o.useState(null),B=o.useRef(!1),A=o.useRef(null),M=o.useRef(null),j=o.useRef(null),s=o.useRef(!1),i=o.useRef(!1),u=o.useCallback(x=>{j.current&&(clearTimeout(j.current),j.current=null),B.current=x,x&&(j.current=setTimeout(()=>{console.warn("[Pagination] Loading timeout - resetting loading state after 10 seconds"),B.current=!1,w(null),j.current=null},1e4))},[]),g=o.useCallback((x,f,T)=>{if(z)return;if(!(B.current||y==="initial"||y==="around"||!s.current)){if(x.scrollTop/x.scrollHeight<.2&&b){u(!0),w("pagination");const O=[...f].sort((G,D)=>new Date(G.created_at).getTime()-new Date(D.created_at).getTime())[0];O&&A.current!==O.id?(t(O.id),A.current=O.id,c(null),M.current=null,v(!1)):O&&(u(!1),w(null))}if(m&&!i.current&&p&&f.length>=T&&x.scrollHeight-x.scrollTop-x.clientHeight<100){u(!0),w("pagination");const O=[...f].sort((D,$)=>new Date(D.created_at).getTime()-new Date($.created_at).getTime()),G=O[O.length-1];G&&M.current!==G.id?(c(G.id),M.current=G.id,t(null),A.current=null,v(!1),i.current=!0):G&&(u(!1),w(null))}}},[z,y,b,p,m,u]),L=o.useCallback(()=>{t(null),c(null),l(!0),d(!0),k(!1),w("initial"),v(!1),F(!1),R(null),u(!1),A.current=null,M.current=null,s.current=!1,i.current=!1},[u]),W=o.useCallback(x=>{F(!0),R(x),w("around"),v(!0),t(null),c(null),A.current=null,M.current=null,u(!1)},[u]),U=o.useCallback(x=>{s.current=x},[]),_=o.useCallback(()=>{i.current=!1},[]);o.useEffect(()=>()=>{j.current&&clearTimeout(j.current)},[]);const S=o.useMemo(()=>({beforeId:a,afterId:r,hasMoreMessages:b,hasMoreMessagesAfter:p,enableAfterPagination:m,loadingMode:y,skipMainQuery:I,isJumpingToMessage:z,aroundMessageId:E}),[a,r,b,p,m,y,I,z,E]),h=o.useMemo(()=>({setBeforeId:t,setAfterId:c,setHasMoreMessages:l,setHasMoreMessagesAfter:d,setEnableAfterPagination:k,setLoadingMode:w,setSkipMainQuery:v,setIsJumpingToMessage:F,setAroundMessageId:R,handleScrollPagination:g,resetPagination:L,jumpToMessage:W,setInitialLoadComplete:U,clearAfterPaginationCooldown:_}),[g,L,W,U,_]);return{state:S,actions:h,isLoadingMoreRef:B,lastBeforeIdRef:A,lastAfterIdRef:M,setLoadingWithTimeout:u}},ht=({activeChannel:a})=>{const t=o.useRef(new Set),r=o.useCallback(l=>{t.current.add(l)},[]),c=o.useCallback(l=>{a&&t.current.add(l)},[a]),b=o.useCallback(()=>{a&&ge.publish(`/app/v1/channels/${a.id}/messages/bulk-read-all`,{})},[a]);return o.useEffect(()=>{if(!a)return;const l=()=>{if(t.current.size>0){const d=Array.from(t.current);ge.publish(`/app/v1/channels/${a.id}/messages/bulk-read`,{messageIds:d}),t.current.clear()}},p=setInterval(l,1e3);return()=>{clearInterval(p),l()}},[a]),{unreadMessagesBufferRef:t,markMessageAsRead:c,markAllMessagesAsRead:b,addToReadBuffer:r}},mt=({messagesContainerRef:a,messages:t,activeChannel:r,onScrollToBottom:c,onMarkAllAsRead:b,bulkReadAllRef:l,paginationActions:p,messagesPerPage:d=20})=>{const[m,k]=o.useState(!0),[y,w]=o.useState(!1),[I,v]=o.useState(!1),[z,F]=o.useState(null),[E,R]=o.useState(!1),[B,A]=o.useState(!1),M=o.useRef(null),j=o.useRef(null),s=o.useRef(0),i=o.useRef(0),u=o.useRef(0),g=o.useRef(!1),L=o.useCallback(()=>{const h=a.current;h&&(s.current=h.scrollHeight,i.current=h.scrollTop)},[a]),W=o.useCallback((h=!1)=>{if(!a.current||E)return;const x=a.current;requestAnimationFrame(()=>{if(h||B){const f=x.style.scrollBehavior;x.style.scrollBehavior="auto",x.scrollTop=x.scrollHeight,x.style.scrollBehavior=f}else x.scrollTop=x.scrollHeight;w(!1),setTimeout(()=>{x.scrollTop<x.scrollHeight-x.clientHeight-100&&(x.scrollTop=x.scrollHeight)},100)})},[E,B,a]),U=o.useCallback(h=>{if(!a.current)return;const x=document.getElementById(`message-${h}`);if(!x)return;R(!0);const f=a.current,T=x.offsetTop,P=x.offsetHeight,N=f.clientHeight,Q=T-N/2+P/2;f.scrollTop=Math.max(0,Q),x.style.transition="background-color 0.3s ease-in-out",x.style.backgroundColor="rgba(0, 207, 255, 0.1)",j.current&&clearTimeout(j.current),j.current=setTimeout(()=>{x&&(x.style.backgroundColor=""),R(!1),f.scrollTop+f.clientHeight>=f.scrollHeight-20&&W()},2e3)},[a,W]),_=o.useCallback(()=>{W(),b&&r&&b()},[r,b,W]),S=h=>{const x=new Date(h),f=new Date,T=new Date(f);if(T.setDate(T.getDate()-1),x.toDateString()===f.toDateString())return"Сегодня";if(x.toDateString()===T.toDateString())return"Вчера";const P=x.getFullYear()===f.getFullYear(),N=x.toLocaleDateString([],{weekday:"long",day:"numeric",month:"long",...P?{}:{year:"numeric"}});return N.charAt(0).toUpperCase()+N.slice(1)};return o.useEffect(()=>{const h=a.current;if(!h)return;let x=h.scrollTop,f=null,T=0;const P=()=>{g.current||(g.current=!0,requestAnimationFrame(()=>{f&&clearTimeout(f);const N=h.scrollTop,O=h.scrollHeight-N-h.clientHeight<100;if(N<x)p&&d&&p.handleScrollPagination(h,t,d);else if(N>x&&O&&!m){k(!0);const $=Date.now();b&&(l!=null&&l.current)&&$-T>1e3&&$-l.current>1e3&&(T=$,l.current=$,b())}x=N,k(O),w(h.scrollTop+h.clientHeight<h.scrollHeight-400),M.current&&clearTimeout(M.current);const G=h.querySelectorAll(".message-item");if(!G.length)return;let D=null;G.forEach($=>{const q=$.getBoundingClientRect(),V=h.getBoundingClientRect();if(q.top>=V.top&&q.bottom<=V.bottom&&!D){const Z=$.getAttribute("data-date");Z&&(D=S(Z))}}),D&&(F(D),v(!0),M.current=setTimeout(()=>{v(!1)},1e3)),f=setTimeout(()=>{f=null},150),g.current=!1}))};return h.addEventListener("scroll",P),()=>{h.removeEventListener("scroll",P),M.current&&clearTimeout(M.current),f&&clearTimeout(f)}},[r,t,a,b,l,p,d]),o.useEffect(()=>{const h=a.current;if(!h)return;const x=t.length,f=u.current;if(x>f&&f>0){const T=h.scrollHeight-s.current;if(T>0){const P=i.current+T;h.scrollTop=P}}u.current=x,s.current=h.scrollHeight,i.current=h.scrollTop},[t.length,a]),o.useEffect(()=>{m&&c&&c()},[m,c]),o.useEffect(()=>()=>{j.current&&clearTimeout(j.current),M.current&&clearTimeout(M.current)},[]),{isScrolledToBottom:m,setIsScrolledToBottom:k,showScrollButton:y,setShowScrollButton:w,showDateLabel:I,setShowDateLabel:v,currentDateLabel:z,setCurrentDateLabel:F,disableAutoScroll:E,setDisableAutoScroll:R,scrollToBottom:W,scrollToMessage:U,handleScrollToBottom:_,prepareScrollCorrection:L,setDisableSmoothScroll:A}},yt=({channelId:a,onSearchResultClick:t})=>{const[r,c]=o.useState(!1),[b,l]=o.useState(""),[p,d]=o.useState(""),[m,k]=o.useState(!1),[y,w]=o.useState(new Set),[I,v]=o.useState(null),[z,F]=o.useState(void 0),[E,R]=o.useState([]),[B,A]=o.useState(!0),M=o.useRef(null),j=o.useRef(null),s=o.useRef(null),i={channelId:a??0,search:p,size:20,...z&&{beforeId:z}},u=!a||!p||!r,{data:g,isLoading:L,isFetching:W}=Ue(i,{skip:u,refetchOnMountOrArgChange:!0}),U=W&&z!==void 0,_=o.useCallback(f=>{l(f),s.current&&clearTimeout(s.current),F(void 0),R([]),A(!0),s.current=setTimeout(()=>{d(f),f.trim()&&k(!0)},300)},[]),S=o.useCallback(f=>{c(!1),l(""),d(""),k(!1),w(new Set),v(null),t(f.id)},[t]),h=o.useCallback(()=>{c(!1),l(""),d(""),k(!1),w(new Set),v(null),F(void 0),R([]),A(!0)},[]),x=o.useCallback(()=>{if(B&&!U&&E.length>0){const f=E[E.length-1];console.log("Loading more, last message id:",f.id,"hasMore:",B),F(f.id)}},[B,U,E]);return o.useEffect(()=>{g?(R(z?f=>{const T=new Set(f.map(N=>N.id)),P=g.filter(N=>!T.has(N.id));return P.length===0&&A(!1),[...f,...P]}:g),A(g.length===20)):p||R([])},[g,z,p]),o.useEffect(()=>{r||(l(""),d(""),k(!1),F(void 0),R([]),A(!0))},[r]),o.useEffect(()=>{const f=T=>{m&&j.current&&M.current&&!j.current.contains(T.target)&&!M.current.contains(T.target)&&k(!1)};return document.addEventListener("mousedown",f),()=>{document.removeEventListener("mousedown",f)}},[m]),o.useEffect(()=>()=>{s.current&&clearTimeout(s.current)},[]),{searchMode:r,setSearchMode:c,searchQuery:b,setSearchQuery:l,debouncedSearchQuery:p,showSearchResults:m,setShowSearchResults:k,searchInputRef:M,searchResultsRef:j,highlightedMessages:y,setHighlightedMessages:w,focusedMessageId:I,setFocusedMessageId:v,searchResults:E,isSearching:L&&z===void 0,handleSearchInputChange:_,handleSearchResultClick:S,clearSearch:h,loadMore:x,hasMore:B,isLoadingMore:U}},Se=(a,t)=>{const r=o.useCallback(t,[t]);o.useEffect(()=>{if(!a)return;let c=!0;return c&&(async()=>{try{await ge.subscribe(a,r)}catch(l){console.error("Failed to setup WebSocket subscription:",l)}})(),()=>{c=!1,ge.unsubscribe(a,r)}},[a,r])};var se=(a=>(a[a.SENT=0]="SENT",a[a.READ=1]="READ",a[a.NEW=2]="NEW",a))(se||{});const jt=(a,t,r,c)=>{const b=o.useRef(0),l=o.useCallback(()=>{if(!a)return;const d=Date.now();d-b.current>1e3&&d-c.bulkReadAllRef.current>1e3&&(b.current=d,c.bulkReadAllRef.current=d,ge.publish(`/app/v1/channels/${a.id}/messages/bulk-read-all`,{}),r.onMarkAllAsRead())},[a,r.onMarkAllAsRead,c.bulkReadAllRef]),p=o.useCallback(d=>{if(d.type==="MESSAGE_CREATE"&&d.message){const m=c.convertToExtendedMessage(d.message);if(m.author.id===(t==null?void 0:t.id))return;if(r.onMessageCreate(m),r.onHighlightMessage(m.id,1500),m.status===se.NEW){const k=c.messagesContainerRef.current;if(k){const y=k.scrollHeight-k.scrollTop-k.clientHeight,w=y<100,I=y>300;w&&a?(c.addToReadBuffer(m.id),r.onMarkMessageAsRead(m.id),c.loadingMode!=="around"&&!c.isJumpingToMessage&&r.onScrollToBottom(),l()):I?(r.onNewMessageIndicator(!0),r.onUnreadMessage(m.id),setTimeout(()=>{const v=document.querySelector(`[data-msg-id="${m.id}"]`);if(v){const z=v.getBoundingClientRect();z.top>=0&&z.bottom<=window.innerHeight&&a&&(c.addToReadBuffer(m.id),r.onMarkMessageAsRead(m.id))}},100)):(c.addToReadBuffer(m.id),r.onMarkMessageAsRead(m.id),c.loadingMode!=="around"&&!c.isJumpingToMessage&&r.onScrollToBottom(),l())}}}else if(d.type==="MESSAGE_UPDATE"&&d.message){const m=c.convertToExtendedMessage(d.message);r.onMessageUpdate(m),m.status===se.READ&&r.onUnreadCountChange(-1)}else d.type==="MESSAGE_DELETE"&&d.messageId?(r.onMessageDelete(d.messageId),r.onUnreadCountChange(-1)):d.type==="MESSAGE_READ_STATUS"&&d.message_range&&r.onMessageReadStatus(d.message_range)},[t==null?void 0:t.id,a,c.convertToExtendedMessage,c.isJumpingToMessage,c.loadingMode,c.messagesContainerRef,c.addToReadBuffer,r.onMessageCreate,r.onMessageUpdate,r.onMessageDelete,r.onMessageReadStatus,r.onHighlightMessage,r.onUnreadMessage,r.onMarkMessageAsRead,r.onNewMessageIndicator,r.onScrollToBottom,l,r.onUnreadCountChange]);return Se(a&&t?`/v1/user/${t.id}/queue/channels/${a.id}/messages`:null,p),Se(a?`/v1/topic/channels/${a.id}/messages`:null,p),{}},wt=()=>{const[a,t]=o.useState([]),[r,c]=o.useState(new Map),[b,l]=o.useState(new Set),[p,d]=o.useState(0),[m,k]=o.useState(0),y=o.useCallback(s=>({...s,status:"status"in s?s.status:se.SENT,reply:s.reply?{...s.reply,status:"status"in s.reply?s.reply.status:se.SENT}:null}),[]),w=o.useCallback(()=>{t([]),c(new Map),l(new Set),d(0),k(0)},[]),I=o.useCallback((s,i)=>{t(u=>u.map(g=>g.id===s&&g.author.id!==i?{...g,status:se.READ}:g))},[]),v=o.useCallback(s=>{t(i=>i.map(u=>u.author.id!==s?{...u,status:se.READ}:u)),l(new Set),d(0),k(0)},[]),z=o.useCallback((s,i)=>{t(u=>u.map(g=>{if(g.id>=s.from&&g.id<=s.to&&g.author.id===i){const L=g.read_by_count||0;return{...g,read_by_count:L+1}}return g}))},[]),F=o.useCallback(s=>{t(i=>i.some(L=>L.id===s)?i.filter(L=>L.id!==s).map(L=>L.reply&&L.reply.id===s?{...L,reply:void 0}:L):i)},[]),E=o.useCallback(s=>{t(i=>i.some(g=>g.id===s.id)?i.map(g=>g.id===s.id?s:g):i)},[]),R=o.useCallback(s=>{t(i=>i.some(g=>g.id===s.id)?i:[...i,s])},[]),B=o.useCallback(s=>{l(i=>{const u=new Set(i);return u.add(s),u}),d(i=>i+1),k(i=>i+1)},[]),A=o.useCallback(s=>{l(i=>{const u=new Set(i);return u.delete(s),u}),d(i=>Math.max(0,i-1)),k(i=>Math.max(0,i-1))},[]),M=o.useCallback(s=>{d(i=>Math.max(0,i+s)),k(i=>Math.max(0,i+s))},[]),j=o.useCallback(()=>{d(0),k(0)},[]);return{messages:a,setMessages:t,tempMessages:r,setTempMessages:c,unreadMessages:b,setUnreadMessages:l,unreadCount:p,setUnreadCount:d,newMessagesCount:m,setNewMessagesCount:k,convertToExtendedMessage:y,resetMessageStates:w,updateMessageReadStatus:I,markAllMessagesAsReadInState:v,updateMessageReadByCount:z,deleteMessageFromState:F,updateMessageInState:E,addMessageToState:R,addUnreadMessage:B,removeUnreadMessage:A,updateUnreadCount:M,resetUnreadCounts:j}};export{bt as C,pt as D,se as M,xt as N,gt as S,ft as a,ht as b,mt as c,yt as d,jt as e,ut as f,wt as u};
