import{f as re,j as e,r,B as a,v as ce,aC as Te,az as pe,a5 as ue,T as B,R as se,U as Le,bv as Be,e as de,I as te,bw as qe,bx as Ye,Y as ve,M as Ae,Z as Ce,b3 as Me,O as _e,by as Ge,bz as Xe,S as Ke,X as Je,$ as Re,P as he,Q as Ze,bA as fe}from"./index-DLx8hl9i.js";import{I as $e}from"./Input-Dqn_Mi60.js";import{C as et}from"./Checkbox--JxRkKXc.js";const tt=re(e.jsx("path",{d:"m18 7-1.41-1.41-6.34 6.34 1.41 1.41zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12zM.41 13.41 6 19l1.41-1.41L1.83 12z"})),He=re(e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11"})),rt=re(e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"})),nt=re(e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"})),Ee=re([e.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"},"0"),e.jsx("path",{d:"M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"},"1")]),we=({signedUrl:s,alt:t="Image",sx:n,className:c,onClick:f,onLoadingChange:i})=>{const[g,d]=r.useState(!1),[u,j]=r.useState(!0),[x,m]=r.useState(!1),_=r.useRef(null);return r.useEffect(()=>{const C=_.current;if(!C)return;const F=new IntersectionObserver(W=>{W.forEach($=>{$.isIntersecting&&(m(!0),F.unobserve(C))})},{rootMargin:"500px",threshold:.1});return F.observe(C),()=>{F.disconnect()}},[]),r.useEffect(()=>{console.log("📷 SignedMediaImage props:",{signedUrl:s,alt:t,imageError:g,isLoading:u,shouldLoad:x})},[s,t,g,u,x]),r.useEffect(()=>{s&&x&&(d(!1),j(!0),i==null||i(!0))},[s,x,i]),r.useEffect(()=>{i==null||i(u)},[u,i]),!s||!x?e.jsx(a,{ref:_,sx:{width:"100%",height:"100%",...n},children:e.jsx(ce,{variant:"rectangular",animation:"wave",sx:{width:"100%",height:"100%",bgcolor:"rgba(255,255,255,0.1)","&::after":{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent)"}}})}):g?e.jsx(a,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"rgba(255,0,0,0.1)",color:"rgba(255,255,255,0.7)",fontSize:"0.875rem",border:"1px dashed rgba(255,0,0,0.3)",...n},children:"Ошибка загрузки"}):e.jsxs(a,{ref:_,sx:{width:"100%",height:"100%",position:"relative",...n},children:[u&&e.jsx(ce,{variant:"rectangular",animation:"wave",sx:{position:"absolute",width:"100%",height:"100%",zIndex:1,bgcolor:"rgba(255,255,255,0.1)","&::after":{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent)"}}}),e.jsx(a,{component:"img",className:c,src:s,alt:t,onClick:f,onLoad:()=>{console.log("✅ Image loaded successfully:",s),j(!1)},onError:C=>{console.error("❌ Image load error:",{signedUrl:s,error:C}),d(!0),j(!1)},sx:{width:"100%",height:"100%",objectFit:"cover",position:"relative",zIndex:2,display:u?"none":"block",willChange:"auto",backfaceVisibility:"hidden",transform:"translateZ(0)"}})]})},We=re(e.jsx("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"})),Ue=re(e.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"})),st=({open:s,images:t,currentIndex:n,signedUrls:c,onClose:f,onNavigate:i})=>(r.useEffect(()=>{const g=d=>{s&&(d.key==="Escape"?f():d.key==="ArrowLeft"&&n>0?i(n-1):d.key==="ArrowRight"&&n<t.length-1&&i(n+1))};return window.addEventListener("keydown",g),()=>window.removeEventListener("keydown",g)},[s,n,t.length,f,i]),e.jsx(Te,{open:s,onClose:f,sx:{display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(20px)",backgroundColor:"rgba(10, 10, 26, 0.85)"},children:e.jsx(pe,{in:s,children:e.jsx(a,{sx:{position:"relative",width:"100vw",height:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, rgba(13,13,26,0.95) 0%, rgba(26,26,46,0.95) 100%)",outline:"none"},onClick:f,children:t[n]&&e.jsxs(e.Fragment,{children:[e.jsx(a,{sx:{position:"relative",maxWidth:"90vw",maxHeight:"90vh",display:"flex",alignItems:"center",justifyContent:"center"},onClick:g=>g.stopPropagation(),children:e.jsx(we,{signedUrl:c==null?void 0:c.get(t[n]),alt:"Fullscreen preview",sx:{maxWidth:"100%",maxHeight:"90vh",objectFit:"contain",borderRadius:2,boxShadow:"0 20px 40px rgba(0,0,0,0.4)",width:"auto",height:"auto"}})}),n>0&&e.jsx(a,{onClick:g=>{g.stopPropagation(),i(n-1)},sx:{position:"absolute",left:40,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(-4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(We,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),n<t.length-1&&e.jsx(a,{onClick:g=>{g.stopPropagation(),i(n+1)},sx:{position:"absolute",right:40,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(Ue,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(a,{onClick:g=>{g.stopPropagation(),f()},sx:{position:"absolute",top:40,right:40,display:"flex",alignItems:"center",justifyContent:"center",width:48,height:48,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.1) 0%, rgba(255, 61, 113, 0.2) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 61, 113, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF3D71 0%, #FF69B4 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"scale(1.1) rotate(90deg)",boxShadow:"0 8px 32px rgba(255, 61, 113, 0.4)",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.2) 0%, rgba(255, 61, 113, 0.3) 100%)","&::before":{opacity:1}}},children:e.jsx(ue,{sx:{fontSize:24,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(a,{sx:{position:"absolute",bottom:40,left:"50%",transform:"translateX(-50%)",display:"flex",gap:1,alignItems:"center"},children:t.map((g,d)=>e.jsx(a,{onClick:u=>{u.stopPropagation(),i(d)},sx:{width:d===n?32:8,height:8,borderRadius:1,bgcolor:d===n?"#FF69B4":"rgba(255, 255, 255, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&:hover":{bgcolor:d===n?"#FF69B4":"rgba(255, 255, 255, 0.5)"}}},d))}),e.jsx(a,{sx:{position:"absolute",top:40,left:40,color:"white",bgcolor:"rgba(30, 30, 47, 0.95)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:2,px:2,py:1},children:e.jsxs(B,{variant:"body2",sx:{opacity:.8},children:[n+1," из ",t.length]})})]})})})})),ot=s=>new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),at=s=>{var n;if(s.content&&s.content.trim())return s.content;const t="attachments_count"in s?s.attachments_count:((n=s.attachments)==null?void 0:n.length)||0;return t>0?t===1?"📎 Вложение":t>=2&&t<=4?`📎 ${t} вложения`:`📎 ${t} вложений`:"📎 Вложение"},Oe=se.memo(s=>{const{message:t,isFirstInGroup:n=s.isFirstOfGroup||!1,isTempMessage:c=!1,isHighlighted:f=!1,isUnread:i=!1,isFocused:g=!1,isSearchMode:d=!1,searchQuery:u="",currentUserId:j,hubId:x=0,signedUrls:m,loadingMode:_=null,onReply:C,onEdit:F,onDelete:W,onReplyClick:$,onMouseEnter:w,onMouseLeave:U}=s,[z,E]=r.useState(!1),[S,o]=r.useState(null),[l,h]=r.useState(0),[p,I]=r.useState(!0),A=r.useRef(null),T=r.useRef(null),R=r.useRef(null),Y=t.attachments&&t.attachments.length>0;se.useEffect(()=>{Y&&(console.log("🖼️ ChatMessageItem - Message attachments:",t.attachments),console.log("🖼️ ChatMessageItem - SignedUrls map size:",m==null?void 0:m.size),t.attachments.forEach(M=>{const G=m==null?void 0:m.get(M);console.log(`🖼️ Storage key ${M} -> signed URL: ${G?"FOUND":"NOT FOUND"}`)}))},[Y,t.attachments,m]),r.useEffect(()=>()=>{R.current&&clearTimeout(R.current)},[]);const k=(M,G)=>{o(M),h(G)},b=()=>{t.reply&&$&&$(t.reply.id)},y=()=>{t&&C&&C(t)},H=()=>{F&&F(t.id)},D=()=>{W&&W(t.id)};return e.jsxs(e.Fragment,{children:[e.jsxs(a,{ref:A,id:`message-${t.id}`,className:"message-item","data-date":t.created_at,"data-msg-id":t.id.toString(),onMouseEnter:M=>{R.current&&(clearTimeout(R.current),R.current=null),E(!0),w&&w(M,t)},onMouseLeave:M=>{R.current=setTimeout(()=>{E(!1),R.current=null},150),U&&U(M)},sx:{position:"relative",mt:n?3:.5,overflow:"visible"},children:[e.jsxs(a,{sx:{contentVisibility:"auto",display:"flex",gap:2,alignItems:"flex-start",position:"relative",borderRadius:"10px",willChange:"auto",transition:"background-color 0.3s ease, box-shadow 0.5s ease",opacity:c?.6:1,px:1.5,py:.5,overflow:"visible",backgroundColor:g?"rgba(0, 207, 255, 0.25)":f?"rgba(33, 150, 243, 0.25)":i?"rgba(25,118,210,0.1)":z?"rgba(255,255,255,0.05)":"transparent","&.highlight-pulse":{animation:"pulse 2s infinite"}},children:[e.jsx(a,{sx:{width:40,display:"flex",flexDirection:"column",alignItems:"center",mt:1},children:n?e.jsx("div",{style:{cursor:"pointer"},children:e.jsx(Le,{src:t.author.avatar||void 0,alt:t.author.login,userId:t.author.id,hubId:x})}):null}),e.jsxs(a,{sx:{flex:1,position:"relative"},children:[e.jsx(a,{sx:{maxWidth:"99%"},children:e.jsxs(a,{sx:{py:"5px",px:"0px",pl:0},children:[n&&e.jsx(B,{sx:{color:"#00CFFF",fontWeight:700,mb:.5,fontSize:"1rem",letterSpacing:.2},children:t.author.login}),t.reply&&e.jsx(a,{sx:{mb:.8,mt:.25},children:e.jsxs(a,{sx:{display:"flex",flexDirection:"column",borderRadius:"8px",padding:"6px 10px",ml:0,background:"rgba(0, 207, 255, 0.06)",borderLeft:"3px solid #00CFFF",cursor:"pointer",transition:"all 0.2s ease","&:hover":{background:"rgba(0, 207, 255, 0.1)",transform:"translateX(2px)"}},onClick:b,children:[e.jsx(a,{sx:{display:"flex",alignItems:"center",gap:.5},children:e.jsx(B,{sx:{color:"#00CFFF",fontSize:"0.75rem",fontWeight:"600",letterSpacing:.3},children:t.reply.author.login})}),e.jsx(B,{sx:{color:"rgba(255,255,255,0.6)",fontSize:"0.8rem",mt:.2,lineHeight:1.3,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"400px"},children:at(t.reply)})]})})]})}),Y&&e.jsx(a,{sx:{mt:1.5,mb:1},children:(()=>{var G;const M=((G=t.attachments)==null?void 0:G.length)||0;if(M===1){const v=m==null?void 0:m.get(t.attachments[0]);return console.log(`🖼️ Single image - Storage key: ${t.attachments[0]}, Signed URL: ${v}`),e.jsx(a,{sx:{position:"relative",borderRadius:3,overflow:"hidden",maxWidth:"450px",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 8px 32px rgba(0,0,0,0.12)",background:"linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%)",border:"1px solid rgba(255,255,255,0.08)",willChange:"transform","&:hover":{transform:"translateY(-4px)",boxShadow:"0 20px 40px rgba(0,0,0,0.2)",border:"1px solid rgba(0, 207, 255, 0.3)","& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>k(t.attachments[0],0),children:e.jsxs(a,{sx:{position:"relative",width:"100%",paddingTop:p?"75%":"0",height:p?"auto":"300px",backgroundColor:"rgba(255,255,255,0.02)",transition:"all 0.3s ease","& > *":{position:"absolute",top:0,left:0,width:"100%",height:"100%"}},children:[e.jsx(we,{signedUrl:v,className:"attachment-image",alt:"Attachment",onLoadingChange:I,sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)",willChange:"transform",backfaceVisibility:"hidden"}},`${t.attachments[0]}-${v?"loaded":"loading"}`),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(3px)"},children:e.jsx(Ee,{sx:{color:"white",fontSize:"36px",filter:"drop-shadow(0 2px 8px rgba(0,0,0,0.4))"}})})]})})}return e.jsx(a,{sx:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:1,maxWidth:"400px"},children:t.attachments.slice(0,4).map((v,N)=>{const L=m==null?void 0:m.get(v);return e.jsxs(a,{sx:{position:"relative",borderRadius:2,overflow:"hidden",aspectRatio:"1",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.05)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.08)"}}},onClick:()=>k(v,N),children:[e.jsx(we,{signedUrl:L,className:"attachment-image",alt:"Attachment",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}},`${v}-${L?"loaded":"loading"}`),e.jsx(a,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(2px)"},children:e.jsx(Ee,{sx:{color:"white",fontSize:"28px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(a,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,backdropFilter:"blur(6px)",border:"1px solid rgba(255,255,255,0.15)"},children:[N+1,"/",M]})]},N)})})})()}),e.jsxs(a,{sx:{display:"flex",flexDirection:"column",position:"relative"},children:[t.content&&e.jsx(B,{sx:{color:"rgba(255,255,255,0.85)",wordBreak:"break-word",fontSize:"1.01rem",whiteSpace:"pre-wrap",pr:"120px",pl:0,lineHeight:1.4},component:"span",dangerouslySetInnerHTML:{__html:Be.sanitize((()=>{let M=t.content.replace(/\r\n/g,`
`).replace(/\n/g,"<br>");if(d&&u.trim()){const v=u.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),N=new RegExp(`(${v})`,"gi");M=M.replace(N,'<span style="background-color: rgba(0, 207, 255, 0.3); color: #fff; border-radius: 2px; padding: 0; font-weight: 600;">$1</span>')}return M})())}}),e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:.5,position:"absolute",top:0,right:0,padding:"0 8px",transition:"all 0.3s ease"},children:[t.last_modified_at&&t.last_modified_at!==t.created_at&&e.jsx("span",{style:{color:"#90caf9",fontSize:"0.85em",fontStyle:"italic",fontWeight:500},children:"ред."}),t.author.id===j&&e.jsx(a,{sx:{display:"flex",alignItems:"center",gap:.5,mr:.5},children:e.jsx(tt,{sx:{fontSize:"1rem",color:t.read_by_count&&t.read_by_count>0?"#FF69B4":"rgba(255,255,255,0.35)"}})}),e.jsx(B,{sx:{color:"rgba(255,255,255,0.35)",fontSize:"0.78rem",lineHeight:1,whiteSpace:"nowrap",display:"flex",alignItems:"center",gap:.5},children:ot(t.created_at)})]})]})]})]}),z&&e.jsx(a,{ref:T,sx:{position:"absolute",top:"-30px",right:"50%",transform:"translateX(50%)",zIndex:10},onMouseEnter:()=>{R.current&&(clearTimeout(R.current),R.current=null),E(!0)},onMouseLeave:()=>{R.current=setTimeout(()=>{E(!1),R.current=null},150)},children:e.jsxs(a,{sx:{display:"flex",gap:.5,padding:"6px 8px",borderRadius:"20px",background:"rgba(20, 20, 35, 0.95)",backdropFilter:"blur(12px)",border:"1px solid rgba(255, 255, 255, 0.1)",boxShadow:"0 8px 24px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.05)"},children:[e.jsx(de,{title:"Ответить",placement:"top",children:e.jsx(te,{size:"small",onClick:y,sx:{color:"#00CFFF",transition:"all 0.2s ease","&:hover":{color:"#E5FBFF",transform:"scale(1.1)",backgroundColor:"rgba(0, 207, 255, 0.1)"}},children:e.jsx(He,{fontSize:"small"})})}),t.author.id===j&&e.jsxs(e.Fragment,{children:[e.jsx(de,{title:"Редактировать",placement:"top",children:e.jsx(te,{size:"small",onClick:H,sx:{color:"#00CFFF",transition:"all 0.2s ease","&:hover":{color:"#E5FBFF",transform:"scale(1.1)",backgroundColor:"rgba(0, 207, 255, 0.1)"}},children:e.jsx(rt,{fontSize:"small"})})}),e.jsx(de,{title:"Удалить",placement:"top",children:e.jsx(te,{size:"small",onClick:D,sx:{color:"#FF3D71",transition:"all 0.2s ease","&:hover":{color:"#FF708D",transform:"scale(1.1)",backgroundColor:"rgba(255, 61, 113, 0.1)"}},children:e.jsx(nt,{fontSize:"small"})})})]})]})})]}),e.jsx(st,{open:!!S,images:t.attachments||[],currentIndex:l,signedUrls:m,onClose:()=>o(null),onNavigate:M=>{h(M),o(t.attachments[M])}})]})});Oe.displayName="ChatMessageItemWithSignedUrls";const Pe=re(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"})),it=Ae().shape({content:_e().min(1,"Message cannot be empty").max(2e3,"Message is too long")}),lt=s=>{const t=new Date(s),n=new Date,c=new Date(n);if(c.setDate(c.getDate()-1),t.toDateString()===n.toDateString())return"Сегодня";if(t.toDateString()===c.toDateString())return"Вчера";const f=t.getFullYear()===n.getFullYear(),i=t.toLocaleDateString([],{weekday:"long",day:"numeric",month:"long",...f?{}:{year:"numeric"}});return i.charAt(0).toUpperCase()+i.slice(1)},jt=({activeChannel:s,messages:t,tempMessages:n,searchMode:c,searchQuery:f,highlightedMessages:i,focusedMessageId:g,unreadMessages:d,isLoadingMore:u,isLoadingAround:j,editingMessageId:x,user:m,hubId:_,signedUrls:C,paginationState:F,messagesPerPage:W,showDateLabel:$,currentDateLabel:w,messagesContainerRef:U,messagesEndRef:z,editInputRef:E,highlightTimeoutRef:S,scrollToMessageIdRef:o,hoverTimeoutRef:l,isHoveringPortal:h,scrollCorrectionRef:p,forceScrollToMessageId:I,setHighlightedMessages:A,setFocusedMessageId:T,setEditingMessageId:R,setMessages:Y,setTempMessages:k,setReplyingToMessage:b,setHoveredMessage:y,setTargetMessageId:H,paginationActions:D,handleEditMessage:M,handleDeleteMessage:G})=>{const v=qe(),[N]=Ye(),L=se.useRef(null),q=se.useCallback(async O=>{if(!v||!O.length)return;const Q=[];if(O.forEach(V=>{V.attachments&&V.attachments.length>0&&Q.push(...V.attachments)}),Q.length!==0)try{const V=await v.getMultiple(Q),Z=[];if(Q.forEach(K=>{const J=V.get(K);J&&C?C.set(K,J):Z.push(K)}),Z.length>0){if(L.current){await L.current;return}const K=(async()=>{try{const J=await N({storage_keys:Z}).unwrap();if(J&&C){const P=Object.entries(J).map(([Se,oe])=>{const ye=oe.sign;return C.set(Se,ye),{storageKey:Se,signedUrl:ye,expiresAt:oe.expires_at}});P.length>0&&await v.setMultiple(P)}}catch(J){console.error("Failed to fetch signed URLs:",J)}finally{L.current=null}})();L.current=K,await K}}catch(V){console.error("Error processing message attachments:",V)}},[v,N,C]);se.useEffect(()=>{v&&!v.isReady()&&v.init()},[v]),se.useEffect(()=>{t.length>0&&v&&v.isReady()&&q(t)},[t,q,v]);const X=[...t].sort((O,Q)=>new Date(O.created_at).getTime()-new Date(Q.created_at).getTime()),xe=t.length===0&&n.size===0&&!u&&!!s&&e.jsx(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(B,{variant:"body1",color:"text.secondary",children:c?"No messages found matching your search.":"No messages yet. Start a conversation!"})}),Ve=O=>{if(X.some(V=>V.id===O)){const V=document.querySelector(`[data-msg-id='${O}']`);V&&(V.scrollIntoView({behavior:"smooth",block:"center"}),S.current&&(clearTimeout(S.current),S.current=null),T(null),A(new Set),T(O),A(()=>{const Z=new Set;return Z.add(O),Z}),S.current=setTimeout(()=>{A(Z=>{const K=new Set(Z);return K.delete(O),K}),T(null),S.current=null},1500))}else D.setIsJumpingToMessage(!0),D.setSkipMainQuery(!0),Y([]),k(new Map),D.setBeforeId(null),D.setAfterId(null),D.setHasMoreMessages(!0),D.setHasMoreMessagesAfter(!0),D.setEnableAfterPagination(!0),H(O),D.setAroundMessageId(O),D.setLoadingMode("around")},Ne=()=>e.jsx(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",color:"rgba(255,255,255,0.5)",textAlign:"center",gap:2},children:F.loadingMode==="around"||F.isJumpingToMessage||j?e.jsx(a,{sx:{width:"100%",height:"100%",overflowY:"auto",p:3,display:"flex",flexDirection:"column",gap:2},children:[...Array(W)].map((O,Q)=>e.jsxs(a,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[e.jsx(ce,{variant:"circular",width:40,height:40,sx:{bgcolor:"rgba(255,255,255,0.1)"}}),e.jsxs(a,{sx:{flex:1},children:[e.jsx(ce,{variant:"text",width:120,height:24,sx:{bgcolor:"rgba(255,255,255,0.1)",mb:1}}),e.jsx(ce,{variant:"text",width:"80%",height:20,sx:{bgcolor:"rgba(255,255,255,0.1)"}}),e.jsx(ce,{variant:"text",width:"60%",height:20,sx:{bgcolor:"rgba(255,255,255,0.1)"}})]})]},Q))}):c&&f&&f.trim()?e.jsxs(e.Fragment,{children:[e.jsx(B,{variant:"h6",children:"Нет результатов поиска"}),e.jsx(B,{variant:"body2",children:"Попробуйте изменить поисковый запрос"})]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{variant:"h6",children:"Нет сообщений"}),e.jsx(B,{variant:"body2",children:"Начните общение, отправив первое сообщение"})]})});return se.useEffect(()=>{const O=U.current;if(!O)return;let Q=!1;const V=()=>{Q||(Q=!0,requestAnimationFrame(()=>{if(O.scrollTop/O.scrollHeight<.2&&F.hasMoreMessages&&!F.isJumpingToMessage&&F.loadingMode!=="pagination"&&F.loadingMode!=="around"){const J=X[0];J&&(D.setBeforeId(J.id),D.setLoadingMode("pagination"))}Q=!1}))};return O.addEventListener("scroll",V,{passive:!0}),()=>O.removeEventListener("scroll",V)},[X,F,D]),se.useEffect(()=>{var Z;const O=U.current;if(!O)return;const Q=I??((o==null?void 0:o.current)||null);if(Q===null)return;const V=O.querySelector(`[data-msg-id="${Q}"]`);V&&(V.scrollIntoView({behavior:(Z=p==null?void 0:p.current)!=null&&Z.setDisableSmoothScroll?"auto":"smooth",block:"center"}),o&&(o.current=null),g!==Q&&(A(K=>{const J=new Set(K);return J.add(Q),J}),T&&T(Q),S.current&&clearTimeout(S.current),S.current=setTimeout(()=>{A(K=>{const J=new Set(K);return J.delete(Q),J}),T&&T(null)},1500)))},[t,I,o==null?void 0:o.current,g,S,A,T,p]),e.jsx(a,{ref:U,className:"messages-container",sx:{flex:1,p:3,overflowY:"auto",display:"flex",flexDirection:"column",gap:1,position:"relative","&::-webkit-scrollbar":{width:"8px"},"&::-webkit-scrollbar-track":{background:"rgba(255,255,255,0.05)",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.1)",borderRadius:"4px","&:hover":{background:"rgba(255,255,255,0.15)"}}},children:X.length===0&&n.size===0?Ne():e.jsxs(e.Fragment,{children:[xe,e.jsx(pe,{in:$,timeout:{enter:300,exit:500},children:e.jsx(a,{sx:{position:"sticky",top:10,zIndex:10,alignSelf:"center",background:"rgba(40, 45, 65, 0.9)",backdropFilter:"blur(16px) saturate(180%)",borderRadius:"20px",px:3,py:1.2,mb:1,minHeight:"36px",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 4px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05)",border:"1px solid rgba(255, 255, 255, 0.08)",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",overflow:"hidden","&::before":{content:'""',position:"absolute",top:0,left:0,right:0,height:"1px",background:"linear-gradient(90deg, transparent 0%, rgba(0, 207, 255, 0.3) 50%, transparent 100%)"},"&:hover":{transform:"translateY(-1px)",boxShadow:"0 6px 24px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.08)",background:"rgba(50, 55, 75, 0.95)"}},children:e.jsx(B,{sx:{color:"#E5FBFF",fontWeight:600,fontSize:"0.9rem",letterSpacing:"0.4px",textShadow:"0 0 16px rgba(0, 207, 255, 0.4)",whiteSpace:"nowrap"},children:w})})}),(()=>{let O=[],Q=null,V=[],Z=null,K=new Set;return[...X,...Array.from(n.values())].forEach(P=>{var Fe;const oe=new Date(P.created_at).toDateString();Z!==oe&&!K.has(oe)&&(V.length>0&&(O.push(...V),V=[]),O.push(e.jsx(a,{className:"date-separator","data-date":P.created_at,sx:{display:"flex",justifyContent:"center",alignItems:"center",my:2.5,position:"relative","&::before":{content:'""',position:"absolute",left:0,right:0,top:"50%",height:"1px",background:"linear-gradient(90deg, transparent 0%, rgba(0, 207, 255, 0.2) 30%, rgba(0, 207, 255, 0.2) 70%, transparent 100%)",transform:"translateY(-50%)"}},children:e.jsx(a,{sx:{position:"relative",background:"linear-gradient(135deg, rgba(0, 207, 255, 0.1) 0%, rgba(255, 105, 180, 0.08) 100%)",backdropFilter:"blur(10px)",border:"1px solid rgba(0, 207, 255, 0.25)",px:2,py:.5,borderRadius:"16px",boxShadow:"0 3px 12px rgba(0,0,0,0.1), 0 0 30px rgba(0, 207, 255, 0.08)",transition:"all 0.3s ease","&:hover":{transform:"translateY(-1px)",boxShadow:"0 4px 16px rgba(0,0,0,0.15), 0 0 40px rgba(0, 207, 255, 0.12)",border:"1px solid rgba(0, 207, 255, 0.35)"}},children:e.jsx(B,{variant:"body2",sx:{color:"#00CFFF",fontWeight:600,fontSize:"0.8rem",letterSpacing:"0.4px",background:"linear-gradient(90deg, #00CFFF 0%, #FF69B4 100%)",backgroundClip:"text",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},children:lt(P.created_at)})})},`date-${oe}`)),Z=oe,K.add(oe));const be="temp_id"in P,je=((Fe=P.author)==null?void 0:Fe.id)!==Q,Qe=x===P.id?e.jsxs(a,{id:`message-${P.id}`,className:"message-item","data-date":P.created_at,"data-msg-id":P.id.toString(),sx:{display:"flex",gap:2,alignItems:"flex-start",position:"relative",borderRadius:"10px",transition:"background-color 0.3s ease",opacity:be?.6:1},children:[e.jsx(a,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"flex-start",width:40,ml:1,mt:1},children:je?e.jsx("div",{style:{cursor:"pointer"},children:e.jsx(Le,{src:P.author.avatar||void 0,alt:P.author.login,userId:P.author.id,hubId:_})}):null}),e.jsx(a,{sx:{flex:1,position:"relative"},children:e.jsx(a,{sx:{maxWidth:"100%"},children:e.jsxs(a,{sx:{py:"5px",px:"0px",pl:0},children:[je&&e.jsx(B,{sx:{color:"#00CFFF",fontWeight:700,mb:.5,fontSize:"1rem",letterSpacing:.2},children:P.author.login}),e.jsx(ve,{initialValues:{content:P.content},validationSchema:it,onSubmit:M,children:({handleSubmit:ee,values:le})=>e.jsx(Ce,{children:e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:1,background:"rgba(30,30,47,0.9)",borderRadius:"8px",padding:"8px",border:"1px solid rgba(255,255,255,0.1)",boxShadow:"0 4px 12px rgba(0,0,0,0.2)"},children:[e.jsx(Me,{name:"content",component:$e,multiline:!0,fullWidth:!0,size:"small",inputRef:E,onKeyDown:ae=>{ae.key==="Enter"&&!ae.shiftKey?(ae.preventDefault(),ee()):ae.key==="Escape"&&(ae.preventDefault(),R(null))}}),e.jsxs(a,{sx:{display:"flex",gap:1,justifyContent:"flex-end",padding:"4px 8px"},children:[e.jsx(te,{size:"small",onClick:ae=>{ae.preventDefault(),R(null)},sx:{color:"#d32f2f","&:hover":{background:"rgba(211,47,47,0.1)"}},children:e.jsx(ue,{fontSize:"small"})}),e.jsx(te,{size:"small",onClick:ae=>ee(),disabled:!le.content,sx:{color:le.content?"#1976D2":"rgba(255,255,255,0.3)",transition:"color 0.25s cubic-bezier(.4,0,.2,1)","&:hover":{color:le.content?"#1976D2":"rgba(255,255,255,0.3)"}},children:e.jsx(Pe,{fontSize:"small"})})]})]})})})]})})})]},be?`temp-${P.created_at}`:P.id):e.jsx(Oe,{message:P,isFirstOfGroup:je,isTempMessage:be,isHighlighted:i.has(P.id),isUnread:d.has(P.id),isFocused:g===P.id,isSearchMode:c,searchQuery:f,currentUserId:m.id,hubId:_,signedUrls:C,loadingMode:F.loadingMode,onReply:ee=>{b(ee)},onEdit:ee=>R(typeof ee=="number"?ee:ee.id),onDelete:ee=>G(typeof ee=="number"?ee:ee.id),onReplyClick:Ve,onMouseEnter:(ee,le)=>{l!=null&&l.current&&(clearTimeout(l.current),l.current=null),y&&le&&y({element:ee.currentTarget,message:le})},onMouseLeave:()=>{l&&(l.current=setTimeout(()=>{!(h!=null&&h.current)&&y&&y(null)},100))}},be?`temp-${P.created_at}`:P.id);V.push(Qe),Q=P.author.id}),V.length>0&&O.push(...V),O})(),e.jsx("div",{ref:z})]})})},ke=re(e.jsx("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"})),ct=se.memo(({message:s,searchQuery:t,onResultClick:n})=>{const{highlightedContent:c,formattedTime:f}=r.useMemo(()=>{const d=new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1});let u=s.content;if(u.length>150&&(u=u.substring(0,150)+"..."),u=u.replace(/\r\n/g," ").replace(/\n/g," "),t.trim()){const x=t.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),m=new RegExp(`(${x})`,"gi");u=u.replace(m,"<mark>$1</mark>")}return{highlightedContent:Be.sanitize(u),formattedTime:d}},[s.content,s.created_at,t]),i=se.useCallback(()=>{n(s)},[s,n]);return e.jsxs(a,{onClick:i,onMouseDown:g=>g.preventDefault(),sx:{p:2,borderBottom:"1px solid rgba(255,255,255,0.05)",cursor:"pointer",transition:"background-color 0.2s ease","&:hover":{background:"rgba(255,255,255,0.1)"},"&:last-child":{borderBottom:"none"},contain:"layout style paint",contentVisibility:"auto",containIntrinsicSize:"0 80px"},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(B,{sx:{color:"#00CFFF",fontSize:"0.8rem",fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"150px"},children:s.author.login}),e.jsx(B,{sx:{color:"rgba(255,255,255,0.4)",fontSize:"0.7rem",ml:"auto"},children:f})]}),e.jsx(B,{sx:{color:"rgba(255,255,255,0.8)",fontSize:"0.85rem",lineHeight:1.4,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical","& mark":{background:"rgba(255, 105, 180, 0.3)",color:"#FF69B4",padding:"1px 2px",borderRadius:"2px",fontWeight:600}},dangerouslySetInnerHTML:{__html:c}})]})},(s,t)=>s.message.id===t.message.id&&s.message.content===t.message.content&&s.searchQuery===t.searchQuery),dt=({channelId:s,onSearchResultClick:t})=>{const[n,c]=r.useState(!1),[f,i]=r.useState(""),[g,d]=r.useState(""),[u,j]=r.useState(!1),[x,m]=r.useState(new Set),[_,C]=r.useState(null),[F,W]=r.useState(void 0),[$,w]=r.useState([]),[U,z]=r.useState(!0),E=r.useRef(null),S=r.useRef(null),o=r.useRef(null),l={channelId:s??0,search:g,size:20,...F&&{beforeId:F}},h=!s||!g||!n,{data:p,isLoading:I,isFetching:A}=Ge(l,{skip:h,refetchOnMountOrArgChange:!0}),T=A&&F!==void 0,R=r.useCallback(y=>{i(y),o.current&&clearTimeout(o.current),W(void 0),w([]),z(!0),o.current=setTimeout(()=>{d(y),y.trim()&&j(!0)},300)},[]),Y=r.useCallback(y=>{c(!1),i(""),d(""),j(!1),m(new Set),C(null),t(y.id)},[t]),k=r.useCallback(()=>{c(!1),i(""),d(""),j(!1),m(new Set),C(null),W(void 0),w([]),z(!0)},[]),b=r.useCallback(()=>{if(U&&!T&&$.length>0){const y=$[$.length-1];console.log("Loading more, last message id:",y.id,"hasMore:",U),W(y.id)}},[U,T,$]);return r.useEffect(()=>{p?(w(F?y=>{const H=new Set(y.map(M=>M.id)),D=p.filter(M=>!H.has(M.id));return D.length===0&&z(!1),[...y,...D]}:p),z(p.length===20)):g||w([])},[p,F,g]),r.useEffect(()=>{n||(i(""),d(""),j(!1),W(void 0),w([]),z(!0))},[n]),r.useEffect(()=>{const y=H=>{u&&S.current&&E.current&&!S.current.contains(H.target)&&!E.current.contains(H.target)&&j(!1)};return document.addEventListener("mousedown",y),()=>{document.removeEventListener("mousedown",y)}},[u]),r.useEffect(()=>()=>{o.current&&clearTimeout(o.current)},[]),{searchMode:n,setSearchMode:c,searchQuery:f,setSearchQuery:i,debouncedSearchQuery:g,showSearchResults:u,setShowSearchResults:j,searchInputRef:E,searchResultsRef:S,highlightedMessages:x,setHighlightedMessages:m,focusedMessageId:_,setFocusedMessageId:C,searchResults:$,isSearching:I&&F===void 0,handleSearchInputChange:R,handleSearchResultClick:Y,clearSearch:k,loadMore:b,hasMore:U,isLoadingMore:T}},ut=({activeChannelId:s})=>{const[t,n]=r.useState(!1),[c,f]=r.useState(""),[i,g]=r.useState(""),[d,u]=r.useState(!1),j=r.useRef(null),x=r.useRef(null),{searchResults:m,isSearching:_,hasMore:C,isLoadingMore:F,loadMore:W,clearSearch:$}=dt({channelId:s!==null?s:void 0,onSearchResultClick:()=>{}}),w=r.useCallback(Xe(S=>{g(S)},300),[]),U=r.useCallback(S=>{f(S),w(S),S.trim()&&u(!0)},[w]),z=r.useCallback(()=>{f(""),g(""),u(!1),$(),t||j.current&&(j.current.value="")},[t,$]),E=r.useCallback(S=>{u(!1),n(!1),z()},[z]);return r.useEffect(()=>{const S=o=>{x.current&&!x.current.contains(o.target)&&j.current&&!j.current.contains(o.target)&&u(!1)};return document.addEventListener("mousedown",S),()=>{document.removeEventListener("mousedown",S)}},[]),r.useEffect(()=>{z(),n(!1)},[s,z]),{searchMode:t,setSearchMode:n,searchQuery:c,searchResults:m,debouncedSearchQuery:i,isSearching:_,showSearchResults:d,setShowSearchResults:u,hasMore:C,isLoadingMore:F,searchInputRef:j,searchResultsRef:x,handleSearchInputChange:U,clearSearch:z,loadMore:W,handleResultClick:E}},wt=({activeChannelId:s,onSearchResultClick:t,searchMode:n,setSearchMode:c,searchQuery:f,searchInputRef:i,searchResultsRef:g,showSearchResults:d,setShowSearchResults:u,searchResults:j,isSearching:x,debouncedSearchQuery:m,handleSearchInputChange:_,clearSearch:C,loadMore:F,hasMore:W,isLoadingMore:$})=>{const w=ut({activeChannelId:s}),U=n!==void 0?n:w.searchMode,z=c||w.setSearchMode,E=f!==void 0?f:w.searchQuery,S=j||w.searchResults,o=m!==void 0?m:w.debouncedSearchQuery,l=x!==void 0?x:w.isSearching,h=d!==void 0?d:w.showSearchResults,p=u||w.setShowSearchResults,I=W!==void 0?W:w.hasMore,A=$!==void 0?$:w.isLoadingMore,T=i||w.searchInputRef,R=g||w.searchResultsRef,Y=_||w.handleSearchInputChange,k=C||w.clearSearch,b=F||w.loadMore,y=w.handleResultClick,H=r.useCallback(L=>{const q=L.currentTarget,{scrollHeight:X,scrollTop:ge,clientHeight:me}=q;X-ge-me<100&&b&&I&&!A&&b()},[b,I,A]),D=r.useCallback(L=>{t?t(L):y&&y(L)},[t,y]),M=(S==null?void 0:S.length)||0,G=r.useMemo(()=>`${M} ${M===1?"result":"results"}`,[M]);if(!U)return e.jsx(de,{title:"Поиск сообщений",placement:"top",children:e.jsx(te,{onClick:()=>{z(!0),requestAnimationFrame(()=>{var L;(L=T.current)==null||L.focus()})},sx:{color:"rgba(255,255,255,0.6)","&:hover":{color:"rgba(255,255,255,0.9)",background:"rgba(255,255,255,0.05)"}},children:e.jsx(Ke,{})})});const v=S&&S.length>0,N=h&&E.trim();return e.jsxs(a,{sx:{display:"flex",flexDirection:"column",position:"relative",zIndex:10001},children:[e.jsx(a,{sx:{display:"flex",alignItems:"center",background:"rgba(255,255,255,0.05)",borderRadius:N&&v?"20px 20px 0 0":"20px",border:"1px solid rgba(255,255,255,0.1)",borderBottom:N&&v?"none":"1px solid rgba(255,255,255,0.1)",paddingLeft:2,paddingRight:1,width:"300px",transition:"all 0.3s ease"},children:e.jsx(ve,{initialValues:{query:E},onSubmit:()=>{},enableReinitialize:!0,children:({setFieldValue:L})=>e.jsxs(Ce,{style:{width:"100%",display:"flex",alignItems:"center"},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",width:"100%",position:"relative"},children:[e.jsx(Me,{name:"query",children:({field:q})=>e.jsx("input",{...q,ref:T,onChange:X=>{q.onChange(X),Y(X.target.value)},onFocus:()=>{var X;(X=q.value)!=null&&X.trim()&&v&&p(!0)},placeholder:"Поиск сообщений...",style:{width:"100%",border:"none",outline:"none",background:"transparent",color:"#fff",fontSize:"0.9rem",padding:"8px 0"},onKeyDown:X=>{X.key==="Escape"&&(h?p(!1):k())}})}),E.trim()&&e.jsx(B,{variant:"caption",sx:{position:"absolute",right:0,top:"-18px",color:v?"#00FFBA":"#FF69B4",fontSize:"0.7rem",fontWeight:500,padding:"2px 6px",borderRadius:"4px",background:"rgba(0,0,0,0.3)"},children:G})]}),e.jsx(te,{type:"button",size:"small",onClick:()=>{h?p(!1):(k(),L("query",""))},sx:{color:"rgba(255,255,255,0.5)","&:hover":{color:"rgba(255,255,255,0.9)",background:"rgba(255,255,255,0.1)"}},children:h?e.jsx(ke,{fontSize:"small"}):e.jsx(ue,{fontSize:"small"})})]})})}),N&&e.jsxs(a,{ref:R,onMouseDown:L=>L.preventDefault(),onScroll:H,sx:{position:"absolute",top:"100%",left:0,width:"100%",maxHeight:"300px",background:"rgba(20, 20, 35, 0.98)",border:"1px solid rgba(255,255,255,0.1)",borderTop:"none",borderRadius:"0 0 20px 20px",overflowY:"auto",overflowX:"hidden",zIndex:10002,backdropFilter:"blur(15px)",boxShadow:"0 8px 32px rgba(0,0,0,0.6)",willChange:"scroll-position",contain:"layout style paint","&::-webkit-scrollbar":{width:"6px"},"&::-webkit-scrollbar-track":{background:"rgba(255,255,255,0.1)",borderRadius:"3px"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.3)",borderRadius:"3px","&:hover":{background:"rgba(255,255,255,0.5)"}}},children:[l&&e.jsxs(a,{sx:{p:2,display:"flex",justifyContent:"center",alignItems:"center"},children:[e.jsx(a,{sx:{width:24,height:24,border:"2px solid rgba(255,255,255,0.1)",borderTop:"2px solid #00CFFF",borderRadius:"50%",animation:"spin 1s linear infinite","@keyframes spin":{"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}}}}),e.jsx(B,{sx:{ml:1,color:"rgba(255,255,255,0.7)",fontSize:"0.9rem"},children:"Поиск..."})]}),!l&&S&&S.length===0&&o&&e.jsx(a,{sx:{p:3,textAlign:"center"},children:e.jsxs(B,{sx:{color:"rgba(255,255,255,0.5)",fontSize:"0.9rem"},children:["По запросу ",e.jsx(a,{component:"span",sx:{fontWeight:"bold",color:"#00CFFF"},children:o})," ничего не найдено"]})}),!l&&v&&S.map((L,q)=>e.jsx(ct,{message:L,searchQuery:o,onResultClick:D},`${L.id}-${q}`)),A&&e.jsxs(a,{sx:{p:2,display:"flex",justifyContent:"center",alignItems:"center"},children:[e.jsx(a,{sx:{width:20,height:20,border:"2px solid rgba(255,255,255,0.1)",borderTop:"2px solid #00CFFF",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsx(B,{sx:{ml:1,color:"rgba(255,255,255,0.5)",fontSize:"0.8rem"},children:"Загрузка..."})]})]})]})},kt=({open:s,messageToDelete:t,deleteForEveryone:n,canManageMessages:c,messages:f,userId:i,onClose:g,onConfirm:d,onDeleteForEveryoneChange:u})=>{const j=t?f.find(_=>_.id===t):null,m=j&&j.author.id===i||c;return e.jsx(Je,{open:s,onClose:g,title:"Удалить сообщение",children:e.jsxs(a,{sx:{p:2,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:[t&&e.jsxs(a,{sx:{mb:3,width:"100%",maxWidth:300},children:[m&&e.jsxs(a,{onClick:()=>u(!n),sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:1.5,mb:1.5,borderRadius:2,cursor:"pointer",backgroundColor:n?"rgba(255, 61, 113, 0.1)":"rgba(0,0,0,0.15)",border:`1px solid ${n?"rgba(255, 61, 113, 0.3)":"rgba(255,255,255,0.1)"}`,transition:"all 0.2s ease","&:hover":{backgroundColor:n?"rgba(255, 61, 113, 0.15)":"rgba(0,0,0,0.2)",transform:"translateY(-2px)"}},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",mb:.5},children:[e.jsx(et,{checked:n,onChange:_=>u(_.target.checked),sx:{color:"rgba(255,255,255,0.5)",p:.5,mr:1,"&.Mui-checked":{color:"#FF3D71"}}}),e.jsx(B,{sx:{fontWeight:500,fontSize:"0.9rem"},children:"Удалить у всех"})]}),e.jsx(B,{variant:"body2",sx:{color:"rgba(255,255,255,0.6)",fontStyle:"italic",fontSize:"0.75rem",textAlign:"center"},children:n?"Сообщение исчезнет у всех участников чата":"Сообщение останется видимым для других"})]}),e.jsx(B,{sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.75rem",textAlign:"center",mt:1},children:m?n?"":"Сообщение будет скрыто только в вашем интерфейсе":"Сообщение будет скрыто только для вас"})]}),e.jsxs(a,{sx:{display:"flex",gap:2,justifyContent:"center"},children:[e.jsx(Re,{variant:"outlined",onClick:g,sx:{color:"rgba(255,255,255,0.7)",borderColor:"rgba(255,255,255,0.2)",borderRadius:2,px:3,"&:hover":{borderColor:"rgba(255,255,255,0.4)",backgroundColor:"rgba(255,255,255,0.05)"}},children:"Отмена"}),e.jsx(Re,{variant:"contained",onClick:d,sx:{backgroundColor:"#FF3D71",color:"#fff",borderRadius:2,px:3,"&:hover":{backgroundColor:"#FF1744"}},children:"Удалить"})]})]})})},vt=({showScrollButton:s,newMessagesCount:t,unreadCount:n,replyingToMessage:c,onScrollToBottom:f})=>{const i=c?160:100;return e.jsxs(e.Fragment,{children:[e.jsx(pe,{in:s,children:e.jsx(te,{onClick:f,sx:{position:"absolute",bottom:i,right:20,backgroundColor:"rgba(30,30,47,0.95)",backdropFilter:"blur(8px)",border:"1px solid rgba(255,255,255,0.1)",boxShadow:"0 4px 12px rgba(0,0,0,0.2)","&:hover":{backgroundColor:"rgba(40,40,57,0.95)"},zIndex:1e3,transition:"bottom 0.2s ease-out"},children:e.jsx(ke,{sx:{color:"#fff"}})})}),e.jsx(pe,{in:t>0||n>0,children:e.jsx(a,{sx:{position:"absolute",bottom:i,left:"50%",transform:"translateX(-50%)",zIndex:1e3,transition:"bottom 0.2s ease-out"},children:e.jsxs(he,{sx:{backgroundColor:"#FF69B4",color:"#fff",px:2,py:1,borderRadius:"20px",cursor:"pointer",boxShadow:"0 4px 12px rgba(255,105,180,0.2)",display:"flex",alignItems:"center",gap:1,"&:hover":{backgroundColor:"#FF1493"}},onClick:f,children:[e.jsx(ke,{}),e.jsxs(B,{variant:"body2",sx:{fontWeight:600},children:[t||n," ",(t||n)===1?"новое сообщение":"новых сообщений"]})]})})})]})},gt=re(e.jsx("path",{d:"M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M8.5 8c.83 0 1.5.67 1.5 1.5S9.33 11 8.5 11 7 10.33 7 9.5 7.67 8 8.5 8M12 18c-2.28 0-4.22-1.66-5-4h10c-.78 2.34-2.72 4-5 4m3.5-7c-.83 0-1.5-.67-1.5-1.5S14.67 8 15.5 8s1.5.67 1.5 1.5-.67 1.5-1.5 1.5"})),ht=re(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-2h2zm0-4h-2V7h2z"})),pt=re(e.jsx("path",{d:"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2M8.5 13.5l2.5 3.01L14.5 12l4.5 6H5z"})),ft=({open:s,images:t,currentIndex:n,onClose:c,onNavigate:f})=>(r.useEffect(()=>{const i=g=>{s&&(g.key==="Escape"?c():g.key==="ArrowLeft"&&n>0?f(n-1):g.key==="ArrowRight"&&n<t.length-1&&f(n+1))};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[s,n,t.length,c,f]),e.jsx(Te,{open:s,onClose:c,sx:{display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(20px)",backgroundColor:"rgba(10, 10, 26, 0.85)"},children:e.jsx(pe,{in:s,children:e.jsx(a,{sx:{position:"relative",width:"90vw",height:"90vh",maxWidth:"1400px",maxHeight:"900px",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, rgba(13,13,26,0.98) 0%, rgba(26,26,46,0.98) 100%)",borderRadius:3,boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.8)",border:"1px solid rgba(255, 255, 255, 0.1)",outline:"none",overflow:"hidden"},onClick:c,children:t[n]&&e.jsxs(e.Fragment,{children:[e.jsx(a,{sx:{position:"relative",maxWidth:"calc(100% - 120px)",maxHeight:"calc(100% - 120px)",display:"flex",alignItems:"center",justifyContent:"center"},onClick:i=>i.stopPropagation(),children:e.jsx(a,{component:"img",src:t[n].preview,alt:"Fullscreen preview",sx:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain",borderRadius:2,boxShadow:"0 20px 40px rgba(0,0,0,0.4)"}})}),n>0&&e.jsx(a,{onClick:i=>{i.stopPropagation(),f(n-1)},sx:{position:"absolute",left:20,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(-4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(We,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),n<t.length-1&&e.jsx(a,{onClick:i=>{i.stopPropagation(),f(n+1)},sx:{position:"absolute",right:20,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(Ue,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(a,{onClick:i=>{i.stopPropagation(),c()},sx:{position:"absolute",top:20,right:20,display:"flex",alignItems:"center",justifyContent:"center",width:48,height:48,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.1) 0%, rgba(255, 61, 113, 0.2) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 61, 113, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF3D71 0%, #FF69B4 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"scale(1.1) rotate(90deg)",boxShadow:"0 8px 32px rgba(255, 61, 113, 0.4)",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.2) 0%, rgba(255, 61, 113, 0.3) 100%)","&::before":{opacity:1}}},children:e.jsx(ue,{sx:{fontSize:24,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(a,{sx:{position:"absolute",bottom:20,left:"50%",transform:"translateX(-50%)",display:"flex",gap:1,alignItems:"center"},children:t.map((i,g)=>e.jsx(a,{onClick:d=>{d.stopPropagation(),f(g)},sx:{width:g===n?32:8,height:8,borderRadius:1,bgcolor:g===n?"#FF69B4":"rgba(255, 255, 255, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&:hover":{bgcolor:g===n?"#FF69B4":"rgba(255, 255, 255, 0.5)"}}},g))}),e.jsx(a,{sx:{position:"absolute",top:20,left:20,color:"white",bgcolor:"rgba(30, 30, 47, 0.95)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:2,px:2,py:1},children:e.jsxs(B,{variant:"body2",sx:{opacity:.8},children:[n+1," из ",t.length]})})]})})})})),xt=Ae().shape({content:_e().max(2e3,"Message is too long").test("content-or-images","Message cannot be empty",function(){return!0})}),De=15*1024*1024,ne=5,ze=["image/jpeg","image/jpg","image/png","image/gif","image/webp"],bt=({activeChannel:s,canSendMessages:t,sending:n,replyingToMessage:c,onSendMessage:f,onReplyCancel:i,onReplyClick:g})=>{var S;const d=r.useRef(null),u=r.useRef(null),j=r.useRef(null),[x,m]=r.useState([]),[_,C]=r.useState(null);r.useEffect(()=>{if(s&&d.current){d.current.focus();const o=d.current.value.length;d.current.setSelectionRange(o,o)}},[s]),r.useEffect(()=>{if(c&&d.current){d.current.focus();const o=d.current.value.length;d.current.setSelectionRange(o,o)}},[c]),r.useEffect(()=>{const o=l=>{l.key==="Escape"&&c&&i()};return document.addEventListener("keydown",o),()=>{document.removeEventListener("keydown",o)}},[c,i]),r.useEffect(()=>{const o=h=>{if(!h.clipboardData)return;const I=Array.from(h.clipboardData.items).filter(T=>T.type.startsWith("image/"));if(I.length===0||x.length>=ne)return;h.preventDefault();const A=[];I.slice(0,ne-x.length).forEach(T=>{const R=T.getAsFile();if(!R)return;if(x.some(v=>v.file.size===R.size&&v.file.type===R.type&&v.file.lastModified===R.lastModified)){console.log("Duplicate image detected, skipping");return}const k=new Date().getTime(),b=Math.random().toString(36).substring(2,8),y=R.type.split("/")[1]||"png",H=new File([R],`pasted-image-${k}-${b}.${y}`,{type:R.type,lastModified:R.lastModified||Date.now()}),D=ze.includes(H.type),M=H.size<=De,G={file:H,preview:URL.createObjectURL(H),valid:D&&M,error:D?M?void 0:"Файл слишком большой (макс. 15MB)":"Неподдерживаемый формат файла"};A.push(G)}),A.length>0&&m(T=>[...T,...A])},l=d.current;if(l)return l.addEventListener("paste",o),()=>{l.removeEventListener("paste",o)}},[x.length]),r.useEffect(()=>()=>{x.forEach(o=>URL.revokeObjectURL(o.preview))},[x]);const F=()=>{c&&g&&g(c.id)},W=o=>{var h;if(o.content&&o.content.trim())return $(o.content);const l=((h=o.attachments)==null?void 0:h.length)||0;return l>0?l===1?"📎 Вложение":l>=2&&l<=4?`📎 ${l} вложения`:`📎 ${l} вложений`:"📎 Вложение"},$=o=>o.length>150?!(o.indexOf(" ")!==-1)&&o.length>100?o.substring(0,100)+"...":o.substring(0,150)+"...":o,w=o=>{if(!o.target.files||!o.target.files.length)return;const l=Array.from(o.target.files);if(u.current&&(u.current.value=""),x.length>=ne)return;const h=[];l.slice(0,ne-x.length).forEach(p=>{if(x.some(Y=>Y.file.size===p.size&&Y.file.type===p.type&&Y.file.name===p.name&&Y.file.lastModified===p.lastModified)){console.log("Duplicate file detected, skipping:",p.name);return}const A=ze.includes(p.type),T=p.size<=De,R={file:p,preview:URL.createObjectURL(p),valid:A&&T,error:A?T?void 0:"Файл слишком большой (макс. 15MB)":"Неподдерживаемый формат файла"};h.push(R)}),h.length>0&&m(p=>[...p,...h])},U=o=>{m(l=>{const h=[...l];return URL.revokeObjectURL(h[o].preview),h.splice(o,1),h})},z=()=>{u.current&&u.current.click()},E=o=>{C(o)};return e.jsxs(a,{sx:{p:2},children:[t?e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:1},children:[c&&e.jsxs(he,{sx:{p:"8px 16px",display:"flex",alignItems:"flex-start",gap:1,background:"rgba(30,30,47,0.95)",border:"1px solid rgba(149,128,255,0.25)",borderRadius:2,position:"relative",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",mb:1,pl:3,width:"100%"},children:[e.jsx(a,{sx:{position:"absolute",left:0,top:0,bottom:0,width:"4px",backgroundColor:"#00CFFF",borderTopLeftRadius:2,borderBottomLeftRadius:2}}),e.jsxs(a,{sx:{flex:1,cursor:"pointer"},onClick:F,children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(He,{sx:{color:"#00CFFF",fontSize:"0.9rem"}}),e.jsxs(B,{variant:"caption",sx:{color:"#00CFFF",fontWeight:600,display:"flex",alignItems:"center"},children:["Ответ ",(S=c.author)!=null&&S.login?`@${c.author.login}`:""]})]}),e.jsx(B,{variant:"body2",sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.85rem",lineHeight:1.4,wordBreak:"break-word"},children:W(c)})]}),e.jsx(te,{size:"small",onClick:i,sx:{color:"rgba(255,255,255,0.5)","&:hover":{color:"rgba(255,255,255,0.8)"}},children:e.jsx(ue,{fontSize:"small"})})]}),x.length>0&&e.jsxs(he,{sx:{p:2,background:"rgba(30,30,47,0.95)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:2,mb:1},children:[e.jsx(a,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:x.map((o,l)=>e.jsx(a,{sx:{width:{xs:"calc(33.33% - 8px)",sm:"calc(25% - 8px)",md:"calc(16.66% - 8px)"}},children:e.jsxs(a,{sx:{position:"relative",height:100,borderRadius:1,overflow:"hidden",border:o.valid?"1px solid rgba(255,255,255,0.1)":"1px solid #f44336","&:hover .image-remove-btn":{opacity:1}},children:[e.jsx(a,{component:"img",src:o.preview,alt:"Preview",onClick:()=>E(l),sx:{width:"100%",height:"100%",objectFit:"cover",cursor:"pointer"}}),!o.valid&&e.jsx(de,{title:o.error||"Invalid image",children:e.jsx(a,{sx:{position:"absolute",top:5,left:5,bgcolor:"rgba(0,0,0,0.7)",borderRadius:"50%",width:24,height:24,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(ht,{sx:{color:"#f44336",fontSize:"16px"}})})}),e.jsx(te,{className:"image-remove-btn",size:"small",onClick:()=>U(l),sx:{position:"absolute",top:5,right:5,bgcolor:"rgba(0,0,0,0.7)",color:"white",p:"4px",opacity:0,transition:"opacity 0.2s","&:hover":{bgcolor:"rgba(0,0,0,0.85)"}},children:e.jsx(ue,{sx:{fontSize:"16px"}})})]})},l))}),e.jsxs(a,{sx:{mt:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(B,{variant:"caption",sx:{color:"rgba(255,255,255,0.7)"},children:[x.length," / ",ne," изображений"]}),x.length>1&&e.jsx(B,{variant:"caption",onClick:()=>{x.forEach(o=>URL.revokeObjectURL(o.preview)),m([])},sx:{color:"#1976D2",cursor:"pointer","&:hover":{textDecoration:"underline"}},children:"Очистить все"})]})]}),e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",multiple:!0,ref:u,onChange:w,style:{display:"none"},max:ne.toString()}),e.jsx(he,{sx:{p:"8px 16px",display:"flex",alignItems:"center",gap:1,background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:3},children:e.jsx(ve,{innerRef:j,initialValues:{content:""},validationSchema:xt,onSubmit:async(o,l)=>{const h=x.filter(p=>p.valid).map(p=>p.file);try{await f({content:o.content,images:h.length>0?h:void 0},l),x.forEach(p=>URL.revokeObjectURL(p.preview)),m([])}catch(p){console.error("Error sending message:",p)}},children:({handleSubmit:o,values:l})=>e.jsxs(e.Fragment,{children:[e.jsx(Ce,{style:{width:"100%"},children:e.jsx(Me,{name:"content",component:$e,placeholder:"Type a message...",multiline:!0,maxRows:4,size:"small",disabled:!s||n,inputRef:d,sx:{"& .MuiOutlinedInput-root":{"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"},"& .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"}}},onKeyDown:h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),o())}})}),e.jsxs(Ze,{direction:"row",spacing:1,children:[e.jsx(te,{size:"small",sx:{color:"#FF69B4"},children:e.jsx(gt,{})}),e.jsx(de,{title:x.length>=ne?`Максимум ${ne} изображений`:"Прикрепить изображения",children:e.jsxs(a,{children:["  ",e.jsx(te,{size:"small",sx:{color:x.length>=ne?"rgba(255,255,255,0.3)":"#1E90FF"},onClick:z,disabled:x.length>=ne,children:e.jsx(pt,{})})]})}),e.jsx(te,{size:"small",sx:{color:l.content||x.length>0?"#1976D2":"rgba(255,255,255,0.3)",transition:"color 0.25s cubic-bezier(.4,0,.2,1)","&:hover":{color:l.content||x.length>0?"#1976D2":"rgba(255,255,255,0.3)"}},onClick:()=>o(),disabled:n||!l.content&&x.length===0,children:e.jsx(Pe,{})})]})]})})})]}):e.jsx(he,{sx:{p:"12px 16px",display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:3},children:e.jsx(B,{sx:{color:"rgba(255,255,255,0.5)",fontSize:"0.9rem"},children:"Недостаточно прав для отправки сообщений"})}),e.jsx(ft,{open:_!==null,images:x,currentIndex:_||0,onClose:()=>C(null),onNavigate:C})]})},Ct=({activeChannel:s,canSendMessages:t,sending:n,replyingToMessage:c,onSendMessage:f,onReplyCancel:i,onReplyClick:g})=>e.jsx(bt,{activeChannel:s,canSendMessages:t,sending:n,replyingToMessage:c,onSendMessage:f,onReplyCancel:i,onReplyClick:g}),Mt=()=>{const[s,t]=r.useState(null),[n,c]=r.useState(null),[f,i]=r.useState(!0),[g,d]=r.useState(!0),[u,j]=r.useState(!1),[x,m]=r.useState("initial"),[_,C]=r.useState(!1),[F,W]=r.useState(!1),[$,w]=r.useState(null),U=r.useRef(!1),z=r.useRef(null),E=r.useRef(null),S=r.useRef(null),o=r.useRef(!1),l=r.useRef(!1),h=r.useCallback(b=>{S.current&&(clearTimeout(S.current),S.current=null),U.current=b,b&&(S.current=setTimeout(()=>{console.warn("[Pagination] Loading timeout - resetting loading state after 10 seconds"),U.current=!1,m(null),S.current=null},1e4))},[]),p=r.useCallback((b,y,H)=>{if(F)return;if(!(U.current||x==="initial"||x==="around"||!o.current)){if(b.scrollTop/b.scrollHeight<.2&&f){h(!0),m("pagination");const v=[...y].sort((N,L)=>new Date(N.created_at).getTime()-new Date(L.created_at).getTime())[0];v&&z.current!==v.id?(t(v.id),z.current=v.id,c(null),E.current=null,C(!1)):v&&(h(!1),m(null))}if(u&&!l.current&&g&&y.length>=H&&b.scrollHeight-b.scrollTop-b.clientHeight<100){h(!0),m("pagination");const v=[...y].sort((L,q)=>new Date(L.created_at).getTime()-new Date(q.created_at).getTime()),N=v[v.length-1];N&&E.current!==N.id?(c(N.id),E.current=N.id,t(null),z.current=null,C(!1),l.current=!0):N&&(h(!1),m(null))}}},[F,x,f,g,u,h]),I=r.useCallback(()=>{t(null),c(null),i(!0),d(!0),j(!1),m("initial"),C(!1),W(!1),w(null),h(!1),z.current=null,E.current=null,o.current=!1,l.current=!1},[h]),A=r.useCallback(b=>{W(!0),w(b),m("around"),C(!0),t(null),c(null),z.current=null,E.current=null,h(!1)},[h]),T=r.useCallback(b=>{o.current=b},[]),R=r.useCallback(()=>{l.current=!1},[]);r.useEffect(()=>()=>{S.current&&clearTimeout(S.current)},[]);const Y=r.useMemo(()=>({beforeId:s,afterId:n,hasMoreMessages:f,hasMoreMessagesAfter:g,enableAfterPagination:u,loadingMode:x,skipMainQuery:_,isJumpingToMessage:F,aroundMessageId:$}),[s,n,f,g,u,x,_,F,$]),k=r.useMemo(()=>({setBeforeId:t,setAfterId:c,setHasMoreMessages:i,setHasMoreMessagesAfter:d,setEnableAfterPagination:j,setLoadingMode:m,setSkipMainQuery:C,setIsJumpingToMessage:W,setAroundMessageId:w,handleScrollPagination:p,resetPagination:I,jumpToMessage:A,setInitialLoadComplete:T,clearAfterPaginationCooldown:R}),[p,I,A,T,R]);return{state:Y,actions:k,isLoadingMoreRef:U,lastBeforeIdRef:z,lastAfterIdRef:E,setLoadingWithTimeout:h}},Ft=({activeChannel:s})=>{const t=r.useRef(new Set),n=r.useCallback(i=>{t.current.add(i)},[]),c=r.useCallback(i=>{s&&t.current.add(i)},[s]),f=r.useCallback(()=>{s&&fe.publish(`/app/v1/channels/${s.id}/messages/bulk-read-all`,{})},[s]);return r.useEffect(()=>{if(!s)return;const i=()=>{if(t.current.size>0){const d=Array.from(t.current);fe.publish(`/app/v1/channels/${s.id}/messages/bulk-read`,{messageIds:d}),t.current.clear()}},g=setInterval(i,1e3);return()=>{clearInterval(g),i()}},[s]),{unreadMessagesBufferRef:t,markMessageAsRead:c,markAllMessagesAsRead:f,addToReadBuffer:n}},Rt=({messagesContainerRef:s,messages:t,activeChannel:n,onScrollToBottom:c,onMarkAllAsRead:f,bulkReadAllRef:i,paginationActions:g,messagesPerPage:d=20})=>{const[u,j]=r.useState(!0),[x,m]=r.useState(!1),[_,C]=r.useState(!1),[F,W]=r.useState(null),[$,w]=r.useState(!1),[U,z]=r.useState(!1),E=r.useRef(null),S=r.useRef(null),o=r.useRef(0),l=r.useRef(0),h=r.useRef(0),p=r.useRef(!1),I=r.useCallback(()=>{const k=s.current;k&&(o.current=k.scrollHeight,l.current=k.scrollTop)},[s]),A=r.useCallback((k=!1)=>{if(!s.current||$)return;const b=s.current;requestAnimationFrame(()=>{if(k||U){const y=b.style.scrollBehavior;b.style.scrollBehavior="auto",b.scrollTop=b.scrollHeight,b.style.scrollBehavior=y}else b.scrollTop=b.scrollHeight;m(!1),setTimeout(()=>{b.scrollTop<b.scrollHeight-b.clientHeight-100&&(b.scrollTop=b.scrollHeight)},100)})},[$,U,s]),T=r.useCallback(k=>{if(!s.current)return;const b=document.getElementById(`message-${k}`);if(!b)return;w(!0);const y=s.current,H=b.offsetTop,D=b.offsetHeight,M=y.clientHeight,G=H-M/2+D/2;y.scrollTop=Math.max(0,G),b.style.transition="background-color 0.3s ease-in-out",b.style.backgroundColor="rgba(0, 207, 255, 0.1)",S.current&&clearTimeout(S.current),S.current=setTimeout(()=>{b&&(b.style.backgroundColor=""),w(!1),y.scrollTop+y.clientHeight>=y.scrollHeight-20&&A()},2e3)},[s,A]),R=r.useCallback(()=>{A(),f&&n&&f()},[n,f,A]),Y=k=>{const b=new Date(k),y=new Date,H=new Date(y);if(H.setDate(H.getDate()-1),b.toDateString()===y.toDateString())return"Сегодня";if(b.toDateString()===H.toDateString())return"Вчера";const D=b.getFullYear()===y.getFullYear(),M=b.toLocaleDateString([],{weekday:"long",day:"numeric",month:"long",...D?{}:{year:"numeric"}});return M.charAt(0).toUpperCase()+M.slice(1)};return r.useEffect(()=>{const k=s.current;if(!k)return;let b=k.scrollTop,y=null,H=0;const D=()=>{p.current||(p.current=!0,requestAnimationFrame(()=>{y&&clearTimeout(y);const M=k.scrollTop,v=k.scrollHeight-M-k.clientHeight<100;if(M<b)g&&d&&g.handleScrollPagination(k,t,d);else if(M>b&&v&&!u){j(!0);const q=Date.now();f&&(i!=null&&i.current)&&q-H>1e3&&q-i.current>1e3&&(H=q,i.current=q,f())}b=M,j(v),m(k.scrollTop+k.clientHeight<k.scrollHeight-400),E.current&&clearTimeout(E.current);const N=k.querySelectorAll(".message-item");if(!N.length)return;let L=null;N.forEach(q=>{const X=q.getBoundingClientRect(),ge=k.getBoundingClientRect();if(X.top>=ge.top&&X.bottom<=ge.bottom&&!L){const xe=q.getAttribute("data-date");xe&&(L=Y(xe))}}),L&&(W(L),C(!0),E.current=setTimeout(()=>{C(!1)},1e3)),y=setTimeout(()=>{y=null},150),p.current=!1}))};return k.addEventListener("scroll",D),()=>{k.removeEventListener("scroll",D),E.current&&clearTimeout(E.current),y&&clearTimeout(y)}},[n,t,s,f,i,g,d]),r.useEffect(()=>{const k=s.current;if(!k)return;const b=t.length,y=h.current;if(b>y&&y>0){const H=k.scrollHeight-o.current;if(H>0){const D=l.current+H;k.scrollTop=D}}h.current=b,o.current=k.scrollHeight,l.current=k.scrollTop},[t.length,s]),r.useEffect(()=>{u&&c&&c()},[u,c]),r.useEffect(()=>()=>{S.current&&clearTimeout(S.current),E.current&&clearTimeout(E.current)},[]),{isScrolledToBottom:u,setIsScrolledToBottom:j,showScrollButton:x,setShowScrollButton:m,showDateLabel:_,setShowDateLabel:C,currentDateLabel:F,setCurrentDateLabel:W,disableAutoScroll:$,setDisableAutoScroll:w,scrollToBottom:A,scrollToMessage:T,handleScrollToBottom:R,prepareScrollCorrection:I,setDisableSmoothScroll:z}},Ie=(s,t)=>{const n=r.useCallback(t,[t]);r.useEffect(()=>{if(!s)return;let c=!0;return c&&(async()=>{try{await fe.subscribe(s,n)}catch(i){console.error("Failed to setup WebSocket subscription:",i)}})(),()=>{c=!1,fe.unsubscribe(s,n)}},[s,n])};var ie=(s=>(s[s.SENT=0]="SENT",s[s.READ=1]="READ",s[s.NEW=2]="NEW",s))(ie||{});const Et=(s,t,n,c)=>{const f=r.useRef(0),i=r.useCallback(()=>{if(!s)return;const d=Date.now();d-f.current>1e3&&d-c.bulkReadAllRef.current>1e3&&(f.current=d,c.bulkReadAllRef.current=d,fe.publish(`/app/v1/channels/${s.id}/messages/bulk-read-all`,{}),n.onMarkAllAsRead())},[s,n.onMarkAllAsRead,c.bulkReadAllRef]),g=r.useCallback(async d=>{if(d.type==="MESSAGE_CREATE"&&d.message){const u=c.convertToExtendedMessage(d.message);if(u.author.id===(t==null?void 0:t.id))return;if(u.attachments&&u.attachments.length>0&&await n.onFetchSignedUrls([u],"websocket-new-message"),n.onMessageCreate(u),n.onHighlightMessage(u.id,1500),u.status===ie.NEW){const j=c.messagesContainerRef.current;if(j){const x=j.scrollHeight-j.scrollTop-j.clientHeight,m=x<100,_=x>300;m&&s?(c.addToReadBuffer(u.id),n.onMarkMessageAsRead(u.id),c.loadingMode!=="around"&&!c.isJumpingToMessage&&n.onScrollToBottom(),i()):_?(n.onNewMessageIndicator(!0),n.onUnreadMessage(u.id),setTimeout(()=>{const C=document.querySelector(`[data-msg-id="${u.id}"]`);if(C){const F=C.getBoundingClientRect();F.top>=0&&F.bottom<=window.innerHeight&&s&&(c.addToReadBuffer(u.id),n.onMarkMessageAsRead(u.id))}},100)):(c.addToReadBuffer(u.id),n.onMarkMessageAsRead(u.id),c.loadingMode!=="around"&&!c.isJumpingToMessage&&n.onScrollToBottom(),i())}}}else if(d.type==="MESSAGE_UPDATE"&&d.message){const u=c.convertToExtendedMessage(d.message);u.attachments&&u.attachments.length>0&&await n.onFetchSignedUrls([u],"websocket-updated-message"),n.onMessageUpdate(u),u.status===ie.READ&&n.onUnreadCountChange(-1)}else d.type==="MESSAGE_DELETE"&&d.messageId?(n.onMessageDelete(d.messageId),n.onUnreadCountChange(-1)):d.type==="MESSAGE_READ_STATUS"&&d.message_range&&n.onMessageReadStatus(d.message_range)},[t==null?void 0:t.id,s,c.convertToExtendedMessage,c.isJumpingToMessage,c.loadingMode,c.messagesContainerRef,c.addToReadBuffer,n.onMessageCreate,n.onMessageUpdate,n.onMessageDelete,n.onMessageReadStatus,n.onHighlightMessage,n.onUnreadMessage,n.onMarkMessageAsRead,n.onNewMessageIndicator,n.onScrollToBottom,n.onFetchSignedUrls,i,n.onUnreadCountChange]);return Ie(s&&t?`/v1/user/${t.id}/queue/channels/${s.id}/messages`:null,g),Ie(s?`/v1/topic/channels/${s.id}/messages`:null,g),{}},Dt=()=>{const[s,t]=r.useState([]),[n,c]=r.useState(new Map),[f,i]=r.useState(new Set),[g,d]=r.useState(0),[u,j]=r.useState(0),x=r.useCallback(o=>({...o,status:"status"in o?o.status:ie.SENT,reply:o.reply?{...o.reply,status:"status"in o.reply?o.reply.status:ie.SENT}:null}),[]),m=r.useCallback(()=>{t([]),c(new Map),i(new Set),d(0),j(0)},[]),_=r.useCallback((o,l)=>{t(h=>h.map(p=>p.id===o&&p.author.id!==l?{...p,status:ie.READ}:p))},[]),C=r.useCallback(o=>{t(l=>l.map(h=>h.author.id!==o?{...h,status:ie.READ}:h)),i(new Set),d(0),j(0)},[]),F=r.useCallback((o,l)=>{t(h=>h.map(p=>{if(p.id>=o.from&&p.id<=o.to&&p.author.id===l){const I=p.read_by_count||0;return{...p,read_by_count:I+1}}return p}))},[]),W=r.useCallback(o=>{t(l=>l.some(I=>I.id===o)?l.filter(I=>I.id!==o).map(I=>I.reply&&I.reply.id===o?{...I,reply:void 0}:I):l)},[]),$=r.useCallback(o=>{t(l=>l.some(p=>p.id===o.id)?l.map(p=>p.id===o.id?o:p):l)},[]),w=r.useCallback(o=>{t(l=>l.some(p=>p.id===o.id)?l:[...l,o])},[]),U=r.useCallback(o=>{i(l=>{const h=new Set(l);return h.add(o),h}),d(l=>l+1),j(l=>l+1)},[]),z=r.useCallback(o=>{i(l=>{const h=new Set(l);return h.delete(o),h}),d(l=>Math.max(0,l-1)),j(l=>Math.max(0,l-1))},[]),E=r.useCallback(o=>{d(l=>Math.max(0,l+o)),j(l=>Math.max(0,l+o))},[]),S=r.useCallback(()=>{d(0),j(0)},[]);return{messages:s,setMessages:t,tempMessages:n,setTempMessages:c,unreadMessages:f,setUnreadMessages:i,unreadCount:g,setUnreadCount:d,newMessagesCount:u,setNewMessagesCount:j,convertToExtendedMessage:x,resetMessageStates:m,updateMessageReadStatus:_,markAllMessagesAsReadInState:C,updateMessageReadByCount:F,deleteMessageFromState:W,updateMessageInState:$,addMessageToState:w,addUnreadMessage:U,removeUnreadMessage:z,updateUnreadCount:E,resetUnreadCounts:S}};export{Ct as C,kt as D,ie as M,vt as N,wt as S,Mt as a,Ft as b,Rt as c,dt as d,Et as e,jt as f,Dt as u};
