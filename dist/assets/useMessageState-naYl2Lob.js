import{f as K,j as e,g as Be,r as o,B as s,t as ie,aB as ve,ay as ce,a4 as ne,T as D,R as Ce,e as se,I as V,U as Me,bu as Fe,X as fe,L as ze,Y as he,b2 as me,N as De,S as _e,W as He,_ as je,P as le,O as We,bv as de,bw as Ue}from"./index-LlJjh5qQ.js";import{I as Ie}from"./Input-CGaVKA2S.js";import{C as $e}from"./Checkbox-B8WgZgUp.js";const Oe=K(e.jsx("path",{d:"m18 7-1.41-1.41-6.34 6.34 1.41 1.41zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12zM.41 13.41 6 19l1.41-1.41L1.83 12z"})),xe=K(e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11"})),Pe=K(e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"})),Ne=K(e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"})),re=K([e.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"},"0"),e.jsx("path",{d:"M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"},"1")]),Ve=Be.injectEndpoints({endpoints:a=>({getMediaUrl:a.query({queryFn:async(t,r,c,x)=>{try{const i=r.getState().auth.token;if(!i)return{error:{status:"UNAUTHORIZED",error:"No auth token available"}};const g=await fetch(`/api/v1/media/${t}`,{headers:{Authorization:`Bearer ${i}`}});if(!g.ok)return{error:{status:g.status,error:`HTTP ${g.status}`}};const u=await g.blob();return{data:URL.createObjectURL(u)}}catch(i){return{error:{status:"FETCH_ERROR",error:String(i)}}}},keepUnusedDataFor:300,providesTags:(t,r,c)=>[{type:"Media",id:c}]})}),overrideExisting:!1}),{useGetMediaUrlQuery:qe}=Ve,te=({storageKey:a,alt:t="Image",sx:r,className:c,onClick:x,loadingMode:i=null})=>{const[g,u]=o.useState(!1),[h,k]=o.useState(!1),f=o.useRef(null);o.useEffect(()=>{const M=f.current;if(!M)return;const z=new IntersectionObserver(E=>{const[B]=E;B.isIntersecting&&(k(!0),z.unobserve(M))},{rootMargin:"200px",threshold:.01});return z.observe(M),()=>{z.unobserve(M)}},[]);const w=a&&h&&i!=="initial",{data:L,isLoading:S,error:F}=qe(a,{skip:!w});return o.useEffect(()=>{u(!1)},[a]),w?S?e.jsx(s,{ref:f,sx:{width:"100%",height:"100%",position:"relative",overflow:"hidden",...r},children:e.jsx(ie,{variant:"rectangular",animation:"wave",sx:{width:"100%",height:"100%",bgcolor:"rgba(255,255,255,0.1)","&::after":{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent)"}}})}):F||g?(console.log("❌ Showing error state for:",a),e.jsx(s,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"rgba(255,0,0,0.1)",color:"rgba(255,255,255,0.7)",fontSize:"0.875rem",border:"1px dashed rgba(255,0,0,0.3)",...r},children:"Ошибка загрузки"})):L?e.jsx(s,{ref:f,component:"img",className:c,src:L,alt:t,onClick:x,onError:M=>{console.error("❌ Image render error:",{storageKey:a,imageSrc:L,error:M}),u(!0)},sx:{width:"100%",height:"100%",objectFit:"cover",display:"block",...r}}):e.jsx(s,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"rgba(255,255,0,0.1)",color:"rgba(255,255,255,0.7)",fontSize:"0.875rem",border:"1px dashed rgba(255,255,0,0.3)",...r},children:"Нет изображения"}):e.jsx(s,{ref:f,sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"rgba(255,255,255,0.05)",color:"rgba(255,255,255,0.3)",fontSize:"0.875rem",border:"1px dashed rgba(255,255,255,0.1)",...r},children:i==="initial"?"Загружается...":"📷"})},Ee=K(e.jsx("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"})),Te=K(e.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"})),Ye=({open:a,images:t,currentIndex:r,onClose:c,onNavigate:x})=>(o.useEffect(()=>{const i=g=>{a&&(g.key==="Escape"?c():g.key==="ArrowLeft"&&r>0?x(r-1):g.key==="ArrowRight"&&r<t.length-1&&x(r+1))};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[a,r,t.length,c,x]),e.jsx(ve,{open:a,onClose:c,sx:{display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(20px)",backgroundColor:"rgba(10, 10, 26, 0.85)"},children:e.jsx(ce,{in:a,children:e.jsx(s,{sx:{position:"relative",width:"100vw",height:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, rgba(13,13,26,0.95) 0%, rgba(26,26,46,0.95) 100%)",outline:"none"},onClick:c,children:t[r]&&e.jsxs(e.Fragment,{children:[e.jsx(s,{sx:{position:"relative",maxWidth:"90vw",maxHeight:"90vh",display:"flex",alignItems:"center",justifyContent:"center"},onClick:i=>i.stopPropagation(),children:e.jsx(te,{storageKey:t[r],alt:"Fullscreen preview",sx:{maxWidth:"100%",maxHeight:"90vh",objectFit:"contain",borderRadius:2,boxShadow:"0 20px 40px rgba(0,0,0,0.4)",width:"auto",height:"auto"}})}),r>0&&e.jsx(s,{onClick:i=>{i.stopPropagation(),x(r-1)},sx:{position:"absolute",left:40,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(-4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(Ee,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),r<t.length-1&&e.jsx(s,{onClick:i=>{i.stopPropagation(),x(r+1)},sx:{position:"absolute",right:40,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(Te,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(s,{onClick:i=>{i.stopPropagation(),c()},sx:{position:"absolute",top:40,right:40,display:"flex",alignItems:"center",justifyContent:"center",width:48,height:48,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.1) 0%, rgba(255, 61, 113, 0.2) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 61, 113, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF3D71 0%, #FF69B4 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"scale(1.1) rotate(90deg)",boxShadow:"0 8px 32px rgba(255, 61, 113, 0.4)",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.2) 0%, rgba(255, 61, 113, 0.3) 100%)","&::before":{opacity:1}}},children:e.jsx(ne,{sx:{fontSize:24,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(s,{sx:{position:"absolute",bottom:40,left:"50%",transform:"translateX(-50%)",display:"flex",gap:1,alignItems:"center"},children:t.map((i,g)=>e.jsx(s,{onClick:u=>{u.stopPropagation(),x(g)},sx:{width:g===r?32:8,height:8,borderRadius:1,bgcolor:g===r?"#FF69B4":"rgba(255, 255, 255, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&:hover":{bgcolor:g===r?"#FF69B4":"rgba(255, 255, 255, 0.5)"}}},g))}),e.jsx(s,{sx:{position:"absolute",top:40,left:40,color:"white",bgcolor:"rgba(30, 30, 47, 0.95)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:2,px:2,py:1},children:e.jsxs(D,{variant:"body2",sx:{opacity:.8},children:[r+1," из ",t.length]})})]})})})})),Xe=a=>new Date(a).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),Ge=a=>{var r;if(a.content&&a.content.trim())return a.content;const t="attachments_count"in a?a.attachments_count:((r=a.attachments)==null?void 0:r.length)||0;return t>0?t===1?"📎 Вложение":t>=2&&t<=4?`📎 ${t} вложения`:`📎 ${t} вложений`:"📎 Вложение"},Re=Ce.memo(a=>{const{message:t,isFirstInGroup:r=a.isFirstOfGroup||!1,isTempMessage:c=!1,isHighlighted:x=!1,isUnread:i=!1,isFocused:g=!1,isSearchMode:u=!1,searchQuery:h="",currentUserId:k,hubId:f=0,loadingMode:w=null,onReply:L,onEdit:S,onDelete:F,onReplyClick:M,onMouseEnter:z,onMouseLeave:E}=a,[B,_]=o.useState(!1),[A,m]=o.useState(null),[n,d]=o.useState(0),p=t.attachments&&t.attachments.length>0,l=(y,R)=>{m(y),d(R)},b=()=>{t.reply&&M&&M(t.reply.id)},I=()=>{t&&L&&L(t)},T=()=>{S&&typeof S=="function"&&S(t.id)},v=()=>{F&&typeof F=="function"&&F(t.id)};return e.jsxs(e.Fragment,{children:[e.jsxs(s,{id:`message-${t.id}`,className:"message-item","data-date":t.created_at,"data-msg-id":t.id.toString(),onMouseEnter:y=>{_(!0),z&&z(y,t)},onMouseLeave:y=>{_(!1),E&&E(y)},sx:{display:"flex",gap:2,alignItems:"flex-start",position:"relative",borderRadius:"10px",transition:"background-color 0.3s ease, box-shadow 0.5s ease",opacity:c?.6:1,mt:r?2:0,backgroundColor:g?"rgba(0, 207, 255, 0.25)":x?"rgba(33, 150, 243, 0.25)":i?"rgba(25,118,210,0.1)":"transparent","&.highlight-pulse":{animation:"pulse 2s infinite"},"&:hover":{backgroundColor:g?"rgba(0, 207, 255, 0.35)":x?"rgba(33, 150, 243, 0.35)":i?"rgba(25,118,210,0.15)":"rgba(255,255,255,0.05)"}},children:[B&&e.jsxs(s,{sx:{position:"absolute",top:-40,left:"50%",transform:"translateX(-50%)",display:"flex",gap:.5,zIndex:1e3,padding:"6px 8px",borderRadius:"20px",background:"rgba(40, 44, 52, 0.85)",backdropFilter:"blur(6px)",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",transition:"all 0.2s ease",opacity:1,animation:"fadeIn 0.2s ease-in-out","@keyframes fadeIn":{from:{opacity:0,transform:"translateX(-50%) translateY(5px)"},to:{opacity:1,transform:"translateX(-50%) translateY(0)"}}},children:[e.jsx(se,{title:"Ответить",enterDelay:1e3,placement:"top",children:e.jsx(V,{size:"small",onClick:I,sx:{color:"#00CFFF",transition:"all 0.2s ease","&:hover":{color:"#E5FBFF",transform:"scale(1.1)"}},children:e.jsx(xe,{fontSize:"small"})})}),t.author.id===k&&e.jsxs(e.Fragment,{children:[e.jsx(se,{title:"Редактировать",enterDelay:1e3,placement:"top",children:e.jsx(V,{size:"small",onClick:T,sx:{color:"#00CFFF",transition:"all 0.2s ease","&:hover":{color:"#E5FBFF",transform:"scale(1.1)"}},children:e.jsx(Pe,{fontSize:"small"})})}),e.jsx(se,{title:"Удалить",enterDelay:1e3,placement:"top",children:e.jsx(V,{size:"small",onClick:v,sx:{color:"#FF3D71",transition:"all 0.2s ease","&:hover":{color:"#FF708D",transform:"scale(1.1)"}},children:e.jsx(Ne,{fontSize:"small"})})})]})]}),e.jsx(s,{sx:{width:40,display:"flex",flexDirection:"column",alignItems:"center",mt:1},children:r?e.jsx("div",{style:{cursor:"pointer"},children:e.jsx(Me,{src:t.author.avatar||void 0,alt:t.author.login,userId:t.author.id,hubId:f})}):null}),e.jsxs(s,{sx:{flex:1,position:"relative"},children:[e.jsx(s,{sx:{maxWidth:"99%"},children:e.jsxs(s,{sx:{py:"5px",px:"0px",pl:0},children:[r&&e.jsx(D,{sx:{color:"#00CFFF",fontWeight:700,mb:.5,fontSize:"1rem",letterSpacing:.2},children:t.author.login}),t.reply&&e.jsxs(s,{sx:{display:"flex",flexDirection:"column",borderRadius:"4px",p:1,background:y=>y.palette.mode==="dark"?"rgba(255,255,255,0.04)":"rgba(0,0,0,0.04)",border:"1px solid rgba(255,255,255,0.05)",mb:1,mt:.25,cursor:"pointer","&:hover":{background:"rgba(255,255,255,0.06)"}},onClick:b,children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(xe,{sx:{fontSize:"0.9rem",color:"#00CFFF"}}),e.jsx(D,{sx:{color:"#00CFFF",fontSize:"0.82rem",fontWeight:"500"},children:t.reply.author.login})]}),e.jsx(D,{sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.82rem",mt:.3,lineHeight:1.3},noWrap:!0,children:Ge(t.reply)})]})]})}),p&&e.jsx(s,{sx:{mt:1.5,mb:1},children:(()=>{var R;const y=((R=t.attachments)==null?void 0:R.length)||0;return y===1?e.jsx(s,{sx:{position:"relative",borderRadius:3,overflow:"hidden",maxWidth:"450px",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 8px 32px rgba(0,0,0,0.12)",background:"linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"translateY(-4px)",boxShadow:"0 20px 40px rgba(0,0,0,0.2)",border:"1px solid rgba(0, 207, 255, 0.3)","& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>l(t.attachments[0],0),children:e.jsxs(s,{sx:{position:"relative",width:"100%",paddingTop:"75%","& > *":{position:"absolute",top:0,left:0,width:"100%",height:"100%"}},children:[e.jsx(te,{storageKey:t.attachments[0],className:"attachment-image",alt:"Attachment",loadingMode:w,sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(s,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(3px)"},children:e.jsx(re,{sx:{color:"white",fontSize:"36px",filter:"drop-shadow(0 2px 8px rgba(0,0,0,0.4))"}})})]})}):y===2?e.jsx(s,{sx:{display:"flex",gap:1,maxWidth:"450px"},children:t.attachments.map((C,j)=>e.jsxs(s,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",flex:1,height:"200px",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"translateY(-2px) scale(1.02)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.05)"}}},onClick:()=>l(C,j),children:[e.jsx(te,{loadingMode:w,storageKey:C,className:"attachment-image",alt:"Attachment",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(s,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(2px)"},children:e.jsx(re,{sx:{color:"white",fontSize:"28px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(s,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,backdropFilter:"blur(6px)",border:"1px solid rgba(255,255,255,0.15)"},children:[j+1,"/",y]})]},j))}):y===3?e.jsxs(s,{sx:{display:"flex",gap:1,maxWidth:"450px",height:"280px"},children:[e.jsxs(s,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",flex:2,cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.02)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.05)"}}},onClick:()=>l(t.attachments[0],0),children:[e.jsx(te,{loadingMode:w,storageKey:t.attachments[0],className:"attachment-image",alt:"Attachment",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(s,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(2px)"},children:e.jsx(re,{sx:{color:"white",fontSize:"32px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(s,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,backdropFilter:"blur(6px)",border:"1px solid rgba(255,255,255,0.15)"},children:["1/",y]})]}),e.jsx(s,{sx:{display:"flex",flexDirection:"column",gap:1,flex:1},children:t.attachments.slice(1,3).map((C,j)=>e.jsxs(s,{sx:{position:"relative",borderRadius:2,overflow:"hidden",flex:1,cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.03)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.08)"}}},onClick:()=>l(C,j+1),children:[e.jsx(te,{loadingMode:w,storageKey:C,className:"attachment-image",alt:"Attachment",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(s,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(2px)"},children:e.jsx(re,{sx:{color:"white",fontSize:"24px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(s,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,backdropFilter:"blur(6px)",border:"1px solid rgba(255,255,255,0.15)"},children:[j+2,"/",y]})]},j+1))})]}):y===4?e.jsx(s,{sx:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:1,maxWidth:"400px",aspectRatio:"1"},children:t.attachments.map((C,j)=>e.jsxs(s,{sx:{position:"relative",borderRadius:2,overflow:"hidden",aspectRatio:"1",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.05)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.08)"}}},onClick:()=>l(C,j),children:[e.jsx(te,{loadingMode:w,storageKey:C,className:"attachment-image",alt:"Attachment",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(s,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(2px)"},children:e.jsx(re,{sx:{color:"white",fontSize:"28px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(s,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,backdropFilter:"blur(6px)",border:"1px solid rgba(255,255,255,0.15)"},children:[j+1,"/",y]})]},j))}):y>=5?e.jsxs(s,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:1,maxWidth:"450px",aspectRatio:"3/2"},children:[e.jsxs(s,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",gridColumn:"span 2",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.02)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.05)"}}},onClick:()=>l(t.attachments[0],0),children:[e.jsx(te,{loadingMode:w,storageKey:t.attachments[0],className:"attachment-image",alt:"Attachment",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(s,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(2px)"},children:e.jsx(re,{sx:{color:"white",fontSize:"32px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(s,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,backdropFilter:"blur(6px)",border:"1px solid rgba(255,255,255,0.15)"},children:["1/",y]})]}),e.jsx(s,{sx:{display:"flex",flexDirection:"column",gap:1},children:t.attachments.slice(1,3).map((C,j)=>e.jsxs(s,{sx:{position:"relative",borderRadius:2,overflow:"hidden",flex:1,cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.05)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.08)"}}},onClick:()=>l(C,j+1),children:[e.jsx(te,{loadingMode:w,storageKey:C,className:"attachment-image",alt:"Attachment",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"}}),e.jsx(s,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease",backdropFilter:"blur(2px)"},children:j===1&&y>3?e.jsxs(s,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:.5},children:[e.jsxs(D,{sx:{color:"white",fontSize:"1.2rem",fontWeight:700,textShadow:"0 2px 8px rgba(0,0,0,0.8)"},children:["+",y-3]}),e.jsx(D,{sx:{color:"white",fontSize:"0.75rem",fontWeight:500,textShadow:"0 1px 4px rgba(0,0,0,0.8)",opacity:.9},children:"ещё"})]}):e.jsx(re,{sx:{color:"white",fontSize:"20px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(s,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,backdropFilter:"blur(6px)",border:"1px solid rgba(255,255,255,0.15)"},children:[j+2,"/",y]})]},j+1))})]}):null})()}),e.jsxs(s,{sx:{display:"flex",flexDirection:"column",position:"relative"},children:[t.content&&e.jsx(D,{sx:{color:"rgba(255,255,255,0.85)",wordBreak:"break-word",fontSize:"1.01rem",whiteSpace:"pre-wrap",pr:"120px",pl:0,lineHeight:1.4},component:"span",dangerouslySetInnerHTML:{__html:Fe.sanitize((()=>{let y=t.content.replace(/\r\n/g,`
`).replace(/\n/g,"<br>");if(u&&h.trim()){const C=h.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),j=new RegExp(`(${C})`,"gi");y=y.replace(j,'<span style="background-color: rgba(0, 207, 255, 0.3); color: #fff; border-radius: 2px; padding: 0; font-weight: 600;">$1</span>')}return y})())}}),e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:.5,position:"absolute",top:0,right:0,padding:"0 8px"},children:[t.last_modified_at&&t.last_modified_at!==t.created_at&&e.jsx("span",{style:{color:"#90caf9",fontSize:"0.85em",fontStyle:"italic",fontWeight:500},children:"ред."}),t.author.id===k&&e.jsx(s,{sx:{display:"flex",alignItems:"center",gap:.5,mr:.5},children:e.jsx(Oe,{sx:{fontSize:"1rem",color:t.read_by_count&&t.read_by_count>0?"#FF69B4":"rgba(255,255,255,0.35)"}})}),e.jsx(D,{sx:{color:"rgba(255,255,255,0.35)",fontSize:"0.78rem",lineHeight:1,whiteSpace:"nowrap",display:"flex",alignItems:"center",gap:.5},children:Xe(t.created_at)})]})]})]})]}),e.jsx(Ye,{open:!!A,images:t.attachments||[],currentIndex:n,onClose:()=>m(null),onNavigate:y=>{d(y),m(t.attachments[y])}})]})});Re.displayName="ChatMessageItem";const Le=K(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"})),Ke=ze().shape({content:De().min(1,"Message cannot be empty").max(2e3,"Message is too long")}),Je=a=>{const t=new Date(a),r=new Date,c=new Date(r);if(c.setDate(c.getDate()-1),t.toDateString()===r.toDateString())return"Сегодня";if(t.toDateString()===c.toDateString())return"Вчера";const x=t.getFullYear()===r.getFullYear(),i=t.toLocaleDateString([],{weekday:"long",day:"numeric",month:"long",...x?{}:{year:"numeric"}});return i.charAt(0).toUpperCase()+i.slice(1)},Qe=(a,t,r=30)=>{const c=new Date(a),x=new Date(t);return Math.abs(c.getTime()-x.getTime())/(1e3*60)<=r},ut=({activeChannel:a,messages:t,tempMessages:r,searchMode:c,searchQuery:x,highlightedMessages:i,focusedMessageId:g,unreadMessages:u,isLoadingMore:h,isLoadingAround:k,editingMessageId:f,user:w,hubId:L,paginationState:S,messagesPerPage:F,showDateLabel:M,currentDateLabel:z,messagesContainerRef:E,messagesEndRef:B,editInputRef:_,highlightTimeoutRef:A,hoverTimeoutRef:m,isHoveringPortal:n,setHighlightedMessages:d,setFocusedMessageId:p,setEditingMessageId:l,setMessages:b,setTempMessages:I,setReplyingToMessage:T,setHoveredMessage:v,setTargetMessageId:y,paginationActions:R,handleEditMessage:C,handleDeleteMessage:j})=>{const U=[...t].sort((H,$)=>new Date(H.created_at).getTime()-new Date($.created_at).getTime()),Y=t.length===0&&r.size===0&&!h&&!!a&&e.jsx(s,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(D,{variant:"body1",color:"text.secondary",children:c?"No messages found matching your search.":"No messages yet. Start a conversation!"})}),X=H=>{if(U.some(J=>J.id===H)){const J=document.querySelector(`[data-msg-id='${H}']`);J&&(J.scrollIntoView({behavior:"smooth",block:"center"}),A.current&&(clearTimeout(A.current),A.current=null),p(null),d(new Set),p(H),d(()=>{const G=new Set;return G.add(H),G}),A.current=setTimeout(()=>{d(G=>{const Z=new Set(G);return Z.delete(H),Z}),p(null),A.current=null},1500))}else R.setIsJumpingToMessage(!0),R.setSkipMainQuery(!0),b([]),I(new Map),R.setBeforeId(null),R.setAfterId(null),R.setHasMoreMessages(!0),R.setHasMoreMessagesAfter(!0),R.setEnableAfterPagination(!0),y(H),R.setAroundMessageId(H),R.setLoadingMode("around")},O=()=>e.jsx(s,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",color:"rgba(255,255,255,0.5)",textAlign:"center",gap:2},children:S.loadingMode==="around"||S.isJumpingToMessage||k?e.jsx(s,{sx:{width:"100%",height:"100%",overflowY:"auto",p:3,display:"flex",flexDirection:"column",gap:2},children:[...Array(F)].map((H,$)=>e.jsxs(s,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[e.jsx(ie,{variant:"circular",width:40,height:40,sx:{bgcolor:"rgba(255,255,255,0.1)"}}),e.jsxs(s,{sx:{flex:1},children:[e.jsx(ie,{variant:"text",width:120,height:24,sx:{bgcolor:"rgba(255,255,255,0.1)",mb:1}}),e.jsx(ie,{variant:"text",width:"80%",height:20,sx:{bgcolor:"rgba(255,255,255,0.1)"}}),e.jsx(ie,{variant:"text",width:"60%",height:20,sx:{bgcolor:"rgba(255,255,255,0.1)"}})]})]},$))}):c&&x.trim()?e.jsxs(e.Fragment,{children:[e.jsx(D,{variant:"h6",children:"Нет результатов поиска"}),e.jsx(D,{variant:"body2",children:"Попробуйте изменить поисковый запрос"})]}):e.jsxs(e.Fragment,{children:[e.jsx(D,{variant:"h6",children:"Нет сообщений"}),e.jsx(D,{variant:"body2",children:"Начните общение, отправив первое сообщение"})]})});return Ce.useEffect(()=>{const H=E.current;if(!H)return;let $=!1;const J=()=>{$||($=!0,requestAnimationFrame(()=>{if(H.scrollTop<100&&S.hasMoreMessages&&!S.isJumpingToMessage&&S.loadingMode!=="pagination"&&S.loadingMode!=="around"){const Z=U[0];Z&&(R.setBeforeId(Z.id),R.setLoadingMode("pagination"))}$=!1}))};return H.addEventListener("scroll",J,{passive:!0}),()=>H.removeEventListener("scroll",J)},[U,S,R]),e.jsx(s,{ref:E,className:"messages-container",sx:{flex:1,p:3,overflowY:"auto",display:"flex",flexDirection:"column",gap:1,position:"relative","&::-webkit-scrollbar":{width:"8px"},"&::-webkit-scrollbar-track":{background:"rgba(255,255,255,0.05)",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.1)",borderRadius:"4px","&:hover":{background:"rgba(255,255,255,0.15)"}}},children:U.length===0&&r.size===0?O():e.jsxs(e.Fragment,{children:[Y,e.jsx(ce,{in:M,timeout:{enter:300,exit:500},children:e.jsx(s,{sx:{position:"sticky",top:0,zIndex:10,alignSelf:"center",backgroundColor:"rgba(30,30,47,0.85)",backdropFilter:"blur(8px)",borderRadius:"16px",px:2,py:.75,mb:1,boxShadow:"0 2px 8px rgba(0,0,0,0.2)",border:"1px solid rgba(255,255,255,0.1)",transition:"all 0.3s ease"},children:e.jsx(D,{sx:{color:"rgba(255,255,255,0.9)",fontWeight:600,fontSize:"0.9rem"},children:z})})}),(()=>{let H=[],$=null,J=null,G=[],Z=null,ye=new Set;return[...U,...Array.from(r.values())].forEach(W=>{const ae=new Date(W.created_at).toDateString();Z!==ae&&!ye.has(ae)&&(G.length>0&&(H.push(...G),G=[]),H.push(e.jsxs(s,{className:"date-separator","data-date":W.created_at,sx:{display:"flex",justifyContent:"center",alignItems:"center",my:2,position:"relative"},children:[e.jsx(s,{sx:{backgroundColor:"rgba(30,30,47,0.85)",backdropFilter:"blur(8px)",borderRadius:"16px",px:2,py:.75,boxShadow:"0 2px 8px rgba(0,0,0,0.2)",border:"1px solid rgba(255,255,255,0.1)",zIndex:2},children:e.jsx(D,{sx:{color:"rgba(255,255,255,0.9)",fontWeight:600,fontSize:"0.9rem"},children:Je(W.created_at)})}),e.jsx(s,{sx:{position:"absolute",height:"1px",width:"100%",backgroundColor:"rgba(255,255,255,0.08)",zIndex:1}})]},`date-${ae}`)),Z=ae,ye.add(ae));const pe=$!==W.author.id||J!==null&&!Qe(J,W.created_at),ue=W.id===-1,Ae=f===W.id?e.jsxs(s,{id:`message-${W.id}`,className:"message-item","data-date":W.created_at,"data-msg-id":W.id.toString(),sx:{display:"flex",gap:2,alignItems:"flex-start",position:"relative",borderRadius:"10px",transition:"background-color 0.3s ease",opacity:ue?.6:1},children:[e.jsx(s,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"flex-start",width:40,ml:1,mt:1},children:pe?e.jsx("div",{style:{cursor:"pointer"},children:e.jsx(Me,{src:W.author.avatar||void 0,alt:W.author.login,userId:W.author.id,hubId:L})}):null}),e.jsx(s,{sx:{flex:1,position:"relative"},children:e.jsx(s,{sx:{maxWidth:"100%"},children:e.jsxs(s,{sx:{py:"5px",px:"0px",pl:0},children:[pe&&e.jsx(D,{sx:{color:"#00CFFF",fontWeight:700,mb:.5,fontSize:"1rem",letterSpacing:.2},children:W.author.login}),e.jsx(fe,{initialValues:{content:W.content},validationSchema:Ke,onSubmit:C,children:({handleSubmit:N,values:oe})=>e.jsx(he,{children:e.jsxs(s,{sx:{display:"flex",flexDirection:"column",gap:1,background:"rgba(30,30,47,0.9)",borderRadius:"8px",padding:"8px",border:"1px solid rgba(255,255,255,0.1)",boxShadow:"0 4px 12px rgba(0,0,0,0.2)"},children:[e.jsx(me,{name:"content",component:Ie,multiline:!0,fullWidth:!0,size:"small",inputRef:_,onKeyDown:ee=>{ee.key==="Enter"&&!ee.shiftKey?(ee.preventDefault(),N()):ee.key==="Escape"&&(ee.preventDefault(),l(null))}}),e.jsxs(s,{sx:{display:"flex",gap:1,justifyContent:"flex-end",padding:"4px 8px"},children:[e.jsx(V,{size:"small",onClick:ee=>{ee.preventDefault(),l(null)},sx:{color:"#d32f2f","&:hover":{background:"rgba(211,47,47,0.1)"}},children:e.jsx(ne,{fontSize:"small"})}),e.jsx(V,{size:"small",onClick:ee=>N(),disabled:!oe.content,sx:{color:oe.content?"#1976D2":"rgba(255,255,255,0.3)",transition:"color 0.25s cubic-bezier(.4,0,.2,1)","&:hover":{color:oe.content?"#1976D2":"rgba(255,255,255,0.3)"}},children:e.jsx(Le,{fontSize:"small"})})]})]})})})]})})})]},ue?`temp-${W.created_at}`:W.id):e.jsx(Re,{message:W,isFirstOfGroup:pe,isTempMessage:ue,isHighlighted:i.has(W.id),isUnread:u.has(W.id),isFocused:g===W.id,isSearchMode:c,searchQuery:x,currentUserId:w.id,hubId:L,loadingMode:S.loadingMode,onReply:N=>{T(N)},onEdit:N=>l(typeof N=="number"?N:N.id),onDelete:N=>j(typeof N=="number"?N:N.id),onReplyClick:X,onMouseEnter:(N,oe)=>{m!=null&&m.current&&(clearTimeout(m.current),m.current=null),v&&oe&&v({element:N.currentTarget,message:oe})},onMouseLeave:()=>{m&&(m.current=setTimeout(()=>{!(n!=null&&n.current)&&v&&v(null)},100))}},ue?`temp-${W.created_at}`:W.id);G.push(Ae),$=W.author.id,J=W.created_at}),G.length>0&&H.push(...G),H})(),e.jsx("div",{ref:B})]})})},be=K(e.jsx("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"})),gt=({searchMode:a,setSearchMode:t,searchQuery:r,searchInputRef:c,searchResultsRef:x,showSearchResults:i,setShowSearchResults:g,searchResults:u,isSearching:h,debouncedSearchQuery:k,handleSearchInputChange:f,clearSearch:w,onSearchResultClick:L,onLoadMore:S,hasMore:F=!1,isLoadingMore:M=!1})=>{const[z,E]=o.useState([]),B=o.useRef(!1),_=m=>new Date(m).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1});o.useEffect(()=>{u&&E(u)},[u]);const A=o.useCallback(m=>{const n=m.currentTarget,d=n.scrollHeight,p=n.scrollTop,l=n.clientHeight;d-p-l<100&&S&&F&&!M&&!B.current&&(B.current=!0,S(),setTimeout(()=>{B.current=!1},1e3))},[S,F,M]);return a?e.jsxs(s,{sx:{display:"flex",flexDirection:"column",position:"relative",zIndex:10001},children:[e.jsx(s,{sx:{display:"flex",alignItems:"center",background:"rgba(255,255,255,0.05)",borderRadius:i&&r.trim()&&u&&u.length>0?"20px 20px 0 0":"20px",border:"1px solid rgba(255,255,255,0.1)",borderBottom:i&&r.trim()&&u&&u.length>0?"none":"1px solid rgba(255,255,255,0.1)",paddingLeft:2,paddingRight:1,width:"300px",transition:"all 0.3s ease"},children:e.jsx(fe,{initialValues:{query:r},onSubmit:()=>{},enableReinitialize:!0,children:({setFieldValue:m})=>e.jsxs(he,{style:{width:"100%",display:"flex",alignItems:"center"},children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",width:"100%",position:"relative"},children:[e.jsx(me,{name:"query",children:({field:n,form:d})=>e.jsx("input",{...n,ref:c,onChange:p=>{n.onChange(p),f(p.target.value)},onFocus:()=>{var p;(p=n.value)!=null&&p.trim()&&u&&u.length>0&&g(!0)},onBlur:p=>{const l=p.relatedTarget;l&&x.current&&!x.current.contains(l)?setTimeout(()=>{x.current&&!x.current.matches(":hover")&&g(!1)},150):l||setTimeout(()=>{g(!1)},150)},placeholder:"Поиск сообщений...",style:{width:"100%",border:"none",outline:"none",background:"transparent",color:"#fff",fontSize:"0.9rem",padding:"8px 0"},onKeyDown:p=>{p.key==="Escape"&&(i?g(!1):(w(),d.resetForm()))}})}),r.trim()&&e.jsxs(D,{variant:"caption",sx:{position:"absolute",right:0,top:"-18px",color:u&&u.length>0?"#00FFBA":"#FF69B4",fontSize:"0.7rem",fontWeight:500,padding:"2px 6px",borderRadius:"4px",background:"rgba(0,0,0,0.3)"},children:[(u==null?void 0:u.length)||0," ",(u==null?void 0:u.length)===1?"result":"results"]})]}),e.jsx(V,{type:"button",size:"small",onClick:()=>{i?g(!1):(w(),m("query",""))},sx:{color:"rgba(255,255,255,0.5)","&:hover":{color:"rgba(255,255,255,0.9)",background:"rgba(255,255,255,0.1)"}},children:i?e.jsx(be,{fontSize:"small"}):e.jsx(ne,{fontSize:"small"})})]})})}),i&&r.trim()&&e.jsxs(s,{ref:x,onMouseDown:m=>{m.preventDefault()},onMouseEnter:()=>{g(!0)},onMouseLeave:m=>{const n=m.relatedTarget;n&&c.current&&!c.current.contains(n)?setTimeout(()=>g(!1),100):n||setTimeout(()=>g(!1),100)},onScroll:A,sx:{position:"absolute",top:"100%",left:0,width:"100%",maxHeight:"300px",background:"rgba(20, 20, 35, 0.98)",border:"1px solid rgba(255,255,255,0.1)",borderTop:"none",borderRadius:"0 0 20px 20px",overflowY:"auto",overflowX:"hidden",zIndex:10002,backdropFilter:"blur(15px)",boxShadow:"0 8px 32px rgba(0,0,0,0.6)","&::-webkit-scrollbar":{width:"6px"},"&::-webkit-scrollbar-track":{background:"rgba(255,255,255,0.1)",borderRadius:"3px"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.3)",borderRadius:"3px","&:hover":{background:"rgba(255,255,255,0.5)"}}},children:[h&&e.jsxs(s,{sx:{p:2,display:"flex",justifyContent:"center",alignItems:"center"},children:[e.jsx(s,{sx:{width:24,height:24,border:"2px solid rgba(255,255,255,0.1)",borderTop:"2px solid #00CFFF",borderRadius:"50%",animation:"spin 1s linear infinite","@keyframes spin":{"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}}}}),e.jsx(D,{sx:{ml:1,color:"rgba(255,255,255,0.7)",fontSize:"0.9rem"},children:"Поиск..."})]}),!h&&u&&u.length===0&&k&&e.jsx(s,{sx:{p:3,textAlign:"center"},children:e.jsxs(D,{sx:{color:"rgba(255,255,255,0.5)",fontSize:"0.9rem"},children:["По запросу ",e.jsx(s,{component:"span",sx:{fontWeight:"bold",color:"#00CFFF"},children:k})," ничего не найдено"]})}),!h&&z&&z.length>0&&z.map((m,n)=>e.jsxs(s,{onClick:()=>{L(m),g(!1)},onMouseDown:d=>{d.preventDefault()},sx:{p:2,borderBottom:"1px solid rgba(255,255,255,0.05)",cursor:"pointer",transition:"all 0.2s ease","&:hover":{background:"rgba(255,255,255,0.1)",transform:"translateX(2px)"},"&:last-child":{borderBottom:"none"}},children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(D,{sx:{color:"#00CFFF",fontSize:"0.8rem",fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"150px"},children:m.author.login}),e.jsx(D,{sx:{color:"rgba(255,255,255,0.4)",fontSize:"0.7rem",ml:"auto"},children:_(m.created_at)})]}),e.jsx(D,{sx:{color:"rgba(255,255,255,0.8)",fontSize:"0.85rem",lineHeight:1.4,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical","& mark":{background:"rgba(255, 105, 180, 0.3)",color:"#FF69B4",padding:"1px 2px",borderRadius:"2px",fontWeight:600}},dangerouslySetInnerHTML:{__html:Fe.sanitize((()=>{let d=m.content;if(d.length>150&&(d=d.substring(0,150)+"..."),d=d.replace(/\r\n/g," ").replace(/\n/g," "),k.trim()){const l=k.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),b=new RegExp(`(${l})`,"gi");d=d.replace(b,"<mark>$1</mark>")}return d})())}})]},`${m.id}-${n}`)),M&&e.jsxs(s,{sx:{p:2,display:"flex",justifyContent:"center",alignItems:"center"},children:[e.jsx(s,{sx:{width:20,height:20,border:"2px solid rgba(255,255,255,0.1)",borderTop:"2px solid #00CFFF",borderRadius:"50%",animation:"spin 1s linear infinite"}}),e.jsx(D,{sx:{ml:1,color:"rgba(255,255,255,0.5)",fontSize:"0.8rem"},children:"Загрузка..."})]})]})]}):e.jsx(se,{title:"Поиск сообщений",placement:"top",children:e.jsx(V,{onClick:()=>{t(!0),setTimeout(()=>{c.current&&c.current.focus()},100)},sx:{color:"rgba(255,255,255,0.6)","&:hover":{color:"rgba(255,255,255,0.9)",background:"rgba(255,255,255,0.05)"}},children:e.jsx(_e,{})})})},pt=({open:a,messageToDelete:t,deleteForEveryone:r,canManageMessages:c,messages:x,userId:i,onClose:g,onConfirm:u,onDeleteForEveryoneChange:h})=>{const k=t?x.find(L=>L.id===t):null,w=k&&k.author.id===i||c;return e.jsx(He,{open:a,onClose:g,title:"Удалить сообщение",children:e.jsxs(s,{sx:{p:2,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:[t&&e.jsxs(s,{sx:{mb:3,width:"100%",maxWidth:300},children:[w&&e.jsxs(s,{onClick:()=>h(!r),sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:1.5,mb:1.5,borderRadius:2,cursor:"pointer",backgroundColor:r?"rgba(255, 61, 113, 0.1)":"rgba(0,0,0,0.15)",border:`1px solid ${r?"rgba(255, 61, 113, 0.3)":"rgba(255,255,255,0.1)"}`,transition:"all 0.2s ease","&:hover":{backgroundColor:r?"rgba(255, 61, 113, 0.15)":"rgba(0,0,0,0.2)",transform:"translateY(-2px)"}},children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",mb:.5},children:[e.jsx($e,{checked:r,onChange:L=>h(L.target.checked),sx:{color:"rgba(255,255,255,0.5)",p:.5,mr:1,"&.Mui-checked":{color:"#FF3D71"}}}),e.jsx(D,{sx:{fontWeight:500,fontSize:"0.9rem"},children:"Удалить у всех"})]}),e.jsx(D,{variant:"body2",sx:{color:"rgba(255,255,255,0.6)",fontStyle:"italic",fontSize:"0.75rem",textAlign:"center"},children:r?"Сообщение исчезнет у всех участников чата":"Сообщение останется видимым для других"})]}),e.jsx(D,{sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.75rem",textAlign:"center",mt:1},children:w?r?"":"Сообщение будет скрыто только в вашем интерфейсе":"Сообщение будет скрыто только для вас"})]}),e.jsxs(s,{sx:{display:"flex",gap:2,justifyContent:"center"},children:[e.jsx(je,{variant:"outlined",onClick:g,sx:{color:"rgba(255,255,255,0.7)",borderColor:"rgba(255,255,255,0.2)",borderRadius:2,px:3,"&:hover":{borderColor:"rgba(255,255,255,0.4)",backgroundColor:"rgba(255,255,255,0.05)"}},children:"Отмена"}),e.jsx(je,{variant:"contained",onClick:u,sx:{backgroundColor:"#FF3D71",color:"#fff",borderRadius:2,px:3,"&:hover":{backgroundColor:"#FF1744"}},children:"Удалить"})]})]})})},xt=({showScrollButton:a,newMessagesCount:t,unreadCount:r,replyingToMessage:c,onScrollToBottom:x})=>{const i=c?160:100;return e.jsxs(e.Fragment,{children:[e.jsx(ce,{in:a,children:e.jsx(V,{onClick:x,sx:{position:"absolute",bottom:i,right:20,backgroundColor:"rgba(30,30,47,0.95)",backdropFilter:"blur(8px)",border:"1px solid rgba(255,255,255,0.1)",boxShadow:"0 4px 12px rgba(0,0,0,0.2)","&:hover":{backgroundColor:"rgba(40,40,57,0.95)"},zIndex:1e3,transition:"bottom 0.2s ease-out"},children:e.jsx(be,{sx:{color:"#fff"}})})}),e.jsx(ce,{in:t>0||r>0,children:e.jsx(s,{sx:{position:"absolute",bottom:i,left:"50%",transform:"translateX(-50%)",zIndex:1e3,transition:"bottom 0.2s ease-out"},children:e.jsxs(le,{sx:{backgroundColor:"#FF69B4",color:"#fff",px:2,py:1,borderRadius:"20px",cursor:"pointer",boxShadow:"0 4px 12px rgba(255,105,180,0.2)",display:"flex",alignItems:"center",gap:1,"&:hover":{backgroundColor:"#FF1493"}},onClick:x,children:[e.jsx(be,{}),e.jsxs(D,{variant:"body2",sx:{fontWeight:600},children:[t||r," ",(t||r)===1?"новое сообщение":"новых сообщений"]})]})})})]})},Ze=K(e.jsx("path",{d:"M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M8.5 8c.83 0 1.5.67 1.5 1.5S9.33 11 8.5 11 7 10.33 7 9.5 7.67 8 8.5 8M12 18c-2.28 0-4.22-1.66-5-4h10c-.78 2.34-2.72 4-5 4m3.5-7c-.83 0-1.5-.67-1.5-1.5S14.67 8 15.5 8s1.5.67 1.5 1.5-.67 1.5-1.5 1.5"})),et=K(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-2h2zm0-4h-2V7h2z"})),tt=K(e.jsx("path",{d:"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2M8.5 13.5l2.5 3.01L14.5 12l4.5 6H5z"})),rt=({open:a,images:t,currentIndex:r,onClose:c,onNavigate:x})=>(o.useEffect(()=>{const i=g=>{a&&(g.key==="Escape"?c():g.key==="ArrowLeft"&&r>0?x(r-1):g.key==="ArrowRight"&&r<t.length-1&&x(r+1))};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[a,r,t.length,c,x]),e.jsx(ve,{open:a,onClose:c,sx:{display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(20px)",backgroundColor:"rgba(10, 10, 26, 0.85)"},children:e.jsx(ce,{in:a,children:e.jsx(s,{sx:{position:"relative",width:"90vw",height:"90vh",maxWidth:"1400px",maxHeight:"900px",display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, rgba(13,13,26,0.98) 0%, rgba(26,26,46,0.98) 100%)",borderRadius:3,boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.8)",border:"1px solid rgba(255, 255, 255, 0.1)",outline:"none",overflow:"hidden"},onClick:c,children:t[r]&&e.jsxs(e.Fragment,{children:[e.jsx(s,{sx:{position:"relative",maxWidth:"calc(100% - 120px)",maxHeight:"calc(100% - 120px)",display:"flex",alignItems:"center",justifyContent:"center"},onClick:i=>i.stopPropagation(),children:e.jsx(s,{component:"img",src:t[r].preview,alt:"Fullscreen preview",sx:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain",borderRadius:2,boxShadow:"0 20px 40px rgba(0,0,0,0.4)"}})}),r>0&&e.jsx(s,{onClick:i=>{i.stopPropagation(),x(r-1)},sx:{position:"absolute",left:20,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(-4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(Ee,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),r<t.length-1&&e.jsx(s,{onClick:i=>{i.stopPropagation(),x(r+1)},sx:{position:"absolute",right:20,display:"flex",alignItems:"center",justifyContent:"center",width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.1) 0%, rgba(30, 144, 255, 0.1) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 255, 255, 0.1)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF69B4 0%, #1E90FF 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"translateX(4px) scale(1.1)",boxShadow:"0 8px 32px rgba(255, 105, 180, 0.4)",background:"linear-gradient(135deg, rgba(255, 105, 180, 0.2) 0%, rgba(30, 144, 255, 0.2) 100%)","&::before":{opacity:1}}},children:e.jsx(Te,{sx:{fontSize:28,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(s,{onClick:i=>{i.stopPropagation(),c()},sx:{position:"absolute",top:20,right:20,display:"flex",alignItems:"center",justifyContent:"center",width:48,height:48,borderRadius:"50%",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.1) 0%, rgba(255, 61, 113, 0.2) 100%)",backdropFilter:"blur(20px)",border:"1px solid rgba(255, 61, 113, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&::before":{content:'""',position:"absolute",inset:-2,borderRadius:"50%",padding:2,background:"linear-gradient(90deg, #FF3D71 0%, #FF69B4 100%)",mask:"linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0)",maskComposite:"exclude",opacity:0,transition:"opacity 0.3s"},"&:hover":{transform:"scale(1.1) rotate(90deg)",boxShadow:"0 8px 32px rgba(255, 61, 113, 0.4)",background:"linear-gradient(135deg, rgba(255, 61, 113, 0.2) 0%, rgba(255, 61, 113, 0.3) 100%)","&::before":{opacity:1}}},children:e.jsx(ne,{sx:{fontSize:24,color:"rgba(255, 255, 255, 0.9)"}})}),e.jsx(s,{sx:{position:"absolute",bottom:20,left:"50%",transform:"translateX(-50%)",display:"flex",gap:1,alignItems:"center"},children:t.map((i,g)=>e.jsx(s,{onClick:u=>{u.stopPropagation(),x(g)},sx:{width:g===r?32:8,height:8,borderRadius:1,bgcolor:g===r?"#FF69B4":"rgba(255, 255, 255, 0.3)",cursor:"pointer",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)","&:hover":{bgcolor:g===r?"#FF69B4":"rgba(255, 255, 255, 0.5)"}}},g))}),e.jsx(s,{sx:{position:"absolute",top:20,left:20,color:"white",bgcolor:"rgba(30, 30, 47, 0.95)",backdropFilter:"blur(10px)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:2,px:2,py:1},children:e.jsxs(D,{variant:"body2",sx:{opacity:.8},children:[r+1," из ",t.length]})})]})})})})),ot=ze().shape({content:De().max(2e3,"Message is too long").test("content-or-images","Message cannot be empty",function(){return!0})}),we=15*1024*1024,Q=5,ke=["image/jpeg","image/jpg","image/png","image/gif","image/webp"],st=({activeChannel:a,canSendMessages:t,sending:r,replyingToMessage:c,onSendMessage:x,onReplyCancel:i,onReplyClick:g})=>{var m;const u=o.useRef(null),h=o.useRef(null),k=o.useRef(null),[f,w]=o.useState([]),[L,S]=o.useState(null);o.useEffect(()=>{if(a&&u.current){u.current.focus();const n=u.current.value.length;u.current.setSelectionRange(n,n)}},[a]),o.useEffect(()=>{if(c&&u.current){u.current.focus();const n=u.current.value.length;u.current.setSelectionRange(n,n)}},[c]),o.useEffect(()=>{const n=d=>{d.key==="Escape"&&c&&i()};return document.addEventListener("keydown",n),()=>{document.removeEventListener("keydown",n)}},[c,i]),o.useEffect(()=>{const n=p=>{if(!p.clipboardData)return;const b=Array.from(p.clipboardData.items).filter(T=>T.type.startsWith("image/"));if(b.length===0||f.length>=Q)return;p.preventDefault();const I=[];b.slice(0,Q-f.length).forEach(T=>{const v=T.getAsFile();if(!v)return;if(f.some(X=>X.file.size===v.size&&X.file.type===v.type&&X.file.lastModified===v.lastModified)){console.log("Duplicate image detected, skipping");return}const R=new Date().getTime(),C=Math.random().toString(36).substring(2,8),j=v.type.split("/")[1]||"png",U=new File([v],`pasted-image-${R}-${C}.${j}`,{type:v.type,lastModified:v.lastModified||Date.now()}),q=ke.includes(U.type),P=U.size<=we,Y={file:U,preview:URL.createObjectURL(U),valid:q&&P,error:q?P?void 0:"Файл слишком большой (макс. 15MB)":"Неподдерживаемый формат файла"};I.push(Y)}),I.length>0&&w(T=>[...T,...I])},d=u.current;if(d)return d.addEventListener("paste",n),()=>{d.removeEventListener("paste",n)}},[f.length]),o.useEffect(()=>()=>{f.forEach(n=>URL.revokeObjectURL(n.preview))},[f]);const F=()=>{c&&g&&g(c.id)},M=n=>{var p;if(n.content&&n.content.trim())return z(n.content);const d=((p=n.attachments)==null?void 0:p.length)||0;return d>0?d===1?"📎 Вложение":d>=2&&d<=4?`📎 ${d} вложения`:`📎 ${d} вложений`:"📎 Вложение"},z=n=>n.length>150?!(n.indexOf(" ")!==-1)&&n.length>100?n.substring(0,100)+"...":n.substring(0,150)+"...":n,E=n=>{if(!n.target.files||!n.target.files.length)return;const d=Array.from(n.target.files);if(h.current&&(h.current.value=""),f.length>=Q)return;const p=[];d.slice(0,Q-f.length).forEach(l=>{if(f.some(y=>y.file.size===l.size&&y.file.type===l.type&&y.file.name===l.name&&y.file.lastModified===l.lastModified)){console.log("Duplicate file detected, skipping:",l.name);return}const I=ke.includes(l.type),T=l.size<=we,v={file:l,preview:URL.createObjectURL(l),valid:I&&T,error:I?T?void 0:"Файл слишком большой (макс. 15MB)":"Неподдерживаемый формат файла"};p.push(v)}),p.length>0&&w(l=>[...l,...p])},B=n=>{w(d=>{const p=[...d];return URL.revokeObjectURL(p[n].preview),p.splice(n,1),p})},_=()=>{h.current&&h.current.click()},A=n=>{S(n)};return e.jsxs(s,{sx:{p:2},children:[t?e.jsxs(s,{sx:{display:"flex",flexDirection:"column",gap:1},children:[c&&e.jsxs(le,{sx:{p:"8px 16px",display:"flex",alignItems:"flex-start",gap:1,background:"rgba(30,30,47,0.95)",border:"1px solid rgba(149,128,255,0.25)",borderRadius:2,position:"relative",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",mb:1,pl:3,width:"100%"},children:[e.jsx(s,{sx:{position:"absolute",left:0,top:0,bottom:0,width:"4px",backgroundColor:"#00CFFF",borderTopLeftRadius:2,borderBottomLeftRadius:2}}),e.jsxs(s,{sx:{flex:1,cursor:"pointer"},onClick:F,children:[e.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(xe,{sx:{color:"#00CFFF",fontSize:"0.9rem"}}),e.jsxs(D,{variant:"caption",sx:{color:"#00CFFF",fontWeight:600,display:"flex",alignItems:"center"},children:["Ответ ",(m=c.author)!=null&&m.login?`@${c.author.login}`:""]})]}),e.jsx(D,{variant:"body2",sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.85rem",lineHeight:1.4,wordBreak:"break-word"},children:M(c)})]}),e.jsx(V,{size:"small",onClick:i,sx:{color:"rgba(255,255,255,0.5)","&:hover":{color:"rgba(255,255,255,0.8)"}},children:e.jsx(ne,{fontSize:"small"})})]}),f.length>0&&e.jsxs(le,{sx:{p:2,background:"rgba(30,30,47,0.95)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:2,mb:1},children:[e.jsx(s,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:f.map((n,d)=>e.jsx(s,{sx:{width:{xs:"calc(33.33% - 8px)",sm:"calc(25% - 8px)",md:"calc(16.66% - 8px)"}},children:e.jsxs(s,{sx:{position:"relative",height:100,borderRadius:1,overflow:"hidden",border:n.valid?"1px solid rgba(255,255,255,0.1)":"1px solid #f44336","&:hover .image-remove-btn":{opacity:1}},children:[e.jsx(s,{component:"img",src:n.preview,alt:"Preview",onClick:()=>A(d),sx:{width:"100%",height:"100%",objectFit:"cover",cursor:"pointer"}}),!n.valid&&e.jsx(se,{title:n.error||"Invalid image",children:e.jsx(s,{sx:{position:"absolute",top:5,left:5,bgcolor:"rgba(0,0,0,0.7)",borderRadius:"50%",width:24,height:24,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(et,{sx:{color:"#f44336",fontSize:"16px"}})})}),e.jsx(V,{className:"image-remove-btn",size:"small",onClick:()=>B(d),sx:{position:"absolute",top:5,right:5,bgcolor:"rgba(0,0,0,0.7)",color:"white",p:"4px",opacity:0,transition:"opacity 0.2s","&:hover":{bgcolor:"rgba(0,0,0,0.85)"}},children:e.jsx(ne,{sx:{fontSize:"16px"}})})]})},d))}),e.jsxs(s,{sx:{mt:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(D,{variant:"caption",sx:{color:"rgba(255,255,255,0.7)"},children:[f.length," / ",Q," изображений"]}),f.length>1&&e.jsx(D,{variant:"caption",onClick:()=>{f.forEach(n=>URL.revokeObjectURL(n.preview)),w([])},sx:{color:"#1976D2",cursor:"pointer","&:hover":{textDecoration:"underline"}},children:"Очистить все"})]})]}),e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",multiple:!0,ref:h,onChange:E,style:{display:"none"},max:Q.toString()}),e.jsx(le,{sx:{p:"8px 16px",display:"flex",alignItems:"center",gap:1,background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:3},children:e.jsx(fe,{innerRef:k,initialValues:{content:""},validationSchema:ot,onSubmit:async(n,d)=>{const p=f.filter(l=>l.valid).map(l=>l.file);try{await x({content:n.content,images:p.length>0?p:void 0},d),f.forEach(l=>URL.revokeObjectURL(l.preview)),w([])}catch(l){console.error("Error sending message:",l)}},children:({handleSubmit:n,values:d})=>e.jsxs(e.Fragment,{children:[e.jsx(he,{style:{width:"100%"},children:e.jsx(me,{name:"content",component:Ie,placeholder:"Type a message...",multiline:!0,maxRows:4,size:"small",disabled:!a||r,inputRef:u,sx:{"& .MuiOutlinedInput-root":{"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"},"& .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"}}},onKeyDown:p=>{p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),n())}})}),e.jsxs(We,{direction:"row",spacing:1,children:[e.jsx(V,{size:"small",sx:{color:"#FF69B4"},children:e.jsx(Ze,{})}),e.jsx(se,{title:f.length>=Q?`Максимум ${Q} изображений`:"Прикрепить изображения",children:e.jsxs(s,{children:["  ",e.jsx(V,{size:"small",sx:{color:f.length>=Q?"rgba(255,255,255,0.3)":"#1E90FF"},onClick:_,disabled:f.length>=Q,children:e.jsx(tt,{})})]})}),e.jsx(V,{size:"small",sx:{color:d.content||f.length>0?"#1976D2":"rgba(255,255,255,0.3)",transition:"color 0.25s cubic-bezier(.4,0,.2,1)","&:hover":{color:d.content||f.length>0?"#1976D2":"rgba(255,255,255,0.3)"}},onClick:()=>n(),disabled:r||!d.content&&f.length===0,children:e.jsx(Le,{})})]})]})})})]}):e.jsx(le,{sx:{p:"12px 16px",display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:3},children:e.jsx(D,{sx:{color:"rgba(255,255,255,0.5)",fontSize:"0.9rem"},children:"Недостаточно прав для отправки сообщений"})}),e.jsx(rt,{open:L!==null,images:f,currentIndex:L||0,onClose:()=>S(null),onNavigate:S})]})},bt=({activeChannel:a,canSendMessages:t,sending:r,replyingToMessage:c,onSendMessage:x,onReplyCancel:i,onReplyClick:g})=>e.jsx(st,{activeChannel:a,canSendMessages:t,sending:r,replyingToMessage:c,onSendMessage:x,onReplyCancel:i,onReplyClick:g}),ft=()=>{const[a,t]=o.useState(null),[r,c]=o.useState(null),[x,i]=o.useState(!0),[g,u]=o.useState(!0),[h,k]=o.useState(!1),[f,w]=o.useState("initial"),[L,S]=o.useState(!1),[F,M]=o.useState(!1),[z,E]=o.useState(null),B=o.useRef(!1),_=o.useRef(null),A=o.useRef(null),m=o.useRef(null),n=o.useRef(!1),d=o.useRef(!1),p=o.useCallback(C=>{m.current&&(clearTimeout(m.current),m.current=null),B.current=C,C&&(m.current=setTimeout(()=>{console.warn("[Pagination] Loading timeout - resetting loading state after 10 seconds"),B.current=!1,w(null),m.current=null},1e4))},[]),l=o.useCallback((C,j,U)=>{if(F)return;const q=B.current||f==="initial"||f==="around"||!n.current,P=C.scrollHeight-C.scrollTop-C.clientHeight;if(C.scrollTop<C.scrollHeight*.2&&C.scrollHeight>200&&!q&&x&&j.length>0)if(j.length>=U){p(!0),w("pagination");const O=[...j].sort((H,$)=>new Date(H.created_at).getTime()-new Date($.created_at).getTime())[0];O&&_.current!==O.id&&(t(O.id),_.current=O.id,c(null),A.current=null,S(!1))}else i(!1);if(P/C.scrollHeight*100<40&&!q&&!d.current&&g&&h&&j.length>0&&j.length>0){p(!0),w("pagination");const X=[...j].sort((H,$)=>new Date(H.created_at).getTime()-new Date($.created_at).getTime()),O=X[X.length-1];O&&A.current!==O.id?(c(O.id),A.current=O.id,t(null),_.current=null,S(!1),d.current=!0):O&&(p(!1),w(null))}},[F,f,x,g,h,p]),b=o.useCallback(()=>{t(null),c(null),i(!0),u(!0),k(!1),w("initial"),S(!1),M(!1),E(null),p(!1),_.current=null,A.current=null,n.current=!1,d.current=!1},[p]),I=o.useCallback(C=>{M(!0),E(C),w("around"),S(!0),t(null),c(null),_.current=null,A.current=null,p(!1)},[p]),T=o.useCallback(C=>{n.current=C},[]),v=o.useCallback(()=>{d.current=!1},[]);o.useEffect(()=>()=>{m.current&&clearTimeout(m.current)},[]);const y=o.useMemo(()=>({beforeId:a,afterId:r,hasMoreMessages:x,hasMoreMessagesAfter:g,enableAfterPagination:h,loadingMode:f,skipMainQuery:L,isJumpingToMessage:F,aroundMessageId:z}),[a,r,x,g,h,f,L,F,z]),R=o.useMemo(()=>({setBeforeId:t,setAfterId:c,setHasMoreMessages:i,setHasMoreMessagesAfter:u,setEnableAfterPagination:k,setLoadingMode:w,setSkipMainQuery:S,setIsJumpingToMessage:M,setAroundMessageId:E,handleScrollPagination:l,resetPagination:b,jumpToMessage:I,setInitialLoadComplete:T,clearAfterPaginationCooldown:v}),[l,b,I,T,v]);return{state:y,actions:R,isLoadingMoreRef:B,lastBeforeIdRef:_,lastAfterIdRef:A,setLoadingWithTimeout:p}},ht=({activeChannel:a})=>{const t=o.useRef(new Set),r=o.useCallback(i=>{t.current.add(i)},[]),c=o.useCallback(i=>{a&&t.current.add(i)},[a]),x=o.useCallback(()=>{a&&de.publish(`/app/v1/channels/${a.id}/messages/bulk-read-all`,{})},[a]);return o.useEffect(()=>{if(!a)return;const i=()=>{if(t.current.size>0){const u=Array.from(t.current);de.publish(`/app/v1/channels/${a.id}/messages/bulk-read`,{messageIds:u}),t.current.clear()}},g=setInterval(i,1e3);return()=>{clearInterval(g),i()}},[a]),{unreadMessagesBufferRef:t,markMessageAsRead:c,markAllMessagesAsRead:x,addToReadBuffer:r}},mt=({messagesContainerRef:a,messages:t,activeChannel:r,onScrollToBottom:c,onMarkAllAsRead:x,bulkReadAllRef:i})=>{const[g,u]=o.useState(!0),[h,k]=o.useState(!1),[f,w]=o.useState(!1),[L,S]=o.useState(null),[F,M]=o.useState(!1),z=o.useRef(null),E=o.useRef(null),B=o.useRef(0),_=o.useRef(0),A=o.useRef(0),m=o.useCallback((l=!1)=>{if(!a.current||F)return;const b=a.current;requestAnimationFrame(()=>{if(l){const I=b.style.scrollBehavior;b.style.scrollBehavior="auto",b.scrollTop=b.scrollHeight,b.style.scrollBehavior=I}else b.scrollTop=b.scrollHeight;k(!1),setTimeout(()=>{b.scrollTop<b.scrollHeight-b.clientHeight-100&&(b.scrollTop=b.scrollHeight)},100)})},[F,a]),n=o.useCallback(l=>{if(!a.current)return;const b=document.getElementById(`message-${l}`);if(!b)return;M(!0);const I=a.current,T=b.offsetTop,v=b.offsetHeight,y=I.clientHeight,R=T-y/2+v/2;I.scrollTop=Math.max(0,R),b.style.transition="background-color 0.3s ease-in-out",b.style.backgroundColor="rgba(0, 207, 255, 0.1)",E.current&&clearTimeout(E.current),E.current=setTimeout(()=>{b.style.backgroundColor="",E.current=null},1500)},[a]),d=o.useCallback(()=>{M(!1),x&&x(),m()},[m,x]),p=l=>{const b=new Date(l),I=new Date,T=new Date(I);if(T.setDate(T.getDate()-1),b.toDateString()===I.toDateString())return"Сегодня";if(b.toDateString()===T.toDateString())return"Вчера";const v=b.getFullYear()===I.getFullYear(),y=b.toLocaleDateString([],{weekday:"long",day:"numeric",month:"long",...v?{}:{year:"numeric"}});return y.charAt(0).toUpperCase()+y.slice(1)};return o.useEffect(()=>{const l=a.current;if(!l)return;let b=l.scrollTop,I=!1,T=0,v=null;const y=()=>{v&&clearTimeout(v);const R=l.scrollTop,j=l.scrollHeight-R-l.clientHeight<100;R<b?I||(I=!0,T=Date.now()):R>b&&j&&(I=!1),b=R;const U=Date.now()-T;if((!I||U>1e3)&&u(j),j&&r){M(!1);const Y=Date.now();x&&(i!=null&&i.current)&&Y-lastMarkAllAsReadTime>1e3&&Y-i.current>1e3&&(lastMarkAllAsReadTime=Y,i.current=Y,x())}k(l.scrollTop+l.clientHeight<l.scrollHeight-400),z.current&&clearTimeout(z.current);const q=l.querySelectorAll(".message-item");if(!q.length)return;let P=null;q.forEach(Y=>{const X=Y.getBoundingClientRect(),O=l.getBoundingClientRect();if(X.top>=O.top&&X.bottom<=O.bottom&&!P){const $=Y.getAttribute("data-date");$&&(P=p($))}}),P&&(S(P),w(!0),z.current=setTimeout(()=>{w(!1)},1e3)),v=setTimeout(()=>{v=null},150)};return l.addEventListener("scroll",y),()=>{l.removeEventListener("scroll",y),z.current&&clearTimeout(z.current),v&&clearTimeout(v)}},[r,t,a,x,i]),o.useEffect(()=>{const l=a.current;if(!l)return;const b=t.length,I=A.current;if(b>I&&I>0){const T=l.scrollHeight-B.current;if(T>0){const v=_.current+T;l.scrollTop=v}}A.current=b,B.current=l.scrollHeight,_.current=l.scrollTop},[t.length,a]),o.useEffect(()=>{g&&c&&c()},[g,c]),o.useEffect(()=>()=>{E.current&&clearTimeout(E.current),z.current&&clearTimeout(z.current)},[]),{isScrolledToBottom:g,setIsScrolledToBottom:u,showScrollButton:h,setShowScrollButton:k,showDateLabel:f,setShowDateLabel:w,currentDateLabel:L,setCurrentDateLabel:S,disableAutoScroll:F,setDisableAutoScroll:M,scrollToBottom:m,scrollToMessage:n,handleScrollToBottom:d}},yt=({channelId:a,onSearchResultClick:t})=>{const[r,c]=o.useState(!1),[x,i]=o.useState(""),[g,u]=o.useState(""),[h,k]=o.useState(!1),[f,w]=o.useState(new Set),[L,S]=o.useState(null),[F,M]=o.useState(void 0),[z,E]=o.useState([]),[B,_]=o.useState(!0),A=o.useRef(null),m=o.useRef(null),n=o.useRef(null),d={channelId:a??0,search:g,size:20,...F&&{beforeId:F}},p=!a||!g||!r,{data:l,isLoading:b,isFetching:I}=Ue(d,{skip:p,refetchOnMountOrArgChange:!0}),T=I&&F!==void 0,v=o.useCallback(j=>{i(j),n.current&&clearTimeout(n.current),M(void 0),E([]),_(!0),n.current=setTimeout(()=>{u(j),j.trim()&&k(!0)},300)},[]),y=o.useCallback(j=>{c(!1),i(""),u(""),k(!1),w(new Set),S(null),t(j.id)},[t]),R=o.useCallback(()=>{c(!1),i(""),u(""),k(!1),w(new Set),S(null),M(void 0),E([]),_(!0)},[]),C=o.useCallback(()=>{if(B&&!T&&z.length>0){const j=z[z.length-1];console.log("Loading more, last message id:",j.id,"hasMore:",B),M(j.id)}},[B,T,z]);return o.useEffect(()=>{l?(E(F?j=>{const U=new Set(j.map(P=>P.id)),q=l.filter(P=>!U.has(P.id));return q.length===0&&_(!1),[...j,...q]}:l),_(l.length===20)):g||E([])},[l,F,g]),o.useEffect(()=>{r||(i(""),u(""),k(!1),M(void 0),E([]),_(!0))},[r]),o.useEffect(()=>{const j=U=>{h&&m.current&&A.current&&!m.current.contains(U.target)&&!A.current.contains(U.target)&&k(!1)};return document.addEventListener("mousedown",j),()=>{document.removeEventListener("mousedown",j)}},[h]),o.useEffect(()=>()=>{n.current&&clearTimeout(n.current)},[]),{searchMode:r,setSearchMode:c,searchQuery:x,setSearchQuery:i,debouncedSearchQuery:g,showSearchResults:h,setShowSearchResults:k,searchInputRef:A,searchResultsRef:m,highlightedMessages:f,setHighlightedMessages:w,focusedMessageId:L,setFocusedMessageId:S,searchResults:z,isSearching:b&&F===void 0,handleSearchInputChange:v,handleSearchResultClick:y,clearSearch:R,loadMore:C,hasMore:B,isLoadingMore:T}},Se=(a,t)=>{const r=o.useCallback(t,[t]);o.useEffect(()=>{if(!a)return;let c=!0;return c&&(async()=>{try{await de.subscribe(a,r)}catch(i){console.error("Failed to setup WebSocket subscription:",i)}})(),()=>{c=!1,de.unsubscribe(a,r)}},[a,r])},jt=(a,t,r,c)=>{const x=o.useRef(0),i=o.useCallback(()=>{if(!a)return;const u=Date.now();u-x.current>1e3&&u-c.bulkReadAllRef.current>1e3&&(x.current=u,c.bulkReadAllRef.current=u,de.publish(`/app/v1/channels/${a.id}/messages/bulk-read-all`,{}),r.onMarkAllAsRead())},[a,r.onMarkAllAsRead,c.bulkReadAllRef]),g=o.useCallback(u=>{if(u.type==="MESSAGE_CREATE"&&u.message){const h=c.convertToExtendedMessage(u.message);if(h.author.id===(t==null?void 0:t.id))return;if(r.onMessageCreate(h),r.onHighlightMessage(h.id,1500),h.status===2){const k=c.messagesContainerRef.current;if(k){const f=k.scrollHeight-k.scrollTop-k.clientHeight,w=f<100,L=f>300;w&&a?(c.addToReadBuffer(h.id),r.onMarkMessageAsRead(h.id),c.loadingMode!=="around"&&!c.isJumpingToMessage&&r.onScrollToBottom(),i()):L?(r.onNewMessageIndicator(!0),r.onUnreadMessage(h.id),setTimeout(()=>{const S=document.querySelector(`[data-msg-id="${h.id}"]`);if(S){const F=S.getBoundingClientRect();F.top>=0&&F.bottom<=window.innerHeight&&a&&(c.addToReadBuffer(h.id),r.onMarkMessageAsRead(h.id))}},100)):(c.addToReadBuffer(h.id),r.onMarkMessageAsRead(h.id),c.loadingMode!=="around"&&!c.isJumpingToMessage&&r.onScrollToBottom(),i())}}}else if(u.type==="MESSAGE_UPDATE"&&u.message){const h=c.convertToExtendedMessage(u.message);r.onMessageUpdate(h),h.status===1&&r.onUnreadCountChange(-1)}else u.type==="MESSAGE_DELETE"&&u.messageId?(r.onMessageDelete(u.messageId),r.onUnreadCountChange(-1)):u.type==="MESSAGE_READ_STATUS"&&u.message_range&&r.onMessageReadStatus(u.message_range)},[t==null?void 0:t.id,a,c.convertToExtendedMessage,c.isJumpingToMessage,c.loadingMode,c.messagesContainerRef,c.addToReadBuffer,r.onMessageCreate,r.onMessageUpdate,r.onMessageDelete,r.onMessageReadStatus,r.onHighlightMessage,r.onUnreadMessage,r.onMarkMessageAsRead,r.onNewMessageIndicator,r.onScrollToBottom,i,r.onUnreadCountChange]);return Se(a&&t?`/v1/user/${t.id}/queue/channels/${a.id}/messages`:null,g),Se(a?`/v1/topic/channels/${a.id}/messages`:null,g),{}};var ge=(a=>(a[a.SENT=0]="SENT",a[a.READ=1]="READ",a[a.NEW=2]="NEW",a))(ge||{});const wt=()=>{const[a,t]=o.useState([]),[r,c]=o.useState(new Map),[x,i]=o.useState(new Set),[g,u]=o.useState(0),[h,k]=o.useState(0),f=o.useCallback(n=>({...n,status:"status"in n?n.status:ge.SENT}),[]),w=o.useCallback(()=>{t([]),c(new Map),i(new Set),u(0),k(0)},[]),L=o.useCallback((n,d)=>{t(p=>p.map(l=>l.id===n&&l.author.id!==d?{...l,status:ge.READ}:l))},[]),S=o.useCallback(n=>{t(d=>d.map(p=>p.author.id!==n?{...p,status:ge.READ}:p)),i(new Set),u(0),k(0)},[]),F=o.useCallback((n,d)=>{t(p=>p.map(l=>{if(l.id>=n.from&&l.id<=n.to&&l.author.id===d){const b=l.read_by_count||0;return{...l,read_by_count:b+1}}return l}))},[]),M=o.useCallback(n=>{t(d=>d.some(b=>b.id===n)?d.filter(b=>b.id!==n).map(b=>b.reply&&b.reply.id===n?{...b,reply:void 0}:b):d)},[]),z=o.useCallback(n=>{t(d=>d.some(l=>l.id===n.id)?d.map(l=>l.id===n.id?n:l):d)},[]),E=o.useCallback(n=>{t(d=>d.some(l=>l.id===n.id)?d:[...d,n])},[]),B=o.useCallback(n=>{i(d=>{const p=new Set(d);return p.add(n),p}),u(d=>d+1),k(d=>d+1)},[]),_=o.useCallback(n=>{i(d=>{const p=new Set(d);return p.delete(n),p}),u(d=>Math.max(0,d-1)),k(d=>Math.max(0,d-1))},[]),A=o.useCallback(n=>{u(d=>Math.max(0,d+n)),k(d=>Math.max(0,d+n))},[]),m=o.useCallback(()=>{u(0),k(0)},[]);return{messages:a,setMessages:t,tempMessages:r,setTempMessages:c,unreadMessages:x,setUnreadMessages:i,unreadCount:g,setUnreadCount:u,newMessagesCount:h,setNewMessagesCount:k,convertToExtendedMessage:f,resetMessageStates:w,updateMessageReadStatus:L,markAllMessagesAsReadInState:S,updateMessageReadByCount:F,deleteMessageFromState:M,updateMessageInState:z,addMessageToState:E,addUnreadMessage:B,removeUnreadMessage:_,updateUnreadCount:A,resetUnreadCounts:m}};export{bt as C,pt as D,ge as M,xt as N,gt as S,ft as a,ht as b,mt as c,yt as d,jt as e,ut as f,wt as u};
