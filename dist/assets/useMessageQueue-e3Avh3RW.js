var lt=Object.defineProperty;var ct=(s,t,o)=>t in s?lt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):s[t]=o;var Se=(s,t,o)=>ct(s,typeof t!="symbol"?t+"":t,o);import{f as se,j as e,r,bt as He,bu as dt,t as ue,B as i,k as G,a5 as fe,I as K,bv as Y,R as N,e as he,U as Ue,T as P,bw as Pe,g as ut,aI as Ce,Y as Me,M as Oe,Z as Re,b1 as De,O as Ne,bx as qe,by as pt,S as gt,X as ht,$ as Te,P as xe,Q as ft,w as be}from"./index-aQ4zL47U.js";import{D as Ve,C as xt}from"./Dialog-QW_xAq5S.js";import{I as Qe}from"./Input-DLCesp6X.js";const bt=se(e.jsx("path",{d:"m18 7-1.41-1.41-6.34 6.34 1.41 1.41zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12zM.41 13.41 6 19l1.41-1.41L1.83 12z"})),Ye=se(e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11"})),mt=se(e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"})),yt=se(e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"})),de=se([e.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"},"0"),e.jsx("path",{d:"M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"},"1")]);class St{constructor(){Se(this,"observer",null);Se(this,"callbacks",new Map);Se(this,"observedElements",new WeakSet)}createObserver(){return this.observer?this.observer:(this.observer=new IntersectionObserver(t=>{t.forEach(o=>{const a=this.callbacks.get(o.target);a&&a(o.isIntersecting)})},{threshold:.1,rootMargin:"500px"}),this.observer)}observe(t,o){if(this.observedElements.has(t))return;const a=this.createObserver();this.callbacks.set(t,o),this.observedElements.add(t),a.observe(t)}unobserve(t){!this.observer||!this.observedElements.has(t)||(this.observer.unobserve(t),this.callbacks.delete(t),this.observedElements.delete(t),this.callbacks.size===0&&(this.observer.disconnect(),this.observer=null))}disconnect(){this.observer&&(this.observer.disconnect(),this.observer=null),this.callbacks.clear()}}const _e=new St,wt=s=>{const t=r.useRef(null),o=r.useRef(s);r.useEffect(()=>{o.current=s},[s]);const a=r.useCallback(()=>{const d=t.current;d&&_e.observe(d,x=>{o.current(x)})},[]),h=r.useCallback(()=>{const d=t.current;d&&_e.unobserve(d)},[]);return r.useEffect(()=>(a(),h),[a,h]),{elementRef:t}},le=({storageKey:s,alt:t="",sx:o,className:a,onClick:h,loadingMode:d=null,staggerIndex:x=0})=>{const{getSignedUrl:b,hasSignedUrl:m}=He(),n=dt(j=>j.user.currentUser),[g,f]=r.useState(!0),[R,c]=r.useState(!1),[I,A]=r.useState(!1),[F,L]=r.useState(!1),B=r.useCallback(j=>{if(j&&!I){A(!0);const u=Math.min(x*50,500);setTimeout(()=>{L(!0)},u)}},[I,x]),{elementRef:z}=wt(B);if(!n)return e.jsx(ue,{ref:z,variant:"rectangular",className:a,sx:{width:"100%",height:"100%",bgcolor:"rgba(255,255,255,0.05)",cursor:h?"pointer":"default",...o}});const S=F?b(s,n.id):null;return!F||!S||!m(s)?e.jsx(ue,{ref:z,variant:"rectangular",className:a,sx:{width:"100%",height:"100%",bgcolor:"rgba(255,255,255,0.05)",cursor:h?"pointer":"default",...o,"&::after":{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent)",animationDuration:"1.5s"}}}):e.jsxs(i,{ref:z,className:a,onClick:h,sx:{width:"100%",height:"100%",position:"relative",overflow:"hidden",cursor:h?"pointer":"default",...o},children:[g&&e.jsx(ue,{variant:"rectangular",sx:{position:"absolute",top:0,left:0,right:0,bottom:0,width:"100%",height:"100%",bgcolor:"rgba(255,255,255,0.05)",zIndex:1,"&::after":{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent)",animationDuration:"1.2s"}}}),R?e.jsx(i,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"rgba(255,255,255,0.05)",color:"rgba(255,255,255,0.3)",fontSize:"2rem",border:"1px dashed rgba(255,255,255,0.1)",borderRadius:"inherit"},children:"❌"}):e.jsx("img",{src:S,alt:t,loading:"lazy",decoding:"async",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:"inherit",transition:"opacity 0.3s ease",willChange:"auto"},onLoad:()=>f(!1),onError:()=>{f(!1),c(!0)}})]})},Ke=se(e.jsx("path",{d:"M11.67 3.87 9.9 2.1 0 12l9.9 9.9 1.77-1.77L3.54 12z"})),Ge=se(e.jsx("path",{d:"M6.23 20.23 8 22l10-10L8 2 6.23 3.77 14.46 12z"})),kt=se(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-2h2zm0-4h-2V7h2z"})),jt=se(e.jsx("path",{d:"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2M8.5 13.5l2.5 3.01L14.5 12l4.5 6H5z"})),ve=se(e.jsx("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"})),Xe=se(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"})),Ct=G(Ve)({"& .MuiBackdrop-root":{backgroundColor:"rgba(0, 0, 0, 0.8)",backdropFilter:"blur(8px)"},"& .MuiDialog-paper":{backgroundColor:"rgba(30, 30, 47, 0.95)",backdropFilter:"blur(10px)",borderRadius:"16px",border:"1px solid rgba(255, 255, 255, 0.1)",maxWidth:"70vw",maxHeight:"90vh",margin:"auto",overflow:"hidden"}}),vt=G("div")({position:"relative",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",userSelect:"none",padding:"20px"}),Le=G(K)({position:"absolute",top:"50%",transform:"translateY(-50%)",width:56,height:56,backgroundColor:"rgba(0, 0, 0, 0.6)",border:`1px solid ${Y.primary}30`,color:Y.text.primary,transition:"all 0.2s ease","&:hover":{backgroundColor:`${Y.primary}20`,borderColor:`${Y.primary}60`,transform:"translateY(-50%) scale(1.1)",boxShadow:`0 0 20px ${Y.primary}40`},"&:active":{transform:"translateY(-50%) scale(0.95)"}}),Mt=G(K)({position:"absolute",top:20,right:20,width:48,height:48,backgroundColor:"rgba(0, 0, 0, 0.6)",border:"1px solid rgba(255, 61, 113, 0.3)",color:Y.text.primary,transition:"all 0.2s ease","&:hover":{backgroundColor:"rgba(255, 61, 113, 0.2)",borderColor:"rgba(255, 61, 113, 0.6)",transform:"scale(1.1) rotate(90deg)",boxShadow:"0 0 20px rgba(255, 61, 113, 0.4)"}}),Rt=G(i)({position:"absolute",bottom:24,left:"50%",transform:"translateX(-50%)",padding:"8px 16px",backgroundColor:"rgba(0, 0, 0, 0.7)",border:`1px solid ${Y.primary}30`,borderRadius:"20px",color:Y.text.primary,fontSize:"14px",fontWeight:600,backdropFilter:"blur(10px)"}),Dt=G(i)({position:"absolute",bottom:60,left:"50%",transform:"translateX(-50%)",display:"flex",gap:"8px",alignItems:"center"}),It=G("button")(({active:s})=>({width:s?24:8,height:8,border:"none",borderRadius:"4px",backgroundColor:s?Y.primary:"rgba(255, 255, 255, 0.3)",cursor:"pointer",transition:"all 0.2s ease","&:hover":{backgroundColor:s?Y.primary:"rgba(255, 255, 255, 0.5)",transform:"scale(1.2)"}})),Et=G(i)({width:"100%",height:"calc(90vh - 120px)",display:"flex",alignItems:"center",justifyContent:"center"}),zt=({open:s,images:t,currentIndex:o,onClose:a,onNavigate:h})=>{const d=r.useMemo(()=>t[o],[t,o]),x=r.useCallback(()=>{o>0&&h(o-1)},[o,h]),b=r.useCallback(()=>{o<t.length-1&&h(o+1)},[o,t.length,h]),m=r.useCallback(n=>{switch(n.key){case"Escape":a();break;case"ArrowLeft":x();break;case"ArrowRight":b();break}},[a,x,b]);return d?e.jsx(Ct,{open:s,onClose:a,onKeyDown:m,children:e.jsxs(vt,{onClick:a,children:[e.jsx(Et,{onClick:n=>n.stopPropagation(),children:e.jsx(le,{storageKey:d,alt:"Preview",sx:{width:"100%",height:"100%",objectFit:"contain",borderRadius:"12px",filter:"drop-shadow(0 8px 32px rgba(0,0,0,0.8))",transition:"transform 0.2s ease","&:hover":{transform:"scale(1.01)"}}})}),o>0&&e.jsx(Le,{onClick:n=>{n.stopPropagation(),x()},style:{left:32},children:e.jsx(Ke,{})}),o<t.length-1&&e.jsx(Le,{onClick:n=>{n.stopPropagation(),b()},style:{right:32},children:e.jsx(Ge,{})}),e.jsx(Mt,{onClick:n=>{n.stopPropagation(),a()},children:e.jsx(fe,{})}),t.length>1&&e.jsxs(e.Fragment,{children:[e.jsxs(Rt,{children:[o+1," / ",t.length]}),e.jsx(Dt,{children:t.map((n,g)=>e.jsx(It,{active:g===o,onClick:f=>{f.stopPropagation(),h(g)}},g))})]})]})}):null},Ft=s=>new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),Tt=s=>{var o;if(s.content&&s.content.trim())return s.content;const t="attachments_count"in s?s.attachments_count:((o=s.attachments)==null?void 0:o.length)||0;return t>0?t===1?"📎 Вложение":t>=2&&t<=4?`📎 ${t} вложения`:`📎 ${t} вложений`:"📎 Вложение"},Je=N.memo(s=>{const{message:t,isFirstInGroup:o=s.isFirstOfGroup||!1,isTempMessage:a=!1,isHighlighted:h=!1,isUnread:d=!1,isFocused:x=!1,isSearchMode:b=!1,searchQuery:m="",currentUserId:n,hubId:g=0,loadingMode:f=null,onReply:R,onEdit:c,onDelete:I,onReplyClick:A,onMouseEnter:F,onMouseLeave:L}=s,[B,z]=r.useState(!1),S=N.useRef(null),[j,u]=r.useState(null),[D,_]=r.useState(0),l=t.attachments&&t.attachments.length>0,p=N.useCallback((y,M)=>{u(y),_(M)},[]),w=N.useCallback(()=>{t.reply&&A&&A(t.reply.id)},[t.reply,A]),T=N.useCallback(()=>{t&&R&&R(t)},[t,R]),C=N.useCallback(()=>{c&&typeof c=="function"&&c(t.id)},[c,t.id]),v=N.useCallback(()=>{I&&typeof I=="function"&&I(t.id)},[I,t.id]);return e.jsxs(e.Fragment,{children:[e.jsxs(i,{id:`message-${t.id}`,className:"message-item","data-date":t.created_at,"data-msg-id":t.id.toString(),onMouseEnter:y=>{S.current&&(clearTimeout(S.current),S.current=null),z(!0),F&&F(y,t)},onMouseLeave:y=>{S.current=setTimeout(()=>{z(!1),L&&L(y)},100)},sx:{display:"flex",gap:2,alignItems:"flex-start",position:"relative",borderRadius:"10px",overflow:"visible",transition:"background-color 0.2s ease",opacity:a?.6:1,mt:o?3:.5,px:1.5,py:.5,backgroundColor:x?"rgba(0, 207, 255, 0.25)":h?"rgba(33, 150, 243, 0.25)":d?"rgba(25,118,210,0.1)":"transparent","&.highlight-pulse":{animation:"pulse 2s infinite"},"&:hover":{backgroundColor:x?"rgba(0, 207, 255, 0.35)":h?"rgba(33, 150, 243, 0.35)":d?"rgba(25,118,210,0.15)":"rgba(255,255,255,0.05)"}},children:[B&&e.jsxs(i,{sx:{position:"absolute",top:-40,left:"50%",transform:"translateX(-50%)",display:"flex",gap:.5,zIndex:1e3,padding:"6px 8px",borderRadius:"20px",background:"rgba(40, 44, 52, 0.95)",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",transition:"all 0.2s ease",opacity:1,animation:"fadeIn 0.2s ease-in-out","@keyframes fadeIn":{from:{opacity:0,transform:"translateX(-50%) translateY(5px)"},to:{opacity:1,transform:"translateX(-50%) translateY(0)"}}},children:[e.jsx(he,{title:"Ответить",enterDelay:1e3,placement:"top",children:e.jsx(K,{size:"small",onClick:T,sx:{color:"#00CFFF",transition:"all 0.2s ease","&:hover":{color:"#E5FBFF",transform:"scale(1.05)"}},children:e.jsx(Ye,{fontSize:"small"})})}),t.author.id===n&&e.jsxs(e.Fragment,{children:[e.jsx(he,{title:"Редактировать",enterDelay:1e3,placement:"top",children:e.jsx(K,{size:"small",onClick:C,sx:{color:"#00CFFF",transition:"transform 0.15s ease, color 0.15s ease","&:hover":{color:"#E5FBFF",transform:"scale(1.02)"}},children:e.jsx(mt,{fontSize:"small"})})}),e.jsx(he,{title:"Удалить",enterDelay:1e3,placement:"top",children:e.jsx(K,{size:"small",onClick:v,sx:{color:"#FF3D71",transition:"transform 0.15s ease, color 0.15s ease","&:hover":{color:"#FF708D",transform:"scale(1.02)"}},children:e.jsx(yt,{fontSize:"small"})})})]})]}),e.jsx(i,{sx:{width:40,display:"flex",flexDirection:"column",alignItems:"center",mt:1},children:o?e.jsx("div",{style:{cursor:"pointer"},children:e.jsx(Ue,{src:t.author.avatar||void 0,alt:t.author.login,userId:t.author.id,hubId:g})}):null}),e.jsxs(i,{sx:{flex:1,position:"relative"},children:[e.jsx(i,{sx:{maxWidth:"99%"},children:e.jsxs(i,{sx:{py:"5px",px:"0px",pl:0},children:[o&&e.jsx(P,{sx:{color:"#00CFFF",fontWeight:700,mb:.5,fontSize:"1rem",letterSpacing:.2},children:t.author.login}),t.reply&&e.jsx(i,{sx:{mb:.8,mt:.25},children:e.jsxs(i,{sx:{display:"flex",flexDirection:"column",borderRadius:"8px",padding:"6px 10px",ml:0,background:"rgba(0, 207, 255, 0.06)",borderLeft:"3px solid #00CFFF",cursor:"pointer",transition:"transform 0.15s ease, color 0.15s ease","&:hover":{background:"rgba(0, 207, 255, 0.1)",transform:"translateX(2px)"}},onClick:w,children:[e.jsx(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:e.jsx(P,{sx:{color:"#00CFFF",fontSize:"0.75rem",fontWeight:"600",letterSpacing:.3},children:t.reply.author.login})}),e.jsx(P,{sx:{color:"rgba(255,255,255,0.6)",fontSize:"0.8rem",mt:.2,lineHeight:1.3,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"400px"},children:Tt(t.reply)})]})})]})}),l&&e.jsx(i,{sx:{mt:1.5,mb:1},children:(()=>{var M;const y=((M=t.attachments)==null?void 0:M.length)||0;return y===1?e.jsxs(i,{sx:{position:"relative",borderRadius:3,overflow:"hidden",maxWidth:"450px",height:"300px",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 8px 32px rgba(0,0,0,0.12)",background:"linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"translateY(-2px)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)","& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.02)"}}},onClick:()=>p(t.attachments[0],0),children:[e.jsx(le,{storageKey:t.attachments[0],className:"attachment-image",alt:"",loadingMode:f,staggerIndex:0,sx:{width:"100%",height:"100%",borderRadius:3,transition:"transform 0.2s ease"}}),e.jsx(i,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(de,{sx:{color:"white",fontSize:"36px",filter:"drop-shadow(0 2px 8px rgba(0,0,0,0.4))"}})})]}):y===2?e.jsx(i,{sx:{display:"flex",gap:1,maxWidth:"450px"},children:t.attachments.map((E,k)=>e.jsxs(i,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",flex:1,height:"200px",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"translateY(-2px) scale(1.02)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>p(E,k),children:[e.jsx(le,{loadingMode:f,storageKey:E,className:"attachment-image",alt:"",staggerIndex:k,sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(i,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(de,{sx:{color:"white",fontSize:"28px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(i,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:[k+1,"/",y]})]},k))}):y===3?e.jsxs(i,{sx:{display:"flex",gap:1,maxWidth:"450px",height:"280px"},children:[e.jsxs(i,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",flex:2,cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.01)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>p(t.attachments[0],0),children:[e.jsx(le,{loadingMode:f,storageKey:t.attachments[0],className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(i,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(de,{sx:{color:"white",fontSize:"32px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(i,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:["1/",y]})]}),e.jsx(i,{sx:{display:"flex",flexDirection:"column",gap:1,flex:1},children:t.attachments.slice(1,3).map((E,k)=>e.jsxs(i,{sx:{position:"relative",borderRadius:2,overflow:"hidden",flex:1,cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.01)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>p(E,k+1),children:[e.jsx(le,{loadingMode:f,storageKey:E,className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(i,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(de,{sx:{color:"white",fontSize:"24px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(i,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:[k+2,"/",y]})]},k+1))})]}):y===4?e.jsx(i,{sx:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:1,maxWidth:"400px",aspectRatio:"1"},children:t.attachments.map((E,k)=>e.jsxs(i,{sx:{position:"relative",borderRadius:2,overflow:"hidden",aspectRatio:"1",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.03)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.08)"}}},onClick:()=>p(E,k),children:[e.jsx(le,{loadingMode:f,storageKey:E,className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(i,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(de,{sx:{color:"white",fontSize:"28px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(i,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:[k+1,"/",y]})]},k))}):y>=5?e.jsxs(i,{sx:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:1,maxWidth:"450px",aspectRatio:"3/2"},children:[e.jsxs(i,{sx:{position:"relative",borderRadius:2.5,overflow:"hidden",gridColumn:"span 2",cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 6px 24px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.01)",boxShadow:"0 12px 32px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>p(t.attachments[0],0),children:[e.jsx(le,{loadingMode:f,storageKey:t.attachments[0],className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(i,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:e.jsx(de,{sx:{color:"white",fontSize:"32px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(i,{sx:{position:"absolute",top:8,right:8,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"12px",px:1.5,py:.5,fontSize:"0.75rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:["1/",y]})]}),e.jsx(i,{sx:{display:"flex",flexDirection:"column",gap:1},children:t.attachments.slice(1,3).map((E,k)=>e.jsxs(i,{sx:{position:"relative",borderRadius:2,overflow:"hidden",flex:1,cursor:"pointer",transition:"transform 0.2s ease, box-shadow 0.2s ease",boxShadow:"0 4px 16px rgba(0,0,0,0.1)",border:"1px solid rgba(255,255,255,0.08)","&:hover":{transform:"scale(1.03)",boxShadow:"0 8px 24px rgba(0,0,0,0.15)",border:"1px solid rgba(0, 207, 255, 0.3)",zIndex:2,"& .zoom-overlay":{opacity:1},"& .attachment-image":{transform:"scale(1.03)"}}},onClick:()=>p(E,k+1),children:[e.jsx(le,{loadingMode:f,storageKey:E,className:"attachment-image",alt:"",sx:{width:"100%",height:"100%",objectFit:"cover",transition:"transform 0.2s ease"}}),e.jsx(i,{className:"zoom-overlay",sx:{position:"absolute",inset:0,background:"linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%)",display:"flex",alignItems:"center",justifyContent:"center",opacity:0,transition:"opacity 0.3s ease"},children:k===1&&y>3?e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:.5},children:[e.jsxs(P,{sx:{color:"white",fontSize:"1.2rem",fontWeight:700,textShadow:"0 2px 8px rgba(0,0,0,0.8)"},children:["+",y-3]}),e.jsx(P,{sx:{color:"white",fontSize:"0.75rem",fontWeight:500,textShadow:"0 1px 4px rgba(0,0,0,0.8)",opacity:.9},children:"ещё"})]}):e.jsx(de,{sx:{color:"white",fontSize:"20px",filter:"drop-shadow(0 2px 6px rgba(0,0,0,0.4))"}})}),e.jsxs(i,{sx:{position:"absolute",top:6,right:6,backgroundColor:"rgba(0,0,0,0.75)",color:"white",borderRadius:"10px",px:1,py:.25,fontSize:"0.7rem",fontWeight:600,border:"1px solid rgba(255,255,255,0.15)"},children:[k+2,"/",y]})]},k+1))})]}):null})()}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",position:"relative"},children:[t.content&&e.jsx(P,{sx:{color:"rgba(255,255,255,0.85)",wordBreak:"break-word",fontSize:"1.01rem",whiteSpace:"pre-wrap",pr:"120px",pl:0,lineHeight:1.4},component:"span",dangerouslySetInnerHTML:{__html:Pe.sanitize((()=>{let y=t.content.replace(/\r\n/g,`
`).replace(/\n/g,"<br>");if(b&&m.trim()){const E=m.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),k=new RegExp(`(${E})`,"gi");y=y.replace(k,'<span style="background-color: rgba(0, 207, 255, 0.3); color: #fff; border-radius: 2px; padding: 0; font-weight: 600;">$1</span>')}return y})())}}),!t.content&&l&&e.jsx(i,{sx:{minHeight:"20px"}}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5,position:"absolute",bottom:t.content?"7px":"22px",right:0,padding:"0 8px"},children:[t.last_modified_at&&t.last_modified_at!==t.created_at&&e.jsx("span",{style:{color:"#90caf9",fontSize:"0.85em",fontStyle:"italic",fontWeight:500},children:"ред."}),t.author.id===n&&e.jsx(i,{sx:{display:"flex",alignItems:"center",gap:.5,mr:.5},children:e.jsx(bt,{sx:{fontSize:"1rem",color:t.read_by_count&&t.read_by_count>0?"#FF69B4":"rgba(255,255,255,0.35)"}})}),e.jsx(P,{sx:{color:"rgba(255,255,255,0.35)",fontSize:"0.78rem",lineHeight:1,whiteSpace:"nowrap",display:"flex",alignItems:"center",gap:.5},children:Ft(t.created_at)})]})]})]})]}),e.jsx(zt,{open:!!j,images:t.attachments||[],currentIndex:D,onClose:()=>u(null),onNavigate:y=>{_(y),u(t.attachments[y])}})]})});Je.displayName="ChatMessageItem";const _t=ut.injectEndpoints({endpoints:s=>({signMediaUrls:s.mutation({query:t=>({url:"/api/v1/media-sign",method:"POST",body:t}),invalidatesTags:["Media"]})})}),{useSignMediaUrlsMutation:Lt}=_t,At=Oe().shape({content:Ne().min(1,"Message cannot be empty").max(2e3,"Message is too long")}),je=new Map,Bt=s=>{const t=s.split("T")[0];if(je.has(t))return je.get(t);const o=new Date(s),a=new Date,h=new Date(a);h.setDate(h.getDate()-1);let d;if(o.toDateString()===a.toDateString())d="Сегодня";else if(o.toDateString()===h.toDateString())d="Вчера";else{const x=o.getFullYear()===a.getFullYear(),b=o.toLocaleDateString([],{weekday:"long",day:"numeric",month:"long",...x?{}:{year:"numeric"}});d=b.charAt(0).toUpperCase()+b.slice(1)}return je.set(t,d),d},$t=(s,t,o=30)=>{const a=new Date(s),h=new Date(t);return Math.abs(a.getTime()-h.getTime())/(1e3*60)<=o},Wt=(s,t)=>{const o=new Date(s),a=new Date(t);return o.toDateString()===a.toDateString()},sr=({activeChannel:s,messages:t,tempMessages:o,searchMode:a,searchQuery:h,highlightedMessages:d,focusedMessageId:x,unreadMessages:b,isLoadingMore:m,isLoadingAround:n,editingMessageId:g,user:f,hubId:R,paginationState:c,messagesPerPage:I,showDateLabel:A,currentDateLabel:F,messagesContainerRef:L,messagesEndRef:B,editInputRef:z,highlightTimeoutRef:S,scrollToMessageIdRef:j,hoverTimeoutRef:u,isHoveringPortal:D,scrollCorrectionRef:_,forceScrollToMessageId:l,setHighlightedMessages:p,setFocusedMessageId:w,setEditingMessageId:T,setMessages:C,setTempMessages:v,setReplyingToMessage:y,setHoveredMessage:M,setTargetMessageId:E,paginationActions:k,handleEditMessage:W,handleDeleteMessage:Q})=>{const[J]=Lt(),{setSignedUrls:oe,hasSignedUrl:ce}=He(),X=N.useRef(new Set),q=N.useMemo(()=>[...t].sort(($,O)=>new Date($.created_at).getTime()-new Date(O.created_at).getTime()),[t]);N.useEffect(()=>{if(!t.length)return;const $=new Set;t.forEach(U=>{U.attachments&&U.attachments.length>0&&U.attachments.forEach(V=>{V.trim()&&$.add(V)})});const O=Array.from($).filter(U=>!ce(U)&&!X.current.has(U));O.length>0&&(O.forEach(U=>X.current.add(U)),J({storage_keys:O}).unwrap().then(U=>{console.log("Media URLs signed:",U),oe(U),O.forEach(V=>X.current.delete(V))}).catch(U=>{console.error("Failed to sign media URLs:",U),O.forEach(V=>X.current.delete(V))}))},[t,J,oe,ce]);const Z=N.useMemo(()=>t.length===0&&o.size===0,[t.length,o.size]),pe=N.useMemo(()=>Z&&!m&&!n&&c.loadingMode!=="initial"&&c.loadingMode!=="around"&&!c.isJumpingToMessage&&!!s,[Z,m,n,c.loadingMode,c.isJumpingToMessage,s]),ge=N.useMemo(()=>{const $=Array.from(o.entries()).map(([O,U])=>({...U,__isTemp:!0,__tempId:O}));return[...q,...$]},[q,o]),Ze=pe&&e.jsx(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(P,{variant:"body1",color:"text.secondary",children:a?"No messages found matching your search.":"No messages yet. Start a conversation!"})}),et=N.useCallback($=>{if(q.some(U=>U.id===$)){const U=document.querySelector(`[data-msg-id='${$}']`);U&&(U.scrollIntoView({behavior:"smooth",block:"center"}),S.current&&(clearTimeout(S.current),S.current=null),w(null),p(new Set),w($),p(()=>{const V=new Set;return V.add($),V}),S.current=setTimeout(()=>{p(V=>{const ee=new Set(V);return ee.delete($),ee}),w(null),S.current=null},1500))}else k.setIsJumpingToMessage(!0),k.setSkipMainQuery(!0),C([]),v(new Map),k.setBeforeId(null),k.setAfterId(null),k.setHasMoreMessages(!0),k.setHasMoreMessagesAfter(!0),k.setEnableAfterPagination(!0),E($),k.setAroundMessageId($),k.setLoadingMode("around")},[q,w,p,S,k,C,v,E]),tt=N.useCallback($=>{y($)},[y]),rt=N.useCallback($=>T(typeof $=="number"?$:$.id),[T]),st=N.useCallback($=>Q(typeof $=="number"?$:$.id),[Q]),ot=N.useCallback(($,O)=>{u!=null&&u.current&&(clearTimeout(u.current),u.current=null),M&&O&&M({element:$.currentTarget,message:O})},[u,M]),nt=N.useCallback(()=>{u&&(u.current=setTimeout(()=>{!(D!=null&&D.current)&&M&&M(null)},100))},[u,D,M]),at=()=>e.jsx(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",color:"rgba(255,255,255,0.5)",textAlign:"center",gap:2},children:c.loadingMode==="around"||c.isJumpingToMessage||n?e.jsx(i,{sx:{width:"100%",height:"100%",overflowY:"auto",p:3,display:"flex",flexDirection:"column",gap:2},children:[...Array(I)].map(($,O)=>e.jsxs(i,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[e.jsx(ue,{variant:"circular",width:40,height:40,sx:{bgcolor:"rgba(255,255,255,0.1)"}}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(ue,{variant:"text",width:120,height:24,sx:{bgcolor:"rgba(255,255,255,0.1)",mb:1}}),e.jsx(ue,{variant:"text",width:"80%",height:20,sx:{bgcolor:"rgba(255,255,255,0.1)"}}),e.jsx(ue,{variant:"text",width:"60%",height:20,sx:{bgcolor:"rgba(255,255,255,0.1)"}})]})]},O))}):a&&h&&h.trim()?e.jsxs(e.Fragment,{children:[e.jsx(P,{variant:"h6",children:"Нет результатов поиска"}),e.jsx(P,{variant:"body2",children:"Попробуйте изменить поисковый запрос"})]}):e.jsxs(e.Fragment,{children:[e.jsx(P,{variant:"h6",children:"Нет сообщений"}),e.jsx(P,{variant:"body2",children:"Начните общение, отправив первое сообщение"})]})}),Ie=N.useRef(null),Ee=N.useRef(null);return N.useEffect(()=>{const $=Ie.current,O=Ee.current;if(!$||!O)return;const U=H=>{const[me]=H;if(me.isIntersecting&&c.hasMoreMessages&&!c.isJumpingToMessage&&c.loadingMode!=="pagination"&&c.loadingMode!=="around"){const re=q[0];re&&(k.setBeforeId(re.id),k.setLoadingMode("pagination"))}},V=H=>{const[me]=H;if(me.isIntersecting&&c.enableAfterPagination&&c.hasMoreMessagesAfter&&!c.isJumpingToMessage&&c.loadingMode!=="pagination"&&c.loadingMode!=="around"){const re=q[q.length-1];re&&(k.setAfterId(re.id),k.setLoadingMode("pagination"))}},ee=new IntersectionObserver(U,{root:L.current,threshold:.1}),te=new IntersectionObserver(V,{root:L.current,threshold:.8});return ee.observe($),te.observe(O),()=>{ee.disconnect(),te.disconnect()}},[q,c,k,L]),N.useEffect(()=>{var V;const $=L.current;if(!$)return;const O=l??((j==null?void 0:j.current)||null);if(O===null)return;if(c.enableAfterPagination&&c.loadingMode==="pagination"&&c.afterId){j&&(j.current=null);return}const U=$.querySelector(`[data-msg-id="${O}"]`);U&&(U.scrollIntoView({behavior:(V=_==null?void 0:_.current)!=null&&V.setDisableSmoothScroll?"auto":"smooth",block:"center"}),j&&(j.current=null),x!==O&&(p(ee=>{const te=new Set(ee);return te.add(O),te}),w&&w(O),S.current&&clearTimeout(S.current),S.current=setTimeout(()=>{p(ee=>{const te=new Set(ee);return te.delete(O),te}),w&&w(null)},1500)))},[l,j==null?void 0:j.current,x,S,p,w,_,c.enableAfterPagination,c.loadingMode,c.afterId]),N.useEffect(()=>{c.enableAfterPagination&&c.loadingMode==="pagination"&&c.afterId&&(S.current&&(clearTimeout(S.current),S.current=null),p(new Set),w(null),j&&(j.current=null))},[c.enableAfterPagination,c.loadingMode,c.afterId,S,p,w,j]),e.jsx(i,{ref:L,className:"messages-container",sx:{flex:1,px:3,pt:3,pb:1,overflowY:"auto",display:"flex",flexDirection:"column",gap:1,position:"relative",willChange:"scroll-position","&::-webkit-scrollbar":{width:"8px"},"&::-webkit-scrollbar-track":{background:"rgba(255,255,255,0.05)",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.1)",borderRadius:"4px","&:hover":{background:"rgba(255,255,255,0.15)"}}},children:q.length===0&&o.size===0?at():e.jsxs(e.Fragment,{children:[Ze,e.jsx(Ce,{in:A,timeout:{enter:300,exit:500},children:e.jsx(i,{sx:{position:"sticky",top:0,zIndex:10,alignSelf:"center",backgroundColor:"rgba(30,30,47,0.85)",backdropFilter:"blur(8px)",borderRadius:"16px",px:2,py:.75,mb:1,boxShadow:"0 2px 8px rgba(0,0,0,0.2)",border:"1px solid rgba(255,255,255,0.1)",transition:"all 0.3s ease"},children:e.jsx(P,{sx:{color:"rgba(255,255,255,0.9)",fontWeight:600,fontSize:"0.9rem"},children:F})})}),e.jsx("div",{ref:Ie,style:{height:"1px",margin:"20px 0"}}),(()=>{let $=[],O=null,U=null,V=[],ee=null,te=new Set;return ge.forEach(H=>{var ze;const re=new Date(H.created_at).toDateString();ee!==re&&!te.has(re)&&(V.length>0&&($.push(...V),V=[]),$.push(e.jsx(i,{className:"date-separator","data-date":H.created_at,sx:{display:"flex",justifyContent:"center",alignItems:"center",my:3,position:"relative","&::before":{content:'""',position:"absolute",top:"50%",left:0,right:0,height:"1px",background:"linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 20%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0.2) 80%, transparent 100%)",zIndex:0}},children:e.jsx(i,{sx:{backgroundColor:"rgba(30,30,47,0.95)",backdropFilter:"blur(8px)",px:3,py:1,borderRadius:"16px",boxShadow:"0 2px 8px rgba(0,0,0,0.25)",border:"1px solid rgba(255,255,255,0.15)",zIndex:1},children:e.jsx(P,{variant:"body2",sx:{color:"rgba(255,255,255,0.85)",fontWeight:600,fontSize:"0.8rem",letterSpacing:"0.5px"},children:Bt(H.created_at)})})},`date-${re}`)),ee=re,te.add(re));const ye="__isTemp"in H&&H.__isTemp,we=((ze=H.author)==null?void 0:ze.id)!==O||!U||!$t(H.created_at,U,30)||!Wt(H.created_at,U),it=g===H.id?e.jsxs(i,{id:`message-${H.id}`,className:"message-item","data-date":H.created_at,"data-msg-id":H.id.toString(),sx:{display:"flex",gap:2,alignItems:"flex-start",position:"relative",borderRadius:"10px",transition:"background-color 0.3s ease",opacity:ye?.6:1},children:[e.jsx(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"flex-start",width:40,ml:1,mt:1},children:we?e.jsx("div",{style:{cursor:"pointer"},children:e.jsx(Ue,{src:H.author.avatar||void 0,alt:H.author.login,userId:H.author.id,hubId:R})}):null}),e.jsx(i,{sx:{flex:1,position:"relative"},children:e.jsx(i,{sx:{maxWidth:"100%"},children:e.jsxs(i,{sx:{py:"5px",px:"0px",pl:0},children:[we&&e.jsx(P,{sx:{color:"#00CFFF",fontWeight:700,mb:.5,fontSize:"1rem",letterSpacing:.2},children:H.author.login}),e.jsx(Me,{initialValues:{content:H.content},validationSchema:At,onSubmit:W,children:({handleSubmit:Fe,values:ke})=>e.jsx(Re,{children:e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:1,background:"rgba(30,30,47,0.9)",borderRadius:"8px",padding:"8px",border:"1px solid rgba(255,255,255,0.1)",boxShadow:"0 4px 12px rgba(0,0,0,0.2)"},children:[e.jsx(De,{name:"content",component:Qe,multiline:!0,fullWidth:!0,size:"small",inputRef:z,onKeyDown:ie=>{ie.key==="Enter"&&!ie.shiftKey?(ie.preventDefault(),Fe()):ie.key==="Escape"&&(ie.preventDefault(),T(null))}}),e.jsxs(i,{sx:{display:"flex",gap:1,justifyContent:"flex-end",padding:"4px 8px"},children:[e.jsx(K,{size:"small",onClick:ie=>{ie.preventDefault(),T(null)},sx:{color:"#d32f2f","&:hover":{background:"rgba(211,47,47,0.1)"}},children:e.jsx(fe,{fontSize:"small"})}),e.jsx(K,{size:"small",onClick:ie=>Fe(),disabled:!ke.content,sx:{color:ke.content?"#1976D2":"rgba(255,255,255,0.3)",transition:"color 0.25s cubic-bezier(.4,0,.2,1)","&:hover":{color:ke.content?"#1976D2":"rgba(255,255,255,0.3)"}},children:e.jsx(Xe,{fontSize:"small"})})]})]})})})]})})})]},ye?`temp-${H.__tempId}`:H.id):e.jsx(Je,{message:H,isFirstOfGroup:we,isTempMessage:ye,isHighlighted:d.has(H.id),isUnread:b.has(H.id),isFocused:x===H.id,isSearchMode:a,searchQuery:h,currentUserId:f.id,hubId:R,loadingMode:c.loadingMode,onReply:tt,onEdit:rt,onDelete:st,onReplyClick:et,onMouseEnter:ot,onMouseLeave:nt},ye?`temp-${H.__tempId}`:H.id);V.push(it),O=H.author.id,U=H.created_at}),V.length>0&&$.push(...V),$})(),e.jsx("div",{ref:Ee,style:{height:"1px",margin:"2px 0"}}),e.jsx("div",{ref:B})]})})},Ht=N.memo(({message:s,searchQuery:t,onResultClick:o})=>{const{highlightedContent:a,formattedTime:h}=r.useMemo(()=>{const b=new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1});let m=s.content;if(m.length>150&&(m=m.substring(0,150)+"..."),m=m.replace(/\r\n/g," ").replace(/\n/g," "),t.trim()){const g=t.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),f=new RegExp(`(${g})`,"gi");m=m.replace(f,"<mark>$1</mark>")}return{highlightedContent:Pe.sanitize(m),formattedTime:b}},[s.content,s.created_at,t]),d=N.useCallback(()=>{o(s)},[s,o]);return e.jsxs(i,{onClick:d,onMouseDown:x=>x.preventDefault(),sx:{p:2,borderBottom:"1px solid rgba(255,255,255,0.05)",cursor:"pointer",transition:"background-color 0.2s ease","&:hover":{background:"rgba(255,255,255,0.1)"},"&:last-child":{borderBottom:"none"},contain:"layout style paint",contentVisibility:"auto",containIntrinsicSize:"0 80px"},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(P,{sx:{color:"#00CFFF",fontSize:"0.8rem",fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"150px"},children:s.author.login}),e.jsx(P,{sx:{color:"rgba(255,255,255,0.4)",fontSize:"0.7rem",ml:"auto"},children:h})]}),e.jsx(P,{sx:{color:"rgba(255,255,255,0.8)",fontSize:"0.85rem",lineHeight:1.4,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical","& mark":{background:"rgba(255, 105, 180, 0.3)",color:"#FF69B4",padding:"1px 2px",borderRadius:"2px",fontWeight:600}},dangerouslySetInnerHTML:{__html:a}})]})},(s,t)=>s.message.id===t.message.id&&s.message.content===t.message.content&&s.searchQuery===t.searchQuery),Ut=({activeChannelId:s})=>{const[t,o]=r.useState(!1),[a,h]=r.useState(""),[d,x]=r.useState(""),[b,m]=r.useState(!1),n=r.useRef(null),g=r.useRef(null),[f,R]=r.useState(0),[c,I]=r.useState([]),[A,F]=r.useState(!0),[L,B]=r.useState(-1),z=s!==null&&d.trim()?{channelId:s,search:d,size:50,...f>0?{page:f}:{}}:void 0,{data:S,isFetching:j,error:u}=qe(z,{skip:!s||!d.trim()}),D=r.useCallback(pt(C=>{x(C)},300),[]);r.useEffect(()=>{S&&(f>0&&f!==L?(I(C=>[...C,...S]),B(f)):(f===0&&L!==-1||f===0&&L===-1)&&(I(S),B(0)),F(S.length>=20))},[S,f,L]),r.useEffect(()=>{d.trim()?(R(0),B(-1)):(I([]),R(0),F(!0),B(-1))},[d]);const _=r.useCallback(C=>{h(C),D(C),C.trim()?m(!0):m(!1)},[D]),l=r.useCallback(()=>{A&&!j&&R(C=>C+1)},[A,j]),p=j&&f>0,w=r.useCallback(()=>{h(""),x(""),m(!1),o(!1),I([]),R(0),F(!0),B(-1),n.current&&(n.current.value="")},[]),T=r.useCallback(C=>{m(!1),o(!1),w()},[w]);return r.useEffect(()=>{const C=v=>{g.current&&!g.current.contains(v.target)&&n.current&&!n.current.contains(v.target)&&m(!1)};return document.addEventListener("mousedown",C),()=>{document.removeEventListener("mousedown",C)}},[]),r.useEffect(()=>{w(),o(!1)},[s,w]),{searchMode:t,setSearchMode:o,searchQuery:a,searchResults:c,debouncedSearchQuery:d,isSearching:j,showSearchResults:b,setShowSearchResults:m,hasMore:A,isLoadingMore:p,searchInputRef:n,searchResultsRef:g,handleSearchInputChange:_,clearSearch:w,loadMore:l,handleResultClick:T}},or=({activeChannelId:s,onSearchResultClick:t})=>{const o=Ut({activeChannelId:s}),a=o.searchMode,h=o.setSearchMode,d=o.searchQuery,x=o.searchResults,b=o.debouncedSearchQuery,m=o.isSearching,n=o.showSearchResults,g=o.setShowSearchResults,f=o.searchInputRef,R=o.searchResultsRef,c=o.handleSearchInputChange,I=o.clearSearch,A=o.handleResultClick,F=r.useCallback(z=>{t?t(z):A&&A(z)},[t,A]);if(!a)return e.jsx(he,{title:"Поиск сообщений",placement:"top",children:e.jsx(K,{onClick:()=>{h(!0),requestAnimationFrame(()=>{var z;(z=f.current)==null||z.focus()})},sx:{color:"rgba(255,255,255,0.6)","&:hover":{color:"rgba(255,255,255,0.9)",background:"rgba(255,255,255,0.05)"}},children:e.jsx(gt,{})})});const L=x&&x.length>0,B=n&&d.trim();return e.jsxs(i,{sx:{display:"flex",flexDirection:"column",position:"relative",zIndex:10001},children:[e.jsx(i,{sx:{display:"flex",alignItems:"center",background:"rgba(255,255,255,0.05)",borderRadius:B&&L?"20px 20px 0 0":"20px",border:"1px solid rgba(255,255,255,0.1)",borderBottom:B&&L?"none":"1px solid rgba(255,255,255,0.1)",paddingLeft:2,paddingRight:1,width:"300px",transition:"all 0.3s ease"},children:e.jsx(Me,{initialValues:{query:d},onSubmit:()=>{},enableReinitialize:!0,children:({setFieldValue:z})=>e.jsxs(Re,{style:{width:"100%",display:"flex",alignItems:"center"},children:[e.jsx(i,{sx:{display:"flex",alignItems:"center",width:"100%",position:"relative"},children:e.jsx(De,{name:"query",children:({field:S})=>e.jsx("input",{...S,ref:f,onChange:j=>{S.onChange(j),c(j.target.value)},onFocus:()=>{var j;(j=S.value)!=null&&j.trim()&&L&&g(!0)},placeholder:"Поиск сообщений...",style:{width:"100%",border:"none",outline:"none",background:"transparent",color:"#fff",fontSize:"0.9rem",padding:"8px 0"},onKeyDown:j=>{j.key==="Escape"&&(n?g(!1):I())}})})}),e.jsx(K,{type:"button",size:"small",onClick:()=>{n?g(!1):(I(),z("query",""))},sx:{color:"rgba(255,255,255,0.5)","&:hover":{color:"rgba(255,255,255,0.9)",background:"rgba(255,255,255,0.1)"}},children:n?e.jsx(ve,{fontSize:"small"}):e.jsx(fe,{fontSize:"small"})})]})})}),B&&e.jsxs(i,{ref:R,onMouseDown:z=>z.preventDefault(),sx:{position:"absolute",top:"100%",left:0,width:"100%",maxHeight:"300px",background:"rgba(20, 20, 35, 0.98)",border:"1px solid rgba(255,255,255,0.1)",borderTop:"none",borderRadius:"0 0 20px 20px",overflowY:"auto",overflowX:"hidden",zIndex:10002,backdropFilter:"blur(15px)",boxShadow:"0 8px 32px rgba(0,0,0,0.6)","&::-webkit-scrollbar":{width:"6px"},"&::-webkit-scrollbar-track":{background:"rgba(255,255,255,0.1)",borderRadius:"3px"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.3)",borderRadius:"3px","&:hover":{background:"rgba(255,255,255,0.5)"}}},children:[m&&e.jsxs(i,{sx:{p:2,display:"flex",justifyContent:"center",alignItems:"center"},children:[e.jsx(i,{sx:{width:24,height:24,border:"2px solid rgba(255,255,255,0.1)",borderTop:"2px solid #00CFFF",borderRadius:"50%",animation:"spin 1s linear infinite","@keyframes spin":{"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}}}}),e.jsx(P,{sx:{ml:1,color:"rgba(255,255,255,0.7)",fontSize:"0.9rem"},children:"Поиск..."})]}),!m&&x&&x.length===0&&b&&e.jsx(i,{sx:{p:3,textAlign:"center"},children:e.jsxs(P,{sx:{color:"rgba(255,255,255,0.5)",fontSize:"0.9rem"},children:["По запросу ",e.jsx(i,{component:"span",sx:{fontWeight:"bold",color:"#00CFFF"},children:b})," ничего не найдено"]})}),!m&&L&&x.map((z,S)=>e.jsx(Ht,{message:z,searchQuery:b,onResultClick:F},`${z.id}-${S}`))]})]})},nr=({open:s,messageToDelete:t,deleteForEveryone:o,canManageMessages:a,messages:h,userId:d,onClose:x,onConfirm:b,onDeleteForEveryoneChange:m})=>{const n=t?h.find(R=>R.id===t):null,f=n&&n.author.id===d||a;return e.jsx(ht,{open:s,onClose:x,title:"Удалить сообщение",children:e.jsxs(i,{sx:{p:2,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:[t&&e.jsxs(i,{sx:{mb:3,width:"100%",maxWidth:300},children:[f&&e.jsxs(i,{onClick:()=>m(!o),sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:1.5,mb:1.5,borderRadius:2,cursor:"pointer",backgroundColor:o?"rgba(255, 61, 113, 0.1)":"rgba(0,0,0,0.15)",border:`1px solid ${o?"rgba(255, 61, 113, 0.3)":"rgba(255,255,255,0.1)"}`,transition:"all 0.2s ease","&:hover":{backgroundColor:o?"rgba(255, 61, 113, 0.15)":"rgba(0,0,0,0.2)",transform:"translateY(-2px)"}},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",mb:.5},children:[e.jsx(xt,{checked:o,onChange:R=>m(R.target.checked),sx:{color:"rgba(255,255,255,0.5)",p:.5,mr:1,"&.Mui-checked":{color:"#FF3D71"}}}),e.jsx(P,{sx:{fontWeight:500,fontSize:"0.9rem"},children:"Удалить у всех"})]}),e.jsx(P,{variant:"body2",sx:{color:"rgba(255,255,255,0.6)",fontStyle:"italic",fontSize:"0.75rem",textAlign:"center"},children:o?"Сообщение исчезнет у всех участников чата":"Сообщение останется видимым для других"})]}),e.jsx(P,{sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.75rem",textAlign:"center",mt:1},children:f?o?"":"Сообщение будет скрыто только в вашем интерфейсе":"Сообщение будет скрыто только для вас"})]}),e.jsxs(i,{sx:{display:"flex",gap:2,justifyContent:"center"},children:[e.jsx(Te,{variant:"outlined",onClick:x,sx:{color:"rgba(255,255,255,0.7)",borderColor:"rgba(255,255,255,0.2)",borderRadius:2,px:3,"&:hover":{borderColor:"rgba(255,255,255,0.4)",backgroundColor:"rgba(255,255,255,0.05)"}},children:"Отмена"}),e.jsx(Te,{variant:"contained",onClick:b,sx:{backgroundColor:"#FF3D71",color:"#fff",borderRadius:2,px:3,"&:hover":{backgroundColor:"#FF1744"}},children:"Удалить"})]})]})})},ar=({showScrollButton:s,newMessagesCount:t,unreadCount:o,replyingToMessage:a,onScrollToBottom:h})=>{const d=a?160:100;return e.jsxs(e.Fragment,{children:[e.jsx(Ce,{in:s,children:e.jsx(K,{onClick:h,sx:{position:"absolute",bottom:d,right:20,backgroundColor:"rgba(30,30,47,0.95)",backdropFilter:"blur(8px)",border:"1px solid rgba(255,255,255,0.1)",boxShadow:"0 4px 12px rgba(0,0,0,0.2)","&:hover":{backgroundColor:"rgba(40,40,57,0.95)"},zIndex:1e3,transition:"bottom 0.2s ease-out"},children:e.jsx(ve,{sx:{color:"#fff"}})})}),e.jsx(Ce,{in:t>0||o>0,children:e.jsx(i,{sx:{position:"absolute",bottom:d,left:"50%",transform:"translateX(-50%)",zIndex:1e3,transition:"bottom 0.2s ease-out"},children:e.jsxs(xe,{sx:{backgroundColor:"#FF69B4",color:"#fff",px:2,py:1,borderRadius:"20px",cursor:"pointer",boxShadow:"0 4px 12px rgba(255,105,180,0.2)",display:"flex",alignItems:"center",gap:1,"&:hover":{backgroundColor:"#FF1493"}},onClick:h,children:[e.jsx(ve,{}),e.jsxs(P,{variant:"body2",sx:{fontWeight:600},children:[t||o," ",(t||o)===1?"новое сообщение":"новых сообщений"]})]})})})]})},Pt=G(Ve)({"& .MuiBackdrop-root":{backgroundColor:"rgba(0, 0, 0, 0.8)",backdropFilter:"blur(8px)"},"& .MuiDialog-paper":{backgroundColor:"rgba(30, 30, 47, 0.95)",backdropFilter:"blur(10px)",borderRadius:"16px",border:"1px solid rgba(255, 255, 255, 0.1)",maxWidth:"70vw",maxHeight:"70vh",margin:"auto",overflow:"hidden"}}),Ot=G("div")({position:"relative",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",userSelect:"none",padding:"20px"}),Nt=G("img")({width:"100%",height:"calc(70vh - 120px)",objectFit:"contain",borderRadius:"12px",filter:"drop-shadow(0 8px 32px rgba(0,0,0,0.8))",transition:"transform 0.2s ease","&:hover":{transform:"scale(1.01)"}}),Ae=G(K)(({theme:s})=>({position:"absolute",top:"50%",transform:"translateY(-50%)",width:56,height:56,backgroundColor:"rgba(0, 0, 0, 0.6)",border:`1px solid ${Y.primary}30`,color:Y.text.primary,transition:"all 0.2s ease","&:hover":{backgroundColor:`${Y.primary}20`,borderColor:`${Y.primary}60`,transform:"translateY(-50%) scale(1.1)",boxShadow:`0 0 20px ${Y.primary}40`},"&:active":{transform:"translateY(-50%) scale(0.95)"}})),qt=G(K)({position:"absolute",top:20,right:20,width:48,height:48,backgroundColor:"rgba(0, 0, 0, 0.6)",border:"1px solid rgba(255, 61, 113, 0.3)",color:Y.text.primary,transition:"all 0.2s ease","&:hover":{backgroundColor:"rgba(255, 61, 113, 0.2)",borderColor:"rgba(255, 61, 113, 0.6)",transform:"scale(1.1) rotate(90deg)",boxShadow:"0 0 20px rgba(255, 61, 113, 0.4)"}}),Vt=G(i)({position:"absolute",bottom:24,left:"50%",transform:"translateX(-50%)",padding:"8px 16px",backgroundColor:"rgba(0, 0, 0, 0.7)",border:`1px solid ${Y.primary}30`,borderRadius:"20px",color:Y.text.primary,fontSize:"14px",fontWeight:600,backdropFilter:"blur(10px)"}),Qt=G(i)({position:"absolute",bottom:60,left:"50%",transform:"translateX(-50%)",display:"flex",gap:"8px",alignItems:"center"}),Yt=G("button")(({active:s})=>({width:s?24:8,height:8,border:"none",borderRadius:"4px",backgroundColor:s?Y.primary:"rgba(255, 255, 255, 0.3)",cursor:"pointer",transition:"all 0.2s ease","&:hover":{backgroundColor:s?Y.primary:"rgba(255, 255, 255, 0.5)",transform:"scale(1.2)"}})),Kt=({open:s,images:t,currentIndex:o,onClose:a,onNavigate:h})=>{const d=r.useMemo(()=>t[o],[t,o]),x=r.useCallback(()=>{o>0&&h(o-1)},[o,h]),b=r.useCallback(()=>{o<t.length-1&&h(o+1)},[o,t.length,h]),m=r.useCallback(n=>{switch(n.key){case"Escape":a();break;case"ArrowLeft":x();break;case"ArrowRight":b();break}},[a,x,b]);return d?e.jsx(Pt,{open:s,onClose:a,onKeyDown:m,children:e.jsxs(Ot,{onClick:a,children:[e.jsx(Nt,{src:d.preview,alt:"Preview",onClick:n=>n.stopPropagation(),draggable:!1}),o>0&&e.jsx(Ae,{onClick:n=>{n.stopPropagation(),x()},style:{left:32},children:e.jsx(Ke,{})}),o<t.length-1&&e.jsx(Ae,{onClick:n=>{n.stopPropagation(),b()},style:{right:32},children:e.jsx(Ge,{})}),e.jsx(qt,{onClick:n=>{n.stopPropagation(),a()},children:e.jsx(fe,{})}),t.length>1&&e.jsxs(e.Fragment,{children:[e.jsxs(Vt,{children:[o+1," / ",t.length]}),e.jsx(Qt,{children:t.map((n,g)=>e.jsx(Yt,{active:g===o,onClick:f=>{f.stopPropagation(),h(g)}},g))})]})]})}):null},Gt=Oe().shape({content:Ne().max(2e3,"Message is too long").test("content-or-images","Message cannot be empty",function(){return!0})}),Be=15*1024*1024,ne=5,$e=["image/jpeg","image/jpg","image/png","image/gif","image/webp"],Xt=({activeChannel:s,canSendMessages:t,sending:o,replyingToMessage:a,onSendMessage:h,onReplyCancel:d,onReplyClick:x})=>{var j;const b=r.useRef(null),m=r.useRef(null),n=r.useRef(null),[g,f]=r.useState([]),[R,c]=r.useState(null);r.useEffect(()=>{if(s&&b.current){b.current.focus();const u=b.current.value.length;b.current.setSelectionRange(u,u)}},[s]),r.useEffect(()=>{if(a&&b.current){b.current.focus();const u=b.current.value.length;b.current.setSelectionRange(u,u)}},[a]),r.useEffect(()=>{const u=D=>{D.key==="Escape"&&a&&d()};return document.addEventListener("keydown",u),()=>{document.removeEventListener("keydown",u)}},[a,d]),r.useEffect(()=>{const u=_=>{if(!_.clipboardData)return;const p=Array.from(_.clipboardData.items).filter(T=>T.type.startsWith("image/"));if(p.length===0||g.length>=ne)return;_.preventDefault();const w=[];p.slice(0,ne-g.length).forEach(T=>{const C=T.getAsFile();if(!C)return;if(g.some(oe=>oe.file.size===C.size&&oe.file.type===C.type&&oe.file.lastModified===C.lastModified)){console.log("Duplicate image detected, skipping");return}const y=new Date().getTime(),M=Math.random().toString(36).substring(2,8),E=C.type.split("/")[1]||"png",k=new File([C],`pasted-image-${y}-${M}.${E}`,{type:C.type,lastModified:C.lastModified||Date.now()}),W=$e.includes(k.type),Q=k.size<=Be,J={file:k,preview:URL.createObjectURL(k),valid:W&&Q,error:W?Q?void 0:"Файл слишком большой (макс. 15MB)":"Неподдерживаемый формат файла"};w.push(J)}),w.length>0&&f(T=>[...T,...w])},D=b.current;if(D)return D.addEventListener("paste",u),()=>{D.removeEventListener("paste",u)}},[g.length]),r.useEffect(()=>()=>{g.forEach(u=>URL.revokeObjectURL(u.preview))},[g]);const I=()=>{a&&x&&x(a.id)},A=u=>{var _;if(u.content&&u.content.trim())return F(u.content);const D=((_=u.attachments)==null?void 0:_.length)||0;return D>0?D===1?"📎 Вложение":D>=2&&D<=4?`📎 ${D} вложения`:`📎 ${D} вложений`:"📎 Вложение"},F=u=>u.length>150?!(u.indexOf(" ")!==-1)&&u.length>100?u.substring(0,100)+"...":u.substring(0,150)+"...":u,L=u=>{if(!u.target.files||!u.target.files.length)return;const D=Array.from(u.target.files);if(m.current&&(m.current.value=""),g.length>=ne)return;const _=[];D.slice(0,ne-g.length).forEach(l=>{if(g.some(v=>v.file.size===l.size&&v.file.type===l.type&&v.file.name===l.name&&v.file.lastModified===l.lastModified)){console.log("Duplicate file detected, skipping:",l.name);return}const w=$e.includes(l.type),T=l.size<=Be,C={file:l,preview:URL.createObjectURL(l),valid:w&&T,error:w?T?void 0:"Файл слишком большой (макс. 15MB)":"Неподдерживаемый формат файла"};_.push(C)}),_.length>0&&f(l=>[...l,..._])},B=u=>{f(D=>{const _=[...D];return URL.revokeObjectURL(_[u].preview),_.splice(u,1),_})},z=()=>{m.current&&m.current.click()},S=u=>{c(u)};return e.jsxs(i,{sx:{p:2},children:[t?e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:1},children:[a&&e.jsxs(xe,{sx:{p:"8px 16px",display:"flex",alignItems:"flex-start",gap:1,background:"rgba(30,30,47,0.95)",border:"1px solid rgba(149,128,255,0.25)",borderRadius:2,position:"relative",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",mb:1,pl:3,width:"100%"},children:[e.jsx(i,{sx:{position:"absolute",left:0,top:0,bottom:0,width:"4px",backgroundColor:"#00CFFF",borderTopLeftRadius:2,borderBottomLeftRadius:2}}),e.jsxs(i,{sx:{flex:1,cursor:"pointer"},onClick:I,children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(Ye,{sx:{color:"#00CFFF",fontSize:"0.9rem"}}),e.jsxs(P,{variant:"caption",sx:{color:"#00CFFF",fontWeight:600,display:"flex",alignItems:"center"},children:["Ответ ",(j=a.author)!=null&&j.login?`@${a.author.login}`:""]})]}),e.jsx(P,{variant:"body2",sx:{color:"rgba(255,255,255,0.7)",fontSize:"0.85rem",lineHeight:1.4,wordBreak:"break-word"},children:A(a)})]}),e.jsx(K,{size:"small",onClick:d,sx:{color:"rgba(255,255,255,0.5)","&:hover":{color:"rgba(255,255,255,0.8)"}},children:e.jsx(fe,{fontSize:"small"})})]}),g.length>0&&e.jsxs(xe,{sx:{p:2,background:"rgba(30,30,47,0.95)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:2,mb:1},children:[e.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:g.map((u,D)=>e.jsx(i,{sx:{width:{xs:"calc(33.33% - 8px)",sm:"calc(25% - 8px)",md:"calc(16.66% - 8px)"}},children:e.jsxs(i,{sx:{position:"relative",height:100,borderRadius:1,overflow:"hidden",border:u.valid?"1px solid rgba(255,255,255,0.1)":"1px solid #f44336","&:hover .image-remove-btn":{opacity:1}},children:[e.jsx(i,{component:"img",src:u.preview,alt:"Preview",onClick:()=>S(D),sx:{width:"100%",height:"100%",objectFit:"cover",cursor:"pointer"}}),!u.valid&&e.jsx(he,{title:u.error||"Invalid image",children:e.jsx(i,{sx:{position:"absolute",top:5,left:5,bgcolor:"rgba(0,0,0,0.7)",borderRadius:"50%",width:24,height:24,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(kt,{sx:{color:"#f44336",fontSize:"16px"}})})}),e.jsx(K,{className:"image-remove-btn",size:"small",onClick:()=>B(D),sx:{position:"absolute",top:5,right:5,bgcolor:"rgba(0,0,0,0.7)",color:"white",p:"4px",opacity:0,transition:"opacity 0.2s","&:hover":{bgcolor:"rgba(0,0,0,0.85)"}},children:e.jsx(fe,{sx:{fontSize:"16px"}})})]})},D))}),e.jsxs(i,{sx:{mt:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(P,{variant:"caption",sx:{color:"rgba(255,255,255,0.7)"},children:[g.length," / ",ne," изображений"]}),g.length>1&&e.jsx(P,{variant:"caption",onClick:()=>{g.forEach(u=>URL.revokeObjectURL(u.preview)),f([])},sx:{color:"#1976D2",cursor:"pointer","&:hover":{textDecoration:"underline"}},children:"Очистить все"})]})]}),e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",multiple:!0,ref:m,onChange:L,style:{display:"none"},max:ne.toString()}),e.jsx(xe,{sx:{p:"8px 16px",display:"flex",alignItems:"center",gap:1,background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:3},children:e.jsx(Me,{innerRef:n,initialValues:{content:""},validationSchema:Gt,onSubmit:async(u,D)=>{const _=g.filter(l=>l.valid).map(l=>l.file);try{await h({content:u.content,images:_.length>0?_:void 0},D),g.forEach(l=>URL.revokeObjectURL(l.preview)),f([])}catch(l){console.error("Error sending message:",l)}},children:({handleSubmit:u,values:D})=>e.jsxs(e.Fragment,{children:[e.jsx(Re,{style:{width:"100%"},children:e.jsx(De,{name:"content",component:Qe,placeholder:"Type a message...",multiline:!0,maxRows:4,size:"small",disabled:!s||o,inputRef:b,sx:{"& .MuiOutlinedInput-root":{"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"},"& .MuiOutlinedInput-notchedOutline":{borderColor:"transparent"}}},onKeyDown:_=>{_.key==="Enter"&&!_.shiftKey&&(_.preventDefault(),u())}})}),e.jsxs(ft,{direction:"row",spacing:1,children:[e.jsx(he,{title:g.length>=ne?`Максимум ${ne} изображений`:"Прикрепить изображения",children:e.jsxs(i,{children:["  ",e.jsx(K,{size:"small",sx:{color:g.length>=ne?"rgba(255,255,255,0.3)":"#1E90FF"},onClick:z,disabled:g.length>=ne,children:e.jsx(jt,{})})]})}),e.jsx(K,{size:"small",sx:{color:D.content||g.length>0?"#1976D2":"rgba(255,255,255,0.3)",transition:"color 0.25s cubic-bezier(.4,0,.2,1)","&:hover":{color:D.content||g.length>0?"#1976D2":"rgba(255,255,255,0.3)"}},onClick:()=>u(),disabled:o||!D.content&&g.length===0,children:e.jsx(Xe,{})})]})]})})})]}):e.jsx(xe,{sx:{p:"12px 16px",display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:3},children:e.jsx(P,{sx:{color:"rgba(255,255,255,0.5)",fontSize:"0.9rem"},children:"Недостаточно прав для отправки сообщений"})}),e.jsx(Kt,{open:R!==null,images:g,currentIndex:R||0,onClose:()=>c(null),onNavigate:c})]})},ir=({activeChannel:s,canSendMessages:t,sending:o,replyingToMessage:a,onSendMessage:h,onReplyCancel:d,onReplyClick:x})=>e.jsx(Xt,{activeChannel:s,canSendMessages:t,sending:o,replyingToMessage:a,onSendMessage:h,onReplyCancel:d,onReplyClick:x}),lr=()=>{const[s,t]=r.useState(null),[o,a]=r.useState(null),[h,d]=r.useState(!0),[x,b]=r.useState(!0),[m,n]=r.useState(!1),[g,f]=r.useState("initial"),[R,c]=r.useState(!1),[I,A]=r.useState(!1),[F,L]=r.useState(null),B=r.useRef(!1),z=r.useRef(null),S=r.useRef(null),j=r.useRef(null),u=r.useRef(!1),D=r.useRef(!1),_=r.useRef(null),l=r.useRef(null),p=r.useCallback(W=>{j.current&&(clearTimeout(j.current),j.current=null),B.current=W,W&&(j.current=setTimeout(()=>{console.warn("[Pagination] Loading timeout - resetting loading state after 10 seconds"),B.current=!1,f(null),j.current=null},1e4))},[]),w=r.useCallback((W,Q,J)=>{if(I)return;if(!(B.current||g==="initial"||g==="around"||!u.current)){if(W.scrollTop/W.scrollHeight<.2&&h){if(_.current!==null&&_.current<J){console.log("[useMessagePagination] Skipping before pagination - previous request returned fewer messages than page size:",{lastMessageCount:_.current,messagesPerPage:J});return}p(!0),f("pagination");const q=[...Q].sort((Z,pe)=>new Date(Z.created_at).getTime()-new Date(pe.created_at).getTime())[0];q&&z.current!==q.id?(console.log("[useMessagePagination] Setting beforeId for pagination:",{oldestMessageId:q.id,previousBeforeId:z.current,messagesCount:Q.length}),t(q.id),z.current=q.id,a(null),S.current=null,c(!1)):q&&(console.log("[useMessagePagination] Duplicate before request detected, skipping:",{oldestMessageId:q.id,lastBeforeId:z.current}),p(!1),f(null))}if(m&&!D.current&&x&&Q.length>=J){if(l.current!==null&&l.current<J){console.log("[useMessagePagination] Skipping after pagination - previous request returned fewer messages than page size:",{lastAfterMessageCount:l.current,messagesPerPage:J});return}if(W.scrollHeight-W.scrollTop-W.clientHeight<100){p(!0),f("pagination");const q=[...Q].sort((pe,ge)=>new Date(pe.created_at).getTime()-new Date(ge.created_at).getTime()),Z=q[q.length-1];Z&&S.current!==Z.id?(a(Z.id),S.current=Z.id,t(null),z.current=null,c(!1),D.current=!0):Z&&(p(!1),f(null))}}}},[I,g,h,x,m,p]),T=r.useCallback(()=>{t(null),a(null),d(!0),b(!0),n(!1),f("initial"),c(!1),A(!1),L(null),p(!1),z.current=null,S.current=null,u.current=!1,D.current=!1,_.current=null,l.current=null},[p]),C=r.useCallback(W=>{A(!0),L(W),f("around"),c(!0),t(null),a(null),z.current=null,S.current=null,p(!1)},[p]),v=r.useCallback(W=>{u.current=W},[]),y=r.useCallback(()=>{D.current=!1},[]),M=r.useCallback((W,Q)=>{Q==="before"?_.current=W:Q==="after"?l.current=W:Q==="initial"&&(_.current=W,l.current=W),console.log("[useMessagePagination] Updated message count tracking:",{direction:Q,count:W,beforeCount:_.current,afterCount:l.current})},[]);r.useEffect(()=>()=>{j.current&&clearTimeout(j.current)},[]);const E=r.useMemo(()=>({beforeId:s,afterId:o,hasMoreMessages:h,hasMoreMessagesAfter:x,enableAfterPagination:m,loadingMode:g,skipMainQuery:R,isJumpingToMessage:I,aroundMessageId:F}),[s,o,h,x,m,g,R,I,F]),k=r.useMemo(()=>({setBeforeId:t,setAfterId:a,setHasMoreMessages:d,setHasMoreMessagesAfter:b,setEnableAfterPagination:n,setLoadingMode:f,setSkipMainQuery:c,setIsJumpingToMessage:A,setAroundMessageId:L,handleScrollPagination:w,resetPagination:T,jumpToMessage:C,setInitialLoadComplete:v,clearAfterPaginationCooldown:y,updateLastRequestMessageCount:M}),[w,T,C,v,y,M]);return{state:E,actions:k,isLoadingMoreRef:B,lastBeforeIdRef:z,lastAfterIdRef:S,setLoadingWithTimeout:p}},cr=({activeChannel:s})=>{const t=r.useRef(new Set),o=r.useCallback(d=>{t.current.add(d)},[]),a=r.useCallback(d=>{s&&t.current.add(d)},[s]),h=r.useCallback(()=>{s&&be.publish(`/app/v1/channels/${s.id}/messages/bulk-read-all`,{})},[s]);return r.useEffect(()=>{if(!s)return;const d=()=>{if(t.current.size>0){const b=Array.from(t.current);be.publish(`/app/v1/channels/${s.id}/messages/bulk-read`,{messageIds:b}),t.current.clear()}},x=setInterval(d,1e3);return()=>{clearInterval(x),d()}},[s]),{unreadMessagesBufferRef:t,markMessageAsRead:a,markAllMessagesAsRead:h,addToReadBuffer:o}},dr=({messagesContainerRef:s,messages:t,activeChannel:o,onMarkAllAsRead:a,bulkReadAllRef:h,paginationActions:d,messagesPerPage:x=20,isUpdatingFromRequest:b=!1})=>{const[m,n]=r.useState(!0),[g,f]=r.useState(!1),[R,c]=r.useState(!1),[I,A]=r.useState(null),[F,L]=r.useState(!1),[B,z]=r.useState(!1),S=r.useRef(null),j=r.useRef(null),u=r.useRef(0),D=r.useRef(0),_=r.useRef(0),l=r.useRef(!1),p=r.useCallback(()=>{const v=s.current;v&&(u.current=v.scrollHeight,D.current=v.scrollTop)},[s]),w=r.useCallback((v=!1,y)=>{if(!s.current||F)return;const M=s.current;requestAnimationFrame(()=>{if(v||B){const E=M.style.scrollBehavior;M.style.scrollBehavior="auto",M.scrollTop=M.scrollHeight,M.style.scrollBehavior=E}else M.scrollTop=M.scrollHeight;f(!1),setTimeout(()=>{M.scrollTop<M.scrollHeight-M.clientHeight-100&&(M.scrollTop=M.scrollHeight),y&&y()},150)})},[F,B,s]),T=r.useCallback(v=>{if(!s.current)return;const y=document.getElementById(`message-${v}`);if(!y)return;L(!0);const M=s.current,E=y.offsetTop,k=y.offsetHeight,W=M.clientHeight,Q=E-W/2+k/2;M.scrollTop=Math.max(0,Q),y.style.transition="background-color 0.3s ease-in-out",y.style.backgroundColor="rgba(0, 207, 255, 0.1)",j.current&&clearTimeout(j.current),j.current=setTimeout(()=>{y&&(y.style.backgroundColor=""),L(!1),M.scrollTop+M.clientHeight>=M.scrollHeight-20&&w()},2e3)},[s,w]),C=v=>{const y=new Date(v),M=new Date,E=new Date(M);if(E.setDate(E.getDate()-1),y.toDateString()===M.toDateString())return"Сегодня";if(y.toDateString()===E.toDateString())return"Вчера";const k=y.getFullYear()===M.getFullYear(),W=y.toLocaleDateString([],{weekday:"long",day:"numeric",month:"long",...k?{}:{year:"numeric"}});return W.charAt(0).toUpperCase()+W.slice(1)};return r.useEffect(()=>{const v=s.current;if(!v)return;let y=v.scrollTop,M=null,E=0;const k=()=>{l.current||(l.current=!0,requestAnimationFrame(()=>{M&&clearTimeout(M);const W=v.scrollTop,J=v.scrollHeight-W-v.clientHeight<100;if(W<y)d&&x&&d.handleScrollPagination(v,t,x);else if(W>y&&J&&!m){n(!0);const X=Date.now();a&&(h!=null&&h.current)&&X-E>1e3&&X-h.current>1e3&&(E=X,h.current=X,a())}y=W,n(J),f(v.scrollTop+v.clientHeight<v.scrollHeight-400),S.current&&clearTimeout(S.current);const oe=v.querySelectorAll(".message-item");let ce=null;if(oe.length>0)for(const X of oe){const q=X.getBoundingClientRect(),Z=v.getBoundingClientRect();if(q.bottom>Z.top&&q.top<Z.bottom){const ge=X.getAttribute("data-date");if(ge){ce=C(ge);break}}}ce?(A(ce),c(!0),S.current=setTimeout(()=>{c(!1)},1e3)):c(!1),M=setTimeout(()=>{M=null},150),l.current=!1}))};return v.addEventListener("scroll",k),()=>{v.removeEventListener("scroll",k),S.current&&clearTimeout(S.current),M&&clearTimeout(M)}},[o,t,s,a,h,d,x]),r.useEffect(()=>{const v=s.current;if(!v)return;const y=t.length,M=_.current;if(y>M&&M>0&&b){const E=v.scrollHeight-u.current;if(E>0){const k=D.current+E;v.scrollTop=k}}_.current=y,u.current=v.scrollHeight,D.current=v.scrollTop},[t.length,s,b]),r.useEffect(()=>()=>{j.current&&clearTimeout(j.current),S.current&&clearTimeout(S.current)},[]),{isScrolledToBottom:m,setIsScrolledToBottom:n,showScrollButton:g,setShowScrollButton:f,showDateLabel:R,setShowDateLabel:c,currentDateLabel:I,setCurrentDateLabel:A,disableAutoScroll:F,setDisableAutoScroll:L,scrollToBottom:w,scrollToMessage:T,prepareScrollCorrection:p,setDisableSmoothScroll:z}},ur=({channelId:s,onSearchResultClick:t})=>{const[o,a]=r.useState(!1),[h,d]=r.useState(""),[x,b]=r.useState(""),[m,n]=r.useState(!1),[g,f]=r.useState(new Set),[R,c]=r.useState(null),[I,A]=r.useState(void 0),[F,L]=r.useState([]),[B,z]=r.useState(!0),S=r.useRef(null),j=r.useRef(null),u=r.useRef(null),D={channelId:s??0,search:x,size:20,...I&&{beforeId:I}},_=!s||!x||!o,{data:l,isLoading:p,isFetching:w}=qe(D,{skip:_,refetchOnMountOrArgChange:!0}),T=w&&I!==void 0,C=r.useCallback(E=>{d(E),u.current&&clearTimeout(u.current),A(void 0),L([]),z(!0),u.current=setTimeout(()=>{b(E),E.trim()&&n(!0)},300)},[]),v=r.useCallback(E=>{a(!1),d(""),b(""),n(!1),f(new Set),c(null),t(E.id)},[t]),y=r.useCallback(()=>{a(!1),d(""),b(""),n(!1),f(new Set),c(null),A(void 0),L([]),z(!0)},[]),M=r.useCallback(()=>{if(B&&!T&&F.length>0){const E=F[F.length-1];console.log("Loading more, last message id:",E.id,"hasMore:",B),A(E.id)}},[B,T,F]);return r.useEffect(()=>{l?(L(I?E=>{const k=new Set(E.map(Q=>Q.id)),W=l.filter(Q=>!k.has(Q.id));return W.length===0&&z(!1),[...E,...W]}:l),z(l.length===20)):x||L([])},[l,I,x]),r.useEffect(()=>{o||(d(""),b(""),n(!1),A(void 0),L([]),z(!0))},[o]),r.useEffect(()=>{const E=k=>{m&&j.current&&S.current&&!j.current.contains(k.target)&&!S.current.contains(k.target)&&n(!1)};return document.addEventListener("mousedown",E),()=>{document.removeEventListener("mousedown",E)}},[m]),r.useEffect(()=>()=>{u.current&&clearTimeout(u.current)},[]),{searchMode:o,setSearchMode:a,searchQuery:h,setSearchQuery:d,debouncedSearchQuery:x,showSearchResults:m,setShowSearchResults:n,searchInputRef:S,searchResultsRef:j,highlightedMessages:g,setHighlightedMessages:f,focusedMessageId:R,setFocusedMessageId:c,searchResults:F,isSearching:p&&I===void 0,handleSearchInputChange:C,handleSearchResultClick:v,clearSearch:y,loadMore:M,hasMore:B,isLoadingMore:T}},We=(s,t)=>{const o=r.useCallback(t,[t]);r.useEffect(()=>{if(!s)return;let a=!0;return a&&(async()=>{try{await be.subscribe(s,o)}catch(d){console.error("Failed to setup WebSocket subscription:",d)}})(),()=>{a=!1,be.unsubscribe(s,o)}},[s,o])};var ae=(s=>(s[s.SENT=0]="SENT",s[s.READ=1]="READ",s[s.NEW=2]="NEW",s))(ae||{});const pr=(s,t,o,a)=>{const h=r.useRef(0),d=r.useRef(o),x=r.useRef(a);r.useEffect(()=>{d.current=o},[o]),r.useEffect(()=>{x.current=a},[a]);const b=r.useCallback(()=>{if(!s)return;const n=Date.now();n-h.current>1e3&&n-x.current.bulkReadAllRef.current>1e3&&(h.current=n,x.current.bulkReadAllRef.current=n,be.publish(`/app/v1/channels/${s.id}/messages/bulk-read-all`,{}),d.current.onMarkAllAsRead())},[s==null?void 0:s.id]),m=r.useCallback(n=>{const g=x.current,f=d.current;if(n.type==="MESSAGE_CREATE"&&n.message){const R=g.convertToExtendedMessage(n.message);if(R.author.id===(t==null?void 0:t.id))return;if(f.onMessageCreate(R),f.onHighlightMessage(R.id,1500),R.status===ae.NEW){const c=g.messagesContainerRef.current;let I=!1,A=!1;if(c){const F=c.scrollHeight-c.scrollTop-c.clientHeight;I=F<100,A=I||F<=300,console.log("[useMessageWebSocket] Pre-message scroll state:",{messageId:R.id,scrollHeight:c.scrollHeight,scrollTop:c.scrollTop,clientHeight:c.clientHeight,scrollPosition:F,wasAtBottom:I,shouldAutoScroll:A})}requestAnimationFrame(()=>{requestAnimationFrame(()=>{setTimeout(()=>{const F=g.messagesContainerRef.current;F&&s&&(console.log("[useMessageWebSocket] Post-message scroll state:",{messageId:R.id,scrollHeight:F.scrollHeight,scrollTop:F.scrollTop,clientHeight:F.clientHeight,wasAtBottom:I,shouldAutoScroll:A}),I?(g.addToReadBuffer(R.id),f.onMarkMessageAsRead(R.id),g.loadingMode!=="around"&&!g.isJumpingToMessage&&(console.log("[useMessageWebSocket] Scrolling to new bottom:",F.scrollHeight),F.scrollTop=F.scrollHeight),b()):A?(g.addToReadBuffer(R.id),f.onMarkMessageAsRead(R.id),g.loadingMode!=="around"&&!g.isJumpingToMessage&&(console.log("[useMessageWebSocket] Auto-scrolling to new bottom:",F.scrollHeight),F.scrollTop=F.scrollHeight),b()):(f.onNewMessageIndicator(!0),f.onUnreadMessage(R.id),setTimeout(()=>{const L=document.querySelector(`[data-msg-id="${R.id}"]`);if(L){const B=L.getBoundingClientRect();B.top>=0&&B.bottom<=window.innerHeight&&s&&(g.addToReadBuffer(R.id),f.onMarkMessageAsRead(R.id))}},100)))},10)})})}}else if(n.type==="MESSAGE_UPDATE"&&n.message){const R=g.convertToExtendedMessage(n.message);f.onMessageUpdate(R),R.status===ae.READ&&f.onUnreadCountChange(-1)}else n.type==="MESSAGE_DELETE"&&n.messageId?(f.onMessageDelete(n.messageId),f.onUnreadCountChange(-1)):n.type==="MESSAGE_READ_STATUS"&&n.message_range&&(console.log("[useMessageWebSocket] Received MESSAGE_READ_STATUS:",n.message_range,"channel:",n.channelId),f.onMessageReadStatus(n.message_range))},[t==null?void 0:t.id,s==null?void 0:s.id,b]);return We(s&&t?`/v1/user/${t.id}/queue/channels/${s.id}/messages`:null,m),We(s?`/v1/topic/channels/${s.id}/messages`:null,m),{}},gr=()=>{const[s,t]=r.useState([]),[o,a]=r.useState(new Map),[h,d]=r.useState(new Set),[x,b]=r.useState(0),[m,n]=r.useState(0),g=r.useCallback(l=>({...l,status:"status"in l?l.status:ae.SENT,reply:l.reply?{...l.reply,status:"status"in l.reply?l.reply.status:ae.SENT}:null}),[]),f=r.useCallback(()=>{t([]),a(new Map),d(new Set),b(0),n(0)},[]),R=r.useCallback((l,p)=>{t(w=>w.map(T=>T.id===l&&T.author.id!==p?{...T,status:ae.READ}:T))},[]),c=r.useCallback(l=>{t(p=>p.map(w=>w.author.id!==l?{...w,status:ae.READ}:w)),d(new Set),b(0),n(0)},[]),I=r.useCallback((l,p)=>{console.log("[useMessageState] Updating read_by_count for range:",l,"by user:",p),t(w=>w.map(C=>{if(C.id>=l.from&&C.id<=l.to){const v=C.read_by_count||0,y=v+1;return console.log("[useMessageState] Message",C.id,"read_by_count:",v,"->",y),{...C,read_by_count:y}}return C}))},[]),A=r.useCallback(l=>{t(p=>p.some(C=>C.id===l)?p.filter(C=>C.id!==l).map(C=>C.reply&&C.reply.id===l?{...C,reply:void 0}:C):p)},[]),F=r.useCallback(l=>{t(p=>p.some(T=>T.id===l.id)?p.map(T=>T.id===l.id?l:T):p)},[]),L=r.useCallback(l=>{t(p=>p.some(T=>T.id===l.id)?p:[...p,l])},[]),B=r.useCallback(l=>{d(p=>{const w=new Set(p);return w.add(l),w}),b(p=>p+1),n(p=>p+1)},[]),z=r.useCallback(l=>{d(p=>{const w=new Set(p);return w.delete(l),w}),b(p=>Math.max(0,p-1)),n(p=>Math.max(0,p-1))},[]),S=r.useCallback(l=>{b(p=>Math.max(0,p+l)),n(p=>Math.max(0,p+l))},[]),j=r.useCallback(()=>{b(0),n(0)},[]),u=r.useCallback((l,p)=>{a(w=>{const T=new Map(w);return T.set(l,p),T})},[]),D=r.useCallback(l=>{a(p=>{const w=new Map(p);return w.delete(l),w})},[]),_=r.useCallback((l,p)=>{a(w=>{const T=new Map(w),C=T.get(l);if(C){const v={...C,status:p==="sending"?ae.SENT:ae.NEW,_tempStatus:p};T.set(l,v)}return T})},[]);return{messages:s,setMessages:t,tempMessages:o,setTempMessages:a,unreadMessages:h,setUnreadMessages:d,unreadCount:x,setUnreadCount:b,newMessagesCount:m,setNewMessagesCount:n,convertToExtendedMessage:g,resetMessageStates:f,updateMessageReadStatus:R,markAllMessagesAsReadInState:c,updateMessageReadByCount:I,deleteMessageFromState:A,updateMessageInState:F,addMessageToState:L,addUnreadMessage:B,removeUnreadMessage:z,updateUnreadCount:S,resetUnreadCounts:j,addTempMessage:u,removeTempMessage:D,updateTempMessage:_}},hr=({onSendMessage:s,onAddTempMessage:t,onRemoveTempMessage:o,onUpdateTempMessage:a,activeChannel:h,user:d})=>{const[x,b]=r.useState(!1),m=r.useRef([]),n=r.useRef(null),g=r.useCallback(async()=>{if(!(x||m.current.length===0)){for(b(!0);m.current.length>0;){const c=m.current.shift();if(!c)break;try{a(c.id,"sending"),await s({content:c.content,images:c.images},c.replyMessage),o(c.id)}catch(I){console.error("Failed to send queued message:",I),a(c.id,"error"),setTimeout(()=>{o(c.id)},3e3)}await new Promise(I=>setTimeout(I,200))}b(!1)}},[x,s,a,o]),f=r.useCallback((c,{resetForm:I},A)=>{if(!h||!d)return;const F=c.content.trim(),L=c.images&&c.images.length>0;if(!F&&!L)return;I();const B=`temp_${Date.now()}_${Math.random()}`,z={id:-1,content:c.content,author:d,created_at:new Date().toISOString(),last_modified_at:void 0,attachments:[],status:ae.SENT,read_by_count:0,channel_id:h.id,reply:A||void 0};t(B,z);const S={id:B,content:c.content,images:c.images,replyMessage:A,tempMessage:z,resetForm:I};m.current.push(S),n.current&&clearTimeout(n.current),n.current=setTimeout(()=>{g()},300)},[h,d,t,g]),R=r.useCallback(()=>{m.current=[],b(!1),n.current&&(clearTimeout(n.current),n.current=null)},[]);return{queueMessage:f,clearQueue:R,isProcessing:x,queueLength:m.current.length}};export{ir as C,nr as D,ae as M,ar as N,or as S,lr as a,cr as b,dr as c,ur as d,pr as e,hr as f,sr as g,gr as u};
